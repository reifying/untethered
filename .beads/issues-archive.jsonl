{"id":"voice-code-security-au2","content_hash":"cba02aa6b675f167b93ab260196abf1674fd8f7710255eca74c37147ce0e5ce6","title":"API Key Authentication","description":"## Design Document\n@docs/api-key-authentication.md\n\n## Overview\nImplement Pre-Shared Key (PSK) authentication between iOS app and Clojure backend. Users generate a 43-character API key on the backend, scan it via QR code on iOS, and all subsequent WebSocket and HTTP connections are authenticated.\n\n## Acceptance Criteria\n1. Backend generates cryptographically secure 43-char API keys (voice-code- prefix + 32 hex chars)\n2. Backend displays API key as QR code in terminal with Unicode block characters\n3. iOS app scans QR code and stores key securely in Keychain with Share Extension access\n4. WebSocket connections include api_key in connect message; backend validates and marks channel authenticated\n5. Invalid/missing API keys are rejected with generic auth_error message (timing-attack resistant)\n6. Authentication persists for WebSocket session lifetime (no per-message auth)\n7. HTTP endpoints validate Bearer token in Authorization header\n8. Share Extension includes API key in HTTP requests\n9. iOS provides UI for key management (scan, view, delete)\n10. Clear error UX when authentication fails or key is missing","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-02T14:39:10.514025-06:00","updated_at":"2026-01-02T17:34:17.197409-06:00","closed_at":"2026-01-02T17:34:17.197409-06:00","source_repo":"."}
{"id":"voice-code-security-au2.10","content_hash":"ba16eeb9620e59e86a5f1b0cd29e94fe2fa4105c30b0d8a167986ccd4ea1c70e","title":"Create KeychainManager for secure API key storage","description":"## Design Reference\n@docs/api-key-authentication.md#35-ios-keychain-storage\n\n## Context\nFoundation iOS task for secure credential storage. KeychainManager provides Keychain access with Share Extension sharing via access group. Must be completed before VoiceCodeClient updates.\n\n## Requirements\n- [ ] Create KeychainManager.swift class\n- [ ] Implement saveAPIKey(_ key: String) throws\n- [ ] Implement retrieveAPIKey() -\u003e String?\n- [ ] Implement deleteAPIKey() throws\n- [ ] Implement hasAPIKey() -\u003e Bool\n- [ ] Implement isValidAPIKeyFormat(_ key: String) -\u003e Bool\n- [ ] Configure kSecAttrAccessGroup for Share Extension sharing\n- [ ] Use kSecAttrAccessibleAfterFirstUnlock for availability\n\n## Technical Approach\n- Files to create: VoiceCode/KeychainManager.swift\n- Service name: \"com.example.voicecode.api-key\"\n- Access group: Configure in entitlements for app + extension\n- Key validation: 43 chars, prefix check, hex validation\n- Error handling: Custom KeychainError enum\n\n## Verification\n- [ ] Unit test: saveAPIKey stores key\n- [ ] Unit test: retrieveAPIKey returns stored key\n- [ ] Unit test: deleteAPIKey removes key\n- [ ] Unit test: hasAPIKey returns correct state\n- [ ] Unit test: isValidAPIKeyFormat validates correctly\n- [ ] Integration test: Share Extension can access stored key\n\n## Parallelization\nCan be worked alongside: Backend auth namespace, ZXing dependency\n\n## Acceptance Criteria\n- AC3: iOS stores key securely in Keychain\n- AC8: Share Extension can access key (via access group)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T14:43:43.925327-06:00","updated_at":"2026-01-03T08:52:55.990561-06:00","closed_at":"2026-01-03T08:52:55.990561-06:00","source_repo":"."}
{"id":"voice-code-security-au2.11","content_hash":"823ffdbe8fd173f5059c6d060026553f249b783262abf54e44480c3cd386a195","title":"Update VoiceCodeClient to include API key in connect","description":"## Design Reference\n@docs/api-key-authentication.md#35-ios-keychain-storage\n\n## Context\nVoiceCodeClient must send API key in connect message and handle auth responses. This integrates KeychainManager with WebSocket communication.\n\n## Requirements\n- [ ] Add apiKey property to VoiceCodeClient\n- [ ] Load API key from KeychainManager on init\n- [ ] Include api_key field in connect message JSON\n- [ ] Handle auth_error message type\n- [ ] Handle auth_version in hello message\n- [ ] Implement exponential backoff for reconnection\n- [ ] Notify delegate/observers on auth failure\n\n## Technical Approach\n- Files to modify: VoiceCode/VoiceCodeClient.swift\n- Connect message: Add \"api_key\": apiKey to JSON\n- Auth error handling: Parse type: \"auth_error\", notify UI\n- Backoff: 1s initial, 30s max, 2x multiplier, +/-25% jitter\n- Store auth_version from hello for future compatibility\n\n## Verification\n- [ ] Unit test: connect message includes api_key\n- [ ] Unit test: auth_error triggers failure callback\n- [ ] Unit test: hello auth_version is parsed\n- [ ] Unit test: exponential backoff timing correct\n- [ ] Integration test: successful auth flow\n- [ ] Integration test: failed auth flow\n\n## Parallelization\nMust wait for: KeychainManager\n\n## Acceptance Criteria\n- AC4: WebSocket connect includes api_key\n- AC5: Auth errors handled gracefully","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T14:44:20.808204-06:00","updated_at":"2026-01-03T09:12:44.901757-06:00","closed_at":"2026-01-03T09:12:44.901757-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-security-au2.11","depends_on_id":"voice-code-security-au2.10","type":"blocks","created_at":"2026-01-02T14:44:20.808727-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-security-au2.12","content_hash":"13dfc14b327f8f1ae20ca3d7c2e380528e9ce4a304ae3bf2a545cd2ba9d6d0e5","title":"Implement QRScannerView for API key scanning","description":"## Design Reference\n@docs/api-key-authentication.md#35-ios-keychain-storage\n\n## Context\nQR scanner enables easy API key transfer from terminal to iOS device. Uses AVFoundation for camera access and validates scanned keys before storage.\n\n## Requirements\n- [ ] Create QRScannerView.swift using AVCaptureSession\n- [ ] Request camera permission with appropriate messaging\n- [ ] Detect QR codes containing API key format\n- [ ] Validate scanned key with isValidAPIKeyFormat\n- [ ] Save valid key via KeychainManager\n- [ ] Provide success/failure feedback to user\n- [ ] Handle camera permission denied state\n\n## Technical Approach\n- Files to create: VoiceCode/Views/QRScannerView.swift\n- Use AVCaptureMetadataOutput for QR detection\n- Filter for .qr metadata object type\n- Validate key format before accepting\n- Dismiss on successful scan or user cancel\n- Show alert for invalid QR codes\n\n## Verification\n- [ ] Unit test: valid QR code accepted\n- [ ] Unit test: invalid QR code rejected with message\n- [ ] Manual test: scan QR from terminal\n- [ ] Manual test: camera permission flow\n- [ ] Manual test: permission denied state\n\n## Parallelization\nCan be worked alongside: AuthenticationRequiredView, APIKeySection\n\n## Acceptance Criteria\n- AC3: iOS scans QR code and stores key\n- AC10: Clear feedback on scan success/failure","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-02T14:44:43.745162-06:00","updated_at":"2026-01-02T14:44:43.745162-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-security-au2.12","depends_on_id":"voice-code-security-au2.10","type":"blocks","created_at":"2026-01-02T14:44:43.745664-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-security-au2.13","content_hash":"a814d5533b2118772006ffc5b1dfcfab081d2a0ad3909e16426a5e8b5d8bd8cc","title":"Create AuthenticationRequiredView for unauthenticated state","description":"## Design Reference\n@docs/api-key-authentication.md#35-ios-keychain-storage\n\n## Context\nShown when app launches without API key or when authentication fails. Provides clear instructions and entry point to QR scanning.\n\n## Requirements\n- [ ] Create AuthenticationRequiredView.swift\n- [ ] Display clear message explaining auth requirement\n- [ ] Show \"Scan QR Code\" button to launch scanner\n- [ ] Show \"Enter Manually\" button for manual entry\n- [ ] Display after auth_error from backend\n- [ ] Integrate with app navigation flow\n\n## Technical Approach\n- Files to create: VoiceCode/Views/AuthenticationRequiredView.swift\n- SwiftUI view with centered content\n- Lock icon or similar visual indicator\n- Instructions text explaining the setup process\n- Two CTAs: Scan QR (primary), Enter Manually (secondary)\n- Navigation to QRScannerView or manual entry\n\n## Verification\n- [ ] Unit test: view renders correctly\n- [ ] Manual test: appears when no API key\n- [ ] Manual test: appears after auth_error\n- [ ] Manual test: navigation to scanner works\n- [ ] Manual test: navigation to manual entry works\n\n## Parallelization\nCan be worked alongside: QRScannerView, APIKeySection\n\n## Acceptance Criteria\n- AC10: Clear error UX when key is missing","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-02T14:44:56.651629-06:00","updated_at":"2026-01-02T14:44:56.651629-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-security-au2.13","depends_on_id":"voice-code-security-au2.10","type":"blocks","created_at":"2026-01-02T14:44:56.652186-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-security-au2.14","content_hash":"f373d0445e3e76258f84e5561b2f22fcd69eceab5e6d5ed163d8513efe1d918c","title":"Create APIKeySection for Settings view","description":"## Design Reference\n@docs/api-key-authentication.md#35-ios-keychain-storage\n\n## Context\nSettings section showing API key status and providing key management actions. Part of the app's settings/preferences screen.\n\n## Requirements\n- [ ] Create APIKeySection.swift view component\n- [ ] Show connection status (authenticated/not)\n- [ ] Show masked key preview (first/last 4 chars)\n- [ ] Provide \"Update Key\" action\n- [ ] Provide \"Delete Key\" action with confirmation\n- [ ] Integrate into existing Settings view\n\n## Technical Approach\n- Files to create: VoiceCode/Views/APIKeySection.swift\n- Files to modify: Settings view to include section\n- Key masking: \"voic...89ab\" format\n- Delete confirmation: Alert with destructive action\n- Update: Navigate to QRScannerView or manual entry\n\n## Verification\n- [ ] Unit test: masked key format correct\n- [ ] Unit test: status displays correctly\n- [ ] Manual test: delete with confirmation\n- [ ] Manual test: update flow works\n\n## Parallelization\nCan be worked alongside: QRScannerView, AuthenticationRequiredView\n\n## Acceptance Criteria\n- AC9: iOS provides key management UI","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T14:45:21.051522-06:00","updated_at":"2026-01-02T14:45:21.051522-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-security-au2.14","depends_on_id":"voice-code-security-au2.10","type":"blocks","created_at":"2026-01-02T14:45:21.052145-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-security-au2.15","content_hash":"ad6f2963ab9b9aea42258bada8f4f4c0727f85ce25f319c140ea2ff730a76bec","title":"Create APIKeyManagementView for manual key entry","description":"## Design Reference\n@docs/api-key-authentication.md#35-ios-keychain-storage\n\n## Context\nFull-screen view for manual API key entry and management. Provides alternative to QR scanning and detailed key information.\n\n## Requirements\n- [ ] Create APIKeyManagementView.swift\n- [ ] Text field for manual key entry\n- [ ] Real-time key format validation\n- [ ] Save button (enabled only for valid keys)\n- [ ] Current key display (masked)\n- [ ] Delete key option\n- [ ] Link to QR scanner as alternative\n\n## Technical Approach\n- Files to create: VoiceCode/Views/APIKeyManagementView.swift\n- TextField with secure entry option\n- Validate on each character change\n- Show validation status (checkmark/x)\n- Format hint showing expected key format\n- Integrate with KeychainManager\n\n## Verification\n- [ ] Unit test: validation feedback works\n- [ ] Unit test: save only enabled for valid keys\n- [ ] Manual test: manual entry flow\n- [ ] Manual test: navigation to QR scanner\n\n## Parallelization\nMust wait for: KeychainManager, QRScannerView\n\n## Acceptance Criteria\n- AC9: iOS provides key management UI","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T14:45:36.252061-06:00","updated_at":"2026-01-02T14:45:36.252061-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-security-au2.15","depends_on_id":"voice-code-security-au2.10","type":"blocks","created_at":"2026-01-02T14:45:36.252628-06:00","created_by":"travisbrown"},{"issue_id":"voice-code-security-au2.15","depends_on_id":"voice-code-security-au2.12","type":"blocks","created_at":"2026-01-02T14:45:36.252938-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-security-au2.16","content_hash":"90ed78cd8c272866cefd4bc9889b12d049e9b819d95a7c7cba2a4c2f70e9b740","title":"Update Share Extension to include Bearer token","description":"## Design Reference\n@docs/api-key-authentication.md#34-http-bearer-authentication\n\n## Context\nShare Extension makes HTTP requests to upload files. Must include Bearer token and handle 401 responses appropriately.\n\n## Requirements\n- [ ] Access API key from Keychain via shared access group\n- [ ] Add Authorization: Bearer header to HTTP requests\n- [ ] Handle 401 Unauthorized response\n- [ ] Show appropriate error message for auth failure\n- [ ] Handle missing API key state gracefully\n\n## Technical Approach\n- Files to modify: ShareExtension/ShareViewController.swift\n- Use KeychainManager with shared access group\n- Header: request.setValue(\"Bearer \\(apiKey)\", forHTTPHeaderField: \"Authorization\")\n- On 401: Show \"Authentication required\" error\n- On missing key: Show \"Please set up API key in main app\"\n\n## Verification\n- [ ] Unit test: Authorization header included\n- [ ] Unit test: 401 response handled\n- [ ] Integration test: successful upload with auth\n- [ ] Manual test: share from other app with valid key\n- [ ] Manual test: share error when no key configured\n\n## Parallelization\nMust wait for: KeychainManager, HTTP Bearer auth\n\n## Acceptance Criteria\n- AC8: Share Extension includes API key in HTTP requests","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-02T14:45:55.639813-06:00","updated_at":"2026-01-02T14:45:55.639813-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-security-au2.16","depends_on_id":"voice-code-security-au2.10","type":"blocks","created_at":"2026-01-02T14:45:55.640333-06:00","created_by":"travisbrown"},{"issue_id":"voice-code-security-au2.16","depends_on_id":"voice-code-security-au2.9","type":"blocks","created_at":"2026-01-02T14:45:55.640651-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-security-au2.17","content_hash":"156b5bfd4d7fc61dd9521e8e5e448d28fd1f16b58d6c43258321707c7cc90eeb","title":"Update STANDARDS.md with authentication protocol","description":"## Design Reference\n@docs/api-key-authentication.md#appendix-a\n\n## Context\nDocumentation must reflect the new authentication fields in the WebSocket protocol. STANDARDS.md is the source of truth for protocol specification.\n\n## Requirements\n- [ ] Add api_key field to connect message documentation\n- [ ] Add auth_error message type documentation\n- [ ] Add auth_version field to hello message documentation\n- [ ] Update message examples to show auth fields\n- [ ] Document Authorization header for HTTP endpoints\n\n## Technical Approach\n- Files to modify: STANDARDS.md\n- Add api_key to Client -\u003e Backend connect message\n- Add auth_error to Backend -\u003e Client message types\n- Add auth_version to hello message fields\n- Add HTTP Authorization header section\n\n## Verification\n- [ ] All new fields documented with examples\n- [ ] Examples match actual implementation\n- [ ] Protocol version noted\n\n## Parallelization\nCan be worked alongside: Any implementation task\n\n## Acceptance Criteria\n- Protocol documentation complete and accurate","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T14:46:25.786254-06:00","updated_at":"2026-01-02T14:46:25.786254-06:00","source_repo":"."}
{"id":"voice-code-security-au2.18","content_hash":"c000d8bf5da99199a993da0d32b39e66feb4a2394a5092901f1d4d559a738b53","title":"End-to-end integration tests for authentication","description":"## Design Reference\n@docs/api-key-authentication.md#5-testing-strategy\n\n## Context\nFinal validation that all authentication components work together. Tests the complete flow from key generation through authenticated communication.\n\n## Requirements\n- [ ] Test: Generate key -\u003e display QR -\u003e scan -\u003e connect -\u003e authenticated\n- [ ] Test: Invalid key rejected at WebSocket connect\n- [ ] Test: Missing key rejected at WebSocket connect\n- [ ] Test: HTTP upload with valid Bearer token succeeds\n- [ ] Test: HTTP upload with invalid Bearer token returns 401\n- [ ] Test: Reconnection maintains authentication\n\n## Technical Approach\n- Backend integration tests in test/voice_code/integration_test.clj\n- iOS UI tests for full flow (if UI testing configured)\n- May require test fixtures for key generation\n- Use dynamic binding for test key file path\n\n## Verification\n- [ ] All integration tests pass\n- [ ] Tests run in CI pipeline\n- [ ] No flaky tests\n\n## Parallelization\nMust wait for: WebSocket auth, HTTP auth, VoiceCodeClient updates\n\n## Acceptance Criteria\n- All acceptance criteria validated end-to-end","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-02T14:46:55.949845-06:00","updated_at":"2026-01-02T14:46:55.949845-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-security-au2.18","depends_on_id":"voice-code-security-au2.8","type":"blocks","created_at":"2026-01-02T14:46:55.950486-06:00","created_by":"travisbrown"},{"issue_id":"voice-code-security-au2.18","depends_on_id":"voice-code-security-au2.9","type":"blocks","created_at":"2026-01-02T14:46:55.950857-06:00","created_by":"travisbrown"},{"issue_id":"voice-code-security-au2.18","depends_on_id":"voice-code-security-au2.11","type":"blocks","created_at":"2026-01-02T14:46:55.951141-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-security-au2.4","content_hash":"ff289f698d52145298cff977c04edfb39846aace0fb80abd8a5c6c34226a7f19","title":"Implement auth namespace with key generation and validation","description":"## Design Reference\n@docs/api-key-authentication.md#3-detailed-design\n\n## Context\nFoundation task for API key authentication. The auth namespace provides all cryptographic operations needed by both WebSocket and HTTP authentication. This must be completed before server integration.\n\n## Requirements\n- [ ] Create backend/src/voice_code/auth.clj namespace\n- [ ] Implement generate-key using SecureRandom for 128-bit entropy\n- [ ] Implement valid-key-format? to validate 43-char key structure\n- [ ] Implement constant-time-equals? to prevent timing attacks\n- [ ] Implement save-key! with chmod 600 file permissions\n- [ ] Implement load-key with nil return for missing file\n- [ ] Implement authenticate combining load and compare\n- [ ] Use dynamic var *key-file-path* for test isolation\n\n## Technical Approach\n- Files to create: backend/src/voice_code/auth.clj\n- Key format: 11-char prefix + 32 lowercase hex chars = 43 chars total\n- Key file location: ~/.voice-code/api-key\n- Use java.security.SecureRandom for entropy\n- Use byte-level XOR accumulation for constant-time comparison\n\n## Verification\n- [ ] Unit test: generate-key produces valid 43-char keys\n- [ ] Unit test: valid-key-format? accepts valid, rejects invalid formats\n- [ ] Unit test: constant-time-equals? returns correct results\n- [ ] Unit test: save-key! creates file with 600 permissions\n- [ ] Unit test: load-key returns nil for missing file\n- [ ] Unit test: authenticate validates correctly\n\n## Parallelization\nCan be worked alongside: Add ZXing dependency, Create KeychainManager\n\n## Acceptance Criteria\n- AC1: Backend generates cryptographically secure 43-char API keys\n- AC5: Invalid keys rejected with timing-attack resistant comparison","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T14:41:08.344469-06:00","updated_at":"2026-01-02T18:29:40.415679-06:00","closed_at":"2026-01-02T18:29:40.415679-06:00","source_repo":"."}
{"id":"voice-code-security-au2.5","content_hash":"51a0719993dea0ee9938aab732692ef3e73f9d7051dfc25f30b7b3aeeb83a15d","title":"Add ZXing dependency to deps.edn","description":"## Design Reference\n@docs/api-key-authentication.md#32-qr-code-display\n\n## Context\nZXing library is required for QR code matrix generation. This is a simple dependency addition that unblocks the QR namespace implementation.\n\n## Requirements\n- [ ] Add com.google.zxing/core to deps.edn\n- [ ] Add com.google.zxing/javase to deps.edn\n- [ ] Verify dependency resolves correctly\n\n## Technical Approach\n- Files to modify: backend/deps.edn\n- Dependencies to add:\n  - com.google.zxing/core {:mvn/version \"3.5.2\"}\n  - com.google.zxing/javase {:mvn/version \"3.5.2\"}\n\n## Verification\n- [ ] Run clj -Stree to verify dependencies resolve\n- [ ] REPL can require com.google.zxing.qrcode.QRCodeWriter\n\n## Parallelization\nCan be worked alongside: Implement auth namespace, Create KeychainManager\n\n## Acceptance Criteria\n- AC2: Supports QR code generation (dependency prerequisite)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T14:41:34.511416-06:00","updated_at":"2026-01-02T18:35:17.675054-06:00","closed_at":"2026-01-02T18:35:17.675054-06:00","source_repo":"."}
{"id":"voice-code-security-au2.6","content_hash":"ecf1f33e3d0378e1406eda6b19a9cba747975db898e6d61671b2119863b25120","title":"Implement QR code namespace for terminal display","description":"## Design Reference\n@docs/api-key-authentication.md#32-qr-code-display\n\n## Context\nQR code display enables easy key transfer from backend to iOS device. Uses ZXing for matrix generation and Unicode block characters for terminal rendering.\n\n## Requirements\n- [ ] Create backend/src/voice_code/qr.clj namespace\n- [ ] Implement generate-qr-matrix using ZXing QRCodeWriter\n- [ ] Implement render-qr-terminal with Unicode block characters\n- [ ] Implement display-setup-qr! with instructions text\n- [ ] Handle error correction level L for QR generation\n\n## Technical Approach\n- Files to create: backend/src/voice_code/qr.clj\n- Dependencies: Requires ZXing (voice-code-security-au2.5)\n- Unicode chars: FULL BLOCK, LOWER HALF, UPPER HALF, SPACE\n- QR size: Let ZXing auto-size based on content\n- Terminal width: Assume 80+ columns\n\n## Verification\n- [ ] Unit test: generate-qr-matrix returns valid matrix\n- [ ] Unit test: render-qr-terminal produces string output\n- [ ] Manual: QR code scannable by iOS camera app\n- [ ] Manual: Instructions clearly visible above QR\n\n## Parallelization\nCan be worked alongside: iOS KeychainManager tasks (after ZXing dep added)\n\n## Acceptance Criteria\n- AC2: Backend displays API key as QR code in terminal","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T14:41:59.390916-06:00","updated_at":"2026-01-02T18:48:08.854493-06:00","closed_at":"2026-01-02T18:48:08.854493-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-security-au2.6","depends_on_id":"voice-code-security-au2.5","type":"blocks","created_at":"2026-01-02T14:41:59.391429-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-security-au2.7","content_hash":"01859be7e4a1201474cc033627c2cb4dc16beedbfc379066e419840258384f13","title":"Add Makefile targets for key generation and QR display","description":"## Design Reference\n@docs/api-key-authentication.md#36-makefile-targets\n\n## Context\nMakefile targets provide user-friendly commands for key management. These are the primary interface for backend operators to generate and display API keys.\n\n## Requirements\n- [ ] Add generate-key target to backend/Makefile\n- [ ] Add show-qr target to backend/Makefile\n- [ ] Ensure targets work from project root\n\n## Technical Approach\n- Files to modify: backend/Makefile\n- generate-key: clj -X:run :command :generate-key\n- show-qr: clj -X:run :command :show-qr\n- May need to add :run alias to deps.edn\n\n## Verification\n- [ ] make generate-key creates ~/.voice-code/api-key\n- [ ] make show-qr displays scannable QR code\n- [ ] Targets fail gracefully if key missing (show-qr)\n\n## Parallelization\nMust wait for: auth namespace, QR namespace\n\n## Acceptance Criteria\n- AC1: Key generation accessible via make target\n- AC2: QR display accessible via make target","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-02T14:42:42.949807-06:00","updated_at":"2026-01-02T14:42:42.949807-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-security-au2.7","depends_on_id":"voice-code-security-au2.4","type":"blocks","created_at":"2026-01-02T14:42:42.950373-06:00","created_by":"travisbrown"},{"issue_id":"voice-code-security-au2.7","depends_on_id":"voice-code-security-au2.6","type":"blocks","created_at":"2026-01-02T14:42:42.950682-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-security-au2.8","content_hash":"9f62684bd4f63426395b8c681f3276b2c28cf59e8dc08531b6bb74ec63347a12","title":"Integrate authentication into WebSocket server","description":"## Design Reference\n@docs/api-key-authentication.md#33-session-based-authentication\n\n## Context\nCore server integration that validates API keys on WebSocket connect and tracks authenticated channels. All subsequent messages are allowed only for authenticated channels.\n\n## Requirements\n- [ ] Add authenticated-channels atom to server namespace\n- [ ] Update hello message to include auth_version: 1\n- [ ] Modify connect handler to extract and validate api_key\n- [ ] Implement auth_error message type\n- [ ] Add channel to authenticated set on successful auth\n- [ ] Remove channel from set on disconnect\n- [ ] Block all messages except connect for unauthenticated channels\n\n## Technical Approach\n- Files to modify: backend/src/voice_code/server.clj\n- New atom: (defonce authenticated-channels (atom #{}))\n- Hello message: Add :auth-version 1 to response\n- Connect handler: Extract :api-key, call auth/authenticate\n- Error response: {:type \"auth_error\" :message \"Authentication failed\"}\n- Use generic error message (no detail about why auth failed)\n\n## Verification\n- [ ] Unit test: hello includes auth_version\n- [ ] Unit test: valid api_key authenticates channel\n- [ ] Unit test: invalid api_key returns auth_error\n- [ ] Unit test: missing api_key returns auth_error\n- [ ] Unit test: unauthenticated channel blocked from prompt\n- [ ] Integration test: full connect flow with auth\n\n## Parallelization\nMust wait for: auth namespace\n\n## Acceptance Criteria\n- AC4: WebSocket validates api_key in connect message\n- AC5: Invalid/missing keys rejected with auth_error\n- AC6: Authentication persists for session lifetime","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T14:43:01.72142-06:00","updated_at":"2026-01-03T08:13:20.567533-06:00","closed_at":"2026-01-03T08:13:20.567533-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-security-au2.8","depends_on_id":"voice-code-security-au2.4","type":"blocks","created_at":"2026-01-02T14:43:01.721997-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-security-au2.9","content_hash":"a566de2f8640a4592fc48720b24b6545bbdca8f01be899880e1ee2f3410fc46c","title":"Add Bearer token authentication to HTTP upload endpoint","description":"## Design Reference\n@docs/api-key-authentication.md#34-http-bearer-authentication\n\n## Context\nHTTP endpoints (file upload) need Bearer token authentication for Share Extension and other HTTP clients. Uses same API key as WebSocket auth.\n\n## Requirements\n- [ ] Extract Authorization header from HTTP requests\n- [ ] Parse Bearer token from header value\n- [ ] Validate token using auth/authenticate\n- [ ] Return 401 Unauthorized for invalid/missing token\n- [ ] Return 401 with generic error message body\n\n## Technical Approach\n- Files to modify: backend/src/voice_code/server.clj (HTTP handler)\n- Header format: Authorization: Bearer \u003capi-key\u003e\n- Parse: (when-let [auth (get-in request [:headers \"authorization\"])]\n           (second (re-matches #\"Bearer (.+)\" auth)))\n- Response: {:status 401 :body \"Unauthorized\"}\n\n## Verification\n- [ ] Unit test: valid Bearer token allows request\n- [ ] Unit test: invalid Bearer token returns 401\n- [ ] Unit test: missing Authorization header returns 401\n- [ ] Unit test: malformed Authorization header returns 401\n- [ ] Integration test: file upload with Bearer token\n\n## Parallelization\nCan be worked alongside: WebSocket auth integration\n\n## Acceptance Criteria\n- AC7: HTTP endpoints validate Bearer token","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T14:43:12.88886-06:00","updated_at":"2026-01-03T08:29:23.677042-06:00","closed_at":"2026-01-03T08:29:23.677042-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-security-au2.9","depends_on_id":"voice-code-security-au2.4","type":"blocks","created_at":"2026-01-02T14:43:12.889424-06:00","created_by":"travisbrown"}]}
