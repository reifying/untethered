{"id":"new-session-worktree-option-1","title":"Add worktree creation option for new sessions","description":"# Feature: Add Worktree Creation Option for New Sessions\n\n## Overview\n\nAdd a checkbox option to the New Session UI that allows users to create a git worktree when creating a new session. This feature integrates git worktree creation, Beads initialization, and Claude Code session initialization into a single automated workflow.\n\n## Background \u0026 Context\n\nVoiceCode is an iOS app for managing Claude Code sessions. Currently, when users create a new session via the \"+\" button, they see NewSessionView (SessionsView.swift:68-111) which allows them to:\n1. Enter a session name\n2. Enter a working directory (optional)\n\nThe new feature adds a worktree option that automates the creation of a git worktree for isolated development work.\n\n### Current Session Creation Flow\n\nNormal sessions:\n1. User creates session in iOS → CoreData placeholder created\n2. User sends first prompt → Backend creates Claude session\n3. Backend syncs session back to iOS via WebSocket\n\n### New Worktree Session Creation Flow\n\nWorktree sessions:\n1. User creates session with worktree checkbox enabled\n2. iOS sends create_worktree_session message to backend with session name and parent directory\n3. Backend (synchronously):\n   - Validates inputs\n   - Creates git worktree\n   - Initializes Beads in worktree\n   - Invokes Claude Code with haiku model\n4. Claude Code creates session on backend (normal session file)\n5. Backend syncs new session to iOS via WebSocket (existing session_created mechanism)\n6. iOS does NOT create CoreData placeholder upfront (waits for backend sync)\n\n## Detailed Design Decisions\n\n### 1. UI Design (iOS - NewSessionView)\n\nChanges to NewSessionView (SessionsView.swift:68-111):\n\n- Add @State private var createWorktree: Bool = false toggle\n- Add Toggle control in Form before \"Session Details\" section\n- Update directory field label/placeholder based on checkbox state:\n  - Unchecked: Label \"Working Directory (Optional)\"\n  - Checked: Label \"Parent Repository Path\" (required), placeholder shows git repo examples\n- When worktree is checked:\n  - Directory field becomes required (validate non-empty)\n  - Validation should confirm it's a valid git repository (backend will do full validation)\n\nRationale: Always showing the directory field (just changing label) is less confusing than hiding/showing fields. Backend does full validation, so iOS only needs basic non-empty check for worktree mode.\n\n### 2. Naming \u0026 Path Conventions\n\nSanitization Rules:\n- Convert to lowercase\n- Replace spaces with hyphens\n- Strip special characters (keep only alphanumeric and hyphens)\n- Example: \"Fix Auth Bug\" → \"fix-auth-bug\"\n\nPath Structure:\n- Parent repo: /Users/travis/code/voice-code\n- Session name: \"Fix Auth Bug\"\n- Project name (from parent path): voice-code\n- Sanitized session name: fix-auth-bug\n- Branch name: fix-auth-bug\n- Worktree directory name: voice-code-fix-auth-bug\n- Worktree path: /Users/travis/code/voice-code-fix-auth-bug (sibling to parent)\n\nRationale:\n- Sibling directories keep worktrees organized and easy to find\n- Including project name in directory prevents collisions across different repos\n- Branch name matches session name for clarity\n- Sanitization ensures valid git branch names and filesystem paths\n\n### 3. WebSocket Protocol\n\nNew Message Type: create_worktree_session\n\niOS → Backend:\n```\n{\n  \"type\": \"create_worktree_session\",\n  \"session_name\": \"Fix Auth Bug\",\n  \"parent_directory\": \"/Users/travis/code/voice-code\"\n}\n```\n\nBackend → iOS (Success):\n```\n{\n  \"type\": \"worktree_session_created\",\n  \"success\": true,\n  \"session_id\": \"abc123de-4567-89ab-cdef-0123456789ab\",\n  \"worktree_path\": \"/Users/travis/code/voice-code-fix-auth-bug\",\n  \"branch_name\": \"fix-auth-bug\"\n}\n```\n\nBackend → iOS (Failure):\n```\n{\n  \"type\": \"worktree_session_error\",\n  \"success\": false,\n  \"error\": \"Detailed error message\",\n  \"error_type\": \"validation_failed|git_failed|beads_failed|claude_failed\",\n  \"details\": {\n    \"step\": \"git_worktree_add|bd_init|claude_invoke\",\n    \"stderr\": \"...\",\n    \"branch_name\": \"...\",\n    \"suggestion\": \"...\"\n  }\n}\n```\n\nRationale:\n- Explicit message type (create_worktree_session) vs. overloading existing types makes intent clear\n- Synchronous error handling (not async) because worktree creation must succeed before proceeding\n- Detailed errors help users understand what went wrong and how to fix it\n- Error types allow iOS to show appropriate UI feedback\n\n### 4. Backend Implementation (Clojure)\n\nLocation: backend/src/voice_code/server.clj - Add new case in handle-message function (line 259)\n\nProcessing Steps (pseudocode):\n\n```\n\"create_worktree_session\"\n(let [session-name (:session-name data)\n      parent-directory (:parent-directory data)]\n  \n  ;; 1. Validate inputs\n  (cond\n    (not session-name)\n    (send-error \"session_name required\")\n    \n    (not parent-directory)\n    (send-error \"parent_directory required\")\n    \n    :else\n    ;; 2. Sanitize and compute paths\n    (let [sanitized-name (sanitize-name session-name)\n          project-name (get-project-name parent-directory)\n          branch-name sanitized-name\n          worktree-dir-name (str project-name \"-\" sanitized-name)\n          worktree-path (str (parent-path parent-directory) \"/\" worktree-dir-name)\n          session-id (str (java.util.UUID/randomUUID))]\n      \n      ;; 3. Validate parent directory\n      (cond\n        (not (.exists (io/file parent-directory)))\n        (send-error \"Directory does not exist\" ...)\n        \n        (not (is-git-repo? parent-directory))\n        (send-error \"Not a git repository\" ...)\n        \n        (.exists (io/file worktree-path))\n        (send-error \"Worktree directory already exists\" ...)\n        \n        (branch-exists? parent-directory branch-name)\n        (send-error \"Branch already exists\" ...)\n        \n        :else\n        ;; 4. Execute worktree creation sequence\n        (try\n          ;; Step 4a: Create git worktree\n          (let [git-result (shell/sh \"git\" \"worktree\" \"add\" \"-b\" branch-name worktree-path \"HEAD\"\n                                     :dir parent-directory)]\n            (when-not (zero? (:exit git-result))\n              (throw (ex-info \"Git worktree creation failed\" \n                             {:stderr (:err git-result)}))))\n          \n          ;; Step 4b: Initialize Beads\n          (let [bd-result (shell/sh \"bd\" \"init\" \"-q\"\n                                    :dir worktree-path)]\n            (when-not (zero? (:exit bd-result))\n              (throw (ex-info \"Beads initialization failed\"\n                             {:stderr (:err bd-result)}))))\n          \n          ;; Step 4c: Invoke Claude Code\n          (let [prompt (format-worktree-prompt session-name worktree-path \n                                              parent-directory branch-name)]\n            (claude/invoke-claude-async\n             prompt\n             (fn [response]\n               (if (:success response)\n                 (send-to-client! channel\n                   {:type :worktree-session-created\n                    :success true\n                    :session-id (:session-id response)\n                    :worktree-path worktree-path\n                    :branch-name branch-name})\n                 (send-to-client! channel\n                   {:type :worktree-session-error\n                    :success false\n                    :error (:error response)\n                    :error-type :claude-failed})))\n             :new-session-id session-id\n             :model \"haiku\"\n             :working-directory worktree-path))\n          \n          (catch Exception e\n            (send-error-with-details e)))))))\n```\n\nHelper Functions Needed:\n\n```\n(defn sanitize-name\n  \"Convert session name to valid branch/directory name.\n  Lowercase, spaces→hyphens, strip special chars.\"\n  [name]\n  (-\u003e name\n      str/lower-case\n      (str/replace #\"\\s+\" \"-\")\n      (str/replace #\"[^a-z0-9-]\" \"\")))\n\n(defn get-project-name\n  \"Extract project name from path. E.g., /Users/.../voice-code → voice-code\"\n  [path]\n  (.getName (io/file path)))\n\n(defn parent-path\n  \"Get parent directory path. E.g., /Users/.../code/voice-code → /Users/.../code\"\n  [path]\n  (.getParent (io/file path)))\n\n(defn is-git-repo?\n  \"Check if directory is a git repository\"\n  [path]\n  (let [result (shell/sh \"git\" \"-C\" path \"rev-parse\" \"--git-dir\")]\n    (zero? (:exit result))))\n\n(defn branch-exists?\n  \"Check if branch already exists in repository\"\n  [repo-path branch-name]\n  (let [result (shell/sh \"git\" \"-C\" repo-path \"rev-parse\" \"--verify\" branch-name)]\n    (zero? (:exit result))))\n\n(defn format-worktree-prompt\n  \"Generate Claude prompt for worktree initialization\"\n  [session-name worktree-path parent-directory branch-name]\n  (format \"You are working in a git worktree named '%s'. This worktree was created at %s from the repository at %s. The branch is '%s'. Don't do anything yet.\"\n          session-name worktree-path parent-directory branch-name))\n```\n\nRationale:\n- Pattern follows existing handle-message structure in server.clj\n- Uses existing shell/sh pattern from claude.clj\n- Validation happens first (fail fast)\n- Each step can fail independently with detailed errors\n- Follows STANDARDS.md: snake_case in JSON, kebab-case in Clojure\n\n### 5. Claude Code Invocation Details\n\nCommand: claude -p --model haiku --session-id {session-id} \"{prompt}\"\n\nFlags:\n- -p: Non-interactive mode (instead of --print)\n- --model haiku: Fast model for initial setup\n- --session-id: New session with specific ID\n- Working directory: Set to worktree path via :dir option in shell/sh\n\nPrompt Template (Option B - Full Context):\n```\nYou are working in a git worktree named '{session_name}'. This worktree was created at {worktree_path} from the repository at {parent_directory}. The branch is '{branch_name}'. Don't do anything yet.\n```\n\nExample:\n```\nYou are working in a git worktree named 'Fix Auth Bug'. This worktree was created at /Users/travis/code/voice-code-fix-auth-bug from the repository at /Users/travis/code/voice-code. The branch is 'fix-auth-bug'. Don't do anything yet.\n```\n\nVisibility: This prompt is visible in conversation history (default behavior, no hiding)\n\nRationale:\n- -p flag is non-interactive (required for programmatic invocation)\n- Haiku is fast and sufficient for simple acknowledgment\n- Full context helps Claude understand the environment\n- Visible prompt provides transparency to user about what was sent\n- \"Don't do anything yet\" prevents Claude from taking actions before user is ready\n\n### 6. Beads Initialization\n\nCommand: bd init -q (run in worktree directory)\n\nFlags:\n- -q: Quiet mode (suppress output)\n\nBehavior:\n- Creates .beads/ directory in worktree\n- Creates database file: .beads/{worktree-dir-name}.db\n- Sets issue prefix to worktree directory name\n- Example: .beads/voice-code-fix-auth-bug.db\n\nRationale:\n- Each worktree gets its own Beads database\n- Quiet mode prevents noise in logs\n- Automatic prefix matches worktree name for clarity\n- This is a REQUIREMENT of the feature (not optional)\n\n### 7. Error Handling \u0026 Validation\n\nValidation Steps (in order):\n\n1. Input validation:\n   - session_name required\n   - parent_directory required\n\n2. Parent directory validation:\n   - Directory exists\n   - Directory is a git repository: git -C {parent-dir} rev-parse --git-dir\n\n3. Path collision checks:\n   - Worktree path doesn't exist\n   - Branch name doesn't exist: git -C {parent-dir} rev-parse --verify {branch-name}\n\nError Response Examples:\n\nNot a git repo:\n```\n{\n  \"type\": \"worktree_session_error\",\n  \"success\": false,\n  \"error\": \"Not a git repository: /Users/travis/code/voice-code\",\n  \"error_type\": \"validation_failed\"\n}\n```\n\nBranch exists:\n```\n{\n  \"type\": \"worktree_session_error\",\n  \"success\": false,\n  \"error\": \"Branch already exists: fix-auth-bug\",\n  \"error_type\": \"validation_failed\",\n  \"details\": {\n    \"branch_name\": \"fix-auth-bug\",\n    \"suggestion\": \"Choose a different session name\"\n  }\n}\n```\n\nWorktree directory exists:\n```\n{\n  \"type\": \"worktree_session_error\",\n  \"success\": false,\n  \"error\": \"Worktree directory already exists: /Users/travis/code/voice-code-fix-auth-bug\",\n  \"error_type\": \"validation_failed\"\n}\n```\n\nGit command failed:\n```\n{\n  \"type\": \"worktree_session_error\",\n  \"success\": false,\n  \"error\": \"Git worktree creation failed: fatal: 'path' already exists\",\n  \"error_type\": \"git_failed\",\n  \"details\": {\n    \"step\": \"git_worktree_add\",\n    \"stderr\": \"fatal: '/Users/travis/code/voice-code-fix-auth-bug' already exists\"\n  }\n}\n```\n\nBeads init failed:\n```\n{\n  \"type\": \"worktree_session_error\",\n  \"success\": false,\n  \"error\": \"Beads initialization failed: Error: .beads directory already exists\",\n  \"error_type\": \"beads_failed\",\n  \"details\": {\n    \"step\": \"bd_init\",\n    \"stderr\": \"Error: .beads directory already exists\"\n  }\n}\n```\n\nClaude invocation failed:\n```\n{\n  \"type\": \"worktree_session_error\",\n  \"success\": false,\n  \"error\": \"Claude CLI invocation failed: ...\",\n  \"error_type\": \"claude_failed\"\n}\n```\n\nRationale:\n- Synchronous errors allow user to fix issues immediately\n- Detailed errors help diagnose problems\n- Error types allow iOS to categorize and display appropriately\n- Including stderr from commands aids debugging\n\n### 8. iOS Session Handling\n\nKey Difference from Normal Sessions:\n\nNormal sessions create CoreData placeholder immediately (DirectoryListView.swift:165-192)\n\nWorktree sessions DO NOT create placeholder:\n- iOS sends create_worktree_session message\n- iOS waits for backend response\n- If success: Session will arrive via session_created WebSocket message (existing mechanism)\n- If failure: Show error alert to user\n- Backend's filesystem watcher detects new Claude session and broadcasts via existing on-session-created callback (server.clj:172-222)\n\nImplementation in DirectoryListView.swift:\n\nAdd new function:\n```\nprivate func createWorktreeSession(name: String, parentDirectory: String) {\n    // Validate inputs\n    guard !name.isEmpty, !parentDirectory.isEmpty else {\n        // Show error\n        return\n    }\n    \n    // Send WebSocket message\n    let message: [String: Any] = [\n        \"type\": \"create_worktree_session\",\n        \"session_name\": name,\n        \"parent_directory\": parentDirectory\n    ]\n    client.sendMessage(message)\n    \n    // Note: Do NOT create CoreData session here\n    // Session will arrive via session_created message when backend completes\n    \n    // Dismiss sheet (or show loading state)\n    showingNewSession = false\n}\n```\n\nModify NewSessionView onCreate handler to call different function based on checkbox state.\n\nRationale:\n- Avoids race conditions between placeholder creation and backend sync\n- Reuses existing session sync mechanism\n- Simpler state management (no placeholder to reconcile)\n- User sees session appear when it's actually ready\n\n### 9. Git Worktree Command Details\n\nCommand: git worktree add -b \u003cbranch-name\u003e \u003cpath\u003e HEAD\n\nParameters:\n- -b \u003cbranch-name\u003e: Create new branch with this name\n- \u003cpath\u003e: Absolute path to worktree directory (sibling to parent)\n- HEAD: Create branch from current HEAD of parent repo\n\nExecution Context:\n- Run in parent repository directory (:dir parent-directory)\n- Creates worktree as sibling directory\n\nExample:\n```\ncd /Users/travis/code/voice-code\ngit worktree add -b fix-auth-bug /Users/travis/code/voice-code-fix-auth-bug HEAD\n```\n\nResult:\n- New directory created: /Users/travis/code/voice-code-fix-auth-bug\n- New branch created: fix-auth-bug (from HEAD)\n- Branch checked out in worktree\n- Worktree linked to parent repository\n\nRationale:\n- -b flag ensures we create a new branch (not reuse existing)\n- HEAD base ensures branch starts from current state of parent\n- Running in parent directory ensures git finds the correct repository\n\n### 10. Testing Considerations\n\nBackend Tests (Clojure):\n\nFile: backend/test/voice_code/worktree_test.clj\n\nTest cases needed:\n1. test-sanitize-name - Verify sanitization rules\n2. test-is-git-repo-valid - Detects valid git repos\n3. test-is-git-repo-invalid - Rejects non-git directories\n4. test-branch-exists-true - Detects existing branches\n5. test-branch-exists-false - Returns false for new branches\n6. test-create-worktree-session-success - Full happy path\n7. test-create-worktree-session-not-git-repo - Validation error\n8. test-create-worktree-session-branch-exists - Branch collision\n9. test-create-worktree-session-dir-exists - Directory collision\n10. test-format-worktree-prompt - Prompt template generation\n\niOS Tests (Swift):\n\nFile: ios/VoiceCodeTests/WorktreeSessionTests.swift\n\nTest cases needed:\n1. testWorktreeCheckboxToggle - UI state changes\n2. testDirectoryFieldRequired - Validation when checkbox enabled\n3. testCreateWorktreeSessionMessage - WebSocket message format\n4. testWorktreeSessionCreatedResponse - Handle success response\n5. testWorktreeSessionErrorResponse - Handle error response\n6. testNoPlaceholderCreated - Verify no CoreData creation\n\nIntegration Tests:\n\nFile: backend/test/voice_code/integration_worktree_test.clj\n\nTest full flow with real git repository:\n1. Create temp git repo\n2. Send create_worktree_session message\n3. Verify worktree directory created\n4. Verify branch created\n5. Verify .beads directory exists\n6. Verify Claude session file created\n7. Verify session synced to iOS\n8. Cleanup worktree\n\nManual Testing Checklist:\n- Create worktree session with valid git repo\n- Verify worktree directory created in correct location\n- Verify branch created from HEAD\n- Verify Beads initialized (.beads/ exists)\n- Verify Claude session appears in iOS\n- Verify initial prompt visible in conversation\n- Test error: non-existent directory\n- Test error: non-git repository\n- Test error: branch already exists\n- Test error: worktree directory already exists\n- Verify error messages are clear and actionable\n\n### 11. Standards Compliance\n\nNaming Conventions (from STANDARDS.md):\n\n- JSON keys: snake_case (e.g., session_name, parent_directory)\n- Clojure keywords: kebab-case (e.g., :session-name, :parent-directory)\n- Swift properties: camelCase (e.g., sessionName, parentDirectory)\n- UUIDs: Always lowercase (e.g., abc123de-4567-89ab-cdef-0123456789ab)\n\nKey Conversion:\n- Parse JSON → Clojure: Use existing parse-json with snake-\u003ekebab (server.clj:37-40)\n- Generate Clojure → JSON: Use existing generate-json with kebab-\u003esnake (server.clj:42-45)\n- iOS: Map camelCase ↔ snake_case at boundary\n\nExample:\n```\n// iOS\nlet message: [String: Any] = [\n    \"type\": \"create_worktree_session\",\n    \"session_name\": name,  // snake_case\n    \"parent_directory\": dir\n]\n\n// Backend receives\n{:type \"create_worktree_session\"\n :session-name \"Fix Auth Bug\"  ; kebab-case keyword\n :parent-directory \"/Users/...\"}\n```\n\n### 12. Implementation Checklist\n\nPhase 1: Backend Core Logic\n- Add helper functions to voice_code/worktree.clj:\n  - sanitize-name\n  - get-project-name\n  - parent-path\n  - is-git-repo?\n  - branch-exists?\n  - format-worktree-prompt\n  - create-worktree! (main orchestration)\n- Add unit tests for all helper functions\n- Add integration test for full worktree creation flow\n\nPhase 2: Backend WebSocket Handler\n- Add \"create_worktree_session\" case to handle-message in server.clj\n- Implement synchronous error handling with detailed responses\n- Add tests for message handling\n\nPhase 3: iOS UI Changes\n- Add worktree checkbox to NewSessionView\n- Add conditional directory field label/placeholder\n- Add directory required validation when checkbox enabled\n- Update DirectoryListView to call new creation function based on checkbox\n- Add createWorktreeSession function (no CoreData placeholder)\n- Add UI tests for worktree option\n\nPhase 4: iOS WebSocket Handling\n- Add handler for worktree_session_created message type in VoiceCodeClient.swift\n- Add handler for worktree_session_error message type\n- Add error alert display in UI\n- Add tests for message handling\n\nPhase 5: Integration \u0026 Testing\n- Test full flow: iOS → Backend → Git → Beads → Claude → Session Sync\n- Test all error scenarios\n- Manual testing with real repositories\n- Update documentation\n\nPhase 6: Documentation\n- Update STANDARDS.md with worktree session protocol\n- Add worktree session section to WebSocket Protocol docs\n- Add usage examples and troubleshooting guide\n\n### 13. Related Code Locations\n\niOS:\n- ios/VoiceCode/Views/SessionsView.swift:68-111 - NewSessionView component\n- ios/VoiceCode/Views/DirectoryListView.swift:165-192 - createNewSession function\n- ios/VoiceCode/Views/SessionsForDirectoryView.swift:147-174 - Similar creation function\n- ios/VoiceCode/Managers/VoiceCodeClient.swift - WebSocket message handling\n\nBackend:\n- backend/src/voice_code/server.clj:259-546 - handle-message function\n- backend/src/voice_code/claude.clj:27-88 - invoke-claude function\n- backend/src/voice_code/claude.clj:90-135 - invoke-claude-async function\n\nReference Examples:\n- Session locking: backend/src/voice_code/server.clj:420-474 - Shows async Claude invocation pattern\n- Compact session: backend/src/voice_code/server.clj:494-531 - Shows shell command invocation pattern\n- Git operations: Use pattern from claude.clj:53 for shell/sh\n\n### 14. Assumptions \u0026 Dependencies\n\nAssumptions:\n- Git is installed and available in PATH\n- Beads (bd) is installed and available in PATH\n- Claude CLI is installed (existing assumption)\n- Parent repository exists and user has write permissions\n- User understands git worktree concepts (or we provide help text)\n\nDependencies:\n- No new library dependencies required\n- Uses existing: clojure.java.shell, clojure.java.io\n- Uses existing WebSocket infrastructure\n- Uses existing session sync mechanism\n\nEnvironment:\n- Backend runs on macOS/Linux (git and bd available)\n- iOS app connects to backend via WebSocket\n- File system supports sibling directory creation\n\n### 15. Future Enhancements (Out of Scope)\n\nNot included in this initial implementation:\n- Worktree deletion when session deleted (manual cleanup required)\n- List existing worktrees in UI\n- Switch between worktrees\n- Merge worktree changes back to main\n- Worktree status indicators\n- Custom branch base (always uses HEAD for now)\n- Worktree path customization (always sibling for now)\n\n### 16. Success Criteria\n\nFeature is complete when:\n1. User can create new session with worktree checkbox\n2. Backend creates git worktree in correct location\n3. Backend initializes Beads in worktree\n4. Backend invokes Claude with haiku model\n5. Session appears in iOS without manual placeholder creation\n6. Initial prompt visible in conversation history\n7. All error cases handled with clear messages\n8. All tests passing (unit + integration)\n9. Documentation updated\n\n### 17. Non-Functional Requirements\n\nPerformance:\n- Worktree creation should complete within 5 seconds (excluding Claude response)\n- UI should show loading state during creation\n- Errors should return within 1 second\n\nReliability:\n- Failed worktree creation should not leave partial state (cleanup on error)\n- Failed Beads init should not prevent retry\n- Backend should log all steps for debugging\n\nUsability:\n- Error messages should be actionable (tell user what to fix)\n- Directory field placeholder should show example git repo paths\n- Checkbox label should clearly indicate \"Git Worktree\" feature\n\nSecurity:\n- Validate all paths (no path traversal)\n- Sanitize session names (prevent command injection)\n- Run git commands with explicit paths (no shell expansion)","status":"open","priority":1,"issue_type":"feature","created_at":"2025-10-26T15:43:40.348474-05:00","updated_at":"2025-10-26T15:43:40.348474-05:00"}
{"id":"voice-code-100","title":"Test deletion workflow","description":"Test session deletion on iOS stops replication.\n\nSteps:\n1. iOS has session subscribed\n2. User swipes to delete session\n3. iOS sends session_deleted message\n4. Verify backend stops sending updates to that iOS client\n5. Verify backend .jsonl file still exists\n6. Verify other iOS clients still receive updates\n7. Create new prompt from terminal in deleted session\n8. Verify first iOS client does NOT receive update\n9. Verify other clients DO receive update","acceptance_criteria":"Deletion stops replication for that client only, backend file remains, other clients unaffected, updates filtered correctly","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.477551-05:00","updated_at":"2025-10-26T01:01:31.477551-05:00","closed_at":"2025-10-22T18:28:23.715744-05:00","dependencies":[{"issue_id":"voice-code-100","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.699407-05:00","created_by":"auto-import"}]}
{"id":"voice-code-101","title":"Performance testing","description":"Test performance with 1000+ sessions.\n\nTests:\n1. Index build time with 1000+ .jsonl files\n2. Measure session_list send time (should be \u003c2s)\n3. Measure per-session load time (should be \u003c200ms)\n4. Verify file watching overhead with 10 subscriptions (\u003c5% CPU)\n5. Memory usage with 1000 sessions in index (~10MB)\n6. Test pagination in iOS (20 sessions/page loads quickly)\n7. Test incremental updates (new message appears \u003c1s after terminal prompt)","acceptance_criteria":"All performance targets met, system scales to 1000+ sessions, no degradation with active watching, memory usage acceptable","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.478464-05:00","updated_at":"2025-10-26T01:01:31.478464-05:00","closed_at":"2025-10-22T18:28:23.71588-05:00","dependencies":[{"issue_id":"voice-code-101","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.700105-05:00","created_by":"auto-import"}]}
{"id":"voice-code-102","title":"Create manual test infrastructure","description":"","design":"Create Clojure-based manual test infrastructure in manual_test/ directory:\n- manual_test/voice_code/fixtures.clj - Shared fixtures (start/stop server, etc.)\n- manual_test/voice_code/websocket_client.clj - WebSocket client helper using http-kit\n- manual_test/voice_code/test_*.clj - Individual test files\n- Makefile with targets: test-manual-startup, test-manual-protocol, etc.\n- deps.edn :manual-test alias with manual_test as extra path\n\nTests in manual_test/ can invoke Claude CLI (cost money) while regular tests in test/ are free.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-26T01:01:31.478863-05:00","updated_at":"2025-10-26T01:01:31.478863-05:00","closed_at":"2025-10-17T16:52:28.05795-05:00"}
{"id":"voice-code-103","title":"Manual test: Backend startup and session discovery","description":"","acceptance_criteria":"Server starts successfully, session index loads from disk with correct count, filesystem watcher initializes watching all project subdirectories. File: manual_test/voice_code/test_03_startup.clj. Free to run (no Claude invocations).","notes":"✅ PASSED - All assertions passed. Tests session discovery, metadata extraction, and index persistence.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-26T01:01:31.479245-05:00","updated_at":"2025-10-26T01:01:31.479245-05:00","closed_at":"2025-10-17T16:36:22.472262-05:00","dependencies":[{"issue_id":"voice-code-103","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-26T01:01:31.700819-05:00","created_by":"auto-import"}]}
{"id":"voice-code-104","title":"Manual test: WebSocket protocol (connect, subscribe, ping)","description":"","acceptance_criteria":"Connect without session_id returns session-list message. Subscribe returns session-history. Ping returns pong. File: manual_test/voice_code/test_04_protocol.clj. Free to run.","notes":"✅ PASSED (after fixes) - Tests ping/pong, connect→session-list, subscribe→session-history. Fixed to expect session-list instead of old 'connected' message.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-26T01:01:31.4798-05:00","updated_at":"2025-10-26T01:01:31.4798-05:00","closed_at":"2025-10-17T16:36:22.472499-05:00","dependencies":[{"issue_id":"voice-code-104","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-26T01:01:31.701384-05:00","created_by":"auto-import"}]}
{"id":"voice-code-105","title":"Manual test: Filesystem watcher (new sessions and updates)","description":"","acceptance_criteria":"Watcher detects new .jsonl file creation, broadcasts session-created message within 2 seconds, metadata includes all fields. File: manual_test/voice_code/test_05_watcher_new.clj. COSTS MONEY (invokes Claude CLI).","notes":"⚠️ RUNS BUT FAILS (~$0.15 spent) - Claude CLI successfully creates sessions, but filesystem watcher doesn't detect new .jsonl files. No session_created/session_updated broadcasts received. Root cause: Watcher not adding new sessions to index in real-time.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-26T01:01:31.480157-05:00","updated_at":"2025-10-26T01:01:31.480157-05:00","closed_at":"2025-10-17T16:38:32.889948-05:00","dependencies":[{"issue_id":"voice-code-105","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-26T01:01:31.701895-05:00","created_by":"auto-import"}]}
{"id":"voice-code-106","title":"Manual test: Prompt sending with new_session_id","description":"","acceptance_criteria":"Prompt with new_session_id creates new Claude session, returns ack then response, .jsonl file created with correct session_id, session-created broadcast sent. File: manual_test/voice_code/test_06_prompt_new.clj. COSTS MONEY.","notes":"✅ PASSED (~$0.05 spent) - Creates new Claude session via WebSocket with new_session_id. Verifies .jsonl file creation and proper session ID handling.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-26T01:01:31.480517-05:00","updated_at":"2025-10-26T01:01:31.480517-05:00","closed_at":"2025-10-17T16:38:32.890207-05:00","dependencies":[{"issue_id":"voice-code-106","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-26T01:01:31.702792-05:00","created_by":"auto-import"},{"issue_id":"voice-code-106","depends_on_id":"voice-code-111","type":"blocks","created_at":"2025-10-26T01:01:31.703493-05:00","created_by":"auto-import"}]}
{"id":"voice-code-107","title":"Manual test: Prompt sending with resume_session_id","description":"","acceptance_criteria":"Prompt with resume_session_id appends to existing session, maintains conversation context, .jsonl file appended not recreated, session-updated broadcast if subscribed. File: manual_test/voice_code/test_07_prompt_resume.clj. COSTS MONEY.","notes":"✅ PASSED (~$0.10 spent, after fixes) - Tests resume_session_id maintains context. Claude correctly remembered number 42. Fixed kebab-case field names and project folder detection. Verifies .jsonl file appended not recreated.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-26T01:01:31.480932-05:00","updated_at":"2025-10-26T01:01:31.480932-05:00","closed_at":"2025-10-17T16:38:32.890329-05:00","dependencies":[{"issue_id":"voice-code-107","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-26T01:01:31.704072-05:00","created_by":"auto-import"},{"issue_id":"voice-code-107","depends_on_id":"voice-code-111","type":"blocks","created_at":"2025-10-26T01:01:31.704684-05:00","created_by":"auto-import"}]}
{"id":"voice-code-108","title":"Manual test: Multi-client broadcast","description":"","acceptance_criteria":"Multiple WebSocket clients receive same session-created broadcast, messages identical across clients, broadcast timing within 200ms. File: manual_test/voice_code/test_08_broadcast.clj. Free to run.","notes":"❌ FAILED - Fixture issue (session ID nil) + expects non-existent protocol messages. Needs same fixture fix as test 05 + protocol expectations rewrite.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-26T01:01:31.481372-05:00","updated_at":"2025-10-26T01:01:31.481372-05:00","closed_at":"2025-10-17T16:36:22.472804-05:00","dependencies":[{"issue_id":"voice-code-108","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-26T01:01:31.705354-05:00","created_by":"auto-import"},{"issue_id":"voice-code-108","depends_on_id":"voice-code-111","type":"blocks","created_at":"2025-10-26T01:01:31.706176-05:00","created_by":"auto-import"}]}
{"id":"voice-code-109","title":"Manual test: Error handling","description":"","acceptance_criteria":"Invalid JSON handled gracefully, unknown message types return error, missing required fields return descriptive errors, connection stays open after errors. File: manual_test/voice_code/test_09_errors.clj. Free to run.","notes":"⚠️ PARTIAL (4/6 passing) - Tests 07a-07d pass (prompt before connect, invalid type, missing fields). Tests 07e-07f fail (non-existent resume_session_id, conflicting session IDs). Edge case error handling needs adjustment.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-26T01:01:31.481769-05:00","updated_at":"2025-10-26T01:01:31.481769-05:00","closed_at":"2025-10-17T16:36:22.47291-05:00","dependencies":[{"issue_id":"voice-code-109","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-26T01:01:31.707011-05:00","created_by":"auto-import"}]}
{"id":"voice-code-110","title":"Fix WebSocket protocol mismatch in session list response","description":"Test 02 expects 'session-list' message type after connect, but server sends different format. Need to either update server to send session-list message type per STANDARDS.md, or update STANDARDS.md and tests to match actual implementation. Test failure location: backend/manual_test/tests/02_protocol_test.clj:54-56","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-26T01:01:31.482131-05:00","updated_at":"2025-10-26T01:01:31.482131-05:00","closed_at":"2025-10-17T15:15:11.816026-05:00"}
{"id":"voice-code-111","title":"Fix Test 07 error: test expects 'connected' message but not receiving it","description":"Test 07 (error handling) sub-test 'test-error-both-new-and-resume-session-id' fails with 'Expected message not received: Connected'. The test expects a 'connected' confirmation after connect message, but isn't receiving it. Need to investigate if this is a test issue or server protocol issue. Location: backend/manual_test/tests/07_error_test.clj:193","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-26T01:01:31.482486-05:00","updated_at":"2025-10-26T01:01:31.482486-05:00","closed_at":"2025-10-17T17:32:16.754825-05:00"}
{"id":"voice-code-112","title":"Test 02 subscribe test needs sessions to validate","description":"The subscribe test in Test 02 was skipped because no sessions were available to subscribe to. Need to either: 1) Pre-populate test sessions before running the test, or 2) Make the test create its own session to subscribe to, or 3) Document that this test requires existing sessions. Location: backend/manual_test/tests/02_protocol_test.clj (subscribe test)","notes":"Root cause identified: WebSocket client cannot receive large payloads even with 20 messages. Server successfully sends session-history (logs confirm) but client times out waiting. Solutions: 1) Further reduce to 5-10 messages, 2) Implement pagination, 3) Investigate WebSocket frame size limits. Status: 4/5 protocol tests pass, only subscribe test fails.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.482856-05:00","updated_at":"2025-10-26T01:01:31.482856-05:00","closed_at":"2025-10-17T17:33:33.350163-05:00"}
{"id":"voice-code-113","title":"Backend optimizations for WebSocket payload size limits","description":"Changes made during manual testing: 1) Limited session-list to 50 most recent sessions (was 663), 2) Limited session-history to 20 most recent messages (was full history), 3) Added validation to reject prompts with both new_session_id and resume_session_id, 4) Changed connect response to send session-list. These prevent WebSocket frame size issues.","acceptance_criteria":"Session list limited to reasonable size, session history limited, validation prevents conflicting parameters","status":"closed","priority":2,"issue_type":"task","assignee":"backend","created_at":"2025-10-26T01:01:31.483208-05:00","updated_at":"2025-10-26T01:01:31.483208-05:00","closed_at":"2025-10-17T17:33:11.260537-05:00"}
{"id":"voice-code-114","title":"Filesystem watcher doesn't detect new Claude sessions","description":"Test 03 revealed that when Claude CLI creates new .jsonl files, the filesystem watcher doesn't detect them or broadcast session_created/session_updated messages.\n\nRoot cause: Watcher not adding new sessions to index in real-time.\n\nSteps to reproduce:\n1. Start backend server\n2. Connect WebSocket client\n3. Create new Claude session via CLI with --session-id \u003cuuid\u003e\n4. Expected: Receive session_created broadcast\n5. Actual: No broadcast received, 'Session not found' when trying to subscribe\n\nFiles involved:\n- backend/src/voice_code/replication.clj (watcher implementation)\n- backend/manual_test/tests/03_watcher_test.clj (test that fails)\n\nImpact: Terminal→iOS sync completely broken. Sessions created from terminal won't appear on iOS.","status":"closed","priority":0,"issue_type":"bug","assignee":"backend","created_at":"2025-10-26T01:01:31.483563-05:00","updated_at":"2025-10-26T01:01:31.483563-05:00","closed_at":"2025-10-17T15:06:23.026154-05:00"}
{"id":"voice-code-115","title":"Test 06 (broadcast) needs fixture and protocol fixes","description":"Test 06 fails due to:\n1. Fixture not running (session ID is nil) - same issue as test 05 had\n2. Test expects protocol messages that don't exist\n\nNeeds:\n- Apply same fixture fix as test 05 (call setup in -main)\n- Update protocol expectations to match actual server behavior\n\nFile: backend/manual_test/tests/06_broadcast_test.clj","status":"closed","priority":2,"issue_type":"bug","assignee":"backend","created_at":"2025-10-26T01:01:31.483908-05:00","updated_at":"2025-10-26T01:01:31.483908-05:00","closed_at":"2025-10-17T17:15:16.8605-05:00"}
{"id":"voice-code-116","title":"Test 07 edge cases fail (07e, 07f)","description":"Test 07 has 4/6 tests passing. Edge case tests fail:\n\n07e (non-existent resume_session_id): \n- Server may handle this differently than expected\n- Need to verify error response format\n\n07f (both new_session_id and resume_session_id):\n- Server correctly validates mutually exclusive params\n- Error message not reaching client properly\n\nFile: backend/manual_test/tests/07_error_test.clj\n\nMay need to adjust server error responses or test expectations.","status":"closed","priority":2,"issue_type":"bug","assignee":"backend","created_at":"2025-10-26T01:01:31.484501-05:00","updated_at":"2025-10-26T01:01:31.484501-05:00","closed_at":"2025-10-17T17:08:07.593609-05:00"}
{"id":"voice-code-117","title":"Session Replication Architecture","description":"Complete implementation of session replication architecture from REPLICATION_ARCHITECTURE.md.\n\nThis epic tracks the migration from iOS session UUID mapping to a unified session replication system where all Claude Code sessions (terminal and iOS) sync to iOS devices via filesystem watching and WebSocket broadcasts.\n\n## Architecture Overview\n- Backend watches ~/.claude/projects for .jsonl files\n- Maintains fast in-memory metadata index\n- Broadcasts session_created/session_updated to all iOS clients\n- iOS stores sessions in CoreData with lazy loading\n- Optimistic UI for instant feedback\n- Client-side filtering for deletion/renaming\n\n## Phases\n**Phase 1: Backend (COMPLETE)** - voice-code-74 through voice-code-86\n- Metadata index system ✓\n- Filesystem watcher ✓\n- Protocol handlers ✓\n- Session naming ✓\n- Manual tests ✓\n\n**Phase 2: iOS (IN PROGRESS)** - voice-code-87 through voice-code-96\n- CoreData schema\n- Session metadata sync\n- Lazy loading\n- Incremental updates\n- Optimistic UI\n- Prompt sending\n- Deletion/renaming\n\n**Phase 3: Testing** - voice-code-141 through voice-code-101\n- Terminal to iOS sync\n- iOS to iOS sync\n- Session forking\n- Deletion workflow\n- Performance testing\n\n## References\n- REPLICATION_ARCHITECTURE.md\n- STANDARDS.md (WebSocket protocol)","acceptance_criteria":"All replication tasks complete (74-101), backend fully tested, iOS implementation complete, end-to-end workflows validated, performance targets met","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-10-26T01:01:31.48489-05:00","updated_at":"2025-10-26T01:01:31.48489-05:00","closed_at":"2025-10-22T18:28:23.711011-05:00"}
{"id":"voice-code-118","title":"Consolidate backend Makefile into root Makefile","description":"The project has two Makefiles: root (iOS tests) and backend/ (Clojure tests). Consolidate into single root Makefile with sections for iOS and backend. Use 'cd backend \u0026\u0026' for backend targets. Maintain all existing targets from both files.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.48526-05:00","updated_at":"2025-10-26T01:01:31.48526-05:00","closed_at":"2025-10-23T19:10:05.304641-05:00"}
{"id":"voice-code-119","title":"Connection status not refreshed after saving server settings","description":"When configuring server settings for the first time, Test Connection works successfully, but after clicking Save, the app still shows 'disconnected'. The real connection should be refreshed/attempted after saving settings.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.485593-05:00","updated_at":"2025-10-26T01:01:31.485593-05:00","closed_at":"2025-10-18T17:23:33.678411-05:00"}
{"id":"voice-code-120","title":"Backend sends session_updated with 0 messages after filtering warmup","description":"The handle-file-modified function in replication.clj checks if new-messages is non-empty BEFORE filtering sidechain messages. This causes session_updated messages with empty message arrays to be sent to iOS clients when only warmup messages were added.\n\nBug location: backend/src/voice_code/replication.clj handle-file-modified function\n\nFix: Move the (when (seq new-messages)) check to AFTER (filter-sidechain-messages new-messages)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-26T01:01:31.486139-05:00","updated_at":"2025-10-26T01:01:31.486139-05:00","closed_at":"2025-10-18T02:46:48.636877-05:00"}
{"id":"voice-code-121","title":"Backend re-sends all messages instead of just new ones on session creation","description":"When handle-file-created detects a new session, it doesn't initialize the file-positions atom for that session. This causes subsequent handle-file-modified calls to re-parse the entire file from the beginning, re-sending all messages instead of just new ones.\n\nEvidence: Triple reconciliation in logs (lines 86-88 of console.out) shows all messages being reconciled again after new session creation.\n\nBug location: backend/src/voice_code/replication.clj handle-file-created function\n\nFix: Initialize file-positions when creating session metadata in handle-file-created","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-26T01:01:31.48666-05:00","updated_at":"2025-10-26T01:01:31.48666-05:00","closed_at":"2025-10-18T02:46:48.637472-05:00"}
{"id":"voice-code-122","title":"Backend includes non-UUID .jsonl files in session list","description":"The extract-session-id-from-path function in replication.clj accepts any .jsonl filename as a valid session ID without validating that it's a UUID. This causes 'Invalid or missing session_id in session data' warnings in iOS when non-UUID .jsonl files exist in Claude projects.\n\nEvidence: Line 8 of console.out shows iOS warning about invalid session_id\n\nBug location: backend/src/voice_code/replication.clj extract-session-id-from-path function\n\nFix: Add UUID validation to extract-session-id-from-path and filter out invalid sessions","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-26T01:01:31.487206-05:00","updated_at":"2025-10-26T01:01:31.487206-05:00","closed_at":"2025-10-18T02:46:48.637907-05:00"}
{"id":"voice-code-123","title":"iOS subscribes twice when creating new session","description":"When creating a new session from SessionsView, the app subscribes to the session in two places:\n1. SessionsView.swift:125 - when sending the prompt that creates the session\n2. ConversationView.swift:151 - when the view appears after navigation\n\nThis causes duplicate 'Client subscribing to session' log entries and duplicate optimistic message creation (though messages don't duplicate in UI).\n\nEvidence: Lines 24-27 and 48-49 in console.out show double subscription and double optimistic message creation\n\nBug locations:\n- ios/VoiceCode/Views/SessionsView.swift:125\n- ios/VoiceCode/Views/ConversationView.swift:151\n\nFix: Remove one of the subscribe calls (likely the one in SessionsView since ConversationView should handle subscription)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-26T01:01:31.48754-05:00","updated_at":"2025-10-26T01:01:31.48754-05:00","closed_at":"2025-10-18T02:46:48.638185-05:00"}
{"id":"voice-code-124","title":"Existing sessions not loading - only new UI sessions populate","description":"When the app starts, existing Claude Code sessions from the filesystem are not appearing in the session list. Only newly created sessions from the iOS UI are showing up.\n\nExpected behavior: On app launch, the backend should send session_list with all existing .jsonl files from ~/.claude/projects, and iOS should display them in the SessionsView.\n\nActual behavior: Session list appears empty or only shows sessions created after the app was opened.\n\nThis blocks the ability to resume existing conversations and makes the app appear to lose history.\n\nRelated: This makes voice-code-123 (double subscription) harder to notice, since long-press to open sessions doesn't work if sessions aren't loaded.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-26T01:01:31.487938-05:00","updated_at":"2025-10-26T01:01:31.487938-05:00","closed_at":"2025-10-18T02:46:48.639015-05:00"}
{"id":"voice-code-125","title":"Session list interaction is not intuitive - tap vs long-press unclear","description":"The SessionsView interaction model is confusing and doesn't follow iOS conventions:\n\nCurrent behavior:\n- Tapping a session highlights it and shows a checkmark\n- Nothing material happens after the tap\n- Requires long-press to open the session (but this is broken per voice-code-124)\n- The checkbox appears to serve no clear function\n\nExpected behavior (choose one approach):\n\nOption A - Single tap opens session:\n- Tap a session → immediately navigate to ConversationView\n- Remove checkbox UI entirely\n- This matches standard iOS list behavior (Settings, Mail, Messages, etc.)\n\nOption B - Checkbox has real function:\n- Keep checkbox for multi-select (e.g., bulk delete, bulk operations)\n- Add a visible action button or toolbar when sessions are selected\n- Require explicit 'Open' button or different gesture to open a single session\n\nRecommendation: Option A is more intuitive. iOS users expect a single tap on a list item to open it. Checkboxes should only appear during explicit 'Edit' or 'Select' modes.\n\nFiles involved:\n- ios/VoiceCode/Views/SessionsView.swift\n- Session list UI implementation","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-26T01:01:31.488448-05:00","updated_at":"2025-10-26T01:01:31.488448-05:00","closed_at":"2025-10-18T02:46:48.639412-05:00"}
{"id":"voice-code-126","title":"Stale session index causes existing sessions not to load messages","description":"The initialize-index! function loads a cached session index from disk without validating it against the filesystem. When the cached index is stale (e.g., from a test run), iOS receives an outdated session list and cannot load messages from existing sessions.\n\nBug: Backend loaded index with 1 test session from /var/folders/temp, but filesystem had 712 real sessions.\nImpact: iOS showed sessions in list but couldn't load their messages (Session not found warnings in backend logs).\nFix: Added validate-index function that checks index count against filesystem and validates sample files exist. Index is rebuilt if validation fails.\nTest coverage: Added test-validate-index with 5 test cases covering all validation scenarios.\nTests passing: 70 tests, 371 assertions, 0 failures.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.488855-05:00","updated_at":"2025-10-26T01:01:31.488855-05:00","closed_at":"2025-10-18T08:50:36.180332-05:00"}
{"id":"voice-code-127","title":"Case-sensitive session lookup prevents iOS sessions from loading","description":"iOS sends uppercase UUIDs (e.g., 6F362136-EF8D-48FB-87C4-82AC582A2618) but backend files use lowercase (e.g., 6f362136-ef8d-48fb-87c4-82ac582a2618.jsonl). Session lookups in get-session-metadata, subscribe-to-session!, unsubscribe-from-session!, and is-subscribed? were case-sensitive, causing Session not found errors.\n\nRoot cause: iOS generates UUIDs via UUID().uuidString which uses uppercase hex digits. Claude CLI uses lowercase. The session-index map keys are lowercase (from filenames) but lookups did not normalize the input session-id.\n\nFix: Modified 4 functions in replication.clj to normalize session-id to lowercase using str/lower-case before lookups or set operations.\n\nTest coverage: Added test-case-insensitive-session-operations with 4 test scenarios covering all case combinations.\n\nBug locations: backend/src/voice_code/replication.clj and backend/test/voice_code/replication_test.clj\n\nTests passing: 71 tests, 388 assertions, 0 failures.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.48921-05:00","updated_at":"2025-10-26T01:01:31.48921-05:00","closed_at":"2025-10-18T09:06:59.507565-05:00"}
{"id":"voice-code-128","title":"Backend: Index keys are uppercase but lookups use lowercase","description":"Case-sensitivity mismatch in session index. Index is built with uppercase UUID keys from filenames, but get-session-metadata normalizes to lowercase for lookups. This causes sessions with uppercase UUIDs (from iOS) to appear missing even though they exist on disk.\n\nRoot cause: build-index! in replication.clj:175-195 uses session-id as-is from filename (uppercase), but get-session-metadata:279-282 normalizes to lowercase.\n\nFix: Normalize session-id to lowercase in build-index! before using as map key: (assoc acc (str/lower-case session-id) metadata)\n\nImpact: ~11+ sessions with uppercase UUIDs cannot be found via lookup despite being in the index.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.489636-05:00","updated_at":"2025-10-26T01:03:30.960191-05:00","closed_at":"2025-10-26T01:03:30.960191-05:00"}
{"id":"voice-code-129","title":"Delete SessionManagerTests.swift (tests deleted SessionManager)","description":"SessionManagerTests.swift (208 lines, 14 tests) tests the SessionManager class that was deleted in commit 0ae654a during the architecture consolidation.\n\nSince SessionManager no longer exists (replaced by CoreData CDSession), these tests are obsolete and should be deleted.\n\nFile: ios/VoiceCodeTests/SessionManagerTests.swift\n\nContext: We consolidated the app to use CoreData exclusively, removing the old in-memory SessionManager and Session models.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.490063-05:00","updated_at":"2025-10-26T01:01:31.490063-05:00","closed_at":"2025-10-18T12:21:49.847435-05:00"}
{"id":"voice-code-13","title":"Fix backend issues discovered in testing","description":"","status":"closed","priority":2,"issue_type":"task","assignee":"backend","created_at":"2025-10-26T01:01:31.490435-05:00","updated_at":"2025-10-26T01:01:31.490435-05:00","closed_at":"2025-10-23T19:10:14.16368-05:00"}
{"id":"voice-code-130","title":"Clean up ModelTests.swift (remove Session tests, keep Message tests)","description":"ModelTests.swift (153 lines, 9 tests) tests both Message and Session models.\n\nKeep: Message tests - Message struct is still used as a DTO for WebSocket communication\nRemove: Session tests - Session struct was deleted in commit 0ae654a (replaced by CDSession)\n\nSession-related tests to remove:\n- testSessionCreation\n- testSessionAddMessage  \n- testSessionUpdateClaudeSessionId\n- testSessionCodable\n\nMessage tests are still valid since Message is used by VoiceCodeClient.\n\nFile: ios/VoiceCodeTests/ModelTests.swift","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.490868-05:00","updated_at":"2025-10-26T01:01:31.490868-05:00","closed_at":"2025-10-18T12:21:49.848087-05:00"}
{"id":"voice-code-131","title":"Better label non-user messages (tool results, etc.)","description":"Currently tool call results and other system messages show as 'User' role. We should distinguish these from actual user prompts so that 'User' label is reserved only for real prompts from a person. This will make the conversation view clearer about what is actually user input vs tool output or other content types.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.491316-05:00","updated_at":"2025-10-26T01:01:31.491316-05:00","closed_at":"2025-10-23T19:09:56.387823-05:00"}
{"id":"voice-code-132","title":"Improve long-press menu focus to highlight entire message","description":"When long-pressing on a message to get the Copy / Read Aloud menu, it would look better if the entire message container was in focus rather than just the text box. This is a nice-to-have UX improvement for better visual feedback.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-10-26T01:01:31.491719-05:00","updated_at":"2025-10-26T01:01:31.491719-05:00","closed_at":"2025-10-23T19:09:46.080218-05:00"}
{"id":"voice-code-133","title":"Group sessions by working directory on Sessions page","description":"Organize the main Sessions page to show the cwd (current working directory) as the group title for each session group. Sorting of cwd directories should remain time-based so that the directory with the most recent session appears at the top. This will help users navigate sessions by project/directory context.","notes":"Implementation complete:\n- Sessions now grouped by working directory in SessionsView\n- Groups sorted by most recent modification date\n- Sessions within each group sorted by modification date\n- Each section header shows directory path and session count\n- + button in each section header pre-populates create dialog with that directory\n- Main + button in toolbar pre-populates with most recently used directory\n- 9 comprehensive tests added and passing in SessionGroupingTests.swift\n\nRemaining: Manual testing in iOS app to verify UI behavior","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.492163-05:00","updated_at":"2025-10-26T01:01:31.492163-05:00"}
{"id":"voice-code-134","title":"Remove Tailscale setup from Help (or remove Help entirely)","description":"Remove the Tailscale setup information from the Help section. We don't want third-party product names like that in our product. Consider whether the entire Help section should be removed or if it should contain different content.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.492672-05:00","updated_at":"2025-10-26T01:01:31.492672-05:00","closed_at":"2025-10-23T19:09:56.286945-05:00"}
{"id":"voice-code-135","title":"Add config setting for default directory for new sessions","description":"Add a configuration setting in the iOS app that allows the user to optionally specify a default directory for new sessions. Currently defaults to / when one is not provided. Need to determine if this requires frontend-only changes or also backend modifications.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.493171-05:00","updated_at":"2025-10-26T01:01:31.493171-05:00","closed_at":"2025-10-23T19:09:56.287244-05:00"}
{"id":"voice-code-136","title":"Fix session auto-closing issue (some sessions still affected)","description":"Some sessions (not all) are still auto-closing after being opened, despite the previous fix in commit 7f40d7e that made session an @ObservedObject. Previous context: User reported session opening then immediately closing. Logs showed session opens, receives session_history with 0 messages (backend filtered sidechain messages), then onDisappear fires and session unsubscribes. Need to investigate why this still happens for some sessions after the property wrapper fix.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.493609-05:00","updated_at":"2025-10-26T01:01:31.493609-05:00","closed_at":"2025-10-22T17:03:20.111099-05:00"}
{"id":"voice-code-137","title":"Fix 'Sending...' spinner to stop when backend receives message","description":"The 'Sending...' spinner currently keeps spinning until Claude Code responds to the user's message. Under our new async architecture, it should stop as soon as the backend receives the message (when we get backend acknowledgment), not wait for the full Claude response. This will provide better user feedback about message delivery status.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-26T01:01:31.49404-05:00","updated_at":"2025-10-26T01:01:31.49404-05:00","closed_at":"2025-10-23T19:09:56.335643-05:00"}
{"id":"voice-code-138","title":"Add clearable server errors list feature","description":"Create a feature to show a list of server errors that can be cleared by the user. Currently transient errors appear below the 'Tap to Speak' button. Consider options: keep current inline error display, or add a button/icon that navigates to a dedicated errors view where users can see error history and clear individual or all errors. This will provide better error visibility and management for users dealing with connection or server issues.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-26T01:01:31.494415-05:00","updated_at":"2025-10-26T01:01:31.494415-05:00","closed_at":"2025-10-23T19:09:56.287428-05:00"}
{"id":"voice-code-139","title":"Backend: Index keys are uppercase but lookups use lowercase","description":"Case-sensitivity mismatch in session index. Index is built with uppercase UUID keys from filenames, but get-session-metadata normalizes to lowercase for lookups. This causes sessions with uppercase UUIDs (from iOS) to appear missing even though they exist on disk.\n\nRoot cause: build-index! in replication.clj:175-195 uses session-id as-is from filename (uppercase), but get-session-metadata:279-282 normalizes to lowercase.\n\nFix: Normalize session-id to lowercase in build-index! before using as map key: (assoc acc (str/lower-case session-id) metadata)\n\nImpact: ~11+ sessions with uppercase UUIDs cannot be found via lookup despite being in the index.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.494785-05:00","updated_at":"2025-10-26T01:01:31.494785-05:00","closed_at":"2025-10-18T18:26:46.133435-05:00"}
{"id":"voice-code-140","title":"Test iOS to iOS sync","description":"End-to-end test: iOS session syncs to other iOS clients.\n\nSteps:\n1. Start backend and iOS app\n2. Create new session from iOS (send prompt with new_session_id)\n3. Backend creates .jsonl file\n4. Verify filesystem watcher detects new file\n5. Verify messages sync via session_updated\n6. Connect second iOS client\n7. Verify session appears in session_list\n8. Verify can subscribe and see full history","acceptance_criteria":"iOS sessions create backend files, sync via file watching works, other iOS clients receive sessions, full history available","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.495218-05:00","updated_at":"2025-10-26T01:01:31.495218-05:00","closed_at":"2025-10-22T18:28:23.716155-05:00","dependencies":[{"issue_id":"voice-code-140","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.708277-05:00","created_by":"auto-import"}]}
{"id":"voice-code-141","title":"Test terminal to iOS sync","description":"End-to-end test: terminal session appears on iOS.\n\nSteps:\n1. Start backend and iOS app\n2. Create new Claude session from terminal\n3. Verify iOS receives session_created message\n4. Verify session appears in iOS session list\n5. Verify auto-subscription works\n6. Send prompt from terminal\n7. Verify iOS receives session_updated\n8. Verify messages display correctly","acceptance_criteria":"Terminal sessions appear on iOS, auto-subscription works, messages sync correctly, end-to-end flow complete","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.495651-05:00","updated_at":"2025-10-26T01:01:31.495651-05:00","closed_at":"2025-10-22T18:28:23.716016-05:00","dependencies":[{"issue_id":"voice-code-141","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.709889-05:00","created_by":"auto-import"}]}
{"id":"voice-code-142","title":"Unknown message type 'session_deleted' in WebSocket handler","description":"Console shows WARNING: Unknown message type {:type session_deleted}\n\nThe WebSocket message handler is receiving messages with type 'session_deleted' but has no handler for this message type.\n\nNeeds investigation:\n1. Is this a valid message type that should be handled?\n2. Should it be added to the WebSocket protocol spec in STANDARDS.md?\n3. Or is something incorrectly sending this message type?\n\nCurrent protocol (per STANDARDS.md) defines: connect, prompt, set_directory, ping, message_ack (client→backend) and hello, connected, ack, response, error, pong, replay (backend→client).\n\n'session_deleted' is not in the spec.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.496058-05:00","updated_at":"2025-10-26T01:01:31.496058-05:00","closed_at":"2025-10-22T17:03:20.1108-05:00"}
{"id":"voice-code-143","title":"Auto-speak for active session not working","description":"Auto-speak functionality is not working for the active session - responses never trigger speech output.\n\nExpected behavior: When a session has auto-speak enabled and receives a response from Claude, the response should be automatically spoken.\n\nActual behavior: Responses are received but never spoken, even when auto-speak is enabled.\n\nNeeds investigation:\n1. Is the auto-speak flag being properly stored/retrieved from session state?\n2. Is the response handler checking the auto-speak flag?\n3. Is the speech synthesis being triggered with the response text?\n4. Are there any errors in the audio/speech pipeline?\n5. Does manual 'speak' work, indicating this is specifically an auto-trigger issue?","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.496391-05:00","updated_at":"2025-10-26T01:01:31.496391-05:00","closed_at":"2025-10-22T17:03:20.110949-05:00"}
{"id":"voice-code-144","title":"Session messages showing 'No messages yet' despite having messages","description":"Bug: Sessions displayed '11 messages' on list page but showed 'No messages yet' when opened\n\nRoot Cause:\n- System messages have different structure: {type: 'system', content: '...'}\n- User/Assistant messages: {type: 'user/assistant', message: {content: '...'}}\n- iOS extractText() only checked for nested message.content, failing for system messages\n- This caused 'Invalid message data, missing role or text' errors (12 occurrences in console)\n\nFix Applied:\n- Updated extractText() in SessionSyncManager.swift:424-466 to handle both formats\n- First checks nested message.content (user/assistant)\n- Falls back to top-level content (system messages)\n- Added 2 new tests: testExtractTextFromSystemMessage, testExtractTextFromSystemMessageWithPlainContent\n- All 25 SessionSyncManager tests pass\n\nFiles Modified:\n- ios/VoiceCode/Managers/SessionSyncManager.swift (extractText function)\n- ios/VoiceCodeTests/SessionSyncManagerTests.swift (added 2 tests)\n\nImpact: System messages (like /status commands) now display correctly in conversation view","notes":"COMPLETE FIX: Added support for all 3 message formats (user/assistant/system/summary). All 26 tests pass. Summary messages with 'summary' field now display correctly.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-10-26T01:01:31.496761-05:00","updated_at":"2025-10-26T01:01:31.496761-05:00","closed_at":"2025-10-18T15:18:51.995904-05:00"}
{"id":"voice-code-145","title":"Hide server sessions with zero or only system messages","description":"Feature: Hide sessions that were created on the server (not in the frontend) if they have zero messages or only contain system messages.\n\nContext:\n- Some sessions appear in the list but contain no useful content\n- These sessions clutter the UI and provide no value to users\n- Only affects server-created sessions (not user-initiated sessions from FE)\n\nAcceptance Criteria:\n- Sessions created in frontend are always shown (regardless of content)\n- Server sessions with 0 messages are hidden from session list\n- Server sessions with only system messages are hidden from session list\n- Server sessions with at least one user/assistant/summary message are shown\n- Filtering happens in SessionsView after fetching from CoreData\n\nImplementation Notes:\n- Add field to CDSession to track if session was created in frontend\n- Update SessionsListView to filter out server sessions with no/system-only content\n- May need to check message types in CoreData query or computed property\n- Consider performance impact of filtering large session lists\n\nRelated:\n- voice-code-144 (message parsing fixes)\n- voice-code-133 (session grouping)","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-26T01:01:31.497143-05:00","updated_at":"2025-10-26T01:01:31.497143-05:00","closed_at":"2025-10-18T17:45:44.996521-05:00"}
{"id":"voice-code-146","title":"Filter summary messages from iOS display","description":"Summary messages (like 401 errors) are being synced to iOS and displayed to users. These are Claude Code internal messages that should be filtered out.\n\nRoot cause: SessionSyncManager.handleSessionUpdated processes all message types without filtering.\n\nFix: Add filtering in handleSessionUpdated to skip messages where type == 'summary'\n\nImpact: Users see confusing error messages that aren't relevant to their conversations.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.497592-05:00","updated_at":"2025-10-26T01:01:31.497592-05:00","closed_at":"2025-10-18T16:35:23.86677-05:00"}
{"id":"voice-code-147","title":"Filter system messages from iOS display","description":"System messages (like local command notifications) are being synced to iOS and displayed to users. These are Claude Code internal messages that should be filtered out.\n\nRoot cause: SessionSyncManager.handleSessionUpdated processes all message types without filtering.\n\nFix: Add filtering in handleSessionUpdated to skip messages where type == 'system'\n\nImpact: Users see internal system notifications that clutter their conversation view.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.497987-05:00","updated_at":"2025-10-26T01:01:31.497987-05:00","closed_at":"2025-10-18T16:35:23.867415-05:00"}
{"id":"voice-code-148","title":"Write tests for message type filtering","description":"Add tests to SessionSyncManagerTests to verify that summary and system messages are filtered out during sync.\n\nTest cases:\n1. Verify summary messages are not created in CoreData\n2. Verify system messages are not created in CoreData\n3. Verify user and assistant messages are still created\n4. Verify message count is correct after filtering","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.498403-05:00","updated_at":"2025-10-26T01:01:31.498403-05:00","closed_at":"2025-10-18T16:35:23.867857-05:00"}
{"id":"voice-code-149","title":"Delete existing summary/system messages from iOS CoreData","description":"After implementing message filtering, existing summary and system messages are still in the iOS CoreData database and visible to users.\n\nSolution: Add a one-time migration/cleanup that deletes all CDMessage records where role == 'summary' or role == 'system'.\n\nThis should run on app launch after the filtering code is deployed.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.498831-05:00","updated_at":"2025-10-26T01:01:31.498831-05:00","closed_at":"2025-10-18T16:55:46.861526-05:00"}
{"id":"voice-code-150","title":"Default to first premium voice on first launch","description":"When the app is installed and launched for the first time, automatically select the first available premium voice instead of defaulting to a basic voice.\n\nCurrent behavior: App likely defaults to first available voice regardless of quality\n\nDesired behavior:\n1. On first launch, check if any premium voices are available\n2. If premium voices exist, set the default to the first premium voice\n3. If no premium voices, fall back to first available voice\n4. Store this selection in AppSettings so it persists\n\nImplementation:\n- Add first-launch detection (using UserDefaults flag)\n- Query AVSpeechSynthesisVoice.speechVoices() for premium voices\n- Filter for premium quality voices\n- Set default voice in AppSettings\n- Mark first-launch as complete\n\nBenefits: Better out-of-box experience with higher quality voice synthesis","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-26T01:01:31.499257-05:00","updated_at":"2025-10-26T01:01:31.499257-05:00","closed_at":"2025-10-23T19:09:56.287565-05:00"}
{"id":"voice-code-151","title":"Refresh sessions list after server settings update","description":"When server configuration is updated in settings, the sessions list does not refresh automatically. Users must exit and restart the app to see the sessions populate.\n\nCurrent behavior:\n1. User updates server URL/port in settings\n2. User saves settings\n3. Sessions list remains empty\n4. User must force quit and restart app to see sessions\n\nExpected behavior:\n1. User updates server URL/port in settings\n2. User saves settings\n3. App automatically reconnects to new server\n4. Sessions list refreshes and populates with sessions from new server\n\nImplementation:\n- In SettingsView, after saving server settings, trigger client.reconnect()\n- SessionsListView should observe connection state changes\n- When connection is established, automatically request sessions list\n- Clear any cached sessions from previous server\n\nRelated to voice-code-119 (connection status refresh) but specifically about sessions list population.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.499745-05:00","updated_at":"2025-10-26T01:01:31.499745-05:00","closed_at":"2025-10-18T17:23:33.76711-05:00"}
{"id":"voice-code-152","title":"Auto-read uses wrong voice instead of configured voice","description":"Auto-read for new messages was using default system voice instead of the user's configured voice from Settings.\n\nRoot cause: SessionSyncManager.handleSessionUpdated:309 called speak(text) without passing the voiceIdentifier parameter.\n\nFix: \n- Added appSettings parameter to SessionSyncManager\n- Updated speak() call to pass settings.selectedVoiceIdentifier\n- Wired appSettings through VoiceCodeClient → SessionSyncManager\n- Added tests to verify voice configuration path\n\nFiles changed:\n- SessionSyncManager.swift: Added appSettings parameter, updated speak() call\n- VoiceCodeClient.swift: Added appSettings parameter, passed to SessionSyncManager\n- VoiceCodeApp.swift: Passed settings when creating VoiceCodeClient\n- ReadAloudTests.swift: Added tests for voice selection\n\nImpact: Auto-read now respects user's voice selection from Settings.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-10-26T01:01:31.500237-05:00","updated_at":"2025-10-26T01:01:31.500237-05:00","closed_at":"2025-10-18T17:54:24.337427-05:00"}
{"id":"voice-code-153","title":"Centralize voice selection to prevent inconsistency","description":"","notes":"Centralized voice management in VoiceOutputManager to prevent voice selection inconsistency. VoiceOutputManager now owns AppSettings and provides speak(text) for automatic voice selection and speakWithVoice(text, voiceIdentifier:) for overrides. Removed appSettings from SessionSyncManager and VoiceCodeClient. All call sites now use consistent voice.","status":"closed","priority":0,"issue_type":"feature","created_at":"2025-10-26T01:01:31.500677-05:00","updated_at":"2025-10-26T01:01:31.500677-05:00","closed_at":"2025-10-18T18:04:20.733231-05:00"}
{"id":"voice-code-154","title":"Fix subscription loss on reconnection","description":"Implement client-side fix to restore subscriptions when iOS app reconnects to backend after network interruption. Current issue: ConversationView subscribes on onAppear, but reconnection doesn't trigger onAppear, causing message loss.\n\nSolution: Track active subscriptions in VoiceCodeClient and automatically resubscribe on reconnection.\n\nBenefits:\n- Zero backend changes (no deployment coordination)\n- Fixes root cause immediately\n- Low risk, high confidence\n- Can ship independently\n\nSee RECONNECTION_FIX_REVIEW.md for full analysis.","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-10-26T01:01:31.501127-05:00","updated_at":"2025-10-26T01:01:31.501127-05:00","closed_at":"2025-10-22T17:00:54.19018-05:00"}
{"id":"voice-code-155","title":"Track active subscriptions in VoiceCodeClient","description":"Add activeSubscriptions property to VoiceCodeClient to track which sessions are currently subscribed.\n\nImplementation:\n- Add private var activeSubscriptions = Set\u003cString\u003e()\n- Update subscribe() to insert session ID into set\n- Update unsubscribe() to remove session ID from set\n- Track subscriptions across reconnections\n\nLocation: ios/VoiceCode/Managers/VoiceCodeClient.swift\n\nCurrent code:\n- subscribe() at line 327\n- unsubscribe() at line 336","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.501616-05:00","updated_at":"2025-10-26T01:01:31.501616-05:00","closed_at":"2025-10-18T19:58:32.71637-05:00"}
{"id":"voice-code-156","title":"Implement auto-resubscribe on reconnection","description":"Restore subscriptions when client reconnects to backend after network interruption.\n\nImplementation:\n- In handleMessage() under connected case (line 187-193)\n- After reconnectionAttempts = 0\n- Iterate through activeSubscriptions set\n- Call subscribe() for each session ID\n- Log resubscription activity\n\nLocation: ios/VoiceCode/Managers/VoiceCodeClient.swift:187-193\n\nDepends on: voice-code-155 (subscription tracking)","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.502183-05:00","updated_at":"2025-10-26T01:01:31.502183-05:00","closed_at":"2025-10-18T19:58:37.253865-05:00","dependencies":[{"issue_id":"voice-code-156","depends_on_id":"voice-code-155","type":"blocks","created_at":"2025-10-26T01:01:31.711203-05:00","created_by":"auto-import"}]}
{"id":"voice-code-157","title":"Add unit tests for subscription tracking","description":"Write unit tests to verify subscription tracking behavior.\n\nTest cases:\n1. Subscribe adds session ID to activeSubscriptions\n2. Unsubscribe removes session ID from activeSubscriptions\n3. Multiple subscribe calls are idempotent\n4. Multiple unsubscribe calls are safe\n5. activeSubscriptions persists across method calls\n\nLocation: ios/VoiceCodeTests/VoiceCodeClientTests.swift\n\nUse existing test patterns from VoiceCodeClientTests.swift","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.502658-05:00","updated_at":"2025-10-26T01:01:31.502658-05:00","closed_at":"2025-10-18T19:58:37.263772-05:00","dependencies":[{"issue_id":"voice-code-157","depends_on_id":"voice-code-155","type":"blocks","created_at":"2025-10-26T01:01:31.712271-05:00","created_by":"auto-import"}]}
{"id":"voice-code-158","title":"Add integration test for reconnection scenario","description":"Create integration test to verify subscriptions are restored after reconnection.\n\nTest scenario:\n1. Connect client and subscribe to session A\n2. Simulate network disconnect (close WebSocket)\n3. Reconnect client (new WebSocket connection)\n4. Verify subscribe message sent for session A\n5. Verify session updates are received\n\nLocation: ios/VoiceCodeTests/IntegrationTests.swift or new file\n\nMock WebSocket connection to simulate disconnect/reconnect cycle","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.503019-05:00","updated_at":"2025-10-26T01:01:31.503019-05:00","closed_at":"2025-10-18T19:58:37.273389-05:00","dependencies":[{"issue_id":"voice-code-158","depends_on_id":"voice-code-156","type":"blocks","created_at":"2025-10-26T01:01:31.713384-05:00","created_by":"auto-import"}]}
{"id":"voice-code-159","title":"Manual test: Verify subscription restore on network interruption","description":"Manually validate that subscriptions are restored after real network interruption.\n\nTest procedure:\n1. Launch iOS app and connect to backend\n2. Open ConversationView for session A\n3. Verify subscription sent (check logs)\n4. Enable airplane mode to force disconnect\n5. From terminal, send prompt to session A (creates new message)\n6. Disable airplane mode to reconnect\n7. Verify iOS receives connected message\n8. Verify iOS sends subscribe message for session A\n9. Verify new message appears in ConversationView\n\nSuccess criteria:\n- Message appears without manual refresh\n- No user intervention required\n- Logs show resubscription occurred\n\nLocation: Manual testing on physical device or simulator with network conditioning","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.503425-05:00","updated_at":"2025-10-26T01:01:31.503425-05:00","closed_at":"2025-10-22T17:00:54.190053-05:00","dependencies":[{"issue_id":"voice-code-159","depends_on_id":"voice-code-156","type":"blocks","created_at":"2025-10-26T01:01:31.714765-05:00","created_by":"auto-import"}]}
{"id":"voice-code-160","title":"Test edge case: Multiple sessions in navigation stack","description":"Validate that multiple backgrounded ConversationViews maintain subscriptions across reconnection.\n\nTest procedure:\n1. Open ConversationView for session A\n2. Navigate to session B (A is backgrounded in nav stack)\n3. Navigate to session C (A and B are backgrounded)\n4. Enable airplane mode\n5. From terminal, send prompts to sessions A, B, and C\n6. Disable airplane mode\n7. Verify all three sessions resubscribe\n8. Navigate back through stack: C -\u003e B -\u003e A\n9. Verify all messages appeared in each session\n\nSuccess criteria:\n- All three sessions show new messages\n- No messages lost during reconnection\n- Backgrounded sessions continue receiving updates\n\nEdge case validation for multi-session UI pattern","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.503944-05:00","updated_at":"2025-10-26T01:01:31.503944-05:00","closed_at":"2025-10-23T19:10:05.354618-05:00","dependencies":[{"issue_id":"voice-code-160","depends_on_id":"voice-code-156","type":"blocks","created_at":"2025-10-26T01:01:31.715849-05:00","created_by":"auto-import"}]}
{"id":"voice-code-161","title":"Test edge case: Reconnection during active prompt","description":"Validate behavior when network interruption occurs while prompt is being processed.\n\nTest procedure:\n1. Open ConversationView for session A\n2. Send prompt that takes \u003e5 seconds to process\n3. During processing, enable airplane mode\n4. Wait for disconnect\n5. Disable airplane mode to reconnect\n6. Verify subscription restored\n7. Verify response appears when Claude completes\n\nSuccess criteria:\n- Response arrives after reconnection\n- No duplicate prompts sent\n- UI shows correct status during reconnection\n\nTests interaction between optimistic messages, prompt processing, and reconnection","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.504411-05:00","updated_at":"2025-10-26T01:01:31.504411-05:00","closed_at":"2025-10-23T19:10:05.355015-05:00","dependencies":[{"issue_id":"voice-code-161","depends_on_id":"voice-code-156","type":"blocks","created_at":"2025-10-26T01:01:31.716843-05:00","created_by":"auto-import"}]}
{"id":"voice-code-162","title":"Add logging for subscription lifecycle debugging","description":"Enhance logging to make subscription lifecycle visible for debugging.\n\nAdd logging for:\n- Subscribe: session ID added to activeSubscriptions\n- Unsubscribe: session ID removed from activeSubscriptions\n- Reconnection: list of sessions being resubscribed\n- State: current activeSubscriptions count\n\nFormat:\n- Use consistent prefix: [VoiceCodeClient:Subscriptions]\n- Include session ID (first 8 chars for brevity)\n- Log at appropriate levels (debug for routine, info for reconnection)\n\nLocation: ios/VoiceCode/Managers/VoiceCodeClient.swift\n\nEnables easier troubleshooting of subscription issues in production","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.504911-05:00","updated_at":"2025-10-26T01:01:31.504911-05:00","closed_at":"2025-10-23T19:09:28.317654-05:00","dependencies":[{"issue_id":"voice-code-162","depends_on_id":"voice-code-155","type":"blocks","created_at":"2025-10-26T01:01:31.717965-05:00","created_by":"auto-import"}]}
{"id":"voice-code-163","title":"Update documentation with reconnection behavior","description":"Document the subscription restoration behavior in relevant files.\n\nUpdates needed:\n1. Add section to STANDARDS.md WebSocket Protocol explaining auto-resubscribe\n2. Update architecture notes about client-side subscription tracking\n3. Document expected behavior on reconnection\n\nLocation: STANDARDS.md (WebSocket Protocol section)\n\nInclude:\n- How activeSubscriptions are tracked\n- When resubscription occurs (on connected message)\n- User-visible behavior (transparent reconnection)\n\nEnsures future developers understand the reconnection mechanism","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.505319-05:00","updated_at":"2025-10-26T01:01:31.505319-05:00","closed_at":"2025-10-23T19:09:19.629933-05:00","dependencies":[{"issue_id":"voice-code-163","depends_on_id":"voice-code-159","type":"blocks","created_at":"2025-10-26T01:01:31.719248-05:00","created_by":"auto-import"}]}
{"id":"voice-code-164","title":"Backend: extract-working-dir only reads first line, misses cwd in warmup messages","description":"When session files start with error/summary messages before warmup, extract-working-dir reads first line which has no cwd field, falls back to placeholder working directory.\n\nRoot cause: replication.clj:90-119 extract-working-dir only reads first line with (first (line-seq rdr))\n\nExample session 5c5198ac-f97a-4e3f-9e4b-dcc61c0a3769:\n- Line 1-2: type=summary error messages (no cwd)\n- Line 3: Warmup message with cwd=/Users/travisbrown/code/mono/active/voice-code\n- Index has: working-directory=[from project: -Users-travisbrown-code-mono-active-voice-code]\n\nImpact: iOS app receives placeholder paths, commands fail with 'No such file or directory'\n\nFix: Search first N lines (e.g., 10) for cwd field instead of only first line\nAlternative: Filter out non-user/assistant messages when searching for cwd","notes":"When session files start with error/summary messages before warmup, extract-working-dir reads first line which has no cwd field, falls back to placeholder working directory.\n\nRoot cause: replication.clj:90-119 extract-working-dir only reads first line with (first (line-seq rdr))\n\nWhen cwd not found, falls back to project-name-\u003eworking-dir which derives path from parent directory name. Directory names like -Users-travisbrown-code-mono-active-voice-code use dashes instead of slashes. Function detects dash prefix and returns placeholder: [from project: -Users-travisbrown-code-mono-active-voice-code]\n\nExample session 5c5198ac-f97a-4e3f-9e4b-dcc61c0a3769:\n- Line 1-2: type=summary error messages (no cwd)\n- Line 3: Warmup message with cwd=/Users/travisbrown/code/mono/active/voice-code\n- Backend reads line 1, no cwd found, uses placeholder\n- Index stores: working-directory=[from project: -Users-travisbrown-code-mono-active-voice-code]\n- iOS receives placeholder, tries to use as actual path\n- Commands fail: Cannot run program in directory [from project: ...] No such file or directory\n\nImpact: iOS app receives invalid paths, all commands fail\n\nFix: Search first N lines (e.g., 10) for cwd field instead of only first line","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-10-26T01:01:31.505679-05:00","updated_at":"2025-10-26T01:01:31.505679-05:00","closed_at":"2025-10-22T17:00:54.189907-05:00"}
{"id":"voice-code-165","title":"iOS: Sessions not appearing after server restart despite being recent","description":"User reports that some recent sessions (from today Oct 19) don't appear in iOS app even after restarting both backend and frontend.\n\nInvestigation findings:\n- Backend has 819 total sessions, 32 from today\n- Backend filters to top 50 most recent sessions (message-count \u003e 0)\n- 50th session is from Oct 11, so all Oct 19 sessions should be included\n- Commit 9df78db added clearAllSessions() and auto-restore subscriptions\n\nPossible causes:\n1. clearAllSessions() clears CoreData but auto-restored subscriptions might restore sessions not in top 50\n2. Race condition between session_list and auto-restored subscriptions\n3. handleSessionHistory doesn't check if session exists in CoreData (line 95-100 SessionSyncManager.swift)\n4. Filter logic in handleSessionCreated (lines 57-62) might be too aggressive\n\nNeed to:\n- Verify which sessions are missing from iOS\n- Check iOS logs for warnings about 'Session not found for history'\n- Test subscription restoration with sessions outside top 50\n- Consider whether 50-session limit is appropriate or needs to be configurable","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.506047-05:00","updated_at":"2025-10-26T01:01:31.506047-05:00","closed_at":"2025-10-22T17:00:54.19107-05:00"}
{"id":"voice-code-166","title":"iOS: Cannot create new sessions - filtered out by messageCount \u003e 0 predicate","description":"User flow broken: Cannot create new sessions in iOS app. When user taps New Session button, enters name and working directory, and saves, the session disappears immediately and user cannot find it to send the first prompt.\n\nUSER BEHAVIOR:\n1. User opens iOS app (SessionsView shows list of sessions from backend)\n2. User taps + button to create new session\n3. User enters session name and working directory in NewSessionView\n4. User taps Save/Create\n5. Sheet dismisses but new session does NOT appear in SessionsView list\n6. User cannot find session to send initial prompt\n7. No prompt ever reaches backend, no session file created\n\nROOT CAUSE:\nSessionsView.swift line 15-17 uses fetchActiveSessions() to display sessions\nCDSession.swift line 35 has predicate: markedDeleted == NO AND messageCount \u003e 0\nWhen createNewSession() creates session (SessionsView.swift line 152-179), it sets messageCount = 0\nFetch request immediately filters out the new session because messageCount is 0\nSession exists in CoreData but is invisible in UI\n\nHISTORY:\nThis broke in commit e2d76d9 which added 3-layer zero-message filtering:\n- Layer 1: Backend don't broadcast if messageCount = 0\n- Layer 2: iOS Database filter messageCount \u003e 0 (THIS IS THE PROBLEM)\n- Layer 3: iOS Handler validate messageCount in handleSessionCreated\n\nLayer 2 was intended to hide old empty sessions from backend, but it also hides brand new locally-created sessions before user can send first message.\n\nFIX OPTIONS:\n\nOption 1: Remove messageCount \u003e 0 from fetchActiveSessions predicate\n- Simple, allows all non-deleted sessions to show\n- Old empty sessions from backend would reappear (bad UX)\n\nOption 2: Add flag to distinguish local vs backend sessions\n- Add isLocallyCreated boolean to CDSession\n- Set true when created in createNewSession()\n- Predicate: markedDeleted == NO AND (messageCount \u003e 0 OR isLocallyCreated == YES)\n- Clear flag when first message arrives from backend\n- Prevents old empty backend sessions while allowing new local ones\n\nOption 3: Don't create session until first prompt sent\n- Refactor: Hold session name/workingDir in state\n- Show temporary new session UI\n- Create CDSession only when user sends first prompt\n- More complex, changes UX flow\n\nRECOMMENDED: Option 2\nCleanest separation between locally-created sessions (which should always show) and backend sessions (which should only show if non-empty).\n\nFILES AFFECTED:\n- ios/VoiceCode/Models/CDSession.swift (add isLocallyCreated attribute)\n- ios/VoiceCode/Models/VoiceCode.xcdatamodeld (update CoreData schema)\n- ios/VoiceCode/Views/SessionsView.swift (set isLocallyCreated=true in createNewSession)\n- ios/VoiceCode/Managers/SessionSyncManager.swift (clear isLocallyCreated when syncing from backend)","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-10-26T01:01:31.506441-05:00","updated_at":"2025-10-26T01:01:31.506441-05:00","closed_at":"2025-10-22T17:00:54.189301-05:00"}
{"id":"voice-code-167","title":"Backend: Support running multiple instances on different ports","description":"Currently the backend can only run one instance because multiple instances would have file conflicts. We need to support running multiple backend instances on different ports (e.g., 8080 and 8081) for development and testing purposes.\n\nCURRENT SITUATION:\nPort configuration is in resources/config.edn at :server :port (default 8080). No command-line argument support.\n\nFILE CONFLICT ISSUES:\n\n1. Session Index File (~/.claude/.session-index.edn)\n   - SHARED between all instances\n   - Both instances read/write same file\n   - Race condition: simultaneous save-index! calls\n   - Last write wins, losing updates from other instance\n   - Each instance has separate in-memory session-index atom\n   - Updates from one instance invisible to the other\n\n2. Filesystem Watcher\n   - Both instances watch same ~/.claude/projects/ directory\n   - Both receive same filesystem events\n   - Both try to update session-index and save to disk\n   - Both broadcast session-created/updated events to their respective clients\n   - Race condition on every file event\n\n3. File Positions Atom (file-positions)\n   - In-memory only, not persisted\n   - Each instance tracks separately\n   - When file modified, both watchers see event\n   - Both parse incrementally from their last position\n   - Could cause duplicate message broadcasts to clients\n\n4. Session Data Files (~/.claude/projects/**/*.jsonl)\n   - Read-only for backend (Claude Code CLI writes them)\n   - No conflict - safe to read from multiple processes\n\nRECOMMENDED SOLUTION:\n\nMake session index file port-specific:\n- Use ~/.claude/.session-index-8080.edn for port 8080\n- Use ~/.claude/.session-index-8081.edn for port 8081\n- Each instance maintains isolated state\n- Both can watch filesystem independently\n- No coordination needed between instances\n\nIMPLEMENTATION PLAN:\n\n1. Pass port parameter through replication namespace\n   - Add port parameter to get-index-file-path function\n   - Store port in defonce or pass through function calls\n   - Update path to use port: (str home \"/.claude/.session-index-\" port \".edn\")\n\n2. Thread port from server.clj to replication.clj\n   - server/-main already has port from config\n   - Pass port to repl/initialize-index! \n   - Pass port to repl/start-watcher! (may need to store in watcher-state)\n   - Update all save-index! and load-index calls to use port\n\n3. Update function signatures:\n   - get-index-file-path [port]\n   - save-index! [index port]\n   - load-index [port]\n   - initialize-index! [port]\n\n4. Consider storing port in namespace state:\n   - Add (defonce current-port (atom nil))\n   - Set during initialize-index!\n   - Use in get-index-file-path without parameter\n\nFILES TO MODIFY:\n- backend/src/voice_code/replication.clj (get-index-file-path, save-index!, load-index, initialize-index!)\n- backend/src/voice_code/server.clj (-main function to pass port)\n\nTESTING:\n- Start two backend instances on different ports\n- Create session in one instance, verify both see filesystem event\n- Verify each instance maintains separate session index file\n- Verify no race conditions or lost updates\n- Verify clients on each port receive correct broadcasts\n\nALTERNATIVE CONSIDERED:\nDisable filesystem watcher on secondary instances - rejected because both instances should be fully functional.\n\nCONTEXT:\nThis came up during work on voice-code-164 (working directory bug). We needed to run a second backend instance for testing without interfering with the primary instance being used for active development.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-26T01:01:31.506893-05:00","updated_at":"2025-10-26T01:01:31.506893-05:00","closed_at":"2025-10-23T19:10:05.399169-05:00"}
{"id":"voice-code-168","title":"iOS: Add client-triggered session compaction","description":"Allow users to trigger session compaction (reducing message history) from the iOS client.\n\nCONTEXT:\nSession files can grow very large over time with full conversation history. Users should be able to trigger compaction to reduce file size and improve performance.\n\nREQUIREMENTS:\n1. Add UI control in iOS app (e.g., button in session detail view or context menu)\n2. Send compaction request message to backend via WebSocket\n3. Backend invokes Claude Code CLI compaction command\n4. Notify client when compaction completes\n5. Refresh session metadata (message count, file size)\n\nPROTOCOL CHANGES:\n\nNew message type - Client → Backend:\n{\n  \"type\": \"compact_session\",\n  \"session_id\": \"\u003cclaude-session-id\u003e\"\n}\n\nNew message type - Backend → Client (success):\n{\n  \"type\": \"compaction_complete\",\n  \"session_id\": \"\u003cclaude-session-id\u003e\",\n  \"old_message_count\": 150,\n  \"new_message_count\": 20,\n  \"messages_removed\": 130\n}\n\nNew message type - Backend → Client (error):\n{\n  \"type\": \"compaction_error\",\n  \"session_id\": \"\u003cclaude-session-id\u003e\",\n  \"error\": \"\u003cerror-message\u003e\"\n}\n\nBACKEND IMPLEMENTATION:\n1. Add compact-session handler in server.clj handle-message\n2. Validate session_id exists\n3. Invoke Claude Code CLI compact command (need to verify CLI supports this)\n4. Wait for filesystem watcher to detect updated session file\n5. Send compaction_complete message with old/new counts\n\niOS IMPLEMENTATION:\n1. Add compaction button/menu item in SessionDetailView or session context menu\n2. Add compactSession() method to VoiceCodeClient\n3. Handle compaction_complete and compaction_error messages\n4. Show progress indicator during compaction\n5. Update UI with new message count after completion\n\nCONSIDERATIONS:\n- Verify Claude Code CLI has compaction command (may need to check docs)\n- Should we allow compaction of currently active sessions?\n- Should we warn user about data loss before compacting?\n- Consider adding \"compact all sessions\" bulk operation\n- File watcher should automatically update session metadata after compaction\n\nFILES TO MODIFY:\n- backend/src/voice_code/server.clj (add compact handler)\n- backend/src/voice_code/claude.clj (add compact-session function)\n- ios/VoiceCode/Managers/VoiceCodeClient.swift (add compactSession method)\n- ios/VoiceCode/Views/SessionDetailView.swift (add UI control)\n- STANDARDS.md (document new protocol messages)","notes":"✓ COMPLETED - Session compaction feature implemented end-to-end\n\nALL SUBTASKS COMPLETED:\n✓ voice-code-216: Backend WebSocket handler\n✓ voice-code-217: Backend compact-session function\n✓ voice-code-218: Message counting utilities\n✓ voice-code-219: iOS VoiceCodeClient method\n✓ voice-code-220: iOS UI (compact button)\n✓ voice-code-221: STANDARDS.md documentation\n\nIMPLEMENTATION DETAILS:\n- Backend: Uses claude -p --output-format json --resume \u003cid\u003e \"/compact\"\n- Parses compact_boundary metadata for token counts\n- WebSocket messages: compact_session → compaction_complete/error\n- iOS: ⚡︎ button in ConversationView toolbar\n- Shows confirmation alert with warning\n- Success toast shows statistics\n- All tests passing (74 tests, 413 assertions)\n\nUX DECISIONS:\n- No minimum threshold\n- No undo/backup\n- No auto-compact\n- Manual trigger only\n\nSee: docs/compaction-ux-proposal.md, docs/claude-compact-testing.md","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-26T01:01:31.507474-05:00","updated_at":"2025-10-26T01:01:31.507474-05:00","closed_at":"2025-10-21T08:28:17.862343-05:00"}
{"id":"voice-code-169","title":"iOS: Preserve draft prompt text when app backgrounds","description":"When user is typing a prompt, switches to another app, then returns to voice-code, the draft text is lost and app returns to session list view.\n\nUSER FLOW:\n1. User opens session detail view\n2. User starts typing prompt in text field\n3. User switches to another app (e.g., to copy text, check reference)\n4. User returns to voice-code app\n5. App shows session list instead of session detail\n6. Draft prompt text is lost\n\nEXPECTED BEHAVIOR:\n- App should remain in session detail view\n- Draft prompt text should be preserved\n- User can continue typing where they left off\n\nROOT CAUSE (likely):\n- iOS app lifecycle: sceneWillResignActive/sceneDidEnterBackground not preserving navigation state\n- Draft text not saved to UserDefaults or AppStorage\n- Navigation stack being reset when app returns to foreground\n\nSOLUTION:\n1. Save draft prompt text when app backgrounds\n   - Use @AppStorage or UserDefaults to persist per-session\n   - Key format: \"draft_prompt_\\{session_id}\"\n   - Save in sceneWillResignActive or TextField onDisappear\n\n2. Restore draft text when view appears\n   - Load from storage in onAppear\n   - Clear storage after prompt is sent\n\n3. Preserve navigation state\n   - Ensure NavigationStack/NavigationView state persists across app lifecycle\n   - Check if SessionDetailView is being popped when app backgrounds\n\n4. Optional: Auto-save draft periodically while typing\n   - Use onChange(of: promptText) with debounce\n   - Prevents data loss from crashes/force quits\n\nFILES TO MODIFY:\n- ios/VoiceCode/Views/SessionDetailView.swift (save/restore draft text)\n- ios/VoiceCode/VoiceCodeApp.swift (check scene delegate lifecycle handling)\n\nTESTING:\n1. Type partial prompt in session detail\n2. Switch to another app\n3. Return to voice-code\n4. Verify: Still in session detail view with draft text preserved","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.507894-05:00","updated_at":"2025-10-26T01:01:31.507894-05:00","closed_at":"2025-10-22T17:00:54.190701-05:00"}
{"id":"voice-code-170","title":"iOS: Persist draft prompts across app lifecycle","description":"Epic to preserve user's draft prompt text when backgrounding app or switching sessions. Prevents data loss and improves UX.\n\nPROBLEM:\nUsers lose their typed prompt text when:\n1. Switching to another app and returning\n2. App being backgrounded\n3. Navigating away from session detail view\n4. App crashes or is force-quit\n\nSOLUTION OVERVIEW:\nCreate a draft management system that:\n- Stores draft text per-session in UserDefaults\n- Auto-saves on every text change\n- Restores draft when viewing a session\n- Clears draft after prompt is sent\n- Prevents cross-session contamination\n\nTECHNICAL APPROACH:\n- Add DraftManager class (similar to AppSettings pattern)\n- Use dictionary [sessionID: draftText] stored in UserDefaults\n- Integrate with ConversationView to auto-save/restore\n- Handle edge cases (nil session IDs, empty drafts, cleanup)\n\nSUB-TASKS:\nSee voice-code-170 through voice-code-173","notes":"CLOSED: Original approach with parameter threading caused Swift compiler type-checking timeout. \n\nReplaced by voice-code-176 which uses @EnvironmentObject instead of parameter threading.\n\nvoice-code-171 (DraftManager class) is complete and reusable.\nvoice-code-172, 173, 174 are obsolete - replaced by new approach.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-10-26T01:01:31.508297-05:00","updated_at":"2025-10-26T01:01:31.508297-05:00","closed_at":"2025-10-19T22:12:47.393798-05:00"}
{"id":"voice-code-172","title":"iOS: Integrate DraftManager with VoiceCodeApp","description":"Add DraftManager instance to VoiceCodeApp and pass to views that need it.\n\nPARENT EPIC: voice-code-170\nDEPENDS ON: voice-code-171\n\nCHANGES:\nFile: ios/VoiceCode/VoiceCodeApp.swift\n\n1. Add @StateObject for DraftManager (around line 12):\n   @StateObject private var draftManager = DraftManager()\n\n2. Pass to RootView and down the hierarchy:\n   RootView(client: client, settings: settings, voiceOutput: voiceOutput, draftManager: draftManager, showingSettings: $showingSettings)\n\n3. Update RootView to accept and forward draftManager parameter\n\n4. Update SessionsListView to accept and forward draftManager parameter\n\n5. Pass draftManager to ConversationView when navigating (SessionsView.swift line 88-92)\n\nTESTING:\n- Verify app compiles after adding parameter threading\n- Verify DraftManager instance is shared across all views","notes":"Obsolete - parameter threading approach abandoned due to Swift compiler limitations. See voice-code-176 for new @EnvironmentObject approach.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.508637-05:00","updated_at":"2025-10-26T01:01:31.508637-05:00","closed_at":"2025-10-19T22:12:52.02498-05:00"}
{"id":"voice-code-173","title":"iOS: Update ConversationView to use DraftManager","description":"Modify ConversationView to save and restore draft text using DraftManager.\n\nPARENT EPIC: voice-code-170\nDEPENDS ON: voice-code-172\n\nCHANGES:\nFile: ios/VoiceCode/Views/ConversationView.swift\n\n1. Add DraftManager parameter to ConversationView init:\n   @ObservedObject var draftManager: DraftManager\n\n2. Change promptText from @State to computed property or keep @State but sync with DraftManager\n\n3. Add onAppear to restore draft:\n   .onAppear {\n       if let sessionID = session.id {\n           promptText = draftManager.getDraft(sessionID: sessionID)\n       }\n   }\n\n4. Add onChange to auto-save draft:\n   .onChange(of: promptText) { _, newValue in\n       if let sessionID = session.id {\n           draftManager.saveDraft(sessionID: sessionID, text: newValue)\n       }\n   }\n\n5. Clear draft after sending (line 134):\n   if let sessionID = session.id {\n       draftManager.clearDraft(sessionID: sessionID)\n   }\n   promptText = \"\"\n\n6. Handle edge case: session.id is nil (guard against it)\n\nTESTING:\n- Type partial prompt, background app, return - verify text restored\n- Type partial prompt, navigate away, return - verify text restored  \n- Send prompt - verify draft is cleared\n- Switch between sessions - verify each has independent draft\n- Restart app - verify drafts persist","notes":"Obsolete - parameter threading approach abandoned. See voice-code-176 for new @EnvironmentObject approach.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.509013-05:00","updated_at":"2025-10-26T01:01:31.509013-05:00","closed_at":"2025-10-19T22:12:55.965177-05:00"}
{"id":"voice-code-174","title":"iOS: Add draft cleanup on session deletion","description":"Clean up stored drafts when sessions are deleted to prevent storage bloat.\n\nPARENT EPIC: voice-code-170\nDEPENDS ON: voice-code-171\n\nCHANGES:\nFile: ios/VoiceCode/Managers/DraftManager.swift\n\nAdd method:\nfunc cleanupDraft(sessionID: String) {\n    drafts.removeValue(forKey: sessionID)\n}\n\nFile: ios/VoiceCode/Views/SessionsView.swift\n\nWhen deleting session (around line 104 where deleteSession is called):\n- Call draftManager.cleanupDraft(sessionID: session.id)\n- Do this before or after CoreData deletion\n\nOPTIONAL ENHANCEMENT:\nAdd periodic cleanup to remove drafts for sessions that no longer exist in CoreData:\n- Run on app launch or periodically\n- Query all session IDs from CoreData\n- Remove drafts for IDs not in CoreData\n\nTESTING:\n- Delete session with draft text\n- Verify draft is removed from UserDefaults\n- Verify storage size doesn't grow indefinitely","notes":"Obsolete - cleanup logic will be implemented in voice-code-176 using @EnvironmentObject approach.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.509353-05:00","updated_at":"2025-10-26T01:01:31.509353-05:00","closed_at":"2025-10-19T22:13:01.092756-05:00"}
{"id":"voice-code-175","title":"iOS: Auto-scroll to bottom when opening session","description":"When user opens a session in ConversationView, automatically scroll to the most recent message so it's visible without manual scrolling.\n\nPROBLEM:\nCurrently when opening a session, the ScrollView starts at the top showing oldest messages. Users must manually scroll down to see the latest conversation, which is inconvenient especially for long sessions.\n\nEXPECTED BEHAVIOR:\n- Open session -\u003e automatically scrolled to bottom (newest message visible)\n- Receive new message -\u003e automatically scroll to show it\n- User manually scrolls up to read history -\u003e don't auto-scroll (preserve user position)\n- User scrolls back to bottom -\u003e resume auto-scroll on new messages\n\nCONTEXT:\nConversationView.swift uses ScrollViewReader to display messages\nMessages are stored in CoreData and fetched via @FetchRequest\nNeed to scroll to last message on view appearance and when new messages arrive\n\nIMPLEMENTATION:\n\nFile: ios/VoiceCode/Views/ConversationView.swift\n\nCurrent structure (around lines 45-130):\n- ScrollViewReader wraps ScrollView\n- Messages displayed in ForEach\n- Each message has .id(message.objectID)\n\nChanges needed:\n\n1. Track last message ID for scroll target:\n   @State private var lastMessageID: NSManagedObjectID?\n\n2. Add .onAppear to scroll to bottom initially:\n   .onAppear {\n       scrollToBottom(proxy: proxy, animated: false)\n   }\n\n3. Watch for new messages with .onChange:\n   .onChange(of: messages.count) { oldCount, newCount in\n       if newCount \u003e oldCount {\n           scrollToBottom(proxy: proxy, animated: true)\n       }\n   }\n\n4. Add helper function:\n   private func scrollToBottom(proxy: ScrollViewProxy, animated: Bool) {\n       guard let lastMessage = messages.last else { return }\n       if animated {\n           withAnimation {\n               proxy.scrollTo(lastMessage.objectID, anchor: .bottom)\n           }\n       } else {\n           proxy.scrollTo(lastMessage.objectID, anchor: .bottom)\n       }\n   }\n\nEDGE CASES:\n- Empty session (no messages) -\u003e nothing to scroll to, handle gracefully\n- Very long messages -\u003e ensure .bottom anchor shows message, not cuts it off\n- Rapid message arrivals -\u003e debounce or use last message only\n- User scrolled up reading history -\u003e optional: detect user scroll and disable auto-scroll until they scroll to bottom again (advanced feature)\n\nOPTIONAL ENHANCEMENT:\nAdd visual indicator when new message arrives while user is scrolled up:\n- Show \"New message\" badge/button at bottom\n- Tapping it scrolls to newest message\n\nTESTING:\n- Open session with many messages -\u003e should show bottom/newest\n- Receive new message while at bottom -\u003e auto-scroll to show it\n- Open empty session -\u003e no crash\n- Open session with 1 message -\u003e message visible\n\nREFERENCES:\n- ScrollViewReader and proxy.scrollTo() are standard SwiftUI\n- Similar pattern used in many chat apps (Messages, Slack, Discord)","notes":"Feature request captured in epic voice-code-277 with full implementation breakdown:\n• voice-code-275: Initial scroll on open\n• voice-code-272: Scroll position tracking  \n• voice-code-273: Conditional auto-scroll\n• voice-code-274: Floating re-engagement button\n• voice-code-276: Testing\n\nSee voice-code-277 for complete technical design and implementation plan.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-26T01:01:31.509767-05:00","updated_at":"2025-10-26T01:01:31.509767-05:00","closed_at":"2025-10-22T19:49:40.305976-05:00"}
{"id":"voice-code-176","title":"Backend: Index keys are uppercase but lookups use lowercase","description":"Case-sensitivity mismatch in session index. Index is built with uppercase UUID keys from filenames, but get-session-metadata normalizes to lowercase for lookups. This causes sessions with uppercase UUIDs (from iOS) to appear missing even though they exist on disk.\n\nRoot cause: build-index! in replication.clj:175-195 uses session-id as-is from filename (uppercase), but get-session-metadata:279-282 normalizes to lowercase.\n\nFix: Normalize session-id to lowercase in build-index! before using as map key: (assoc acc (str/lower-case session-id) metadata)\n\nImpact: ~11+ sessions with uppercase UUIDs cannot be found via lookup despite being in the index.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.510134-05:00","updated_at":"2025-10-26T01:01:31.510134-05:00","closed_at":"2025-10-22T17:00:54.190309-05:00"}
{"id":"voice-code-177","title":"iOS: Draft persistence using @EnvironmentObject pattern","description":"Epic to preserve user's draft prompt text using SwiftUI @EnvironmentObject pattern instead of parameter threading.\n\nSUPERSEDES: voice-code-170 (parameter threading approach caused Swift compiler timeout)\nREUSES: voice-code-171 (DraftManager class already implemented and tested)\n\nPROBLEM:\nUsers lose typed prompt text when:\n1. Switching to another app and returning\n2. App being backgrounded\n3. Navigating away from session detail view\n4. App crashes or is force-quit\n\nSOLUTION ARCHITECTURE:\nUse SwiftUI @EnvironmentObject to inject DraftManager throughout view hierarchy without explicit parameter passing.\n\nBENEFITS:\n- No view signature changes (avoids Swift compiler type-checking timeout)\n- Idiomatic SwiftUI pattern\n- DraftManager class already complete with tests\n- Simple integration - just 2 files need changes\n\nTECHNICAL APPROACH:\n1. VoiceCodeApp creates @StateObject DraftManager\n2. Inject via .environmentObject() modifier (1 line)\n3. ConversationView accesses via @EnvironmentObject\n4. Auto-save/restore draft per session\n5. Clean up on session delete\n\nIMPLEMENTATION:\n- voice-code-177: Inject DraftManager as environment object in VoiceCodeApp\n- voice-code-178: Update ConversationView to use @EnvironmentObject\n- voice-code-179: Add draft cleanup on session deletion\n\nCONTEXT FOR NEW DEVELOPERS:\n- iOS 18.5 deployment target\n- DraftManager class: ios/VoiceCode/Managers/DraftManager.swift (complete)\n- Tests: ios/VoiceCodeTests/DraftManagerTests.swift (6 tests passing)\n- Storage: UserDefaults key sessionDrafts as [String: String]\n- Pattern reference: AppSettings uses same @Published + didSet pattern\n\nESTIMATED EFFORT: 30-45 minutes total","notes":"COMPLETED: All tasks finished successfully.\n\nImplementation used @EnvironmentObject pattern (idiomatic SwiftUI) instead of parameter threading.\n\nCompleted tasks:\n- voice-code-171: DraftManager class (REUSED from previous work)\n- voice-code-178: Inject DraftManager via @EnvironmentObject ✅\n- voice-code-179: ConversationView draft auto-save/restore ✅  \n- voice-code-180: Cleanup drafts on session deletion ✅\n\nAll builds passing. Ready for testing.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-10-26T01:01:31.51058-05:00","updated_at":"2025-10-26T01:01:31.51058-05:00","closed_at":"2025-10-19T22:18:37.496257-05:00"}
{"id":"voice-code-178","title":"iOS: Inject DraftManager via @EnvironmentObject","description":"Add DraftManager to app environment so all child views can access it without parameter passing.\n\nPARENT EPIC: voice-code-177\nDEPENDS ON: voice-code-171 (DraftManager class - COMPLETE)\n\nCONTEXT:\nDraftManager class already exists and is tested (voice-code-171).\nNeed to make it available throughout view hierarchy using SwiftUI @EnvironmentObject pattern.\n\nCHANGES NEEDED:\n\nFile: ios/VoiceCode/VoiceCodeApp.swift\n\n1. Create @StateObject after line 10:\n   @StateObject private var draftManager = DraftManager()\n\n2. Inject into environment after line 14 (inside WindowGroup):\n   RootView(settings: settings)\n       .environment(\\.managedObjectContext, persistenceController.container.viewContext)\n       .environmentObject(draftManager)  // ← ADD THIS LINE\n\nThat's it! No other changes needed for this task.\n\nTESTING:\n- App should compile and run\n- No runtime errors\n- DraftManager accessible from any child view via @EnvironmentObject\n\nREFERENCE:\nSimilar pattern used for other managers:\n- PersistenceController passed via .environment()\n- We're adding DraftManager via .environmentObject()\n\nDifference: .environment() for value types, .environmentObject() for ObservableObject","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.51093-05:00","updated_at":"2025-10-26T01:01:31.51093-05:00","closed_at":"2025-10-19T22:15:24.211108-05:00"}
{"id":"voice-code-179","title":"iOS: Use @EnvironmentObject in ConversationView for drafts","description":"Update ConversationView to access DraftManager from environment and implement auto-save/restore logic.\n\nPARENT EPIC: voice-code-177\nDEPENDS ON: voice-code-178\n\nCONTEXT:\nConversationView.swift currently has @State private var promptText.\nNeed to sync this with DraftManager to persist across app lifecycle.\n\nCHANGES NEEDED:\n\nFile: ios/VoiceCode/Views/ConversationView.swift\n\n1. Add @EnvironmentObject property (around line 14, with other properties):\n   @EnvironmentObject var draftManager: DraftManager\n\n2. Keep existing @State (line 17):\n   @State private var promptText = \"\"\n   (Keep this - UI needs @State for TextField binding)\n\n3. Add .onAppear modifier to restore draft:\n   .onAppear {\n       if let sessionID = session.id {\n           promptText = draftManager.getDraft(sessionID: sessionID)\n       }\n   }\n\n4. Add .onChange modifier to auto-save draft:\n   .onChange(of: promptText) { oldValue, newValue in\n       if let sessionID = session.id {\n           draftManager.saveDraft(sessionID: sessionID, text: newValue)\n       }\n   }\n\n5. Update sendPrompt to clear draft (around line 134):\n   // After successful send, before setting promptText = \"\"\n   if let sessionID = session.id {\n       draftManager.clearDraft(sessionID: sessionID)\n   }\n   promptText = \"\"\n\nEDGE CASES:\n- session.id might be nil: Use guard/if let to safely unwrap\n- Empty text: DraftManager.saveDraft already handles (removes entry)\n- Multiple sessions: Each has independent draft (DraftManager uses dictionary)\n\nTESTING:\n- Type partial prompt, background app, return → text should restore\n- Type partial prompt, navigate away, return → text should restore\n- Send prompt → draft should clear\n- Switch sessions → each session has own draft\n- Kill app, relaunch → drafts persist\n\nLOCATION HINTS:\n- Current @State promptText: line 17\n- ConversationTextInputView usage: around line 131-136\n- sendPrompt logic: look for where promptText is cleared","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.511266-05:00","updated_at":"2025-10-26T01:01:31.511266-05:00","closed_at":"2025-10-19T22:17:29.336314-05:00"}
{"id":"voice-code-180","title":"iOS: Clean up drafts when session deleted","description":"Remove stored draft text when user deletes a session to prevent storage bloat.\n\nPARENT EPIC: voice-code-177\nDEPENDS ON: voice-code-178\n\nCONTEXT:\nUserDefaults will accumulate draft entries for deleted sessions over time.\nNeed to clean up drafts when sessions are deleted.\n\nCHANGES NEEDED:\n\nFile: ios/VoiceCode/Views/SessionsView.swift\n\n1. Access DraftManager via @EnvironmentObject (around line 11):\n   @EnvironmentObject var draftManager: DraftManager\n\n2. In deleteSession function (around line 104):\n   Before or after viewContext.delete(session):\n   if let sessionID = session.id {\n       draftManager.cleanupDraft(sessionID: sessionID)\n   }\n\nLOCATION:\n- deleteSession function is in SessionsView.swift\n- Currently deletes from CoreData around line 104-110\n- Just add draft cleanup before viewContext.save()\n\nTESTING:\n- Create draft in session (type partial prompt)\n- Delete that session\n- Check UserDefaults: draft should be removed\n- Verify via: UserDefaults.standard.dictionary(forKey: \"sessionDrafts\")\n\nOPTIONAL ENHANCEMENT (P2):\nAdd bulk cleanup on app launch to remove orphaned drafts:\n- In DraftManager.init or separate method\n- Fetch all valid session IDs from CoreData\n- Remove drafts where sessionID not in valid set\n- Only run if draft count \u003e 100 (performance)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.513054-05:00","updated_at":"2025-10-26T01:01:31.513054-05:00","closed_at":"2025-10-19T22:18:30.318265-05:00"}
{"id":"voice-code-181","title":"Epic: Fix session list whiplash on first open (immediate fix)","description":"Fix the immediate cause of session list whiplash when opening a session for the first time.\n\n## Problem\nWhen a user taps a session in the session list that hasn't been opened since app launch:\n1. Session opens briefly (ConversationView appears)\n2. View immediately closes and pops back to session list\n3. Session jumps to a different position in the list\n4. User must find and re-open the session\n\nThis only happens on first open after app receives session from backend.\n\n## Root Cause\nThe issue occurs in SessionSyncManager.swift handleSessionHistory() method (line 109-152). When ConversationView opens (line 200 onAppear), it calls loadSessionIfNeeded() which subscribes to the session (line 244). The backend responds with a session_history message containing the full conversation history.\n\nWhen handleSessionHistory() processes this history replay, it ALWAYS updates session.lastModified = Date() on line 137, even though this is existing historical data, not new activity. This causes:\n1. CoreData saveContext() triggers @FetchRequest observer in SessionsView\n2. @FetchRequest re-sorts by lastModified descending (CDSession.swift:38)\n3. Session moves to top of list\n4. NavigationLink breaks because session position changed in array\n5. View pops back to session list\n\n## Solution\nRemove the lastModified update from handleSessionHistory() at SessionSyncManager.swift:137. History replay represents existing activity that already has a lastModified timestamp from the backend. We should only update lastModified when truly NEW messages arrive (which happens in handleSessionUpdated()).\n\n## Scope\n- Modify SessionSyncManager.swift handleSessionHistory() method\n- Write tests to verify lastModified is NOT updated during history replay\n- Write tests to verify lastModified IS still updated for new messages\n- Verify fix resolves the whiplash issue\n\n## Out of Scope\nThis is a tactical fix. It does NOT address the underlying architectural fragility of position-based navigation. That will be addressed in a separate epic for ID-based navigation refactoring.","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-10-26T01:01:31.513998-05:00","updated_at":"2025-10-26T01:01:31.513998-05:00","closed_at":"2025-10-20T21:12:19.192791-05:00"}
{"id":"voice-code-182","title":"Understand the session history flow and identify the bug location","description":"## Context\nThis task helps you understand how session history loading works and where the bug occurs.\n\n## Background: What is Session History?\nIn this app, sessions represent conversations with Claude. When you open a session for the first time after app launch, the iOS app needs to load the full conversation history from the backend server. This is called 'session history replay'.\n\nThe flow works like this:\n1. User taps a session in SessionsView (the list of all sessions)\n2. ConversationView opens and displays the conversation\n3. ConversationView.swift line 200-201: onAppear lifecycle method fires\n4. Line 230-250: loadSessionIfNeeded() method executes\n5. Line 244: client.subscribe(sessionId:) sends a 'subscribe' message to backend via WebSocket\n6. Backend responds with a 'session_history' message containing all messages in that conversation\n7. VoiceCodeClient.swift line 283-289: Receives the session_history message\n8. SessionSyncManager.swift line 109-152: handleSessionHistory() processes the message\n\n## The Bug Location\nOpen ios/VoiceCode/Managers/SessionSyncManager.swift and find the handleSessionHistory() method (starts around line 109).\n\nLook at lines 135-137:\n\n\u001b[1;38;5;196mWelcome to Swift!\u001b[0m\n\n\u001b[1mSubcommands:\u001b[0m\n\n  \u001b[1mswift build\u001b[0m      Build Swift packages\n  \u001b[1mswift package\u001b[0m    Create and work on packages\n  \u001b[1mswift run\u001b[0m        Run a program from a package\n  \u001b[1mswift test\u001b[0m       Run package tests\n  \u001b[1mswift repl\u001b[0m       Experiment with Swift code interactively\n\n  Use \u001b[1m`swift --version`\u001b[0m for Swift version information.\n\n  Use \u001b[1m`swift --help`\u001b[0m for descriptions of available options and flags.\n\n  Use \u001b[1m`swift help \u003csubcommand\u003e`\u001b[0m for more information about a subcommand.\n\nLine 137 sets lastModified to the current time (Date()). This is incorrect because:\n- We're replaying EXISTING history, not creating new activity\n- The backend already sent us the correct lastModified timestamp in the session_list\n- Updating it to 'now' makes the session jump to the top of the list\n\n## Why Does This Cause Whiplash?\nSessionsView displays sessions in a list sorted by lastModified (most recent first). The list uses SwiftUI's @FetchRequest which automatically re-sorts when CoreData changes.\n\nWhen we update lastModified:\n1. CoreData saves the change (line 145-146)\n2. @FetchRequest in SessionsView.swift (line 17-20) observes the change\n3. The fetch request re-sorts: CDSession.swift line 38 sorts by lastModified descending\n4. The session moves from its original position to the top of the list\n5. SwiftUI's NavigationLink is position-based (SessionsView.swift line 110-114)\n6. The NavigationLink's reference becomes invalid because the array position changed\n7. Navigation pops back to the session list\n\n## Your Task\n1. Read through the code files mentioned above\n2. Trace the flow from ConversationView.onAppear to handleSessionHistory()\n3. Locate line 137 in SessionSyncManager.swift\n4. Understand why updating lastModified during history replay is semantically incorrect\n5. Note that handleSessionUpdated() (line 238-349) DOES need to update lastModified because it handles NEW messages\n6. Write a comment in this task explaining the difference between handleSessionHistory() and handleSessionUpdated()\n\n## Success Criteria\n- You can explain the flow from session tap to whiplash\n- You understand why line 137 is the bug\n- You can explain why handleSessionUpdated() should keep its lastModified update","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.514668-05:00","updated_at":"2025-10-26T01:01:31.514668-05:00","closed_at":"2025-10-20T21:07:22.472515-05:00","dependencies":[{"issue_id":"voice-code-182","depends_on_id":"voice-code-181","type":"blocks","created_at":"2025-10-26T01:01:31.720728-05:00","created_by":"auto-import"}]}
{"id":"voice-code-183","title":"Remove lastModified update from handleSessionHistory method","description":"Context: Fix the bug by removing the problematic lastModified update from handleSessionHistory.\n\nWhat to change:\n- File: ios/VoiceCode/Managers/SessionSyncManager.swift\n- Method: handleSessionHistory() (line 109-152)\n- Line to remove: 137\n\nWhy remove this line:\nThe handleSessionHistory() method processes EXISTING conversation history being replayed from the backend. This history already happened in the past. The backend already sent us the correct lastModified timestamp in the session_list message. Setting lastModified = Date() incorrectly marks the session as modified right now.\n\nThe fix:\n1. Open ios/VoiceCode/Managers/SessionSyncManager.swift\n2. Find handleSessionHistory() method (starts around line 109)\n3. Locate line 137: session.lastModified = Date()\n4. REMOVE line 137\n5. Keep line 136 (messageCount update is correct)\n6. Add a comment explaining why we do not update lastModified during history replay\n\nImportant: Do NOT remove lastModified from handleSessionUpdated() method (line 306). That update is correct because handleSessionUpdated() receives NEW messages being created right now.\n\nSuccess criteria:\n- Line 137 in handleSessionHistory() removed or commented out\n- Line 306 in handleSessionUpdated() still present\n- Code compiles without errors\n- Comment added explaining the reasoning","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.515282-05:00","updated_at":"2025-10-26T01:01:31.515282-05:00","closed_at":"2025-10-20T21:09:19.84195-05:00","dependencies":[{"issue_id":"voice-code-183","depends_on_id":"voice-code-181","type":"blocks","created_at":"2025-10-26T01:01:31.721885-05:00","created_by":"auto-import"},{"issue_id":"voice-code-183","depends_on_id":"voice-code-182","type":"blocks","created_at":"2025-10-26T01:01:31.722913-05:00","created_by":"auto-import"}]}
{"id":"voice-code-184","title":"Write test: Verify lastModified NOT updated during session history replay","description":"Context: Write a test to verify that our fix works - lastModified should NOT be updated when replaying session history.\n\nTest location:\nCreate or add to: ios/VoiceCodeTests/SessionSyncManagerTests.swift\n\nTest purpose:\nVerify that when handleSessionHistory() is called with existing messages, the session lastModified timestamp is NOT changed to the current time. This ensures sessions do not jump to the top of the list when opened for the first time.\n\nTest implementation:\n1. Create a test method: testHandleSessionHistory_DoesNotUpdateLastModified()\n2. Setup: Create a test session in CoreData with a known lastModified timestamp (e.g., 1 hour ago)\n3. Capture the original lastModified value\n4. Call sessionSyncManager.handleSessionHistory() with mock message data\n5. Wait for the async background context to complete\n6. Fetch the session again from CoreData\n7. Assert that session.lastModified equals the original timestamp (has NOT changed)\n8. Assert that session.messageCount HAS been updated to match the history count\n\nMock data format:\nThe messages array should contain dictionaries matching the Claude Code jsonl format with fields: type (user or assistant), message object with content, timestamp, uuid.\n\nReference existing tests:\nLook at ios/VoiceCodeTests/CoreDataTests.swift and ios/VoiceCodeTests/SessionDeletionTests.swift for examples of how to set up CoreData test contexts and wait for async operations.\n\nSuccess criteria:\n- Test file created or updated\n- Test passes with the fix applied\n- Test would fail if line 137 (lastModified = Date()) were added back\n- Test verifies messageCount IS updated (showing we are processing the history)\n- Test uses proper async expectations to wait for background context saves","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.515947-05:00","updated_at":"2025-10-26T01:01:31.515947-05:00","closed_at":"2025-10-20T21:11:31.724889-05:00","dependencies":[{"issue_id":"voice-code-184","depends_on_id":"voice-code-181","type":"blocks","created_at":"2025-10-26T01:01:31.724122-05:00","created_by":"auto-import"},{"issue_id":"voice-code-184","depends_on_id":"voice-code-183","type":"blocks","created_at":"2025-10-26T01:01:31.72562-05:00","created_by":"auto-import"}]}
{"id":"voice-code-185","title":"Write test: Verify lastModified IS updated for new messages","description":"Context: Write a test to verify that lastModified IS still updated when NEW messages arrive (not history replay).\n\nTest location:\nAdd to: ios/VoiceCodeTests/SessionSyncManagerTests.swift\n\nTest purpose:\nVerify that when handleSessionUpdated() is called with new messages arriving in real-time, the session lastModified timestamp IS updated to the current time. This is the correct behavior for new activity.\n\nDifference from previous test:\n- Previous test (voice-code-184): Tests handleSessionHistory() which should NOT update lastModified\n- This test: Tests handleSessionUpdated() which SHOULD update lastModified\n\nTest implementation:\n1. Create test method: testHandleSessionUpdated_UpdatesLastModified()\n2. Setup: Create a test session in CoreData with lastModified set to 1 hour ago\n3. Capture the original lastModified value\n4. Call sessionSyncManager.handleSessionUpdated() with mock new message data\n5. Wait for async background context to complete\n6. Fetch the session again from CoreData\n7. Assert that session.lastModified is GREATER than the original timestamp (has been updated)\n8. Assert that the new lastModified is within the last few seconds (approximately Date())\n9. Assert that session.messageCount has been incremented\n\nMock data format:\nMessages array should match the Claude Code jsonl format. Include at least one assistant message to simulate a new response from Claude.\n\nWhy this test is important:\nThis verifies we did not accidentally break the correct behavior. When new messages arrive during active conversation, we WANT the session to move to the top of the list because it represents recent activity.\n\nSuccess criteria:\n- Test passes with current code\n- Test verifies lastModified IS updated to recent time\n- Test verifies messageCount is incremented\n- Test distinguishes between history replay and new message arrival\n- Test uses proper async expectations","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.516455-05:00","updated_at":"2025-10-26T01:01:31.516455-05:00","closed_at":"2025-10-20T21:11:31.738981-05:00","dependencies":[{"issue_id":"voice-code-185","depends_on_id":"voice-code-181","type":"blocks","created_at":"2025-10-26T01:01:31.72718-05:00","created_by":"auto-import"},{"issue_id":"voice-code-185","depends_on_id":"voice-code-183","type":"blocks","created_at":"2025-10-26T01:01:31.728357-05:00","created_by":"auto-import"}]}
{"id":"voice-code-186","title":"Manual verification: Test the whiplash fix on device","description":"Context: Manually verify that the fix resolves the session list whiplash issue on a real device or simulator.\n\nPrerequisites:\n- Code fix applied (voice-code-183 completed)\n- Tests written and passing (voice-code-184 and voice-code-185 completed)\n- Backend server running and accessible\n- iOS app built and installed on device or simulator\n\nTest setup:\n1. Start the backend server (cd to voice-code directory, run: make run)\n2. Ensure backend has at least 3-5 sessions with conversation history\n3. Build and run the iOS app in Xcode\n4. Connect to the backend (check Settings if needed)\n5. Verify you see the session list populated\n\nTest procedure - Before fix (verify the bug exists):\nIf testing on a branch without the fix, you should observe:\n1. Tap a session in the middle of the list that has not been opened yet\n2. ConversationView opens briefly\n3. View immediately pops back to session list\n4. Session has moved to a different position (usually top)\n5. Must tap again to open successfully\n\nTest procedure - After fix (verify bug is resolved):\n1. Force quit and restart the app to clear any cached state\n2. Wait for session list to load from backend\n3. Note the current order of sessions in the list\n4. Tap a session in the middle of the list that has not been opened yet\n5. VERIFY: ConversationView opens and STAYS open\n6. VERIFY: Conversation history loads and displays\n7. Return to session list (back button)\n8. VERIFY: Session is in the SAME position as before (did not jump to top)\n9. Repeat for 2-3 different sessions to confirm consistency\n\nAdditional test scenarios:\n1. Test with sessions from different working directories\n2. Test with sessions that have many messages (50+)\n3. Test with sessions that have few messages (1-5)\n4. Test after app has been in background and returns to foreground\n\nWhat to look for:\n- No navigation popping immediately after opening session\n- Session position in list remains stable\n- Session order only changes when NEW messages arrive (expected behavior)\n\nSuccess criteria:\n- Session opens and stays open on first tap\n- Session position in list does not change from opening/viewing history\n- No whiplash or navigation disruption\n- Behavior consistent across multiple sessions","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.517151-05:00","updated_at":"2025-10-26T01:01:31.517151-05:00","closed_at":"2025-10-20T21:11:37.91541-05:00","dependencies":[{"issue_id":"voice-code-186","depends_on_id":"voice-code-181","type":"blocks","created_at":"2025-10-26T01:01:31.729407-05:00","created_by":"auto-import"},{"issue_id":"voice-code-186","depends_on_id":"voice-code-183","type":"blocks","created_at":"2025-10-26T01:01:31.730845-05:00","created_by":"auto-import"},{"issue_id":"voice-code-186","depends_on_id":"voice-code-184","type":"blocks","created_at":"2025-10-26T01:01:31.732043-05:00","created_by":"auto-import"},{"issue_id":"voice-code-186","depends_on_id":"voice-code-185","type":"blocks","created_at":"2025-10-26T01:01:31.73297-05:00","created_by":"auto-import"}]}
{"id":"voice-code-187","title":"Code review and documentation update","description":"Context: Review the changes and update documentation to explain the distinction between history replay and new message handling.\n\nCode review checklist:\n1. Review the change in SessionSyncManager.swift handleSessionHistory()\n2. Verify line 137 was removed (lastModified = Date())\n3. Verify line 306 in handleSessionUpdated() is still present\n4. Verify comments were added explaining the reasoning\n5. Check that both test files pass\n6. Review test coverage for edge cases\n\nDocumentation to add:\nAdd a comment block above handleSessionHistory() method explaining:\n- This method processes EXISTING history (replay from backend)\n- History replay should not update lastModified timestamp\n- The correct lastModified comes from the backend session_list\n- Only handleSessionUpdated() should update lastModified for NEW messages\n\nAdd a comment block above handleSessionUpdated() method explaining:\n- This method processes NEW messages arriving in real-time\n- New messages should update lastModified to current time\n- This ensures active sessions move to top of list (expected behavior)\n\nCode review questions to answer:\n1. Does the fix make semantic sense (history replay vs new activity)?\n2. Are there any other places in the code that might have similar issues?\n3. Could this same pattern apply to messageCount updates?\n4. Should we add logging to distinguish history replay from new messages?\n\nAdditional documentation:\nUpdate docs/session-list-refresh-issue.md:\n- Add a section documenting the fix that was implemented\n- Explain which option was chosen and why\n- Note that this is a tactical fix and ID-based navigation is still recommended\n- Add date of fix and link to relevant task IDs\n\nSuccess criteria:\n- Comments added to both methods explaining their different purposes\n- Documentation file updated with fix details\n- Code review questions answered in task comments\n- No other instances of this pattern found in codebase","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.517652-05:00","updated_at":"2025-10-26T01:01:31.517652-05:00","closed_at":"2025-10-20T21:12:09.912362-05:00","dependencies":[{"issue_id":"voice-code-187","depends_on_id":"voice-code-181","type":"blocks","created_at":"2025-10-26T01:01:31.733931-05:00","created_by":"auto-import"},{"issue_id":"voice-code-187","depends_on_id":"voice-code-183","type":"blocks","created_at":"2025-10-26T01:01:31.734927-05:00","created_by":"auto-import"},{"issue_id":"voice-code-187","depends_on_id":"voice-code-184","type":"blocks","created_at":"2025-10-26T01:01:31.736553-05:00","created_by":"auto-import"},{"issue_id":"voice-code-187","depends_on_id":"voice-code-185","type":"blocks","created_at":"2025-10-26T01:01:31.737611-05:00","created_by":"auto-import"},{"issue_id":"voice-code-187","depends_on_id":"voice-code-186","type":"blocks","created_at":"2025-10-26T01:01:31.738705-05:00","created_by":"auto-import"}]}
{"id":"voice-code-188","title":"Epic: Refactor to ID-based navigation (long-term fix)","description":"Refactor SessionsView navigation from position-based to ID-based to permanently fix session list whiplash and improve architecture.\n\n## Problem\nThe current navigation implementation in SessionsView uses SwiftUI NavigationLink inside a ForEach that iterates over @FetchRequest results. This creates a position-based navigation dependency where the NavigationLink is tied to the specific index position in the FetchedResults array.\n\nWhen CoreData updates and re-sorts the underlying array during active navigation, the NavigationLink reference becomes invalid and navigation pops back to the list. This causes the whiplash issue.\n\n## Current Implementation\nSessionsView.swift lines 109-114:\nForEach iterates over sessions sorted by lastModified\nNavigationLink(destination: ConversationView(session: session))\nNavigation is implicitly tied to array position\n\n## Root Architectural Issue\nPosition-based navigation is fragile because:\n- FetchedResults array can re-sort at any time when CoreData changes\n- Animations on @FetchRequest make this visible and disruptive\n- Any code that updates session metadata can break active navigation\n- Makes the app brittle and hard to maintain\n\n## Solution: ID-Based Navigation\nRefactor to use SwiftUI value-based navigation pattern:\n- Use NavigationStack with NavigationPath state\n- Navigate by session UUID, not by position\n- Use navigationDestination(for: UUID.self) to resolve session by ID\n- Navigation remains stable regardless of array re-sorting\n\n## Benefits\n- Immune to CoreData re-sorting during navigation\n- Aligns with SwiftUI best practices\n- Enables future features: deep linking, state restoration, URL schemes\n- More maintainable and robust architecture\n- Follows iOS HIG recommendations for list-detail navigation\n\n## Scope\n- Refactor SessionsView to use NavigationStack and NavigationPath\n- Replace NavigationLink with value-based navigation\n- Add navigationDestination for UUID type\n- Update navigation state management\n- Write tests for navigation stability during CoreData updates\n- Verify all navigation flows still work correctly\n- Test deep linking scenarios (if applicable)\n\n## Out of Scope\n- Backend changes (purely iOS refactor)\n- Other navigation flows outside SessionsView -\u003e ConversationView\n- Changes to ConversationView itself (except navigation-related state)\n\n## Dependencies\nThis epic is independent of voice-code-181 (immediate fix). Can be implemented in parallel or after.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-10-26T01:01:31.518147-05:00","updated_at":"2025-10-26T01:01:31.518147-05:00","closed_at":"2025-10-20T21:32:55.420385-05:00"}
{"id":"voice-code-189","title":"Research SwiftUI NavigationStack and value-based navigation","description":"Context: Learn about SwiftUI value-based navigation and how it differs from traditional NavigationLink patterns.\n\n## What is NavigationStack?\nNavigationStack is a SwiftUI container introduced in iOS 16 that manages a stack of views using a NavigationPath. It replaces the older NavigationView pattern and provides better programmatic control over navigation state.\n\n## What is Value-Based Navigation?\nInstead of embedding a destination view directly in NavigationLink, you navigate using a value (like a UUID). The navigation system looks up the destination based on that value.\n\nTraditional position-based:\nForEach(sessions) { session in\n  NavigationLink(destination: ConversationView(session: session)) {\n    SessionRow(session: session)\n  }\n}\n\nValue-based:\nForEach(sessions) { session in\n  NavigationLink(value: session.id) {\n    SessionRow(session: session)\n  }\n}\n.navigationDestination(for: UUID.self) { sessionId in\n  // Look up session by ID and create view\n  if let session = findSession(by: sessionId) {\n    ConversationView(session: session)\n  }\n}\n\n## Why Value-Based is Better\nPosition-based navigation breaks when the array re-sorts because NavigationLink is tied to a specific index. Value-based navigation uses the UUID to look up the session fresh each time, so it does not matter if the array position changes.\n\n## Research Tasks\n1. Read Apple documentation on NavigationStack and NavigationPath\n2. Read Apple documentation on navigationDestination modifier\n3. Study example code in Apple sample projects (search for navigationDestination)\n4. Find 2-3 blog posts or tutorials on migrating from NavigationView to NavigationStack\n5. Understand how NavigationPath works as state storage for navigation stack\n\n## Key Concepts to Understand\n- NavigationPath: Type-erased collection storing navigation state\n- navigationDestination(for:): Modifier that maps values to destinations\n- Value types: Any Hashable type can be used (UUID, String, custom types)\n- Multiple destination types: Can have different navigationDestination for different types\n- Programmatic navigation: Can append to NavigationPath to navigate programmatically\n\n## Resources\n- Apple WWDC 2022 session on NavigationStack\n- SwiftUI documentation for NavigationStack\n- SwiftUI documentation for navigationDestination\n- Apple sample code: Food Truck app (uses NavigationStack extensively)\n\n## Deliverable\nWrite a summary in this task describing:\n1. How NavigationPath stores navigation state\n2. How navigationDestination looks up views by value\n3. Why this approach is immune to array re-sorting\n4. Any potential gotchas or edge cases to be aware of\n5. Links to 2-3 useful resources\n\nSuccess criteria:\n- Understand the difference between position-based and value-based navigation\n- Can explain how navigationDestination works\n- Found and reviewed Apple documentation\n- Ready to implement the pattern in our codebase","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.518604-05:00","updated_at":"2025-10-26T01:01:31.518604-05:00","closed_at":"2025-10-20T21:19:41.940201-05:00","dependencies":[{"issue_id":"voice-code-189","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-26T01:01:31.739636-05:00","created_by":"auto-import"}]}
{"id":"voice-code-190","title":"Audit current navigation structure and identify all touch points","description":"Context: Map out all the navigation touch points in the current implementation before refactoring.\n\n## Files to Audit\n1. ios/VoiceCode/VoiceCodeApp.swift - App entry point and top-level navigation structure\n2. ios/VoiceCode/Views/SessionsView.swift - Main session list view with NavigationLink\n3. ios/VoiceCode/Views/ConversationView.swift - Destination view for session navigation\n4. ios/VoiceCode/Views/ContentView.swift - May contain navigation wrapper\n\n## What to Document\nFor each file, identify:\n1. Current navigation container (NavigationView or NavigationStack?)\n2. Where NavigationLink is used\n3. What state is passed to ConversationView\n4. Any programmatic navigation (isPresented, NavigationLink with tag/selection)\n5. Any navigation-related @State or @Binding variables\n\n## Specific Questions to Answer\n1. Does VoiceCodeApp.swift use NavigationView or NavigationStack?\n2. Is there a ContentView that wraps SessionsView?\n3. How many NavigationLink instances exist in SessionsView?\n4. Are there any other navigation paths to ConversationView besides from SessionsView?\n5. Does ConversationView navigate to any other views?\n6. Are there any sheets, fullScreenCovers, or other modal presentations?\n7. Is there any deep linking or URL handling code?\n\n## Navigation Flow Diagram\nCreate a simple text diagram showing:\n- App entry point\n- Top-level navigation container\n- SessionsView -\u003e ConversationView navigation\n- Any other navigation relationships\n- Modal presentations (sheets, alerts, etc)\n\nExample format:\nVoiceCodeApp\n  └─ NavigationView (or NavigationStack?)\n      └─ SessionsView\n          ├─ NavigationLink -\u003e ConversationView\n          ├─ Sheet -\u003e NewSessionView\n          └─ Sheet -\u003e SettingsView\n\n## Navigation State Inventory\nList all navigation-related state:\n- Is there a @State var for selected session?\n- Is there any navigationBarItems or toolbar navigation?\n- Are there any programmatic dismiss/pop operations?\n\n## Deliverable\nDocument findings in this task with:\n1. List of all navigation touch points\n2. Navigation flow diagram\n3. State inventory\n4. Any concerns or questions about the refactor\n5. Estimate of refactor scope (how many files need changes)\n\nSuccess criteria:\n- All navigation paths documented\n- Understand current navigation architecture\n- Identified all files that need modification\n- Ready to plan the refactor implementation","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.519078-05:00","updated_at":"2025-10-26T01:01:31.519078-05:00","closed_at":"2025-10-20T21:20:30.000671-05:00","dependencies":[{"issue_id":"voice-code-190","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-26T01:01:31.740822-05:00","created_by":"auto-import"},{"issue_id":"voice-code-190","depends_on_id":"voice-code-189","type":"blocks","created_at":"2025-10-26T01:01:31.741841-05:00","created_by":"auto-import"}]}
{"id":"voice-code-191","title":"Design the ID-based navigation architecture","description":"Context: Design the new navigation architecture using NavigationStack and value-based navigation.\n\nDesign Constraints:\n1. Must support iOS 16+ (NavigationStack requirement)\n2. Must maintain all existing functionality\n3. Should be backward compatible with current session management\n4. Must handle session lookup by UUID efficiently\n5. Should support future deep linking if needed\n\nArchitecture Decisions to Make:\n\n1. Where to Place NavigationStack\n- Option A: Wrap entire app in NavigationStack at VoiceCodeApp level\n- Option B: Wrap SessionsView in NavigationStack\n- Option C: Use NavigationStack in ContentView wrapper\n\n2. NavigationPath Storage\n- Option A: @State var navigationPath in SessionsView\n- Option B: @StateObject NavigationManager as environment object\n- Option C: @AppStorage for persistence across app restarts\n\n3. Session Lookup Strategy\n- Option A: Use @FetchRequest in navigationDestination closure\n- Option B: Pass sessions array via environment\n- Option C: Create a SessionManager to handle lookups\n\n4. Handling Missing Sessions\nWhat if UUID is in NavigationPath but session no longer exists (deleted)?\n- Option A: Show error view with back button\n- Option B: Pop navigation automatically\n- Option C: Show empty state with explanation\n\n5. Backward Compatibility\nDo we need to support iOS 15? If yes, need both implementations with availability checks.\n\nDeliverable: Post design document with architecture decisions, code structure diagram, pseudo-code for key components, migration path, and testing strategy.\n\nSuccess criteria: Clear architectural plan, all decisions documented with rationale, issues identified with mitigation strategies, ready for implementation.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.519508-05:00","updated_at":"2025-10-26T01:01:31.519508-05:00","closed_at":"2025-10-20T21:21:13.065406-05:00","dependencies":[{"issue_id":"voice-code-191","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-26T01:01:31.743618-05:00","created_by":"auto-import"},{"issue_id":"voice-code-191","depends_on_id":"voice-code-189","type":"blocks","created_at":"2025-10-26T01:01:31.744506-05:00","created_by":"auto-import"},{"issue_id":"voice-code-191","depends_on_id":"voice-code-190","type":"blocks","created_at":"2025-10-26T01:01:31.745059-05:00","created_by":"auto-import"}]}
{"id":"voice-code-192","title":"Implement NavigationStack wrapper and NavigationPath state","description":"Context: Implement the NavigationStack container and NavigationPath state management based on the design from voice-code-191.\n\nPrerequisites:\n- Design decisions finalized in voice-code-191\n- Architecture documented and reviewed\n\nImplementation Steps:\n\n1. Determine NavigationStack Placement\nBased on design decision, implement NavigationStack in the appropriate location:\n- If VoiceCodeApp: Wrap the root view in NavigationStack\n- If SessionsView: Add NavigationStack wrapper\n- If ContentView: Create or modify ContentView to include NavigationStack\n\n2. Add NavigationPath State\nAdd state variable to manage navigation stack:\n@State private var navigationPath = NavigationPath()\n\nLocation depends on design decision. If using environment object, create NavigationManager class.\n\n3. Update VoiceCodeApp.swift (if needed)\nIf NavigationStack goes at app level:\n- Import SwiftUI\n- Wrap body content in NavigationStack(path: dollar-sign-navigationPath)\n- Pass navigationPath to child views if needed\n\n4. Create NavigationManager (if using environment object)\nIf design calls for environment object:\n- Create new file: NavigationManager.swift\n- Implement ObservableObject with @Published var path = NavigationPath()\n- Add helper methods: navigate(to sessionId: UUID), pop(), popToRoot()\n- Inject as environment object in VoiceCodeApp\n\n5. Handle Environment Injection\nIf using environment object:\n- Add .environmentObject(navigationManager) in VoiceCodeApp\n- Access with @EnvironmentObject var navigationManager in child views\n\n6. Verify Compilation\nAt this stage, code should compile but navigation will not work yet (NavigationLink not updated).\n\nCode Review Points:\n- NavigationStack properly wraps content\n- NavigationPath state initialized\n- State management approach matches design\n- No compilation errors\n- Existing navigation still works (old NavigationLink untouched for now)\n\nSuccess criteria:\n- NavigationStack implemented at designed location\n- NavigationPath state exists and accessible\n- Code compiles without errors\n- Existing functionality unaffected (no regressions)\n- Ready for next step (updating NavigationLink)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.519993-05:00","updated_at":"2025-10-26T01:01:31.519993-05:00","closed_at":"2025-10-20T21:22:31.321759-05:00","dependencies":[{"issue_id":"voice-code-192","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-26T01:01:31.746346-05:00","created_by":"auto-import"},{"issue_id":"voice-code-192","depends_on_id":"voice-code-191","type":"blocks","created_at":"2025-10-26T01:01:31.747166-05:00","created_by":"auto-import"}]}
{"id":"voice-code-193","title":"Refactor SessionsView NavigationLink to value-based pattern","description":"Context: Convert SessionsView from position-based NavigationLink to value-based NavigationLink.\n\nCurrent Implementation (SessionsView.swift line 109-114):\nThe ForEach iterates over sessions and creates NavigationLink with embedded destination:\nNavigationLink(destination: ConversationView(...))\n\nThis couples navigation to array position.\n\nNew Implementation:\nUse NavigationLink with value parameter instead of destination.\n\nStep-by-Step Implementation:\n\n1. Locate the NavigationLink\nFile: ios/VoiceCode/Views/SessionsView.swift\nCurrent location: Around line 110-114 inside ForEach loop\n\n2. Replace NavigationLink Signature\nChange from:\nNavigationLink(destination: ConversationView(session: session, client: client, voiceOutput: voiceOutput, settings: settings))\n\nChange to:\nNavigationLink(value: session.id)\n\nKeep the closure content (the SessionRow view) unchanged.\n\n3. Update the Closure\nThe closure body should remain the same:\nNavigationLink(value: session.id) {\n  CDSessionRowContent(session: session)\n}\n\n4. Keep swipeActions Unchanged\nThe swipeActions for delete should remain as-is.\n\n5. Verify Other NavigationLinks\nCheck if there are any other NavigationLink instances in SessionsView (there should not be any others in the session list, but verify).\n\nExpected Result After This Change:\n- NavigationLink no longer creates destination view immediately\n- Navigation is triggered by appending session.id (UUID) to NavigationPath\n- Destination view will be resolved in navigationDestination modifier (implemented in next task)\n\nImportant Notes:\n- Do NOT implement navigationDestination yet (that is next task)\n- Navigation will be broken temporarily after this change\n- This is expected - we are doing incremental refactoring\n- Keep all other SessionsView functionality unchanged\n\nTesting After This Change:\n- Code should compile\n- Tapping sessions will not navigate (expected, navigationDestination not added yet)\n- No crashes or errors\n\nSuccess criteria:\n- NavigationLink changed to use value parameter\n- session.id (UUID) passed as value\n- Destination parameter removed\n- Code compiles without errors\n- Ready for navigationDestination implementation","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.520673-05:00","updated_at":"2025-10-26T01:01:31.520673-05:00","closed_at":"2025-10-20T21:23:03.583498-05:00","dependencies":[{"issue_id":"voice-code-193","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-26T01:01:31.747873-05:00","created_by":"auto-import"},{"issue_id":"voice-code-193","depends_on_id":"voice-code-192","type":"blocks","created_at":"2025-10-26T01:01:31.748457-05:00","created_by":"auto-import"}]}
{"id":"voice-code-194","title":"Implement navigationDestination for UUID to resolve ConversationView","description":"Context: Implement the navigationDestination modifier to resolve session UUIDs to ConversationView.\n\nWhat is navigationDestination:\nThis SwiftUI modifier maps values in the NavigationPath to destination views. When NavigationLink pushes a UUID onto the path, navigationDestination looks up the session and creates the ConversationView.\n\nImplementation Location:\nAdd navigationDestination modifier to SessionsView or the NavigationStack container (depends on design decision in voice-code-191).\n\nStep-by-Step Implementation:\n\n1. Add navigationDestination Modifier\nIf NavigationStack is in SessionsView, add after the List view.\nIf NavigationStack is in parent view, add there.\n\nExample placement in SessionsView:\nAdd after the closing brace of the Group/List, before .navigationTitle\n\n2. Implement the Modifier\n.navigationDestination(for: UUID.self) { sessionId in\n  // Lookup session by UUID\n  // Create ConversationView if session exists\n}\n\n3. Session Lookup Strategy\nInside the closure, you need to find the session with matching UUID from the @FetchRequest results.\n\nOption A - Direct lookup from sessions FetchedResults:\nif let session = sessions.first(where: { dollarsign-0.id == sessionId }) {\n  ConversationView(session: session, client: client, voiceOutput: voiceOutput, settings: settings)\n}\n\nOption B - Fresh CoreData fetch:\nFetch session from viewContext using CDSession.fetchSession(id: sessionId)\n\nChoose based on design decision. Option A is simpler and reuses existing @FetchRequest.\n\n4. Handle Missing Session Case\nWhat if session was deleted or does not exist?\nAdd an else clause to handle this:\n\nelse {\n  SessionNotFoundView(sessionId: sessionId)\n}\n\nCreate a simple SessionNotFoundView:\nstruct SessionNotFoundView: View {\n  let sessionId: UUID\n  var body: some View {\n    VStack {\n      Text(\"Session not found\")\n      Text(sessionId.uuidString).font(.caption)\n      // Navigation back button will appear automatically\n    }\n  }\n}\n\n5. Complete Implementation Example\n.navigationDestination(for: UUID.self) { sessionId in\n  if let session = sessions.first(where: { dollarsign-0.id == sessionId }) {\n    ConversationView(session: session, client: client, voiceOutput: voiceOutput, settings: settings)\n  } else {\n    SessionNotFoundView(sessionId: sessionId)\n  }\n}\n\n6. Test Navigation\nBuild and run the app:\n- Tap a session in the list\n- Should navigate to ConversationView\n- Navigation should stay stable (no whiplash)\n- Back button should work\n- Try opening multiple sessions in sequence\n\nSuccess criteria:\n- navigationDestination implemented for UUID type\n- Session lookup working correctly\n- ConversationView renders with correct session\n- Missing session case handled gracefully\n- Navigation stable during CoreData updates\n- No whiplash when opening sessions\n- All navigation flows working correctly","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.521225-05:00","updated_at":"2025-10-26T01:01:31.521225-05:00","closed_at":"2025-10-20T21:23:39.491301-05:00","dependencies":[{"issue_id":"voice-code-194","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-26T01:01:31.748916-05:00","created_by":"auto-import"},{"issue_id":"voice-code-194","depends_on_id":"voice-code-193","type":"blocks","created_at":"2025-10-26T01:01:31.749368-05:00","created_by":"auto-import"}]}
{"id":"voice-code-195","title":"Write tests for ID-based navigation stability","description":"Context: Write comprehensive tests to verify that ID-based navigation remains stable when CoreData updates and re-sorts sessions.\n\nTest File:\nCreate: ios/VoiceCodeTests/NavigationStabilityTests.swift\n\nTest Purpose:\nVerify that unlike the old position-based navigation, ID-based navigation does not break when the underlying sessions array re-sorts during active navigation.\n\nTest 1: Navigation Stability During Session Update\nSimulate the original whiplash scenario:\n1. Setup: Create test environment with NavigationPath and sessions\n2. Navigate to a session (append UUID to NavigationPath)\n3. Simulate session_history update that changes lastModified\n4. Verify NavigationPath still contains the same UUID\n5. Verify destination view can still resolve the session\n\nThis test proves that updating lastModified does not break navigation anymore.\n\nTest 2: Navigation with Session Re-ordering\n1. Setup: Create 5 sessions with different lastModified times\n2. Navigate to session in middle of list (position 2)\n3. Update another session lastModified to move it above current session\n4. Verify navigation destination still resolves correctly\n5. Verify no navigation pop occurs\n\nTest 3: Session Lookup Performance\n1. Create 100 sessions in CoreData\n2. Navigate to session by UUID\n3. Measure time to resolve session in navigationDestination\n4. Verify lookup completes in under 100ms\n\nTest 4: Missing Session Handling\n1. Create NavigationPath with UUID that does not exist in CoreData\n2. Attempt to resolve destination\n3. Verify graceful error handling (SessionNotFoundView appears)\n4. Verify no crash occurs\n\nTest 5: Multiple Navigation and Back\n1. Navigate to session A\n2. Navigate back\n3. Navigate to session B\n4. Navigate back\n5. Navigate to session A again\n6. Verify all transitions work correctly\n\nTest 6: Session Deletion During Navigation\n1. Navigate to session A\n2. While on ConversationView, delete session A from another context\n3. Navigate back\n4. Verify session no longer appears in list\n5. Verify no crash occurs\n\nTesting Approach:\nUse XCTest with ViewInspector or SwiftUI testing to verify navigation state. May need to expose NavigationPath for testing via environment or test helpers.\n\nMock Data Setup:\nCreate helper functions to:\n- Generate test sessions with specific UUIDs and timestamps\n- Simulate CoreData updates\n- Create test NavigationPath states\n\nSuccess criteria:\n- All 6 tests written and passing\n- Tests verify navigation stability during CoreData changes\n- Tests cover edge cases (missing session, deletion, re-ordering)\n- Performance test validates efficient session lookup\n- Tests would fail with old position-based navigation (proving fix works)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.521751-05:00","updated_at":"2025-10-26T01:01:31.521751-05:00","closed_at":"2025-10-20T21:27:38.585876-05:00","dependencies":[{"issue_id":"voice-code-195","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-26T01:01:31.749865-05:00","created_by":"auto-import"},{"issue_id":"voice-code-195","depends_on_id":"voice-code-194","type":"blocks","created_at":"2025-10-26T01:01:31.750725-05:00","created_by":"auto-import"}]}
{"id":"voice-code-196","title":"Manual testing: Verify navigation stability across all scenarios","description":"Context: Comprehensive manual testing of the ID-based navigation refactor to ensure all functionality works and whiplash is eliminated.\n\nTest Environment Setup:\n1. Build and install app on iOS device or simulator (iOS 16+ required)\n2. Connect to backend server with multiple sessions\n3. Ensure at least 10 sessions exist with varied lastModified times\n4. Have sessions from multiple working directories\n\nTest Scenarios:\n\nScenario 1: Basic Navigation (Regression Test)\n1. Tap any session in the list\n2. Verify ConversationView opens\n3. Verify conversation history loads\n4. Verify back button returns to list\n5. Verify session still in same position after return\nRepeat for 5 different sessions.\n\nScenario 2: No Whiplash on First Open (Primary Fix)\n1. Force quit app and restart\n2. Wait for session list to load\n3. Note position of a session in middle of list\n4. Tap that session (first open since app launch)\n5. Verify ConversationView opens and STAYS open (no whiplash)\n6. Verify history loads without navigation disruption\n7. Return to list\n8. Verify session position unchanged\nThis is the key test - should not exhibit the original bug.\n\nScenario 3: Navigation During Backend Updates\n1. Open a session\n2. While viewing conversation, send a message from terminal (backend)\n3. Verify new message appears in iOS app\n4. Verify navigation remains stable (no pop)\n5. Verify session moves to top of list when you go back (expected)\n\nScenario 4: Rapid Session Switching\n1. Tap session A\n2. Immediately tap back\n3. Tap session B\n4. Immediately tap back\n5. Tap session C\nVerify all transitions smooth, no crashes, no animation glitches.\n\nScenario 5: Session Deletion\n1. Open session A\n2. Navigate back to list\n3. Swipe to delete session A\n4. Verify session removed from list\n5. Verify no crash or navigation issues\n\nScenario 6: Session Creation\n1. Create new session from SessionsView\n2. Verify new session appears at top of list\n3. Tap new session\n4. Verify navigation works\n5. Send a message\n6. Verify everything functions correctly\n\nScenario 7: Working Directory Groups\n1. Verify sessions grouped by working directory\n2. Tap session from different working directory groups\n3. Verify navigation works for all groups\n4. Verify group order updates correctly\n\nScenario 8: Background/Foreground Transitions\n1. Open a session\n2. Background the app (home button)\n3. Wait 10 seconds\n4. Bring app to foreground\n5. Verify still on ConversationView\n6. Verify no navigation disruption\n\nScenario 9: Large Session List Performance\nIf you have 50+ sessions:\n1. Scroll through entire list\n2. Tap session near bottom\n3. Verify navigation is responsive\n4. Measure time from tap to ConversationView appearing\nShould be under 500ms.\n\nScenario 10: Edge Cases\n1. Session with 0 messages (if any exist)\n2. Session with 100+ messages\n3. Session with very long name\n4. Session with special characters in working directory path\n\nIssues to Watch For:\n- Navigation popping unexpectedly\n- Whiplash or flickering\n- Crashes\n- Slow navigation (over 1 second delay)\n- Sessions appearing in wrong order\n- Missing sessions\n- Back button not working\n- Toolbar buttons not functioning\n\nSuccess criteria:\n- All 10 scenarios pass without issues\n- No whiplash observed in any scenario\n- Navigation smooth and responsive\n- No regressions in existing functionality\n- Performance acceptable (under 500ms navigation)\n- Edge cases handled gracefully","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.522353-05:00","updated_at":"2025-10-26T01:01:31.522353-05:00","closed_at":"2025-10-20T21:27:49.235092-05:00","dependencies":[{"issue_id":"voice-code-196","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-26T01:01:31.751222-05:00","created_by":"auto-import"},{"issue_id":"voice-code-196","depends_on_id":"voice-code-194","type":"blocks","created_at":"2025-10-26T01:01:31.751739-05:00","created_by":"auto-import"},{"issue_id":"voice-code-196","depends_on_id":"voice-code-195","type":"blocks","created_at":"2025-10-26T01:01:31.752177-05:00","created_by":"auto-import"}]}
{"id":"voice-code-197","title":"Performance profiling: Measure navigation and session lookup performance","description":"Context: Profile the performance of ID-based navigation to ensure session lookup by UUID is efficient and does not introduce performance regressions.\n\nTools to Use:\n1. Xcode Instruments - Time Profiler\n2. Xcode Instruments - Allocations\n3. SwiftUI View Body profiling\n4. Manual timing measurements\n\nPerformance Metrics to Measure:\n\nMetric 1: Session Lookup Time\nMeasure time to find session by UUID in navigationDestination closure.\n- Test with 10 sessions\n- Test with 100 sessions\n- Test with 500 sessions\n\nTarget: Under 10ms for 100 sessions, under 50ms for 500 sessions.\n\nImplementation: Add os_signpost markers around session lookup code.\n\nMetric 2: Navigation Transition Time\nMeasure time from NavigationLink tap to ConversationView appearing.\n- User taps session\n- Time until ConversationView onAppear fires\n\nTarget: Under 300ms on device, under 100ms on simulator.\n\nMetric 3: Memory Usage During Navigation\nUse Instruments Allocations to measure:\n- Memory before navigation\n- Memory after navigation\n- Memory after returning to list\n\nTarget: No memory leaks, reasonable memory growth (under 10MB per navigation).\n\nMetric 4: FetchRequest Performance\nMeasure @FetchRequest update time when sessions re-sort:\n- Trigger CoreData update that changes sort order\n- Measure time for @FetchRequest to reflect changes\n\nTarget: Under 50ms for 100 sessions.\n\nProfiling Procedure:\n\n1. Setup Large Dataset\nCreate test database with 100+ sessions using a script or test helper.\n\n2. Run Time Profiler\n- Open Xcode Instruments\n- Select Time Profiler\n- Run app\n- Navigate to multiple sessions\n- Look for bottlenecks in session lookup\n\n3. Run Allocations Profiler\n- Open Xcode Instruments\n- Select Allocations\n- Run app\n- Navigate to sessions and back multiple times\n- Check for memory leaks or excessive allocations\n\n4. Add Performance Tests\nCreate XCTestCase for performance:\n- testSessionLookupPerformance()\n- testNavigationPerformance()\n\nUse XCTest measure blocks:\nmeasure {\n  // Session lookup code\n}\n\n5. Compare with Baseline\nIf possible, measure old position-based navigation for comparison.\nDocument any performance differences.\n\nPerformance Optimization Opportunities:\n\nIf session lookup is slow:\n- Consider caching UUID to session mapping\n- Use Dictionary instead of linear search through FetchedResults\n- Optimize CoreData fetch request\n\nIf navigation is slow:\n- Profile ConversationView initialization\n- Check for unnecessary view updates\n- Optimize @FetchRequest predicates\n\nDeliverables:\n\n1. Performance Report\nDocument for each metric:\n- Baseline measurement\n- Target threshold\n- Actual measurement\n- Pass/fail status\n\n2. Instruments Screenshots\nCapture key findings from Time Profiler and Allocations.\n\n3. Performance Tests\nAdd to test suite with baseline expectations.\n\n4. Optimization Recommendations\nIf any metrics fail, document recommended optimizations.\n\nSuccess criteria:\n- All performance metrics meet targets\n- No memory leaks detected\n- Performance tests passing\n- No regressions vs old navigation (if measurable)\n- Report documents findings and any concerns","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.522864-05:00","updated_at":"2025-10-26T01:01:31.522864-05:00","closed_at":"2025-10-20T21:27:49.248777-05:00","dependencies":[{"issue_id":"voice-code-197","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-26T01:01:31.752606-05:00","created_by":"auto-import"},{"issue_id":"voice-code-197","depends_on_id":"voice-code-194","type":"blocks","created_at":"2025-10-26T01:01:31.753186-05:00","created_by":"auto-import"}]}
{"id":"voice-code-198","title":"Documentation: Update architecture docs and add migration guide","description":"Context: Document the new ID-based navigation architecture and create migration guide for future developers.\n\nDocumentation to Create/Update:\n\n1. Architecture Documentation\nCreate or update: docs/ios-navigation-architecture.md\n\nContent should include:\n- Overview of NavigationStack and NavigationPath pattern\n- Why we use ID-based navigation instead of position-based\n- Diagram showing navigation flow from SessionsView to ConversationView\n- How session lookup works in navigationDestination\n- How to add new navigation destinations in the future\n- Best practices for SwiftUI navigation in this codebase\n\n2. Migration Guide\nCreate: docs/navigation-migration-guide.md\n\nDocument the migration from old to new pattern:\n- What changed and why\n- Before/after code examples\n- How to migrate other navigation flows to this pattern\n- Common pitfalls to avoid\n- Testing checklist for navigation changes\n\n3. Code Comments\nAdd comprehensive comments in:\n\nSessionsView.swift:\n- Comment above NavigationStack explaining its purpose\n- Comment above navigationDestination explaining session lookup\n- Comment explaining why we use UUID values instead of destination\n\nVoiceCodeApp.swift (or wherever NavigationStack root is):\n- Comment explaining navigation hierarchy\n- Comment on NavigationPath state management\n\n4. Update Session List Refresh Issue Doc\nUpdate: docs/session-list-refresh-issue.md\n\nAdd new section:\n- Document that Epic voice-code-188 implemented the long-term fix\n- Explain how ID-based navigation solved the root cause\n- Mark the issue as resolved\n- Keep original problem description for historical reference\n\n5. Developer Onboarding Guide\nUpdate: docs/developer-guide.md (create if does not exist)\n\nAdd section on Navigation:\n- How our navigation is structured\n- How to navigate programmatically\n- How to add new navigation destinations\n- How to test navigation changes\n\n6. Inline Code Documentation\nAdd doc comments to key components:\n\nNavigationManager class (if created):\nDocument all public methods and properties.\n\nSessionNotFoundView:\nDocument when this appears and how to prevent it.\n\nnavigationDestination closure:\nAdd inline comments explaining the lookup logic.\n\n7. Performance Considerations\nDocument in architecture doc:\n- Session lookup performance characteristics\n- When to optimize (threshold of sessions)\n- Alternative lookup strategies if needed at scale\n\n8. Future Enhancements\nDocument potential future improvements:\n- Deep linking support (URL schemes)\n- State restoration across app restarts\n- NavigationPath persistence\n- Multi-level navigation hierarchies\n\nDocumentation Review Checklist:\n- All new patterns documented\n- Code examples accurate and tested\n- Diagrams clear and helpful\n- Migration guide complete\n- No outdated information\n- Links between related docs\n- Formatted consistently\n\nDeliverables:\n1. ios-navigation-architecture.md created/updated\n2. navigation-migration-guide.md created\n3. session-list-refresh-issue.md updated\n4. Code comments added to all key files\n5. Developer guide updated\n6. All documentation reviewed for accuracy\n\nSuccess criteria:\n- New developer can understand navigation architecture from docs\n- Migration guide enables porting pattern to other navigation flows\n- All decisions documented with rationale\n- Code comments explain non-obvious implementation details\n- Documentation accurate and up-to-date","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.523258-05:00","updated_at":"2025-10-26T01:01:31.523258-05:00","closed_at":"2025-10-20T21:28:52.635752-05:00","dependencies":[{"issue_id":"voice-code-198","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-26T01:01:31.753691-05:00","created_by":"auto-import"},{"issue_id":"voice-code-198","depends_on_id":"voice-code-194","type":"blocks","created_at":"2025-10-26T01:01:31.754258-05:00","created_by":"auto-import"},{"issue_id":"voice-code-198","depends_on_id":"voice-code-195","type":"blocks","created_at":"2025-10-26T01:01:31.754755-05:00","created_by":"auto-import"},{"issue_id":"voice-code-198","depends_on_id":"voice-code-196","type":"blocks","created_at":"2025-10-26T01:01:31.755752-05:00","created_by":"auto-import"}]}
{"id":"voice-code-199","title":"Cleanup: Remove deprecated position-based navigation code and comments","description":"Context: Clean up any deprecated code, remove obsolete comments, and ensure codebase reflects the new ID-based navigation pattern consistently.\n\nCode Cleanup Tasks:\n\n1. Remove Unused Navigation State\nSearch for any @State variables related to old navigation pattern:\n- @State var selectedSession\n- @State var isNavigationActive\n- Tag/selection based NavigationLink state\n\nIf found and no longer used, remove them.\n\n2. Remove Commented-Out Code\nSearch for commented-out NavigationLink or NavigationView code that was part of the old implementation. Remove if no longer needed.\n\n3. Update Variable Names\nEnsure variable names reflect new pattern:\n- navigationPath (not navigationState or similar)\n- sessionId (not sessionIndex)\n\n4. Remove Obsolete Helpers\nCheck for any helper functions that were specific to position-based navigation and are no longer needed.\n\n5. Update Imports\nRemove any imports that are no longer used after refactor:\n- Check for unused Combine imports\n- Check for unused CoreData imports in navigation-specific files\n\n6. Clean Up TODO Comments\nSearch for TODO comments related to navigation issues:\n- TODOs about fixing whiplash\n- TODOs about improving navigation stability\n- Mark as resolved or remove if completed\n\n7. Verify NavigationView Removal\nEnsure no files still use deprecated NavigationView:\nSearch codebase for NavigationView usage (should be NavigationStack now).\n\n8. Consistent Naming Conventions\nEnsure all navigation-related code uses consistent naming:\n- Methods: navigateToSession, not goToSession or showSession\n- Variables: navigationPath, not navPath or path\n- Comments: Use NavigationStack, not navigation stack or nav stack\n\n9. Remove Debug Logging\nRemove any debug print statements added during refactor:\n- Search for print statements in SessionsView, ConversationView\n- Keep important logging, remove temporary debug logs\n\n10. Code Formatting\nRun SwiftFormat or SwiftLint to ensure consistent formatting:\n- Proper indentation\n- Consistent spacing\n- Line length limits\n\n11. Asset Cleanup\nCheck if any navigation-related assets are unused:\n- Images for old navigation patterns\n- Deprecated colors or styles\n\n12. Dependency Cleanup\nReview Package.swift or Podfile:\n- Remove any dependencies added for old navigation pattern\n- Ensure no unused navigation libraries\n\nFiles to Review:\n- SessionsView.swift\n- ConversationView.swift\n- VoiceCodeApp.swift\n- NavigationManager.swift (if created)\n- Any other files modified during refactor\n\nSearch Patterns to Use:\ngit grep NavigationView\ngit grep selectedSession\ngit grep TODO navigation\ngit grep FIXME navigation\ngit grep print.*navigation (for debug logs)\n\nCleanup Verification:\n1. Full text search for old navigation patterns\n2. Build and run app - no warnings\n3. No unused imports or variables\n4. All TODOs resolved or tracked in Beads\n5. Code passes linter checks\n\nSuccess criteria:\n- No deprecated NavigationView usage\n- No unused navigation state variables\n- No commented-out old navigation code\n- All TODO/FIXME navigation comments addressed\n- Code formatting consistent\n- No unnecessary debug logging\n- Clean git diff (only intentional changes)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.523681-05:00","updated_at":"2025-10-26T01:01:31.523681-05:00","closed_at":"2025-10-20T21:32:45.754101-05:00","dependencies":[{"issue_id":"voice-code-199","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-26T01:01:31.75655-05:00","created_by":"auto-import"},{"issue_id":"voice-code-199","depends_on_id":"voice-code-194","type":"blocks","created_at":"2025-10-26T01:01:31.757519-05:00","created_by":"auto-import"},{"issue_id":"voice-code-199","depends_on_id":"voice-code-196","type":"blocks","created_at":"2025-10-26T01:01:31.758421-05:00","created_by":"auto-import"}]}
{"id":"voice-code-200","title":"Session updates for sessions outside top-50 are silently dropped","description":"Problem: Backend broadcasts session_updated messages to all connected clients whenever any session file changes. However, iOS only receives the top 50 sessions (sorted by last_modified) in the initial session_list. If a session outside the top-50 receives an update, iOS doesn't have it in CoreData and silently drops the update with 'Session not found for update' warning.\n\nImpact: Sessions that become active after initial connection won't appear in the iOS UI until app reconnects and gets fresh session_list. Users won't see sessions that move into relevance via updates.\n\nExample scenario:\n1. iOS connects, receives top 50 sessions (by last_modified)\n2. Session #51 receives new messages, becomes most recently modified\n3. Backend broadcasts session_updated for session #51\n4. iOS logs warning and ignores it (doesn't have session #51)\n5. Session #51 remains invisible until app reconnects\n\nRoot cause: SessionSyncManager.swift:249-252 guard statement returns early if session not found in CoreData.\n\nSolution approach: Create session from session_updated message if it doesn't exist. We have session-id and messages - can derive metadata (last-modified=now, message-count, preview). Name and working-directory will be incomplete initially but will sync on next session_list refresh.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-10-26T01:01:31.524101-05:00","updated_at":"2025-10-26T01:01:31.524101-05:00","closed_at":"2025-10-22T17:13:44.215047-05:00"}
{"id":"voice-code-201","title":"Modify handleSessionUpdated to create missing sessions","description":"Modify SessionSyncManager.handleSessionUpdated() to create sessions that don't exist in CoreData instead of returning early.\n\nLocation: ios/VoiceCode/Managers/SessionSyncManager.swift:240-252\n\nCurrent behavior: guard statement returns early if session not found, logging warning and dropping the update.\n\nRequired change: Replace guard with conditional creation. If session exists, use it. If not, create new CDSession with: id from sessionId parameter, empty backendName and workingDirectory (will sync later), markedDeleted=false, unreadCount=0, isLocallyCreated=false.\n\nThe rest of handleSessionUpdated already handles deriving metadata: lastModified=Date(), messageCount increment, preview extraction, and message creation.\n\nTesting: Verify session appears in UI when created from update, metadata syncs on next session_list, no duplicates, existing sessions work normally.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.524507-05:00","updated_at":"2025-10-26T01:01:31.524507-05:00","closed_at":"2025-10-20T21:45:44.528491-05:00","dependencies":[{"issue_id":"voice-code-201","depends_on_id":"voice-code-200","type":"blocks","created_at":"2025-10-26T01:01:31.759212-05:00","created_by":"auto-import"}]}
{"id":"voice-code-202","title":"Write tests for session creation from session_updated","description":"Write tests in SessionSyncManagerTests.swift to verify session creation from session_updated messages.\n\nTest cases to add:\n\n1. Test session_updated creates missing session:\n   - Clear CoreData, ensure no sessions exist\n   - Call handleSessionUpdated with session-id not in database\n   - Verify CDSession created with correct id, messages added\n   - Verify metadata: lastModified set to now, messageCount matches messages.count\n   - Verify backendName and workingDirectory are empty strings\n\n2. Test created session syncs metadata on next session_list:\n   - Create session via handleSessionUpdated (empty name/workingDirectory)\n   - Call handleSessionList with full metadata for same session-id\n   - Verify backendName and workingDirectory populated correctly\n\n3. Test no duplicate sessions created:\n   - Call handleSessionUpdated twice for same session-id\n   - Verify only one CDSession exists in CoreData\n   - Verify messageCount reflects all messages\n\n4. Test existing session flow unchanged:\n   - Create session via handleSessionList first\n   - Call handleSessionUpdated for same session-id\n   - Verify session updated (not created)\n   - Verify metadata preserved\n\n5. Test unread count behavior for created sessions:\n   - Create session via handleSessionUpdated (not active)\n   - Verify unreadCount incremented correctly\n   - Make session active, send another update\n   - Verify unreadCount not incremented\n\nLocation: ios/VoiceCodeTests/SessionSyncManagerTests.swift","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.524899-05:00","updated_at":"2025-10-26T01:01:31.524899-05:00","closed_at":"2025-10-22T17:03:20.109939-05:00","dependencies":[{"issue_id":"voice-code-202","depends_on_id":"voice-code-201","type":"blocks","created_at":"2025-10-26T01:01:31.760122-05:00","created_by":"auto-import"}]}
{"id":"voice-code-203","title":"Add integration test for session appearing after update","description":"Add integration test verifying complete user flow: session outside top-50 becomes visible after receiving update.\n\nTest scenario:\n1. Mock backend with 51+ sessions\n2. Connect iOS client, receive session_list with top 50 (sorted by last_modified)\n3. Verify session #51 not in CoreData\n4. Simulate backend sending session_updated for session #51 (with new messages)\n5. Verify session #51 now appears in CoreData\n6. Verify session appears in SessionsView UI\n7. Verify incomplete metadata (empty name/workingDirectory)\n8. Reconnect and receive fresh session_list\n9. Verify metadata now complete\n\nThis test validates the full fix end-to-end, ensuring sessions moving into relevance via updates appear correctly.\n\nConsider adding to: ios/VoiceCodeTests/SessionSyncManagerTests.swift or creating new integration test file.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.52528-05:00","updated_at":"2025-10-26T01:01:31.52528-05:00","closed_at":"2025-10-23T19:09:28.445924-05:00","dependencies":[{"issue_id":"voice-code-203","depends_on_id":"voice-code-201","type":"blocks","created_at":"2025-10-26T01:01:31.761355-05:00","created_by":"auto-import"}]}
{"id":"voice-code-204","title":"Consider deriving session name from first message","description":"Enhancement: When creating session from session_updated, derive a meaningful name from the first message instead of leaving backendName empty.\n\nCurrent approach: Set backendName to empty string, wait for session_list to provide name.\n\nProposed enhancement: Extract first user message text and generate name similar to backend logic. This provides better UX - session has meaningful name immediately instead of showing empty/default.\n\nImplementation:\n- In handleSessionUpdated when creating new session\n- Find first message with role=user in messages array\n- Extract text and take first ~50 chars or first sentence\n- Set session.backendName to derived name\n- Still allow session_list to override with canonical backend name\n\nBenefits:\n- Better immediate UX when session appears\n- Consistent with backend naming convention\n- Falls back gracefully if no user message found\n\nConsideration: May not be necessary if session_list sync happens quickly. Evaluate priority based on real-world reconnection frequency.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-10-26T01:01:31.525676-05:00","updated_at":"2025-10-26T01:01:31.525676-05:00","closed_at":"2025-10-23T19:09:45.993876-05:00","dependencies":[{"issue_id":"voice-code-204","depends_on_id":"voice-code-201","type":"blocks","created_at":"2025-10-26T01:01:31.762449-05:00","created_by":"auto-import"}]}
{"id":"voice-code-205","title":"Document session sync behavior in protocol spec","description":"Update STANDARDS.md WebSocket protocol documentation to describe session sync behavior, especially edge cases.\n\nAdd to STANDARDS.md protocol section:\n\n1. Session Discovery section:\n   - session_list returns top 50 sessions sorted by last_modified descending\n   - Clients receive updates for ALL sessions via session_updated broadcasts\n   - Sessions outside top-50 may appear via session_updated messages\n   - Clients should create sessions from session_updated if not in local store\n\n2. Session Metadata Completeness:\n   - session_list provides complete metadata (id, name, working_directory, last_modified, message_count)\n   - session_updated provides id and messages only\n   - Clients creating sessions from session_updated should use placeholder metadata\n   - Metadata will sync on next session_list or reconnection\n\n3. Edge Cases:\n   - Session outside top-50 receives update -\u003e Client creates with partial metadata\n   - Session deleted from filesystem -\u003e session_deleted broadcast removes from all clients\n   - Session moves into top-50 -\u003e Appears in next session_list with complete metadata\n\nLocation: /Users/travisbrown/code/mono/active/voice-code/STANDARDS.md (WebSocket Protocol section)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.52605-05:00","updated_at":"2025-10-26T01:01:31.52605-05:00","closed_at":"2025-10-23T19:09:19.629532-05:00","dependencies":[{"issue_id":"voice-code-205","depends_on_id":"voice-code-200","type":"blocks","created_at":"2025-10-26T01:01:31.763689-05:00","created_by":"auto-import"}]}
{"id":"voice-code-206","title":"Add copy session ID to clipboard feature","description":"Add ability to copy session UUID to clipboard via long-press interaction. Consider two possible locations:\n1. Session list view - long-press on a session\n2. Session detail view - long-press on a message\n\nDeveloper should evaluate UX of both approaches and choose the most appropriate implementation. Feature should provide haptic feedback and visual confirmation when ID is copied.","design":"## Final Implementation\n\nImplemented copy session ID in **both locations**:\n1. Session list view - context menu (long-press on session row)  \n2. Conversation view - toolbar button (number icon)\n\n## Key Design Change\n**Removed navigation title from conversation view** to reduce toolbar crowding and improve visual clarity. Title was already truncated to a few letters, so removing it provides cleaner UI with more focus on the action buttons.\n\n## Features\n- Context menu on long-press in session list\n- Toolbar button (number icon) in conversation view\n- Haptic feedback (success notification)\n- Visual confirmation banner (2 seconds)\n- Lowercase UUID format (per STANDARDS.md)\n- 5 new tests in CopyFeaturesTests","notes":"## Final Implementation\n\nImplemented copy session ID in **both locations**:\n1. Session list view - context menu (long-press on session row)  \n2. Conversation view - toolbar button (number icon)\n\n**Design Changes:**\n- Removed navigation title from conversation view to reduce toolbar crowding\n- Title was already truncated to a few letters, so removing it provides more visual clarity\n- Toolbar now has 6 action buttons but no competing title text\n\n**Rationale:**\n- Session list context menu: Quick access without opening session\n- Conversation view toolbar: Available while actively working in a session\n- Having copy in both locations provides flexibility for different workflows\n- Session ID typically needed for debugging/logging, useful from either context\n\n## Features Implemented\n- Context menu with \"Copy Session ID\" option on long-press in session list\n- Toolbar button (number icon) in conversation view\n- Haptic feedback (success notification) in both locations\n- Visual confirmation banner (2 second display) in both locations\n- Lowercase UUID format (per STANDARDS.md)\n- Comprehensive test coverage (5 new tests in CopyFeaturesTests)\n\n## Tests Added\n1. testCopySessionIDToClipboard - Verifies basic clipboard copy\n2. testCopySessionIDIsLowercase - Ensures lowercase format\n3. testCopySessionIDFormat - Validates UUID format with regex\n4. testCopyDifferentSessionIDs - Tests sequential copies overwrite properly\n5. testCopySessionIDPreservesFullUUID - Validates full 36-char UUID preservation\n\n## Files Modified\n- ios/VoiceCode/Views/SessionsForDirectoryView.swift: Added context menu and copy function\n- ios/VoiceCode/Views/ConversationView.swift: Added toolbar button, removed title, added copy function\n- ios/VoiceCodeTests/CopyFeaturesTests.swift: Added 5 session ID copy tests","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-26T01:01:31.526424-05:00","updated_at":"2025-10-26T01:01:31.526424-05:00","closed_at":"2025-10-22T21:48:38.089912-05:00"}
{"id":"voice-code-207","title":"Sessions don't re-sort when receiving updates","description":"Problem: When a session receives new messages via session_updated, it becomes visible (after voice-code-201 fix) but doesn't bubble to the top of the session list. The session list sorting is based on lastModified from the initial session_list, not updated dynamically as new messages arrive.\n\nImpact: Sessions with new activity remain buried in the list until the app reconnects or manually refreshes. User has to scroll through potentially many sessions to find the one with recent activity.\n\nCurrent behavior:\n- Session list is sorted by lastModified descending\n- SessionSyncManager.handleSessionUpdated updates session.lastModified = Date()\n- But SwiftUI @FetchRequest doesn't automatically re-sort when lastModified changes\n- Session stays in its original position until view refreshes\n\nExpected behavior:\n- When session receives session_updated message, it should jump to the top of the list\n- Most recently active sessions should always be at the top\n\nRoot cause: FetchRequest in SessionsView.swift uses CDSession.fetchActiveSessions() which sorts by lastModified, but SwiftUI doesn't automatically re-sort when that property changes in CoreData.\n\nSolution approach:\n1. Ensure lastModified updates trigger FetchRequest refresh (may need to mark as @objc dynamic or check fetch request cache policy)\n2. Verify background context saves properly propagate to view context\n3. Consider adding explicit context.refresh() or notification observer\n4. Test that sessions visually re-sort when receiving updates\n\nRelated: voice-code-200 (session visibility), voice-code-201 (session creation from updates)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-26T01:01:31.526895-05:00","updated_at":"2025-10-26T01:01:31.526895-05:00","closed_at":"2025-10-23T19:10:22.379554-05:00"}
{"id":"voice-code-208","title":"3-tier navigation: Directories → Sessions → Conversations","description":"Epic: Restructure iOS app navigation from 2-tier to 3-tier for better session organization and discovery.\n\nCurrent UX (2-tier):\n- Sessions list (all sessions grouped by directory, all expanded)\n- Click session → Conversation view\n\nProposed UX (3-tier):\n- Directories list (sorted by most recent activity)\n- Click directory → Sessions list (for that directory only)\n- Click session → Conversation view\n\nUser Problem:\nWith many sessions across multiple projects, the current flat list is overwhelming. Users need to scroll through potentially 50+ sessions to find what they want. Grouping by directory with drill-down navigation provides better information architecture.\n\nBenefits:\n- Clearer mental model: \"Which project?\" → \"Which session?\" → \"What messages?\"\n- Less overwhelming: See 5-10 directories instead of 50 sessions\n- Faster navigation: Unread badges at directory level show where attention is needed\n- Better use of screen space: Each level optimized for its content\n\nDesign Specifications:\n\nDirectory Row Format:\n  📁 voice-code                                [2]\n  /Users/travis/code/mono/active/voice-code\n  3 sessions • 2 minutes ago\n\n- Directory name extracted from path (last component)\n- Full path in secondary text\n- Session count + relative timestamp\n- Aggregate unread badge (red capsule)\n- Folder icon for visual consistency\n\nNavigation Model:\n- Push navigation (NavigationLink) for native iOS feel\n- Natural back button at each level\n- State: Remember location during session, reset to directories on relaunch\n- After creating session: Navigate directly to conversation\n- After deleting session: Pop back to sessions list\n\nNew Session Creation:\n- Top level (Directories): + button → choose directory or enter custom\n- Directory level (Sessions): + button → pre-filled with current directory\n- Toolbar consistent across all levels: Refresh, +, Settings\n\nEmpty States:\n- No directories: \"No sessions yet - create one to get started\"\n- No sessions in directory: \"No sessions in [path] yet\"\n\nUnread Badges:\n- Directory level: Aggregate unread across all sessions\n- Session level: Individual session unread count\n- Matches iOS Mail/Messages pattern\n\nPull-to-Refresh:\n- Available at all navigation levels\n- Haptic feedback\n- \"Updated just now\" confirmation\n\nCurrent Code Structure:\n- SessionsView.swift: Contains SessionsListView (current 2-tier implementation)\n- Uses @FetchRequest with CDSession.fetchActiveSessions()\n- Already groups sessions by workingDirectory\n- CDSession model has: id, displayName, workingDirectory, lastModified, unreadCount, messageCount\n\nRelated Issues:\n- voice-code-207: Sessions need to re-sort on updates (affects all levels)\n- voice-code-200: Session visibility improvements (completed)","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-10-26T01:01:31.527499-05:00","updated_at":"2025-10-26T01:01:31.527499-05:00","closed_at":"2025-10-23T19:09:36.527444-05:00"}
{"id":"voice-code-209","title":"Create DirectoryListView for top-level navigation","description":"Create the top-level Directories view that shows working directories sorted by most recent activity.\n\nLocation: Create new file ios/VoiceCode/Views/DirectoryListView.swift\n\nRequirements:\n\n1. Data Model:\n   - Compute list of unique working directories from CDSession entities\n   - For each directory, calculate:\n     * Total session count\n     * Aggregate unread count (sum of all session.unreadCount)\n     * Most recent lastModified timestamp across all sessions\n     * Directory name (last path component, e.g., \"voice-code\" from \"/Users/travis/code/voice-code\")\n   - Sort directories by most recent lastModified descending\n\n2. Directory Row UI (DirectoryRowContent view):\n   - Line 1: HStack with folder icon (SF Symbol \"folder.fill\") + directory name (headline font) + unread badge (if \u003e 0)\n   - Line 2: Full working directory path (caption font, secondary color, lineLimit: 1)\n   - Line 3: HStack with session count + bullet + relative timestamp (caption2 font, secondary color)\n   \n   Example:\n   📁 voice-code                                [2]\n   /Users/travis/code/mono/active/voice-code\n   3 sessions • 2 minutes ago\n\n3. Unread Badge:\n   - Only show if aggregate unread count \u003e 0\n   - Red capsule background, white text, bold font\n   - Same styling as session unread badges\n\n4. Navigation:\n   - Use NavigationLink(value:) to push to SessionsForDirectoryView\n   - Pass working directory path as navigation value\n   - Navigation destination shows sessions filtered to that directory\n\n5. Toolbar:\n   - Refresh button (arrow.clockwise) - calls client.requestSessionList()\n   - Plus button - shows NewSessionView sheet\n   - Settings button (gear) - shows settings\n\n6. Empty State:\n   - When no sessions exist at all\n   - Show folder icon (large), \"No sessions yet\", helpful text\n   - Encourage creating first session\n\n7. Pull-to-Refresh:\n   - Use .refreshable modifier\n   - Calls client.requestSessionList()\n   - Shows activity indicator during refresh\n\nImplementation Notes:\n- Use @FetchRequest to get all CDSession entities with fetchActiveSessions()\n- Compute groupedDirectories in a computed property similar to current SessionsListView.groupedSessions\n- Extract directory name using: (path as NSString).lastPathComponent\n- Calculate relative timestamp using RelativeDateTimeFormatter\n- Follow existing code patterns from SessionsListView.swift\n- Use @Environment(\\.managedObjectContext) for CoreData access\n- Inject VoiceCodeClient, AppSettings, VoiceOutputManager via @ObservedObject\n\nTesting:\n- Verify directories sorted by most recent activity\n- Verify unread badges aggregate correctly\n- Verify navigation pushes to correct directory\n- Verify empty state shows when no sessions\n- Verify pull-to-refresh works","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.528018-05:00","updated_at":"2025-10-26T01:01:31.528018-05:00","closed_at":"2025-10-20T23:15:28.476072-05:00","dependencies":[{"issue_id":"voice-code-209","depends_on_id":"voice-code-208","type":"blocks","created_at":"2025-10-26T01:01:31.764712-05:00","created_by":"auto-import"}]}
{"id":"voice-code-210","title":"Create SessionsForDirectoryView for directory-specific sessions","description":"Create the second-tier view that shows sessions for a specific working directory.\n\nLocation: Create new file ios/VoiceCode/Views/SessionsForDirectoryView.swift\n\nPurpose: When user taps a directory in DirectoryListView, show only sessions for that directory.\n\nRequirements:\n\n1. Input Parameters:\n   - workingDirectory: String (the directory path to filter by)\n   - client: VoiceCodeClient (@ObservedObject)\n   - settings: AppSettings (@ObservedObject)\n   - voiceOutput: VoiceOutputManager (@ObservedObject)\n   - @Environment(\\.managedObjectContext) for CoreData\n\n2. Data Fetching:\n   - Create @FetchRequest that filters CDSession by workingDirectory\n   - Use NSPredicate: format: \"workingDirectory == %@ AND markedDeleted == NO\", workingDirectory\n   - Sort by lastModified descending (most recent first)\n   - This ensures only sessions for THIS directory are shown\n\n3. Session Row UI:\n   - Reuse existing CDSessionRowContent component from SessionsView.swift\n   - Shows: session name, session ID prefix, working directory, message count, preview, unread badge\n   - Same visual design as current implementation\n\n4. Navigation:\n   - Use NavigationLink(value: session.id) to push to ConversationView\n   - Navigation destination looks up session by UUID and shows ConversationView\n   - Reuse existing navigation pattern from SessionsView.swift\n\n5. Toolbar:\n   - Refresh button (arrow.clockwise) - calls client.requestSessionList()\n   - Plus button - shows NewSessionView sheet with workingDirectory pre-filled\n   - Settings button (gear) - shows settings\n   - All three buttons in trailing position\n\n6. Navigation Title:\n   - Extract directory name from path: (workingDirectory as NSString).lastPathComponent\n   - Use .navigationTitle(directoryName)\n   - Example: \"voice-code\" instead of full path\n   - Subtitle could show full path in .navigationBarTitleDisplayMode(.large) mode\n\n7. Empty State:\n   - When directory has no sessions\n   - Show tray icon, \"No sessions in [directoryName]\", helpful text\n   - Suggest creating a new session with + button\n\n8. Swipe Actions:\n   - Swipe-to-delete on session rows\n   - Calls deleteSession() method (same logic as current SessionsListView)\n   - Marks session.markedDeleted = true\n   - Sends session_deleted message to backend\n   - Unsubscribes from session\n\n9. Pull-to-Refresh:\n   - Use .refreshable modifier\n   - Calls client.requestSessionList()\n   - Shows activity indicator during refresh\n\n10. Session Deletion Logic:\n    - Copy deleteSession() method from SessionsView.swift\n    - Mark session.markedDeleted = true\n    - Clean up draft via draftManager.cleanupDraft(sessionID:)\n    - Unsubscribe: client.unsubscribe(sessionId:)\n    - Send session_deleted message to backend\n    - Save context\n\nImplementation Notes:\n- This view is very similar to current SessionsListView but filtered to one directory\n- Extract directory name for title: let directoryName = (workingDirectory as NSString).lastPathComponent\n- Pre-fill NewSessionView with workingDirectory when + button tapped\n- Follow existing patterns from SessionsView.swift for consistency\n- Use List with ForEach over filtered sessions\n- NavigationLink should use .navigationDestination(for: UUID.self) pattern\n\nFetchRequest Example:\n@FetchRequest var sessions: FetchedResults\u003cCDSession\u003e\n\ninit(workingDirectory: String, ...) {\n    self.workingDirectory = workingDirectory\n    _sessions = FetchRequest\u003cCDSession\u003e(\n        sortDescriptors: [NSSortDescriptor(keyPath: \\CDSession.lastModified, ascending: false)],\n        predicate: NSPredicate(format: \"workingDirectory == %@ AND markedDeleted == NO\", workingDirectory),\n        animation: .default\n    )\n}\n\nTesting:\n- Verify only sessions for specified directory appear\n- Verify navigation to conversation works\n- Verify + button pre-fills directory\n- Verify swipe-to-delete works\n- Verify empty state shows correctly\n- Verify pull-to-refresh updates list","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.528468-05:00","updated_at":"2025-10-26T01:01:31.528468-05:00","closed_at":"2025-10-20T23:15:28.491872-05:00","dependencies":[{"issue_id":"voice-code-210","depends_on_id":"voice-code-209","type":"blocks","created_at":"2025-10-26T01:01:31.765798-05:00","created_by":"auto-import"}]}
{"id":"voice-code-211","title":"Update app navigation to use DirectoryListView as root","description":"Update VoiceCodeApp.swift and related navigation code to use DirectoryListView as the root view instead of SessionsListView.\n\nLocation: ios/VoiceCode/VoiceCodeApp.swift\n\nCurrent Structure:\n- VoiceCodeApp → NavigationStack → SessionsListView (2-tier)\n\nTarget Structure:\n- VoiceCodeApp → NavigationStack → DirectoryListView → SessionsForDirectoryView → ConversationView (3-tier)\n\nRequirements:\n\n1. Update VoiceCodeApp.swift:\n   - Change root view from SessionsListView to DirectoryListView\n   - Keep existing NavigationStack wrapper\n   - Maintain all @StateObject injections (client, settings, voiceOutput, draftManager, etc.)\n   - Pass all required dependencies to DirectoryListView\n\n2. Navigation Path Setup:\n   - NavigationStack should handle two navigation types:\n     * String (working directory path) - navigates to SessionsForDirectoryView\n     * UUID (session ID) - navigates to ConversationView\n   - Use .navigationDestination(for: String.self) for directory navigation\n   - Use .navigationDestination(for: UUID.self) for session navigation\n   - Both navigationDestination modifiers should be on NavigationStack\n\n3. Navigation Destination Handlers:\n   \n   For directories (String):\n   .navigationDestination(for: String.self) { workingDirectory in\n       SessionsForDirectoryView(\n           workingDirectory: workingDirectory,\n           client: client,\n           settings: settings,\n           voiceOutput: voiceOutput,\n           showingSettings: $showingSettings\n       )\n       .environment(\\.managedObjectContext, persistenceController.container.viewContext)\n       .environmentObject(draftManager)\n   }\n   \n   For sessions (UUID):\n   .navigationDestination(for: UUID.self) { sessionId in\n       // Look up session from CoreData\n       // Show ConversationView or \"Session Not Found\" message\n   }\n\n4. Session Lookup Logic:\n   - For UUID navigation destination, need to fetch CDSession by ID\n   - Cannot use @FetchRequest in navigationDestination closure\n   - Options:\n     a) Pass viewContext and perform fetch directly\n     b) Use SessionLookupView wrapper that has @FetchRequest\n     c) Store navigation session in @State and use onChange\n   - Recommended: Create SessionLookupView(sessionId: UUID) wrapper view\n\n5. Create SessionLookupView Helper:\n   - New view: ios/VoiceCode/Views/SessionLookupView.swift\n   - Takes sessionId: UUID parameter\n   - Uses @FetchRequest to fetch session by ID\n   - If found: shows ConversationView(session:)\n   - If not found: shows \"Session Not Found\" error message\n   - This keeps navigation destination clean and SwiftUI-friendly\n\n6. Preserve Existing Behavior:\n   - Settings sheet should still work (@State var showingSettings)\n   - NewSessionView sheet should still work\n   - All dependency injection should flow through navigation hierarchy\n   - Draft manager should be accessible via @EnvironmentObject at all levels\n\n7. Remove Old Code:\n   - SessionsListView can eventually be deleted (after SessionsForDirectoryView is confirmed working)\n   - Keep CDSessionRowContent component (reused in SessionsForDirectoryView)\n   - Keep NewSessionView (reused in both DirectoryListView and SessionsForDirectoryView)\n\n8. Testing Requirements:\n   - Verify app launches to DirectoryListView\n   - Verify tapping directory navigates to SessionsForDirectoryView\n   - Verify tapping session navigates to ConversationView\n   - Verify back button works at each level\n   - Verify settings and new session creation still work\n   - Verify deep linking (if applicable) still works\n   - Verify state preservation during navigation\n\nImplementation Notes:\n- NavigationStack supports heterogeneous navigation paths (String and UUID)\n- Each .navigationDestination(for:) handles one type\n- Directory navigation: DirectoryListView → SessionsForDirectoryView\n- Session navigation: SessionsForDirectoryView → ConversationView (via SessionLookupView)\n- Keep dependency injection consistent across all views\n- Use .environment() and .environmentObject() to pass context and managers\n\nExample VoiceCodeApp Structure:\nstruct VoiceCodeApp: App {\n    @StateObject private var client = VoiceCodeClient(...)\n    @StateObject private var settings = AppSettings()\n    @StateObject private var voiceOutput = VoiceOutputManager()\n    @StateObject private var draftManager = DraftManager()\n    let persistenceController = PersistenceController.shared\n    \n    @State private var showingSettings = false\n    \n    var body: some Scene {\n        WindowGroup {\n            NavigationStack {\n                DirectoryListView(\n                    client: client,\n                    settings: settings,\n                    voiceOutput: voiceOutput,\n                    showingSettings: $showingSettings\n                )\n                .navigationDestination(for: String.self) { workingDirectory in\n                    SessionsForDirectoryView(...)\n                }\n                .navigationDestination(for: UUID.self) { sessionId in\n                    SessionLookupView(sessionId: sessionId, ...)\n                }\n            }\n            .environment(\\.managedObjectContext, persistenceController.container.viewContext)\n            .environmentObject(draftManager)\n            .sheet(isPresented: $showingSettings) {\n                SettingsView(...)\n            }\n        }\n    }\n}\n\nTesting:\n- Launch app, verify DirectoryListView appears\n- Tap directory, verify SessionsForDirectoryView appears with filtered sessions\n- Tap session, verify ConversationView appears\n- Tap back from conversation, verify SessionsForDirectoryView appears\n- Tap back from sessions, verify DirectoryListView appears\n- Verify settings button works at all levels\n- Verify new session creation works at all levels","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.528846-05:00","updated_at":"2025-10-26T01:01:31.528846-05:00","closed_at":"2025-10-20T23:15:28.504361-05:00","dependencies":[{"issue_id":"voice-code-211","depends_on_id":"voice-code-209","type":"blocks","created_at":"2025-10-26T01:01:31.766849-05:00","created_by":"auto-import"},{"issue_id":"voice-code-211","depends_on_id":"voice-code-210","type":"blocks","created_at":"2025-10-26T01:01:31.767966-05:00","created_by":"auto-import"}]}
{"id":"voice-code-212","title":"Add relative timestamp formatting for directory rows","description":"Add relative timestamp formatting utility for displaying \"2 minutes ago\", \"3 hours ago\", etc. in directory and session rows.\n\nLocation: Create ios/VoiceCode/Utilities/RelativeTimeFormatter.swift\n\nPurpose: Convert Date objects to human-readable relative timestamps like iOS Mail/Messages.\n\nRequirements:\n\n1. Create RelativeTimeFormatter utility:\n   - Input: Date object\n   - Output: String like \"just now\", \"2 minutes ago\", \"3 hours ago\", \"2 days ago\", \"Jan 15\"\n\n2. Time Formatting Rules:\n   - \u003c 1 minute: \"just now\"\n   - \u003c 1 hour: \"X minutes ago\" (e.g., \"5 minutes ago\")\n   - \u003c 24 hours: \"X hours ago\" (e.g., \"3 hours ago\")\n   - \u003c 7 days: \"X days ago\" (e.g., \"2 days ago\")\n   - \u003e= 7 days: Abbreviated date \"MMM d\" (e.g., \"Jan 15\", \"Oct 20\")\n   - Different year: \"MMM d, yyyy\" (e.g., \"Dec 25, 2024\")\n\n3. Implementation Approach:\n   - Use Foundation's RelativeDateTimeFormatter for \u003c 7 days\n   - Use DateFormatter for \u003e= 7 days\n   - Detect if date is in current year vs. past year\n   - Cache formatters (DateFormatter initialization is expensive)\n\n4. API Design:\n   extension Date {\n       func relativeFormatted() -\u003e String\n   }\n   \n   Usage:\n   Text(session.lastModified.relativeFormatted())\n\n5. Locale Support:\n   - Use system locale from RelativeDateTimeFormatter\n   - Automatically adapts to user's language/region\n   - Respects 12/24 hour time preferences\n\n6. Example Implementation:\n   \n   static let relativeFormatter: RelativeDateTimeFormatter = {\n       let formatter = RelativeDateTimeFormatter()\n       formatter.unitsStyle = .full // \"2 minutes ago\" not \"2 min ago\"\n       return formatter\n   }()\n   \n   static let dateFormatter: DateFormatter = {\n       let formatter = DateFormatter()\n       formatter.dateFormat = \"MMM d\"\n       return formatter\n   }()\n   \n   static let dateFormatterWithYear: DateFormatter = {\n       let formatter = DateFormatter()\n       formatter.dateFormat = \"MMM d, yyyy\"\n       return formatter\n   }()\n   \n   extension Date {\n       func relativeFormatted() -\u003e String {\n           let now = Date()\n           let interval = now.timeIntervalSince(self)\n           \n           // Less than 1 minute\n           if interval \u003c 60 {\n               return \"just now\"\n           }\n           \n           // Less than 7 days: use RelativeDateTimeFormatter\n           if interval \u003c 7 * 24 * 60 * 60 {\n               return RelativeTimeFormatter.relativeFormatter.localizedString(for: self, relativeTo: now)\n           }\n           \n           // 7+ days: use date format\n           let calendar = Calendar.current\n           if calendar.isDate(self, equalTo: now, toGranularity: .year) {\n               return RelativeTimeFormatter.dateFormatter.string(from: self)\n           } else {\n               return RelativeTimeFormatter.dateFormatterWithYear.string(from: self)\n           }\n       }\n   }\n\n7. Usage in Views:\n   - DirectoryRowContent: session.lastModified.relativeFormatted()\n   - Could also use in SessionRowContent for consistency\n   - Updates automatically when view refreshes\n\n8. Edge Cases:\n   - Future dates: Show \"just now\" (shouldn't happen but defensive)\n   - Very old dates (years ago): Show \"MMM d, yyyy\"\n   - Nil dates: Caller should handle (optional Date? should use ?? \"Never\")\n\n9. Performance Considerations:\n   - Cache formatter instances (static let)\n   - Don't create new formatters on each call\n   - Formatting is fast enough for List with 50-100 items\n\nTesting:\n- Verify \"just now\" for dates \u003c 1 minute ago\n- Verify \"X minutes ago\" for recent dates\n- Verify \"X hours ago\" for dates today\n- Verify \"X days ago\" for dates this week\n- Verify \"MMM d\" for dates \u003e 7 days in current year\n- Verify \"MMM d, yyyy\" for dates in past years\n- Verify locale support (test with different system languages)","status":"closed","priority":3,"issue_type":"task","created_at":"2025-10-26T01:01:31.529222-05:00","updated_at":"2025-10-26T01:01:31.529222-05:00","closed_at":"2025-10-23T19:09:36.527997-05:00","dependencies":[{"issue_id":"voice-code-212","depends_on_id":"voice-code-209","type":"blocks","created_at":"2025-10-26T01:01:31.768895-05:00","created_by":"auto-import"}]}
{"id":"voice-code-213","title":"Add unit tests for 3-tier navigation","description":"Add comprehensive unit tests for DirectoryListView, SessionsForDirectoryView, and navigation behavior.\n\nLocation: Create ios/VoiceCodeTests/DirectoryNavigationTests.swift\n\nPurpose: Ensure 3-tier navigation works correctly, directories are computed and sorted properly, and UI displays correct data.\n\nRequirements:\n\n1. Test Directory Grouping and Sorting:\n   - Create multiple sessions across different working directories\n   - Verify directories list is computed correctly\n   - Verify directories sorted by most recent session.lastModified descending\n   - Verify directory names extracted correctly from paths\n\n2. Test Aggregate Unread Counts:\n   - Create sessions with various unreadCount values\n   - Verify directory unread count = sum of all session unreadCounts in that directory\n   - Verify unread badge shows correct total\n   - Verify badge hidden when unread count = 0\n\n3. Test Session Filtering by Directory:\n   - Create sessions in multiple directories\n   - Verify SessionsForDirectoryView shows only sessions for specified directory\n   - Verify sessions sorted by lastModified descending\n   - Verify sessions in other directories not shown\n\n4. Test Navigation State:\n   - Verify NavigationStack handles String (directory) navigation\n   - Verify NavigationStack handles UUID (session) navigation  \n   - Verify back navigation works correctly\n   - Verify navigation path maintained during session\n\n5. Test Empty States:\n   - No sessions at all → DirectoryListView shows empty state\n   - Directory with no sessions → SessionsForDirectoryView shows empty state\n   - Verify empty state messages correct\n\n6. Test Directory Name Extraction:\n   - Test paths: \"/Users/travis/code/voice-code\" → \"voice-code\"\n   - Test paths: \"/tmp\" → \"tmp\"\n   - Test paths: \"\" (empty) → handle gracefully\n   - Test paths: \"/\" (root) → handle gracefully\n   - Use (path as NSString).lastPathComponent\n\n7. Test Most Recent Timestamp Calculation:\n   - Directory with 3 sessions, different lastModified times\n   - Verify directory shows most recent timestamp\n   - Update one session's lastModified, verify directory timestamp updates\n\n8. Test Session Count Per Directory:\n   - Create 5 sessions in dir A, 3 in dir B\n   - Verify dir A shows \"5 sessions\"\n   - Verify dir B shows \"3 sessions\"\n   - Verify singular \"1 session\" for directory with one session\n\n9. Mock Data Setup:\n   Helper methods to create test data:\n   \n   func createSession(\n       workingDirectory: String,\n       lastModified: Date,\n       unreadCount: Int32,\n       messageCount: Int32\n   ) -\u003e CDSession {\n       let session = CDSession(context: context)\n       session.id = UUID()\n       session.workingDirectory = workingDirectory\n       session.lastModified = lastModified\n       session.unreadCount = unreadCount\n       session.messageCount = messageCount\n       session.backendName = \"Test Session\"\n       session.markedDeleted = false\n       session.preview = \"Preview\"\n       try! context.save()\n       return session\n   }\n\n10. Test Cases to Write:\n    - testDirectoriesGroupedCorrectly()\n    - testDirectoriesSortedByMostRecent()\n    - testDirectoryAggregateUnreadCount()\n    - testDirectorySessionCount()\n    - testDirectoryNameExtraction()\n    - testSessionsFilteredByDirectory()\n    - testSessionsSortedByLastModified()\n    - testEmptyDirectoriesList()\n    - testEmptySessionsInDirectory()\n    - testDirectoryWithSingleSession()\n    - testDirectoryWithMultipleSessions()\n    - testUnreadBadgeHiddenWhenZero()\n    - testUnreadBadgeShownWhenNonZero()\n\n11. CoreData Test Setup:\n    - Use in-memory PersistenceController for tests\n    - Create fresh context for each test\n    - Clean up after each test\n    \n    override func setUpWithError() throws {\n        persistenceController = PersistenceController(inMemory: true)\n        context = persistenceController.container.viewContext\n    }\n    \n    override func tearDownWithError() throws {\n        context = nil\n        persistenceController = nil\n    }\n\n12. Computed Property Testing:\n    - Test computed properties like groupedDirectories\n    - Test sorting logic\n    - Test filtering logic\n    - Use snapshot testing or manual verification\n\n13. Edge Cases:\n    - Empty working directory string\n    - Working directory = \"/\" (root)\n    - Very long directory paths\n    - Special characters in paths\n    - Multiple sessions with identical timestamps\n    - Sessions marked as deleted (should be filtered out)\n\nImplementation Notes:\n- Use XCTest framework\n- Import @testable import VoiceCode to access internal methods\n- Use in-memory CoreData store for isolation\n- Create helper methods for common test data setup\n- Follow existing test patterns from SessionSyncManagerTests.swift\n- Use XCTAssertEqual, XCTAssertTrue, XCTAssertNotNil for assertions\n- Test both successful cases and edge cases\n\nTesting:\n- Run all tests: xcodebuild test -scheme VoiceCode -only-testing:VoiceCodeTests/DirectoryNavigationTests\n- Verify all tests pass\n- Verify test coverage for grouping, sorting, filtering, navigation","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.530751-05:00","updated_at":"2025-10-26T01:01:31.530751-05:00","closed_at":"2025-10-20T23:28:22.95792-05:00","dependencies":[{"issue_id":"voice-code-213","depends_on_id":"voice-code-209","type":"blocks","created_at":"2025-10-26T01:01:31.770113-05:00","created_by":"auto-import"},{"issue_id":"voice-code-213","depends_on_id":"voice-code-210","type":"blocks","created_at":"2025-10-26T01:01:31.771152-05:00","created_by":"auto-import"},{"issue_id":"voice-code-213","depends_on_id":"voice-code-211","type":"blocks","created_at":"2025-10-26T01:01:31.772588-05:00","created_by":"auto-import"}]}
{"id":"voice-code-214","title":"Update NewSessionView to work with directory-first navigation","description":"Update NewSessionView to support both directory-level and top-level session creation, with improved UX for directory selection.\n\nLocation: ios/VoiceCode/Views/SessionsView.swift (NewSessionView component)\n\nCurrent Behavior:\n- NewSessionView has text field for working directory\n- User must type full path manually\n- Used from SessionsListView only\n\nTarget Behavior:\n- When opened from DirectoryListView (top-level): Show directory picker or text field\n- When opened from SessionsForDirectoryView: Pre-fill and lock directory field\n- Make directory selection easier with suggestions\n\nRequirements:\n\n1. Add Context Awareness:\n   - New parameter: prefilledDirectory: String? = nil\n   - If prefilledDirectory provided: Lock that field, show as read-only\n   - If nil: Show directory selection UI\n\n2. Directory Selection UI (when not pre-filled):\n   Option A - Picker from existing directories:\n   - Show Picker with list of existing working directories\n   - Plus \"Custom...\" option to enter new path\n   - Default to most recently used directory\n   \n   Option B - Text field with suggestions:\n   - TextField with autocomplete\n   - Show list of existing directories as suggestions below\n   - Tap suggestion to fill field\n   \n   Recommendation: Option A (Picker) for simpler UX\n\n3. Pre-filled Directory Display:\n   - When prefilledDirectory provided:\n   - Show directory in Text (not TextField)\n   - Add label \"Working Directory: [path]\"\n   - Gray out and non-editable\n   - User understands session will be created in this directory\n\n4. Form Structure (Pre-filled):\n   Section(header: Text(\"Session Details\")) {\n       TextField(\"Session Name\", text: $name)\n       \n       // Pre-filled, read-only\n       VStack(alignment: .leading) {\n           Text(\"Working Directory\")\n               .font(.caption)\n               .foregroundColor(.secondary)\n           Text(prefilledDirectory ?? \"\")\n               .font(.body)\n       }\n   }\n\n5. Form Structure (Top-level):\n   Section(header: Text(\"Session Details\")) {\n       TextField(\"Session Name\", text: $name)\n       \n       Picker(\"Working Directory\", selection: $selectedDirectory) {\n           ForEach(existingDirectories, id: \\.self) { dir in\n               Text((dir as NSString).lastPathComponent).tag(dir)\n           }\n           Text(\"Custom...\").tag(\"__custom__\")\n       }\n       \n       if selectedDirectory == \"__custom__\" {\n           TextField(\"Custom Directory Path\", text: $customDirectory)\n               .autocapitalization(.none)\n               .disableAutocorrection(true)\n       }\n   }\n\n6. Data Flow:\n   - DirectoryListView: Calls NewSessionView(prefilledDirectory: nil, onCreate: ...)\n   - SessionsForDirectoryView: Calls NewSessionView(prefilledDirectory: workingDirectory, onCreate: ...)\n   - onCreate closure receives (name: String, workingDirectory: String)\n   - Parent view creates session in CoreData\n\n7. Existing Directories List:\n   - Pass as parameter: existingDirectories: [String]\n   - Computed in parent view from @FetchRequest sessions\n   - Extract unique working directories: Set(sessions.map { $0.workingDirectory })\n   - Sorted by most recent usage (or alphabetically)\n\n8. Validation:\n   - Disable Create button if name.isEmpty\n   - Disable Create button if directory.isEmpty (when custom entry)\n   - Show validation error for invalid paths (optional)\n\n9. Updated API:\n   struct NewSessionView: View {\n       @Binding var name: String\n       @Binding var workingDirectory: String\n       let prefilledDirectory: String? // New parameter\n       let existingDirectories: [String] // New parameter\n       let onCreate: () -\u003e Void\n       let onCancel: () -\u003e Void\n       \n       @State private var selectedDirectory: String\n       @State private var showCustomPath: Bool = false\n       \n       init(...) {\n           // If pre-filled, use that\n           // Otherwise default to first existing directory\n       }\n   }\n\n10. Usage Examples:\n    \n    From DirectoryListView:\n    NewSessionView(\n        name: $newSessionName,\n        workingDirectory: $newWorkingDirectory,\n        prefilledDirectory: nil,\n        existingDirectories: Array(Set(sessions.map { $0.workingDirectory })),\n        onCreate: { ... },\n        onCancel: { ... }\n    )\n    \n    From SessionsForDirectoryView:\n    NewSessionView(\n        name: $newSessionName,\n        workingDirectory: .constant(workingDirectory), // Constant binding\n        prefilledDirectory: workingDirectory,\n        existingDirectories: [],\n        onCreate: { ... },\n        onCancel: { ... }\n    )\n\n11. Examples Section:\n    - Keep existing examples for custom paths\n    - Add note: \"Or choose from existing directories above\"\n    - Update examples to be more relevant\n\n12. Empty Directories Case:\n    - If existingDirectories.isEmpty (first session ever)\n    - Show TextField for manual entry\n    - Provide helpful examples\n    - Default to FileManager.default.currentDirectoryPath\n\nImplementation Notes:\n- Maintain backward compatibility during transition\n- prefilledDirectory = nil means top-level creation\n- prefilledDirectory = some path means directory-level creation\n- Use Picker for better UX than manual typing\n- Extract directory name for display: (path as NSString).lastPathComponent\n- Sort existing directories by most recent use for better UX\n\nTesting:\n- Verify pre-filled directory is read-only\n- Verify picker shows existing directories\n- Verify custom directory entry works\n- Verify validation prevents empty fields\n- Verify Create button disabled appropriately\n- Verify Cancel button works\n- Test with 0 existing directories (first session)\n- Test with 5+ existing directories","status":"closed","priority":3,"issue_type":"task","created_at":"2025-10-26T01:01:31.531245-05:00","updated_at":"2025-10-26T01:01:31.531245-05:00","closed_at":"2025-10-23T19:09:36.528192-05:00","dependencies":[{"issue_id":"voice-code-214","depends_on_id":"voice-code-209","type":"blocks","created_at":"2025-10-26T01:01:31.773932-05:00","created_by":"auto-import"},{"issue_id":"voice-code-214","depends_on_id":"voice-code-210","type":"blocks","created_at":"2025-10-26T01:01:31.775009-05:00","created_by":"auto-import"}]}
{"id":"voice-code-215","title":"Add swipe actions for directories","description":"Add swipe actions on directory rows for bulk operations (mark all read, etc.).\n\nLocation: ios/VoiceCode/Views/DirectoryListView.swift\n\nPurpose: Allow users to perform actions on all sessions within a directory at once.\n\nRequirements:\n\n1. Swipe Actions to Implement:\n   \n   Primary Action - Mark All Read:\n   - Swipe left on directory row\n   - Blue button with checkmark icon\n   - Sets unreadCount = 0 for all sessions in that directory\n   - Provides haptic feedback\n   - Most common action, non-destructive\n   \n   Secondary Action - Archive/Hide All (Optional):\n   - Could add in future\n   - Not in initial scope\n\n2. Mark All Read Implementation:\n   \n   .swipeActions(edge: .trailing) {\n       Button {\n           markAllReadInDirectory(workingDirectory)\n       } label: {\n           Label(\"Mark All Read\", systemImage: \"checkmark.circle.fill\")\n       }\n       .tint(.blue)\n   }\n   \n   func markAllReadInDirectory(_ directory: String) {\n       let fetchRequest = CDSession.fetchRequest()\n       fetchRequest.predicate = NSPredicate(\n           format: \"workingDirectory == %@ AND markedDeleted == NO\",\n           directory\n       )\n       \n       if let sessions = try? viewContext.fetch(fetchRequest) {\n           for session in sessions {\n               session.unreadCount = 0\n           }\n           \n           do {\n               try viewContext.save()\n               // Optional: Send mark_read message to backend for each session\n               // Or add new backend message type: mark_directory_read\n           } catch {\n               print(\"Failed to mark all read: \\(error)\")\n           }\n       }\n   }\n\n3. Haptic Feedback:\n   - Use UIImpactFeedbackGenerator on successful action\n   - Provides tactile confirmation\n   \n   let generator = UIImpactFeedbackGenerator(style: .medium)\n   generator.impactOccurred()\n\n4. Visual Feedback:\n   - Unread badge should disappear immediately after action\n   - View should update reactively (SwiftUI + CoreData)\n   - No need for manual refresh\n\n5. Backend Synchronization:\n   - Consider whether to notify backend of mark-all-read\n   - If backend tracks read state, send message for each session\n   - If backend doesn't track read state, no action needed\n   - Check existing protocol for mark_read message type\n\n6. Edge Cases:\n   - Directory with 0 unread messages: Action still available, no-op\n   - Directory with 50+ sessions: Could be slow, consider progress indicator\n   - Offline mode: Queue messages for later sync (if applicable)\n\n7. Alternative Actions (Future):\n   - \"Delete All\" (destructive, needs confirmation alert)\n   - \"Archive All\" (hide but don't delete)\n   - \"Export All\" (export sessions to file)\n   - Not in scope for initial implementation\n\n8. Confirmation Dialogs:\n   - Mark All Read: No confirmation needed (non-destructive, easy to undo by receiving new messages)\n   - Delete All: Would need confirmation alert (destructive)\n\n9. Accessibility:\n   - Ensure swipe actions have accessibility labels\n   - Support VoiceOver\n   - Ensure button tap targets are large enough\n\nImplementation Notes:\n- Use .swipeActions modifier on NavigationLink or row container\n- Mark All Read is the most valuable action (reduces cognitive load)\n- Keep swipe actions simple, avoid too many options\n- Follow iOS Mail pattern: swipe for common actions\n- Ensure viewContext saves properly trigger UI updates\n- Test with many sessions to ensure performance\n\nTesting:\n- Verify swipe action appears on directory row\n- Verify Mark All Read sets all session unreadCounts to 0\n- Verify unread badge disappears from directory row\n- Verify haptic feedback occurs\n- Verify action works with 1 session, 10 sessions, 50 sessions\n- Verify action is no-op when already all read\n- Verify accessibility labels present","status":"closed","priority":3,"issue_type":"task","created_at":"2025-10-26T01:01:31.531709-05:00","updated_at":"2025-10-26T01:01:31.531709-05:00","closed_at":"2025-10-23T19:09:36.528356-05:00","dependencies":[{"issue_id":"voice-code-215","depends_on_id":"voice-code-209","type":"blocks","created_at":"2025-10-26T01:01:31.776133-05:00","created_by":"auto-import"}]}
{"id":"voice-code-216","title":"Backend: Implement compact_session WebSocket handler","description":"Add handler for compact_session message type in server.clj.\n\nIMPLEMENTATION:\n1. Add :compact_session case to handle-message in server.clj\n2. Extract and validate session_id from message\n3. Look up iOS session UUID → Claude session ID mapping\n4. Validate Claude session exists on disk\n5. Call compact-session function (to be implemented in claude.clj)\n6. Return appropriate response or error\n\nVALIDATION:\n- session_id must be provided\n- Claude session file must exist at ~/.claude/projects/\u003cproject\u003e/\u003csession-id\u003e.jsonl\n- Log all validation failures with actual values\n\nMESSAGE FORMAT:\nInput: {\"type\": \"compact_session\", \"session_id\": \"\u003cclaude-session-id\u003e\"}\n\nERROR CASES:\n- Missing session_id → {\"type\": \"error\", \"message\": \"session_id required\"}\n- Invalid session_id → {\"type\": \"error\", \"message\": \"Session not found: \u003csession-id\u003e\"}\n- Compaction fails → {\"type\": \"compaction_error\", \"session_id\": \"...\", \"error\": \"...\"}","notes":"✓ Completed - Added compact_session WebSocket handler to server.clj\n\n- Accepts compact_session message with session_id\n- Validates session_id is provided\n- Calls claude/compact-session asynchronously\n- Returns compaction_complete or compaction_error response\n- Includes old/new message counts, messages removed, pre-tokens","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.532207-05:00","updated_at":"2025-10-26T01:01:31.532207-05:00","closed_at":"2025-10-21T08:27:32.022479-05:00","dependencies":[{"issue_id":"voice-code-216","depends_on_id":"voice-code-168","type":"blocks","created_at":"2025-10-26T01:01:31.777724-05:00","created_by":"auto-import"}]}
{"id":"voice-code-217","title":"Backend: Implement compact-session function in claude.clj","description":"Implement function to invoke Claude CLI compact command and return metadata.\n\nIMPLEMENTATION:\n1. Create compact-session function in claude.clj\n2. Accept claude-session-id as parameter\n3. Invoke: claude -p --output-format json --resume \u003csession-id\u003e \"/compact\"\n4. Parse JSON output to extract compaction metadata\n5. Count JSONL lines before and after to get message counts\n6. Return map with {:success, :old-count, :new-count, :pre-tokens}\n\nBASED ON RESEARCH:\n- Command: claude -p --output-format json --resume \u003csession-id\u003e \"/compact\"\n- JSON output includes compact_boundary with compactMetadata.preTokens\n- Session ID remains the same after compaction\n- Need to count JSONL lines manually (not in CLI output)\n- Text mode output is silent (use JSON for metadata)\n\nFUNCTION SIGNATURE:\n(defn compact-session [claude-session-id]\n  {:success true\n   :old-message-count 150\n   :new-message-count 20\n   :messages-removed 130\n   :pre-tokens 17689})\n\nERROR HANDLING:\n- Catch shell command failures\n- Validate JSON parsing\n- Log actual error messages from CLI\n- Return {:success false :error \"...\"} on failure","notes":"✓ Completed - Implemented compact-session function in claude.clj\n\n- Invokes: claude -p --output-format json --resume \u003csession-id\u003e \"/compact\"\n- Parses JSON response to extract compact_boundary metadata\n- Counts JSONL lines before/after compaction\n- Returns success with old/new counts, messages removed, pre-tokens\n- Proper error handling with detailed logging","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.533043-05:00","updated_at":"2025-10-26T01:01:31.533043-05:00","closed_at":"2025-10-21T08:27:39.179762-05:00","dependencies":[{"issue_id":"voice-code-217","depends_on_id":"voice-code-168","type":"blocks","created_at":"2025-10-26T01:01:31.779048-05:00","created_by":"auto-import"},{"issue_id":"voice-code-217","depends_on_id":"voice-code-216","type":"blocks","created_at":"2025-10-26T01:01:31.780305-05:00","created_by":"auto-import"}]}
{"id":"voice-code-218","title":"Backend: Calculate message counts for compaction stats","description":"Implement utility to count JSONL lines in session files before/after compaction.\n\nIMPLEMENTATION:\n1. Create count-session-messages function in claude.clj or utils\n2. Count lines in session .jsonl file\n3. Exclude compact_boundary and isCompactSummary entries from user-visible count\n4. Cache count before compaction, re-count after\n5. Return {:old-count N :new-count M :messages-removed (- N M)}\n\nBASED ON RESEARCH:\n- Compact adds 3 entries: user command, compact_boundary, compact summary\n- compact_boundary has type=system, subtype=compact_boundary\n- compact summary has isCompactSummary=true\n- May want to exclude these from user-facing counts\n- Can use: wc -l \u003cfile.jsonl\u003e for total line count\n- Or grep -c for filtered counts\n\nFUNCTION SIGNATURE:\n(defn count-session-messages [session-file-path]\n  ;; Returns total line count or filtered count\n  42)\n\nCONSIDERATIONS:\n- Should we count ALL lines or exclude system messages?\n- Do we count compact summaries as \"messages\"?\n- Performance: wc -l vs reading/parsing file\n- Cache the count to avoid duplicate reads","notes":"✓ Completed - Implemented message counting utilities in claude.clj\n\n- count-jsonl-lines: Counts lines in JSONL file\n- get-session-file-path: Finds session file in ~/.claude/projects/\n- Used by compact-session to calculate before/after message counts\n- Proper error handling for missing files","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.533585-05:00","updated_at":"2025-10-26T01:01:31.533585-05:00","closed_at":"2025-10-21T08:27:44.780406-05:00","dependencies":[{"issue_id":"voice-code-218","depends_on_id":"voice-code-217","type":"blocks","created_at":"2025-10-26T01:01:31.781426-05:00","created_by":"auto-import"}]}
{"id":"voice-code-219","title":"iOS: Add compactSession method to VoiceCodeClient","description":"Add method to send compact_session request via WebSocket.\n\nIMPLEMENTATION:\n1. Add compactSession(claudeSessionId:) method to VoiceCodeClient.swift\n2. Send compact_session message with snake_case session_id\n3. Generate unique request ID for tracking response\n4. Add async/await or completion handler pattern\n5. Handle compaction_complete and compaction_error responses\n\nMETHOD SIGNATURE:\nfunc compactSession(claudeSessionId: String) async throws -\u003e CompactionResult\n\nstruct CompactionResult {\n    let sessionId: String\n    let oldMessageCount: Int\n    let newMessageCount: Int\n    let messagesRemoved: Int\n    let preTokens: Int?\n}\n\nMESSAGE FORMAT:\nSend: {\"type\": \"compact_session\", \"session_id\": \"\u003cclaude-session-id\u003e\"}\nReceive: {\"type\": \"compaction_complete\", \"session_id\": \"...\", \"old_message_count\": 150, \"new_message_count\": 20, \"messages_removed\": 130}\nError: {\"type\": \"compaction_error\", \"session_id\": \"...\", \"error\": \"...\"}\n\nERROR HANDLING:\n- Throw error if backend returns compaction_error\n- Timeout after 60 seconds (compaction can be slow)\n- Handle network disconnection during compaction","notes":"✓ Completed - Added compactSession method to VoiceCodeClient.swift\n\n- async/await API: compactSession(claudeSessionId:) throws -\u003e CompactionResult\n- Sends compact_session WebSocket message\n- Parses compaction_complete or compaction_error responses\n- 60-second timeout with proper error handling\n- Returns CompactionResult with message counts and token stats","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.534025-05:00","updated_at":"2025-10-26T01:01:31.534025-05:00","closed_at":"2025-10-21T08:27:50.307291-05:00","dependencies":[{"issue_id":"voice-code-219","depends_on_id":"voice-code-168","type":"blocks","created_at":"2025-10-26T01:01:31.783002-05:00","created_by":"auto-import"}]}
{"id":"voice-code-220","title":"iOS: Add compaction UI to SessionDetailView","description":"Add UI control for triggering session compaction from iOS app.\n\nIMPLEMENTATION:\n1. Add \"Compact Session\" button or menu item in SessionDetailView\n2. Show confirmation dialog before compacting (warn about data loss)\n3. Display progress indicator during compaction\n4. Update session metadata after successful compaction\n5. Show success/error toast with statistics\n\nUI OPTIONS (choose one):\nOption A: Button in toolbar/header\nOption B: Context menu item (long-press or swipe action)\nOption C: Settings/gear menu within session detail\nOption D: Section in session info with compact button + stats\n\nCONFIRMATION DIALOG:\nTitle: \"Compact Session?\"\nMessage: \"This will summarize the conversation history to reduce file size. The summary cannot be undone.\"\nButtons: [Cancel] [Compact]\n\nSUCCESS MESSAGE:\n\"Session compacted: Removed X messages, saved Y tokens\"\n\nERROR HANDLING:\n- Show error alert if compaction fails\n- Don't update UI if compaction fails\n- Allow retry on failure\n\nCONSIDERATIONS:\n- Should we show estimated size savings before compacting?\n- Show token count reduction in UI?\n- Disable compact button if session is empty/already compact?\n- Gray out button if session is currently active?","notes":"✓ Completed - Added compact button UI to ConversationView.swift\n\n- Lightning bolt icon (⚡︎) in toolbar, left of refresh button\n- Shows progress indicator during compaction\n- Disabled if no Claude session ID\n- Confirmation alert: \"Compact Session?\" with warning\n- Shows message count in confirmation\n- Success toast with statistics: \"Removed X messages, saved Y tokens\"\n- Refreshes session metadata after compaction","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.534499-05:00","updated_at":"2025-10-26T01:01:31.534499-05:00","closed_at":"2025-10-21T08:28:00.304791-05:00","dependencies":[{"issue_id":"voice-code-220","depends_on_id":"voice-code-168","type":"blocks","created_at":"2025-10-26T01:01:31.784334-05:00","created_by":"auto-import"},{"issue_id":"voice-code-220","depends_on_id":"voice-code-219","type":"blocks","created_at":"2025-10-26T01:01:31.785495-05:00","created_by":"auto-import"}]}
{"id":"voice-code-221","title":"Update STANDARDS.md with compaction protocol messages","description":"Document new WebSocket protocol messages for session compaction.\n\nADD TO STANDARDS.md:\n\n## Session Compaction Messages\n\n### Client → Backend: Compact Session Request\n```json\n{\n  \"type\": \"compact_session\",\n  \"session_id\": \"\u003cclaude-session-id\u003e\"\n}\n```\n\nTriggers compaction of the specified Claude session. The session_id must be a valid Claude CLI session ID (not iOS session UUID).\n\n### Backend → Client: Compaction Complete\n```json\n{\n  \"type\": \"compaction_complete\",\n  \"session_id\": \"\u003cclaude-session-id\u003e\",\n  \"old_message_count\": 150,\n  \"new_message_count\": 20,\n  \"messages_removed\": 130,\n  \"pre_tokens\": 17689\n}\n```\n\nSent when compaction succeeds. Includes statistics about messages removed and token count before compaction.\n\n### Backend → Client: Compaction Error\n```json\n{\n  \"type\": \"compaction_error\",\n  \"session_id\": \"\u003cclaude-session-id\u003e\",\n  \"error\": \"\u003cerror-message\u003e\"\n}\n```\n\nSent when compaction fails. Common errors:\n- \"Session not found: \u003csession-id\u003e\"\n- \"Invalid session_id\"\n- Claude CLI errors\n\n## Compaction Behavior\n\n- Session ID remains the same after compaction\n- Adds compact_boundary marker to JSONL file\n- Conversation history is summarized, not deleted\n- Cannot be undone\n- Recommended when sessions exceed ~50K tokens","notes":"✓ Completed - Updated STANDARDS.md with compaction protocol\n\nAdded to WebSocket Protocol section:\n- compact_session request message (Client → Backend)\n- compaction_complete response (Backend → Client) with stats\n- compaction_error response (Backend → Client)\n- Session Compaction section with overview, behavior, usage guidelines\n- Documented that session ID remains same, operation is permanent","status":"closed","priority":3,"issue_type":"task","created_at":"2025-10-26T01:01:31.534966-05:00","updated_at":"2025-10-26T01:01:31.534966-05:00","closed_at":"2025-10-21T08:28:06.85485-05:00","dependencies":[{"issue_id":"voice-code-221","depends_on_id":"voice-code-168","type":"blocks","created_at":"2025-10-26T01:01:31.786436-05:00","created_by":"auto-import"}]}
{"id":"voice-code-222","title":"Test compaction with active vs inactive sessions","description":"Test edge cases for session compaction to ensure safety.\n\nTEST CASES:\n\n1. Compact currently active session (session in use by iOS client)\n   - Expected: Should work or return clear error\n   - Risk: Concurrent writes to JSONL file\n\n2. Compact already-compacted session\n   - Expected: Should compact again or return \"already compact\" message\n   - Check: Multiple compact_boundary markers in file\n\n3. Compact empty/new session\n   - Expected: Should fail gracefully with \"insufficient history\" error\n   - Minimum messages/tokens needed for compaction?\n\n4. Compact session while disconnected from iOS\n   - Expected: Works, iOS sees updated metadata on reconnect\n   - Check: File watcher detects change\n\n5. Multiple concurrent compaction requests for same session\n   - Expected: Queue or reject duplicate requests\n   - Risk: Race condition with CLI invocations\n\n6. Session file permissions errors\n   - Expected: Clear error message with file path\n   - Log actual permission error\n\nIMPLEMENTATION:\n- Write integration tests in backend/test/\n- Test with real Claude CLI (not mocked)\n- Use temporary test sessions\n- Verify JSONL file structure after compaction\n\nSAFETY CONSIDERATIONS:\n- Should we lock sessions during compaction?\n- Block compaction of currently active sessions?\n- Add cooldown period between compactions?","notes":"SIMPLIFIED SCOPE - Focus on essential edge cases only\n\nTEST CASES:\n1. Compact currently active session - should work\n2. Compact already-compacted session - should work (adds another boundary)\n3. Compact empty session - let it work, backend will handle\n4. Multiple concurrent requests - queue or reject duplicates\n\nREMOVED FROM SCOPE:\n- No minimum threshold testing (no minimums)\n- No undo/backup testing (not implementing)\n- No auto-compact testing (not implementing)\n- Session locking complexity (keep simple)","status":"closed","priority":3,"issue_type":"task","created_at":"2025-10-26T01:01:31.53541-05:00","updated_at":"2025-10-26T01:01:31.53541-05:00","closed_at":"2025-10-23T19:10:14.259128-05:00","dependencies":[{"issue_id":"voice-code-222","depends_on_id":"voice-code-217","type":"blocks","created_at":"2025-10-26T01:01:31.78779-05:00","created_by":"auto-import"}]}
{"id":"voice-code-223","title":"Backend: Remove old storage-based session architecture","description":"The backend has two session architectures running in parallel:\n\n1. Old: WebSocket-based with sessions.edn storage mapping iOS UUID → Claude session ID\n2. New: Replication-based using filesystem watcher, iOS UUID = Claude session ID\n\nThe old architecture creates complexity and confusion. Recent compaction bug (voice-code-168) required fallback logic to support both.\n\nTasks:\n- Remove storage/sessions.edn and storage.clj\n- Remove storage-based session registration in server.clj\n- Update all handlers to assume replication-based architecture only\n- Remove fallback logic in compact_session handler\n- Update tests to remove storage mocks\n- Verify iOS app doesn't depend on old architecture\n\nImpact: Simplifies codebase, removes dual-architecture complexity, one source of truth (filesystem)","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.536546-05:00","updated_at":"2025-10-26T01:01:31.536546-05:00"}
{"id":"voice-code-224","title":"Backend: Centralize UUID case normalization to fix case-sensitivity bugs","description":"Case sensitivity with UUIDs keeps causing bugs across the codebase:\n\n1. Session index (replication.clj) stores uppercase UUIDs from filenames\n2. Backend handlers receive UUIDs in mixed case from iOS\n3. Lookups fail when case doesn't match exactly\n\nRecent occurrences:\n- Compaction failed for 02C8AC33-61F5-41F4-AA19-19A66CF7D005 (uppercase in filesystem)\n- get-session-metadata normalizes to lowercase but index uses uppercase keys\n\nSolution:\n- Establish canonical case (lowercase recommended per RFC 4122)\n- Create normalize-uuid utility function in common namespace\n- Apply normalization at ALL boundaries:\n  * Parsing JSON from iOS (snake-\u003ekebab conversion)\n  * Building session index from filesystem\n  * Looking up sessions in index\n  * Storing session IDs in maps/atoms\n- Add validation logging when case mismatches detected\n- Update tests to verify case normalization\n\nImpact: Eliminates entire class of case-sensitivity bugs, makes UUID handling predictable","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-26T01:01:31.53866-05:00","updated_at":"2025-10-26T01:01:31.53866-05:00","closed_at":"2025-10-21T22:53:42.297573-05:00"}
{"id":"voice-code-225","title":"Normalize all UUIDs to lowercase","description":"Eliminate case inconsistencies in session ID handling by using lowercase UUIDs everywhere. Backend currently normalizes at lookup, but iOS generates uppercase UUIDs, causing confusion in logs and potential failures on case-sensitive filesystems.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-10-26T01:01:31.5405-05:00","updated_at":"2025-10-26T01:01:31.5405-05:00","closed_at":"2025-10-21T22:38:27.540036-05:00"}
{"id":"voice-code-226","title":"iOS: Lowercase all UUID.uuidString calls in VoiceCodeClient","description":"Update all session.id.uuidString calls to session.id.uuidString.lowercased() in VoiceCodeClient.swift. Locations: compactSession (line 371, 389), subscribe/unsubscribe calls, sendPrompt, requestSessionRefresh. Ensures all UUIDs sent to backend are lowercase.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.541907-05:00","updated_at":"2025-10-26T01:01:31.541907-05:00","closed_at":"2025-10-21T22:37:58.950553-05:00","dependencies":[{"issue_id":"voice-code-226","depends_on_id":"voice-code-225","type":"blocks","created_at":"2025-10-26T01:01:31.788996-05:00","created_by":"auto-import"}]}
{"id":"voice-code-227","title":"iOS: Lowercase all UUID.uuidString calls in ConversationView","description":"Update all session.id.uuidString calls to session.id.uuidString.lowercased() in ConversationView.swift. Locations: lines 172, 232, 237, 245, 271, 300, 321, 322, 324, 325, 334, 371, 389. Affects: subscribe, unsubscribe, sendPrompt, requestSessionRefresh, compactSession.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.543194-05:00","updated_at":"2025-10-26T01:01:31.543194-05:00","closed_at":"2025-10-21T22:37:58.951295-05:00","dependencies":[{"issue_id":"voice-code-227","depends_on_id":"voice-code-225","type":"blocks","created_at":"2025-10-26T01:01:31.790692-05:00","created_by":"auto-import"}]}
{"id":"voice-code-228","title":"iOS: Lowercase all UUID.uuidString calls in SessionSyncManager","description":"Update all session ID string conversions to use .lowercased() in SessionSyncManager.swift. Review all places where session.id.uuidString is used for CoreData lookups, backend communication, and session management.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.544786-05:00","updated_at":"2025-10-26T01:01:31.544786-05:00","closed_at":"2025-10-21T22:37:58.951437-05:00","dependencies":[{"issue_id":"voice-code-228","depends_on_id":"voice-code-225","type":"blocks","created_at":"2025-10-26T01:01:31.791689-05:00","created_by":"auto-import"}]}
{"id":"voice-code-229","title":"iOS: Lowercase all UUID.uuidString calls in remaining Swift files","description":"Search and update all remaining .uuidString calls in: SessionsView, DirectoryListView, SessionsForDirectoryView, PersistenceController, and all test files. Use grep to find: grep -r 'uuidString' ios/ --include='*.swift' and apply .lowercased() to all session ID conversions.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.545884-05:00","updated_at":"2025-10-26T01:01:31.545884-05:00","closed_at":"2025-10-21T22:37:58.951596-05:00","dependencies":[{"issue_id":"voice-code-229","depends_on_id":"voice-code-225","type":"blocks","created_at":"2025-10-26T01:01:31.793299-05:00","created_by":"auto-import"}]}
{"id":"voice-code-230","title":"Backend: Remove str/lower-case normalization from replication.clj build-index!","description":"Remove str/lower-case call at replication.clj:195. Change (assoc acc (str/lower-case session-id) metadata) to (assoc acc session-id metadata). This is safe after iOS changes ensure all incoming UUIDs are already lowercase.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.546966-05:00","updated_at":"2025-10-26T01:01:31.546966-05:00","closed_at":"2025-10-21T22:37:58.951836-05:00","dependencies":[{"issue_id":"voice-code-230","depends_on_id":"voice-code-226","type":"blocks","created_at":"2025-10-26T01:01:31.794158-05:00","created_by":"auto-import"},{"issue_id":"voice-code-230","depends_on_id":"voice-code-227","type":"blocks","created_at":"2025-10-26T01:01:31.795231-05:00","created_by":"auto-import"},{"issue_id":"voice-code-230","depends_on_id":"voice-code-228","type":"blocks","created_at":"2025-10-26T01:01:31.796058-05:00","created_by":"auto-import"},{"issue_id":"voice-code-230","depends_on_id":"voice-code-229","type":"blocks","created_at":"2025-10-26T01:01:31.79671-05:00","created_by":"auto-import"}]}
{"id":"voice-code-231","title":"Backend: Remove str/lower-case normalization from replication.clj load-index","description":"Remove str/lower-case call at replication.clj:241 in normalized-sessions map. Change (assoc acc (str/lower-case k) v) to (assoc acc k v). Remove the entire normalization step since all session IDs are already lowercase.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.548017-05:00","updated_at":"2025-10-26T01:01:31.548017-05:00","closed_at":"2025-10-21T22:37:58.951961-05:00","dependencies":[{"issue_id":"voice-code-231","depends_on_id":"voice-code-226","type":"blocks","created_at":"2025-10-26T01:01:31.798065-05:00","created_by":"auto-import"},{"issue_id":"voice-code-231","depends_on_id":"voice-code-227","type":"blocks","created_at":"2025-10-26T01:01:31.798723-05:00","created_by":"auto-import"},{"issue_id":"voice-code-231","depends_on_id":"voice-code-228","type":"blocks","created_at":"2025-10-26T01:01:31.799768-05:00","created_by":"auto-import"},{"issue_id":"voice-code-231","depends_on_id":"voice-code-229","type":"blocks","created_at":"2025-10-26T01:01:31.800737-05:00","created_by":"auto-import"}]}
{"id":"voice-code-232","title":"Backend: Remove str/lower-case normalization from replication.clj get-session-metadata","description":"Remove str/lower-case call at replication.clj:282. Change (get @session-index (str/lower-case session-id)) to (get @session-index session-id). Direct lookup without normalization.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.54932-05:00","updated_at":"2025-10-26T01:01:31.54932-05:00","closed_at":"2025-10-21T22:37:58.952284-05:00","dependencies":[{"issue_id":"voice-code-232","depends_on_id":"voice-code-226","type":"blocks","created_at":"2025-10-26T01:01:31.801547-05:00","created_by":"auto-import"},{"issue_id":"voice-code-232","depends_on_id":"voice-code-227","type":"blocks","created_at":"2025-10-26T01:01:31.802276-05:00","created_by":"auto-import"},{"issue_id":"voice-code-232","depends_on_id":"voice-code-228","type":"blocks","created_at":"2025-10-26T01:01:31.803149-05:00","created_by":"auto-import"},{"issue_id":"voice-code-232","depends_on_id":"voice-code-229","type":"blocks","created_at":"2025-10-26T01:01:31.803834-05:00","created_by":"auto-import"}]}
{"id":"voice-code-233","title":"Backend: Remove str/lower-case normalization from replication.clj subscribe-to-session!","description":"Remove str/lower-case normalization at replication.clj:550. Change (swap! watcher-state update :subscribed-sessions conj (str/lower-case session-id)) to use session-id directly. Update function to remove normalized-id variable.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.550661-05:00","updated_at":"2025-10-26T01:01:31.550661-05:00","closed_at":"2025-10-21T22:37:58.952643-05:00","dependencies":[{"issue_id":"voice-code-233","depends_on_id":"voice-code-226","type":"blocks","created_at":"2025-10-26T01:01:31.804519-05:00","created_by":"auto-import"},{"issue_id":"voice-code-233","depends_on_id":"voice-code-227","type":"blocks","created_at":"2025-10-26T01:01:31.805191-05:00","created_by":"auto-import"},{"issue_id":"voice-code-233","depends_on_id":"voice-code-228","type":"blocks","created_at":"2025-10-26T01:01:31.80576-05:00","created_by":"auto-import"},{"issue_id":"voice-code-233","depends_on_id":"voice-code-229","type":"blocks","created_at":"2025-10-26T01:01:31.806332-05:00","created_by":"auto-import"}]}
{"id":"voice-code-234","title":"Backend: Remove str/lower-case normalization from replication.clj unsubscribe-from-session!","description":"Remove str/lower-case normalization at replication.clj:560. Change (swap! watcher-state update :subscribed-sessions disj (str/lower-case session-id)) to use session-id directly. Update function to remove normalized-id variable.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.552004-05:00","updated_at":"2025-10-26T01:01:31.552004-05:00","closed_at":"2025-10-21T22:37:58.953006-05:00","dependencies":[{"issue_id":"voice-code-234","depends_on_id":"voice-code-226","type":"blocks","created_at":"2025-10-26T01:01:31.806797-05:00","created_by":"auto-import"},{"issue_id":"voice-code-234","depends_on_id":"voice-code-227","type":"blocks","created_at":"2025-10-26T01:01:31.807244-05:00","created_by":"auto-import"},{"issue_id":"voice-code-234","depends_on_id":"voice-code-228","type":"blocks","created_at":"2025-10-26T01:01:31.807742-05:00","created_by":"auto-import"},{"issue_id":"voice-code-234","depends_on_id":"voice-code-229","type":"blocks","created_at":"2025-10-26T01:01:31.80843-05:00","created_by":"auto-import"}]}
{"id":"voice-code-235","title":"Backend: Remove str/lower-case normalization from replication.clj is-subscribed?","description":"Remove str/lower-case normalization at replication.clj:571. Change (contains? (:subscribed-sessions @watcher-state) (str/lower-case session-id)) to use session-id directly.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.553326-05:00","updated_at":"2025-10-26T01:01:31.553326-05:00","closed_at":"2025-10-21T22:37:58.953179-05:00","dependencies":[{"issue_id":"voice-code-235","depends_on_id":"voice-code-226","type":"blocks","created_at":"2025-10-26T01:01:31.809371-05:00","created_by":"auto-import"},{"issue_id":"voice-code-235","depends_on_id":"voice-code-227","type":"blocks","created_at":"2025-10-26T01:01:31.809945-05:00","created_by":"auto-import"},{"issue_id":"voice-code-235","depends_on_id":"voice-code-228","type":"blocks","created_at":"2025-10-26T01:01:31.810419-05:00","created_by":"auto-import"},{"issue_id":"voice-code-235","depends_on_id":"voice-code-229","type":"blocks","created_at":"2025-10-26T01:01:31.810951-05:00","created_by":"auto-import"}]}
{"id":"voice-code-236","title":"Backend: Remove str/lower-case normalization from replication.clj handle-file-created","description":"Remove str/lower-case normalization at replication.clj:817. Remove normalized-id variable and use session-id directly when adding to index: (swap! session-index assoc session-id metadata).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.554963-05:00","updated_at":"2025-10-26T01:01:31.554963-05:00","closed_at":"2025-10-21T22:37:58.953315-05:00","dependencies":[{"issue_id":"voice-code-236","depends_on_id":"voice-code-226","type":"blocks","created_at":"2025-10-26T01:01:31.811425-05:00","created_by":"auto-import"},{"issue_id":"voice-code-236","depends_on_id":"voice-code-227","type":"blocks","created_at":"2025-10-26T01:01:31.81198-05:00","created_by":"auto-import"},{"issue_id":"voice-code-236","depends_on_id":"voice-code-228","type":"blocks","created_at":"2025-10-26T01:01:31.812883-05:00","created_by":"auto-import"},{"issue_id":"voice-code-236","depends_on_id":"voice-code-229","type":"blocks","created_at":"2025-10-26T01:01:31.813874-05:00","created_by":"auto-import"}]}
{"id":"voice-code-237","title":"Backend: Remove str/lower-case normalization from replication.clj handle-file-modified","description":"Remove str/lower-case normalization at replication.clj:840. Remove normalized-id variable and use session-id directly when updating index: (swap! session-index assoc session-id new-metadata).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.556323-05:00","updated_at":"2025-10-26T01:01:31.556323-05:00","closed_at":"2025-10-21T22:37:58.95344-05:00","dependencies":[{"issue_id":"voice-code-237","depends_on_id":"voice-code-226","type":"blocks","created_at":"2025-10-26T01:01:31.81487-05:00","created_by":"auto-import"},{"issue_id":"voice-code-237","depends_on_id":"voice-code-227","type":"blocks","created_at":"2025-10-26T01:01:31.815864-05:00","created_by":"auto-import"},{"issue_id":"voice-code-237","depends_on_id":"voice-code-228","type":"blocks","created_at":"2025-10-26T01:01:31.816855-05:00","created_by":"auto-import"},{"issue_id":"voice-code-237","depends_on_id":"voice-code-229","type":"blocks","created_at":"2025-10-26T01:01:31.817888-05:00","created_by":"auto-import"}]}
{"id":"voice-code-238","title":"Backend: Update replication.clj docstrings to remove case-normalization mentions","description":"Clean up function docstrings that mention case normalization or lowercase conversion. Update comments in: build-index!, load-index, get-session-metadata, subscribe-to-session!, unsubscribe-from-session!, is-subscribed?, handle-file-created, handle-file-modified.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.557429-05:00","updated_at":"2025-10-26T01:01:31.557429-05:00","closed_at":"2025-10-21T22:37:58.953559-05:00","dependencies":[{"issue_id":"voice-code-238","depends_on_id":"voice-code-230","type":"blocks","created_at":"2025-10-26T01:01:31.819515-05:00","created_by":"auto-import"},{"issue_id":"voice-code-238","depends_on_id":"voice-code-231","type":"blocks","created_at":"2025-10-26T01:01:31.820588-05:00","created_by":"auto-import"},{"issue_id":"voice-code-238","depends_on_id":"voice-code-232","type":"blocks","created_at":"2025-10-26T01:01:31.821563-05:00","created_by":"auto-import"},{"issue_id":"voice-code-238","depends_on_id":"voice-code-233","type":"blocks","created_at":"2025-10-26T01:01:31.82237-05:00","created_by":"auto-import"},{"issue_id":"voice-code-238","depends_on_id":"voice-code-234","type":"blocks","created_at":"2025-10-26T01:01:31.823471-05:00","created_by":"auto-import"},{"issue_id":"voice-code-238","depends_on_id":"voice-code-235","type":"blocks","created_at":"2025-10-26T01:01:31.824765-05:00","created_by":"auto-import"},{"issue_id":"voice-code-238","depends_on_id":"voice-code-236","type":"blocks","created_at":"2025-10-26T01:01:31.825889-05:00","created_by":"auto-import"},{"issue_id":"voice-code-238","depends_on_id":"voice-code-237","type":"blocks","created_at":"2025-10-26T01:01:31.826951-05:00","created_by":"auto-import"}]}
{"id":"voice-code-239","title":"Backend: Write tests for UUID case consistency in replication.clj","description":"Add tests to verify session index handles lowercase UUIDs correctly without normalization. Test: build-index!, get-session-metadata, subscribe/unsubscribe, file watchers. Verify uppercase UUIDs no longer match (demonstrating case-sensitivity is enforced).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.558734-05:00","updated_at":"2025-10-26T01:01:31.558734-05:00","closed_at":"2025-10-22T17:13:44.21466-05:00","dependencies":[{"issue_id":"voice-code-239","depends_on_id":"voice-code-238","type":"blocks","created_at":"2025-10-26T01:01:31.828324-05:00","created_by":"auto-import"}]}
{"id":"voice-code-240","title":"iOS: Write tests for lowercase UUID generation and usage","description":"Add Swift tests verifying all session ID strings are lowercase. Test: VoiceCodeClient message payloads, SessionSyncManager ID conversions, ConversationView session operations. Use XCTest assertions to verify .uuidString.lowercased() is used consistently.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.560228-05:00","updated_at":"2025-10-26T01:01:31.560228-05:00","closed_at":"2025-10-22T17:13:44.214794-05:00","dependencies":[{"issue_id":"voice-code-240","depends_on_id":"voice-code-227","type":"blocks","created_at":"2025-10-26T01:01:31.829919-05:00","created_by":"auto-import"},{"issue_id":"voice-code-240","depends_on_id":"voice-code-228","type":"blocks","created_at":"2025-10-26T01:01:31.831384-05:00","created_by":"auto-import"},{"issue_id":"voice-code-240","depends_on_id":"voice-code-229","type":"blocks","created_at":"2025-10-26T01:01:31.832382-05:00","created_by":"auto-import"}]}
{"id":"voice-code-241","title":"Integration test: Verify end-to-end UUID lowercase consistency","description":"Create integration test that verifies: (1) iOS sends lowercase session IDs, (2) Backend stores/retrieves without case normalization, (3) Session operations (create/subscribe/compact) work with lowercase IDs, (4) Uppercase IDs are rejected or fail to match.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.561648-05:00","updated_at":"2025-10-26T01:01:31.561648-05:00","closed_at":"2025-10-22T17:13:44.214919-05:00","dependencies":[{"issue_id":"voice-code-241","depends_on_id":"voice-code-239","type":"blocks","created_at":"2025-10-26T01:01:31.833633-05:00","created_by":"auto-import"},{"issue_id":"voice-code-241","depends_on_id":"voice-code-240","type":"blocks","created_at":"2025-10-26T01:01:31.835085-05:00","created_by":"auto-import"}]}
{"id":"voice-code-242","title":"Update STANDARDS.md to specify UUIDs must be lowercase","description":"Add explicit requirement to STANDARDS.md: 'All UUIDs (session IDs) must be lowercase across the entire system. iOS generates UUIDs with .lowercased(), backend stores and compares without case normalization.' Add examples showing correct usage.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.562872-05:00","updated_at":"2025-10-26T01:01:31.562872-05:00","closed_at":"2025-10-21T22:37:58.953919-05:00","dependencies":[{"issue_id":"voice-code-242","depends_on_id":"voice-code-241","type":"blocks","created_at":"2025-10-26T01:01:31.836084-05:00","created_by":"auto-import"}]}
{"id":"voice-code-243","title":"Lightning bolt icon color states for compaction feedback","description":"Implement color-coded lightning bolt icon to provide persistent visual feedback for compaction status. Icon should be gray/primary by default, green after compaction completes, and reset to gray when user sends next message. Green icon shows compaction stats and prevents accidental re-compaction.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-10-26T01:01:31.563909-05:00","updated_at":"2025-10-26T01:01:31.563909-05:00","closed_at":"2025-10-22T17:13:44.213755-05:00"}
{"id":"voice-code-244","title":"Add state variables for compaction feedback in ConversationView","description":"Add state management for tracking compaction status:\n- @State private var wasRecentlyCompacted: Bool = false\n- @State private var lastCompactionStats: CompactionResult? \n- @State private var compactionTimestamps: [UUID: Date] = [:]\n- @State private var recentCompactionsBySession: [UUID: CompactionResult] = [:]\n\nThese variables track whether the current session was recently compacted and store stats for display.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.565205-05:00","updated_at":"2025-10-26T01:01:31.565205-05:00","closed_at":"2025-10-22T09:48:09.08738-05:00","dependencies":[{"issue_id":"voice-code-244","depends_on_id":"voice-code-243","type":"blocks","created_at":"2025-10-26T01:01:31.837655-05:00","created_by":"auto-import"}]}
{"id":"voice-code-245","title":"Update lightning bolt icon to use green color when recently compacted","description":"Modify the bolt.fill icon in ConversationView toolbar to use conditional coloring:\n- Default state: .foregroundColor(.primary) \n- After compaction: .foregroundColor(.green)\n- Based on wasRecentlyCompacted state variable\n\nCode location: ios/VoiceCode/Views/ConversationView.swift toolbar section","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.567288-05:00","updated_at":"2025-10-26T01:01:31.567288-05:00","closed_at":"2025-10-22T09:48:13.603998-05:00","dependencies":[{"issue_id":"voice-code-245","depends_on_id":"voice-code-244","type":"blocks","created_at":"2025-10-26T01:01:31.838802-05:00","created_by":"auto-import"}]}
{"id":"voice-code-246","title":"Implement enhanced confirmation dialog for green (recently compacted) icon","description":"When user taps the green lightning bolt icon, show an informative alert instead of immediate compaction:\n\nTitle: 'Session Already Compacted'\nMessage: 'This session was compacted \u003crelative-time\u003e ago.\\n• Removed \u003cN\u003e messages\\n• Saved \u003cN\u003e tokens'\nActions: [Cancel] [Compact Again]\n\nRequirements:\n- Use relative time formatting (e.g., '2 minutes ago', '5m ago')\n- Display stats from lastCompactionStats\n- Only show 'Compact Again' option, which then shows standard confirmation\n- Alert should inform user and prevent accidental double-compaction","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.568511-05:00","updated_at":"2025-10-26T01:01:31.568511-05:00","closed_at":"2025-10-22T09:48:13.618936-05:00","dependencies":[{"issue_id":"voice-code-246","depends_on_id":"voice-code-245","type":"blocks","created_at":"2025-10-26T01:01:31.840157-05:00","created_by":"auto-import"}]}
{"id":"voice-code-247","title":"Update compaction completion handler to set green state","description":"When compaction completes successfully:\n1. Set wasRecentlyCompacted = true\n2. Store lastCompactionStats with the CompactionResult data\n3. Store timestamp in compactionTimestamps[session.id]\n4. Store result in recentCompactionsBySession[session.id]\n\nThis happens in the WebSocket message handler for 'compaction_complete' message type.\n\nLocation: ios/VoiceCode/Managers/VoiceCodeClient.swift or ConversationView compaction handler","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.56975-05:00","updated_at":"2025-10-26T01:01:31.56975-05:00","closed_at":"2025-10-22T09:48:13.633032-05:00","dependencies":[{"issue_id":"voice-code-247","depends_on_id":"voice-code-244","type":"blocks","created_at":"2025-10-26T01:01:31.841484-05:00","created_by":"auto-import"}]}
{"id":"voice-code-248","title":"Reset green icon state when user sends next message","description":"Implement logic to reset wasRecentlyCompacted to false when user sends a new message:\n- Hook into the message send flow\n- Set wasRecentlyCompacted = false after successful message send\n- Clear lastCompactionStats for the current session\n- This provides natural 'acknowledgment' that user has seen the compaction feedback\n\nLocation: ConversationView message sending logic or VoiceCodeClient prompt handler","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.57073-05:00","updated_at":"2025-10-26T01:01:31.57073-05:00","closed_at":"2025-10-22T09:48:13.647025-05:00","dependencies":[{"issue_id":"voice-code-248","depends_on_id":"voice-code-247","type":"blocks","created_at":"2025-10-26T01:01:31.842726-05:00","created_by":"auto-import"}]}
{"id":"voice-code-249","title":"Ensure green state is session-specific","description":"Verify that green compaction state is properly scoped to individual sessions:\n- When viewing Session A that was recently compacted, icon should be green\n- When switching to Session B, icon should be gray (not green)\n- When switching back to Session A (before sending message), icon should still be green\n- State should be keyed by session.id UUID\n\nImplementation approach:\n- Use recentCompactionsBySession dictionary keyed by UUID\n- On view appear/session change, check if current session.id is in dictionary\n- Set wasRecentlyCompacted based on dictionary lookup","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.572077-05:00","updated_at":"2025-10-26T01:01:31.572077-05:00","closed_at":"2025-10-22T09:48:13.661563-05:00","dependencies":[{"issue_id":"voice-code-249","depends_on_id":"voice-code-247","type":"blocks","created_at":"2025-10-26T01:01:31.843911-05:00","created_by":"auto-import"}]}
{"id":"voice-code-250","title":"Add relative time formatting utility","description":"Create helper function to format relative timestamps for compaction feedback:\n- Input: Date (compaction timestamp)\n- Output: String (e.g., '2 minutes ago', '5m ago', '1 hour ago')\n- Handle edge cases: seconds, minutes, hours, days\n- Keep format concise for UI display\n\nExample:\nfunc relativeTimeString(from date: Date) -\u003e String\n\nUsage: Display in 'Session Already Compacted' alert message","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.573024-05:00","updated_at":"2025-10-26T01:01:31.573024-05:00","closed_at":"2025-10-22T09:48:13.675504-05:00","dependencies":[{"issue_id":"voice-code-250","depends_on_id":"voice-code-246","type":"blocks","created_at":"2025-10-26T01:01:31.845044-05:00","created_by":"auto-import"}]}
{"id":"voice-code-251","title":"Write tests for compaction icon state management","description":"Create unit tests to verify compaction icon color state behavior:\n\nTest cases:\n1. Icon is gray/primary by default\n2. Icon turns green after successful compaction\n3. Icon returns to gray after user sends message\n4. Green state is session-specific (doesn't leak between sessions)\n5. Tapping green icon shows stats alert, not immediate compaction\n6. Tapping gray icon shows standard confirmation\n7. Stats display correctly in 'already compacted' alert\n8. Relative time formatting works correctly\n\nLocation: Create or update test file for ConversationView","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.574636-05:00","updated_at":"2025-10-26T01:01:31.574636-05:00","closed_at":"2025-10-22T09:48:13.688731-05:00","dependencies":[{"issue_id":"voice-code-251","depends_on_id":"voice-code-248","type":"blocks","created_at":"2025-10-26T01:01:31.846387-05:00","created_by":"auto-import"},{"issue_id":"voice-code-251","depends_on_id":"voice-code-249","type":"blocks","created_at":"2025-10-26T01:01:31.847825-05:00","created_by":"auto-import"}]}
{"id":"voice-code-252","title":"Manual testing: Verify icon color feedback workflow","description":"Perform end-to-end manual testing of the compaction icon color feedback:\n\nTest workflow:\n1. Open a session with message history\n2. Verify lightning bolt is gray/primary color\n3. Tap bolt → confirm compaction → verify compaction starts\n4. After compaction completes, verify bolt turns green\n5. Tap green bolt → verify 'Session Already Compacted' alert shows with stats\n6. Cancel alert → green bolt remains\n7. Send a new message → verify bolt returns to gray\n8. Switch to different session → verify bolt is gray\n9. Switch back to compacted session (before sending message) → verify bolt is still green\n10. Test double-compaction flow: tap green bolt → 'Compact Again' → verify second compaction works\n\nDocument any issues or unexpected behavior.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.575532-05:00","updated_at":"2025-10-26T01:01:31.575532-05:00","closed_at":"2025-10-22T17:13:44.214369-05:00","dependencies":[{"issue_id":"voice-code-252","depends_on_id":"voice-code-251","type":"blocks","created_at":"2025-10-26T01:01:31.848954-05:00","created_by":"auto-import"}]}
{"id":"voice-code-253","title":"Delayed Notification: Backend waits for valid messages before notifying iOS","description":"Implement delayed notification pattern to eliminate race condition where sessions created with only sidechain messages never appear on iOS.\n\n**Problem:**\n- 27% of terminal sessions (241/904) stuck at message-count: 0\n- Race condition: file created with sidechain → iOS notification skipped → real messages arrive → updates skipped (not subscribed) → deadlock\n\n**Solution:**\nBackend delays iOS notification until 0→N message transition detected. This eliminates:\n- Race condition deadlock\n- iOS filtering logic (except user-deleted sessions)\n- 0-message sessions in UI\n- Need for complex synchronization\n\n**Core Mechanism:**\n```\nFile created (0 msgs) → Add to index (internal, ios-notified: false)\n                     → Do NOT notify iOS\nMessages arrive     → Detect 0→N transition\n                     → Send session_created NOW\n                     → Mark ios-notified: true\n```\n\n**Architecture:**\n- Backend maintains complete index internally\n- Backend decides session \"readiness\"\n- iOS trusts backend, no filtering needed\n- Clean separation of concerns\n\n**Impact:**\n- Fixes 27% of sessions currently broken\n- Prevents future race conditions\n- Simplifies iOS logic\n- Improves user experience\n\nSee: backend/DESIGN-delayed-notification.md","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-10-26T01:01:31.577249-05:00","updated_at":"2025-10-26T01:01:31.577249-05:00","closed_at":"2025-10-22T13:05:43.722969-05:00"}
{"id":"voice-code-254","title":"Add ios-notified tracking fields to session metadata","description":"Add new tracking fields to session metadata structure to support delayed notifications.\n\n**Location:** backend/src/voice_code/replication.clj\n\n**Changes to build-session-metadata:**\n```clojure\n{:session-id session-id\n :file (.getAbsolutePath file)\n :name name\n :working-directory working-dir\n :created-at created-at\n :last-modified last-modified\n :message-count message-count\n :preview preview\n :first-message first-message\n :last-message last-message\n :ios-notified false        ; NEW: Track if iOS has been notified\n :first-notification nil}   ; NEW: Timestamp when iOS first notified\n```\n\n**Purpose:**\n- :ios-notified - Boolean flag indicating whether iOS has received session_created\n- :first-notification - Timestamp (milliseconds) of first notification to iOS\n\n**Impact:**\n- Index file format changes (backward compatible)\n- All new sessions get these fields with default values\n- Migration needed for existing sessions\n\n**Testing:**\n- Verify new sessions have both fields with correct defaults\n- Verify index save/load preserves new fields\n- Verify backward compatibility with old index entries","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.577757-05:00","updated_at":"2025-10-26T01:01:31.577757-05:00","closed_at":"2025-10-22T13:05:39.018892-05:00","dependencies":[{"issue_id":"voice-code-254","depends_on_id":"voice-code-253","type":"blocks","created_at":"2025-10-26T01:01:31.849618-05:00","created_by":"auto-import"}]}
{"id":"voice-code-255","title":"Modify handle-file-created to skip iOS notification for 0-message sessions","description":"Update file creation handler to add sessions to index but delay iOS notification until messages exist.\n\n**Location:** backend/src/voice_code/replication.clj (handle-file-created, lines ~570-595)\n\n**Current Behavior:**\n```clojure\n;; Notifies iOS only if message-count \u003e 0\n(when (pos? (:message-count metadata))\n  (when-let [callback (:on-session-created @watcher-state)]\n    (callback metadata)))\n```\n\n**New Behavior:**\n```clojure\n;; ALWAYS add to index (for backend tracking)\n(swap! session-index assoc session-id metadata)\n(save-index! @session-index)\n\n;; Initialize file position\n(swap! file-positions assoc file-path file-size)\n\n;; Only notify iOS if we have real messages\n(if (pos? message-count)\n  (do\n    (log/info \"Notifying iOS of new session with messages\"\n              {:session-id session-id :message-count message-count})\n    (when-let [callback (:on-session-created @watcher-state)]\n      (callback metadata))\n    ;; Mark as notified\n    (swap! session-index assoc-in [session-id :ios-notified] true)\n    (swap! session-index assoc-in [session-id :first-notification] (System/currentTimeMillis))\n    (save-index! @session-index))\n  ;; Log but don't notify yet\n  (log/info \"Session created with no messages yet, will notify when messages arrive\"\n            {:session-id session-id :name (:name metadata) :file-size file-size}))\n```\n\n**Key Changes:**\n1. Always add session to index (even with 0 messages)\n2. Check message-count before iOS notification\n3. If 0 messages: log and skip notification\n4. If \u003e0 messages: notify iOS AND mark :ios-notified true\n5. Save index after marking notified\n\n**Dependencies:**\n- Requires voice-code-254 (tracking fields) to be completed first\n\n**Testing:**\n- Create session with only sidechain → verify no iOS notification\n- Create session with real messages → verify iOS notified immediately\n- Verify index contains session in both cases\n- Verify :ios-notified flag set correctly","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.578343-05:00","updated_at":"2025-10-26T01:01:31.578343-05:00","closed_at":"2025-10-22T13:05:39.036141-05:00","dependencies":[{"issue_id":"voice-code-255","depends_on_id":"voice-code-253","type":"blocks","created_at":"2025-10-26T01:01:31.850299-05:00","created_by":"auto-import"}]}
{"id":"voice-code-256","title":"Detect 0→N transition in handle-file-modified and trigger delayed notification","description":"Update file modification handler to detect when session transitions from 0 to N messages and send delayed iOS notification.\n\n**Location:** backend/src/voice_code/replication.clj (handle-file-modified, lines ~600-680)\n\n**Core Logic:**\n```clojure\n(let [old-count (:message-count old-metadata 0)\n      new-count (+ old-count (count filtered-messages))\n      ios-notified? (:ios-notified old-metadata false)]\n  \n  ;; ALWAYS update index\n  (let [new-metadata (assoc old-metadata\n                           :last-modified (.lastModified file)\n                           :message-count new-count)]\n    (swap! session-index assoc session-id new-metadata)\n    (save-index! @session-index))\n  \n  ;; Check if this is the 0→N transition\n  (if (and (zero? old-count)\n           (pos? new-count)\n           (not ios-notified?))\n    ;; DELAYED NOTIFICATION TRIGGER\n    (do\n      (log/info \"Session now has messages - notifying iOS (delayed notification)\"\n                {:session-id session-id\n                 :message-count new-count\n                 :name (:name old-metadata)})\n      \n      ;; Send session_created NOW\n      (when-let [callback (:on-session-created @watcher-state)]\n        (callback (get @session-index session-id)))\n      \n      ;; Mark as notified\n      (swap! session-index assoc-in [session-id :ios-notified] true)\n      (swap! session-index assoc-in [session-id :first-notification] (System/currentTimeMillis))\n      (save-index! @session-index))\n    \n    ;; Normal update for already-notified sessions\n    (when (and ios-notified? (is-subscribed? session-id))\n      (log/debug \"Sending update to subscribed iOS client\"\n                 {:session-id session-id :new-messages (count filtered-messages)})\n      (when-let [callback (:on-session-updated @watcher-state)]\n        (callback session-id filtered-messages)))))\n```\n\n**Transition Detection:**\n- old-count = 0 AND new-count \u003e 0 AND ios-notified = false\n\n**Key Behaviors:**\n1. Always update index with new message count (even if not notified)\n2. Detect 0→N transition\n3. On transition: send session_created (delayed notification)\n4. Mark :ios-notified true and set :first-notification timestamp\n5. For already-notified sessions: continue normal subscription-based updates\n\n**This Solves the Race Condition:**\n- Session created with 0 messages → not notified (no deadlock)\n- Real messages arrive → 0→N detected → notification sent\n- iOS receives session_created with message-count \u003e 0\n- iOS subscribes → future updates work normally\n\n**Dependencies:**\n- Requires voice-code-254 (tracking fields)\n- Works with voice-code-255 (file creation changes)\n\n**Testing:**\n- Session with delayed first message → verify notification sent on first real message\n- Verify :ios-notified flag transitions false→true\n- Verify :first-notification timestamp set\n- Verify subsequent updates use normal subscription flow\n- Reproduce original race condition → verify it's fixed","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.579041-05:00","updated_at":"2025-10-26T01:01:31.579041-05:00","closed_at":"2025-10-22T13:05:39.048959-05:00","dependencies":[{"issue_id":"voice-code-256","depends_on_id":"voice-code-253","type":"blocks","created_at":"2025-10-26T01:01:31.851237-05:00","created_by":"auto-import"}]}
{"id":"voice-code-257","title":"Filter session list to only return ios-notified sessions","description":"Update session list handling to only return sessions that have been notified to iOS.\n\n**Location:** backend/src/voice_code/server.clj (handle-message \"connect\", lines ~250-270)\n\n**Current Code:**\n```clojure\n(let [all-sessions (repl/get-all-sessions)\n      ;; Filter to message-count \u003e 0 BEFORE taking top 50\n      valid-sessions (-\u003e\u003e all-sessions\n                          (filter #(pos? (or (:message-count %) 0)))\n                          (sort-by :last-modified \u003e)\n                          (take 50))]\n  ...)\n```\n\n**New Code:**\n```clojure\n(let [all-sessions (repl/get-all-sessions)\n      ;; Filter to only sessions we've notified iOS about\n      ;; This is our \"public\" list\n      notified-sessions (-\u003e\u003e all-sessions\n                             (filter #(:ios-notified % false))\n                             (sort-by :last-modified \u003e)\n                             (take 50)\n                             (mapv #(select-keys % [:session-id :name :working-directory\n                                                    :last-modified :message-count])))\n      total-notified (count (filter #(:ios-notified % false) all-sessions))\n      total-all (count all-sessions)]\n\n  (log/info \"Sending session list\"\n            {:count (count notified-sessions)\n             :total-notified total-notified\n             :total-all total-all})\n\n  (http/send! channel\n              (generate-json\n               {:type :session-list\n                :sessions notified-sessions\n                :total-count total-notified})))\n```\n\n**Key Changes:**\n1. Filter by :ios-notified instead of message-count \u003e 0\n2. This represents sessions iOS \"knows about\"\n3. Backend maintains complete index internally (all sessions)\n4. iOS only sees sessions that were deemed \"ready\"\n5. Enhanced logging shows total-notified vs total-all\n\n**Benefits:**\n- Clean separation: internal index vs public list\n- Backend controls session \"visibility\" to iOS\n- iOS never sees 0-message sessions (by design, not filtering)\n- Debugging: can see how many sessions exist vs notified\n\n**Dependencies:**\n- Requires voice-code-254 (tracking fields)\n- Works with voice-code-255 and voice-code-256\n\n**Testing:**\n- Create session with 0 messages → verify NOT in session list\n- Session gets messages → verify APPEARS in session list after refresh\n- Verify total_count reflects only notified sessions\n- Verify backend logs show total-notified vs total-all","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.581799-05:00","updated_at":"2025-10-26T01:01:31.581799-05:00","closed_at":"2025-10-22T13:05:39.063169-05:00","dependencies":[{"issue_id":"voice-code-257","depends_on_id":"voice-code-253","type":"blocks","created_at":"2025-10-26T01:01:31.851912-05:00","created_by":"auto-import"}]}
{"id":"voice-code-258","title":"Create migration script for 241 existing broken sessions","description":"Create one-time migration to fix existing sessions with messages but never notified to iOS.\n\n**Problem:** 241 sessions (27% of 904 total) have messages but :ios-notified = false\n\n**Location:** Create new file: backend/src/voice_code/migration.clj or run via REPL\n\n**Migration Logic:**\n```clojure\n(ns voice-code.migration\n  (:require [voice-code.replication :as repl]\n            [clojure.tools.logging :as log]))\n\n(defn migrate-unnotified-sessions\n  \"Fix sessions with messages but never notified to iOS\"\n  []\n  (let [index (repl/load-index)\n        unnotified-sessions (-\u003e\u003e index\n                                 vals\n                                 (filter #(and (pos? (:message-count %))\n                                              (not (:ios-notified % false)))))\n        total-count (count unnotified-sessions)]\n    \n    (log/info \"Starting migration for unnotified sessions\"\n              {:total-sessions (count index)\n               :unnotified-count total-count})\n    \n    (doseq [session unnotified-sessions]\n      (let [session-id (:session-id session)]\n        (log/info \"Migrating session\" {:session-id session-id\n                                         :message-count (:message-count session)})\n        \n        ;; Send session_created notification to connected iOS clients\n        (when-let [callback (:on-session-created @repl/watcher-state)]\n          (callback session))\n        \n        ;; Mark as notified in index\n        (swap! repl/session-index assoc-in [session-id :ios-notified] true)\n        (swap! repl/session-index assoc-in [session-id :first-notification] \n               (System/currentTimeMillis))))\n    \n    ;; Save updated index\n    (repl/save-index! @repl/session-index)\n    \n    (log/info \"Migration complete\"\n              {:migrated-count total-count})\n    \n    {:migrated total-count\n     :session-ids (map :session-id unnotified-sessions)}))\n```\n\n**Execution:**\nRun via REPL when backend is running:\n```clojure\n(require '[voice-code.migration :as mig])\n(mig/migrate-unnotified-sessions)\n```\n\n**Expected Results:**\n- 241 sessions marked as :ios-notified true\n- 241 session_created notifications sent to connected iOS clients\n- Index saved with updated flags\n- All 241 sessions now appear in iOS after refresh\n\n**Safety:**\n- Idempotent: can be run multiple times safely\n- Only affects sessions with positive message-count\n- No data loss risk (only adding flags)\n- Backend can continue running during migration\n\n**Verification:**\n```clojure\n;; Before: 241 unnotified sessions with messages\n(-\u003e\u003e (repl/load-index) vals\n     (filter #(and (pos? (:message-count %))\n                   (not (:ios-notified % false))))\n     count)\n;; Should be: 241\n\n;; After: 0 unnotified sessions with messages\n;; Should be: 0\n```\n\n**Testing:**\n- Dry-run mode that reports what would be migrated\n- Verify connected iOS clients receive notifications\n- Verify sessions appear in iOS list after migration\n- Verify index file contains updated flags","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.582377-05:00","updated_at":"2025-10-26T01:01:31.582377-05:00","closed_at":"2025-10-22T13:05:39.077248-05:00","dependencies":[{"issue_id":"voice-code-258","depends_on_id":"voice-code-253","type":"blocks","created_at":"2025-10-26T01:01:31.852428-05:00","created_by":"auto-import"}]}
{"id":"voice-code-259","title":"Remove 0-message filtering from iOS SessionSyncManager","description":"Simplify iOS session handling by removing defensive 0-message filtering since backend guarantees valid sessions.\n\n**Location:** ios/VoiceCode/Managers/SessionSyncManager.swift (handleSessionCreated, lines 91-96)\n\n**Current Behavior:** iOS filters out and drops any session_created message with messageCount = 0\n\n**New Behavior:** iOS trusts backend and saves all received sessions\n\n**Code Change:**\nRemove or modify the filtering check (lines 91-96) to always proceed to upsertSession\n\n**Rationale:**\n- Backend now delays notification until messages exist\n- iOS can trust backend decisions\n- Defensive filtering no longer needed\n- Cleaner trust relationship\n\n**Benefits:**\n1. Eliminates iOS-side filtering logic\n2. Reduces code complexity\n3. Trust backend as source of truth\n4. Backend handles all race condition prevention\n\n**Testing:**\n- Create session with immediate messages → verify saves normally\n- If backend bug sends 0-message session → verify iOS saves it (no crash)\n- Verify session list shows correct counts after backend migration\n- Verify no regressions in normal session creation flow\n\n**Dependencies:**\n- Should deploy AFTER backend changes (voice-code-255, voice-code-256)\n- Can deploy before migration (voice-code-258)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.582937-05:00","updated_at":"2025-10-26T01:01:31.582937-05:00","closed_at":"2025-10-22T13:05:39.091376-05:00","dependencies":[{"issue_id":"voice-code-259","depends_on_id":"voice-code-253","type":"blocks","created_at":"2025-10-26T01:01:31.853154-05:00","created_by":"auto-import"}]}
{"id":"voice-code-260","title":"Add unit tests for 0→N transition detection","description":"Write comprehensive unit tests for delayed notification and 0→N transition logic.\n\n**Location:** Create backend/test/voice_code/replication_test.clj\n\n**Test Cases:**\n\n**1. Session created with 0 messages does not trigger notification**\n- Create test file with only sidechain messages\n- Call handle-file-created\n- Verify callback NOT invoked\n- Verify session added to index with :ios-notified false\n\n**2. Session created with messages triggers immediate notification**\n- Create test file with real messages\n- Call handle-file-created\n- Verify callback invoked with correct metadata\n- Verify :ios-notified set to true\n- Verify :first-notification timestamp set\n\n**3. File modification with 0→N transition triggers delayed notification**\n- Create session with 0 messages (no notification)\n- Add real messages to file\n- Call handle-file-modified\n- Verify callback invoked (delayed notification)\n- Verify :ios-notified transitions false→true\n- Verify :first-notification timestamp set\n\n**4. File modification for already-notified session uses normal flow**\n- Create session with messages (notified)\n- Add more messages to file\n- Call handle-file-modified\n- Verify normal subscription-based update logic\n- Verify :ios-notified remains true\n\n**5. Multiple modifications before transition**\n- Create session with 0 messages\n- Add more sidechain messages (still 0 real messages)\n- Verify no notification\n- Add first real message\n- Verify notification sent on first real message\n\n**6. Metadata fields persistence**\n- Create and notify session\n- Save and reload index\n- Verify :ios-notified and :first-notification preserved\n\n**Test Infrastructure:**\n- Mock callback functions to verify invocations\n- Test file creation/modification helpers\n- Index state assertions\n- Timestamp validation\n\n**Success Criteria:**\n- All tests pass\n- Code coverage \u003e80% for modified functions\n- Tests are deterministic and fast (\u003c100ms each)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.583517-05:00","updated_at":"2025-10-26T01:01:31.583517-05:00","closed_at":"2025-10-22T13:05:39.106747-05:00","dependencies":[{"issue_id":"voice-code-260","depends_on_id":"voice-code-253","type":"blocks","created_at":"2025-10-26T01:01:31.853757-05:00","created_by":"auto-import"}]}
{"id":"voice-code-261","title":"Add integration test reproducing race condition fix","description":"Create end-to-end integration test that reproduces the original race condition and verifies the fix works.\n\n**Purpose:** Prove delayed notification eliminates race condition\n\n**Test Scenario:**\nReproduce exact timing that caused 241 broken sessions:\n1. Start Claude Code terminal session\n2. File created with only sidechain (warmup)\n3. Backend detects creation\n4. Verify: session added to index\n5. Verify: NO iOS notification sent\n6. Verify: :ios-notified = false\n7. Wait (simulate user delay before first prompt)\n8. Add real user message to file\n9. Backend detects modification\n10. Verify: 0→N transition detected\n11. Verify: session_created notification sent\n12. Verify: :ios-notified = true\n13. Verify: iOS can now subscribe and receive updates\n\n**Test Implementation:**\n```clojure\n(deftest test-race-condition-fixed\n  (testing \"Session created with sidechain then real messages\"\n    (let [notifications (atom [])\n          callback (fn [metadata] (swap! notifications conj metadata))\n          test-file (create-test-file-with-sidechain)]\n      \n      ;; Step 1: File created with only sidechain\n      (handle-file-created test-file callback)\n      \n      ;; Verify: No notification yet\n      (is (empty? @notifications) \"Should not notify on sidechain-only session\")\n      (is (contains? @session-index session-id) \"Should be in index\")\n      (is (false? (:ios-notified (get @session-index session-id))))\n      \n      ;; Step 2: Add real message\n      (append-real-message test-file \"Hello Claude\")\n      (handle-file-modified test-file callback)\n      \n      ;; Verify: Delayed notification sent\n      (is (= 1 (count @notifications)) \"Should notify after 0→N transition\")\n      (is (true? (:ios-notified (get @session-index session-id))))\n      (is (pos? (:message-count (first @notifications)))))))\n```\n\n**Verification Points:**\n- Original race condition would fail at step 11 (no notification)\n- Fixed version succeeds (notification sent)\n- Timing-sensitive: tests actual file watcher behavior\n- End-to-end: covers full notification flow\n\n**Test Variations:**\n1. Immediate first message (no delay) - should work both before and after fix\n2. Very long delay (minutes) - should still work with fix\n3. Multiple sidechain additions before real message - should trigger on first real\n\n**Environment:**\n- Uses real file system (temporary directory)\n- Real file watcher or mocked timing\n- Real index save/load cycle\n- Mocked iOS callbacks\n\n**Success Criteria:**\n- Test fails on old code (reproduces race condition)\n- Test passes on new code (proves fix)\n- Test is deterministic and repeatable\n- Test runs in reasonable time (\u003c5 seconds)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.584012-05:00","updated_at":"2025-10-26T01:01:31.584012-05:00","closed_at":"2025-10-22T13:05:39.120687-05:00","dependencies":[{"issue_id":"voice-code-261","depends_on_id":"voice-code-253","type":"blocks","created_at":"2025-10-26T01:01:31.854406-05:00","created_by":"auto-import"}]}
{"id":"voice-code-262","title":"Update documentation for delayed notification feature","description":"Update protocol documentation and architecture docs to reflect delayed notification behavior.\n\n**Files to Update:**\n\n**1. STANDARDS.md - WebSocket Protocol Section**\nAdd note about delayed notification behavior:\n- Backend may delay session_created until messages exist\n- iOS should expect sessions to always have message_count \u003e 0\n- Explain :ios-notified tracking field\n\n**2. backend/README.md or Architecture Doc**\nDocument delayed notification pattern:\n- Why it exists (race condition prevention)\n- How it works (0→N transition detection)\n- Index metadata fields (:ios-notified, :first-notification)\n- Migration information for existing deployments\n\n**3. DESIGN-delayed-notification.md**\nUpdate with final implementation details:\n- Mark as IMPLEMENTED\n- Add links to code locations\n- Document any deviations from original design\n- Add lessons learned\n\n**4. Code Comments**\nAdd inline documentation:\n- backend/src/voice_code/replication.clj (handle-file-created)\n- backend/src/voice_code/replication.clj (handle-file-modified)\n- backend/src/voice_code/server.clj (session list filtering)\n\n**Documentation Content:**\n\n**Architecture Decision:**\n\"Backend delays iOS notification until sessions contain at least one non-sidechain message. This eliminates a race condition where terminal sessions starting with only warmup messages would never appear on iOS.\"\n\n**For Developers:**\n\"The :ios-notified flag tracks whether iOS has been informed about a session. Sessions are always added to the backend index, but iOS notification is delayed until the 0→N message transition is detected.\"\n\n**For Operators:**\n\"Existing sessions with messages but :ios-notified=false can be migrated using the migration script. This affects approximately 27% of sessions created before this feature.\"\n\n**Success Criteria:**\n- Protocol documentation updated\n- Architecture rationale documented\n- Migration guide available\n- Code comments explain non-obvious logic\n- Future developers can understand the design","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.584504-05:00","updated_at":"2025-10-26T01:01:31.584504-05:00","closed_at":"2025-10-23T19:09:00.792091-05:00","dependencies":[{"issue_id":"voice-code-262","depends_on_id":"voice-code-253","type":"blocks","created_at":"2025-10-26T01:01:31.855069-05:00","created_by":"auto-import"}]}
{"id":"voice-code-263","title":"Backend: Fix session index showing placeholder working directories","description":"iOS was showing ugly placeholder titles like \"[from project: -Users-travisbrown-code-mono-hunt910-share-location]\" for sessions.\n\nRoot Cause:\n- Session index was loaded from cached .session-index.edn file instead of being rebuilt from filesystem\n- Cached index had old placeholder working directories\n- extract-working-dir successfully reads cwd from .jsonl files but cached index wasn't updated\n\nFix:\n- Added diagnostic logging to extract-working-dir, build-session-metadata, and session list handler\n- Added warning when sending sessions with placeholder working directories to iOS\n- Rebuild session index from filesystem (reads cwd from .jsonl files line 1-10)\n- Properly save index to disk with backend stopped to prevent race condition\n- Backend now loads corrected index with real paths instead of placeholders\n\nImpact:\n- Sessions now show proper working directory names like \"hunt910-share-location\"\n- Eliminates ugly placeholder strings in iOS session titles\n- Improved logging for troubleshooting session index issues\n\nFiles Modified:\n- backend/src/voice_code/replication.clj: Added logging to extract-working-dir and build-session-metadata\n- backend/src/voice_code/server.clj: Added warning when sending placeholder working directories to iOS","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-10-26T01:01:31.584923-05:00","updated_at":"2025-10-26T01:01:31.584923-05:00","closed_at":"2025-10-22T15:03:15.529569-05:00"}
{"id":"voice-code-264","title":"Enable Audio background mode in Xcode project","description":"Add 'Audio, AirPlay, and Picture in Picture' background mode to the iOS app target in Xcode.\n\nSteps:\n1. Open the iOS project in Xcode\n2. Select the app target\n3. Go to 'Signing \u0026 Capabilities' tab\n4. Click '+ Capability' \n5. Add 'Background Modes'\n6. Check 'Audio, AirPlay, and Picture in Picture'\n\nThis enables the app to continue audio playback when the screen is locked or the app is backgrounded.\n\nAcceptance: Background Modes capability is visible in project settings with Audio checkbox enabled.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.585343-05:00","updated_at":"2025-10-26T01:01:31.585343-05:00","closed_at":"2025-10-22T19:02:54.40883-05:00","dependencies":[{"issue_id":"voice-code-264","depends_on_id":"voice-code-50","type":"blocks","created_at":"2025-10-26T01:01:31.855759-05:00","created_by":"auto-import"}]}
{"id":"voice-code-265","title":"Configure AVAudioSession for background playback","description":"Configure the AVAudioSession to use playback category so TTS continues when the screen locks.\n\nImplementation location: Look for existing AVAudioSession configuration in the iOS app (likely in AppDelegate, SceneDelegate, or a dedicated audio manager class).\n\nCode to add:\nimport AVFoundation\n\nIn app initialization or before first TTS playback:\n- Get AVAudioSession.sharedInstance()\n- Set category to .playback with mode .spokenAudio\n- Call setActive(true)\n- Handle errors appropriately\n\nNotes:\n- playback category allows audio to continue when screen locks\n- spokenAudio mode optimizes for voice/TTS content\n- setActive activates the session\n- This should be called early in app lifecycle, before any TTS playback\n\nAcceptance: AVAudioSession is configured with playback category and spokenAudio mode. TTS playback continues when screen locks (may need silence workaround for long responses).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.585791-05:00","updated_at":"2025-10-26T01:01:31.585791-05:00","closed_at":"2025-10-22T19:02:54.409397-05:00","dependencies":[{"issue_id":"voice-code-265","depends_on_id":"voice-code-264","type":"blocks","created_at":"2025-10-26T01:01:31.856792-05:00","created_by":"auto-import"}]}
{"id":"voice-code-266","title":"Implement silence snippet workaround for long TTS playback","description":"iOS may stop TTS playback after 30-60 seconds when the app is backgrounded/locked. Implement a workaround that plays brief silent audio snippets periodically to keep the audio session active.\n\nImplementation approach:\n1. Create or generate a short (100-200ms) silent audio file (e.g., silence.mp3 or silence.m4a)\n2. Add the file to the Xcode project bundle\n3. Use AVAudioPlayer to play the silent audio periodically while TTS is active in background\n4. Schedule playback every 20-30 seconds during long TTS sessions\n5. Stop the timer when TTS completes or app returns to foreground\n\nAlternative approach:\n- Some developers use AVAudioPlayer with a looping silent track\n- Others use a Timer that triggers brief audio playback\n- Consider using AVSpeechSynthesizer delegate methods to detect when speech is ongoing\n\nImplementation considerations:\n- Only activate this workaround when app is backgrounded AND TTS is playing\n- Clean up timers/players when no longer needed to avoid battery drain\n- Test with responses longer than 60 seconds to verify effectiveness\n- Monitor for iOS updates that might change this behavior\n\nAcceptance: TTS playback continues for responses longer than 60 seconds when screen is locked. No audio glitches or interruptions. Silence mechanism only activates when needed.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.586498-05:00","updated_at":"2025-10-26T01:01:31.586498-05:00","closed_at":"2025-10-22T19:02:54.409664-05:00","dependencies":[{"issue_id":"voice-code-266","depends_on_id":"voice-code-265","type":"blocks","created_at":"2025-10-26T01:01:31.857474-05:00","created_by":"auto-import"}]}
{"id":"voice-code-267","title":"Test locked-screen TTS with short responses","description":"Manual testing to verify TTS playback works when iPhone screen is locked for short responses (under 30 seconds).\n\nTest scenarios:\n1. Start TTS playback of a short response (10-15 seconds)\n2. Lock the iPhone screen immediately\n3. Verify audio continues playing through to completion\n4. Unlock and verify app state is correct\n\nEdge cases to test:\n- Lock screen DURING TTS playback (mid-sentence)\n- Lock screen BEFORE TTS starts (queued response)\n- Incoming call during locked-screen playback\n- Notifications during playback\n- Switch to another app then lock screen\n- Headphone connect/disconnect while locked\n\nDevice conditions:\n- Test with iPhone in silent mode\n- Test with ringer on\n- Test with Do Not Disturb enabled\n- Test with low battery mode\n\nExpected behavior:\n- TTS continues playing when screen locks\n- Audio completes normally\n- No crashes or state corruption\n- Playback can be controlled via lock screen controls (if applicable)\n\nAcceptance: All test scenarios pass. Short TTS responses play completely when screen is locked.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.587218-05:00","updated_at":"2025-10-26T01:01:31.587218-05:00","closed_at":"2025-10-22T19:20:33.431209-05:00","dependencies":[{"issue_id":"voice-code-267","depends_on_id":"voice-code-265","type":"blocks","created_at":"2025-10-26T01:01:31.858289-05:00","created_by":"auto-import"}]}
{"id":"voice-code-268","title":"Test locked-screen TTS with long responses","description":"Manual testing to verify TTS playback works when iPhone screen is locked for long responses (60+ seconds) with the silence snippet workaround.\n\nTest scenarios:\n1. Request a long response from Claude (aim for 90-120 seconds of TTS)\n2. Lock the iPhone screen at various points:\n   - Before TTS starts\n   - 10 seconds into playback\n   - 30 seconds into playback\n   - 60 seconds into playback\n3. Verify audio continues playing through to completion\n4. Verify no audible glitches from silence snippet playback\n\nSpecific long-response tests:\n- Ask Claude to explain a complex technical concept\n- Request a detailed code walkthrough\n- Ask for step-by-step instructions\n- Request a long story or explanation\n\nMonitor for issues:\n- Audio cutting out after 30-60 seconds\n- Audible silence snippets (should be inaudible)\n- Battery drain from workaround\n- Memory leaks from timers not being cleaned up\n- TTS restart/stutter when silence plays\n\nDevice states to test:\n- Screen locked entire duration\n- Lock during playback, unlock midway, re-lock\n- Background the app instead of locking\n- Switch to another app then lock screen\n\nExpected behavior:\n- TTS continues playing for full duration (120+ seconds)\n- Silence workaround is transparent to user\n- No audio artifacts or interruptions\n- App state remains correct when unlocking\n\nAcceptance: Long TTS responses (90+ seconds) play completely when screen is locked. No audible glitches. Silence workaround functions correctly.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.587909-05:00","updated_at":"2025-10-26T01:01:31.587909-05:00","closed_at":"2025-10-22T19:20:33.431628-05:00","dependencies":[{"issue_id":"voice-code-268","depends_on_id":"voice-code-266","type":"blocks","created_at":"2025-10-26T01:01:31.859228-05:00","created_by":"auto-import"}]}
{"id":"voice-code-269","title":"Update documentation for locked-screen playback feature","description":"Document the locked-screen TTS playback feature in user-facing and technical documentation.\n\nUser documentation updates:\n- Add to feature list: 'Listen to responses with screen locked'\n- Add to usage tips: 'You can lock your phone during responses and audio will continue playing'\n- Note any limitations (iOS version requirements, etc.)\n\nTechnical documentation updates:\n- Document the AVAudioSession configuration\n- Explain the silence snippet workaround and why it's needed\n- Document the background mode capability requirement\n- Add troubleshooting section for audio issues\n\nImplementation notes to document:\n- Which iOS versions this works on (test and document minimum version)\n- Any known issues or edge cases\n- Battery impact (if measurable)\n- How the silence workaround is implemented\n\nFiles to update:\n- README.md (if it has user features section)\n- Any user guide or help documentation\n- Technical architecture docs\n- Known limitations document\n\nAcceptance: Documentation clearly explains the locked-screen playback feature, how it works, and any limitations. Technical docs explain implementation details for future maintainers.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.588455-05:00","updated_at":"2025-10-26T01:01:31.588455-05:00","closed_at":"2025-10-23T19:09:00.791305-05:00","dependencies":[{"issue_id":"voice-code-269","depends_on_id":"voice-code-268","type":"blocks","created_at":"2025-10-26T01:01:31.859972-05:00","created_by":"auto-import"}]}
{"id":"voice-code-270","title":"Add unit tests for AVAudioSession configuration","description":"Write unit tests to verify AVAudioSession is configured correctly for background playback.\n\nTests to implement:\n\n1. Test audio session category is set to .playback\n   - Verify category after configuration\n   - Test that it persists across app lifecycle\n\n2. Test audio session mode is .spokenAudio\n   - Verify mode is correctly set\n   - Ensure it's appropriate for TTS content\n\n3. Test audio session activation\n   - Verify setActive(true) is called\n   - Test error handling for activation failures\n\n4. Test audio session deactivation (if implemented)\n   - Verify proper cleanup when TTS stops\n   - Test reactivation after deactivation\n\n5. Test error handling\n   - Simulate AVAudioSession errors\n   - Verify app handles failures gracefully\n   - Check error logging is appropriate\n\n6. Test session interruption handling\n   - Simulate incoming call scenario\n   - Test recovery after interruption ends\n   - Verify TTS state is handled correctly\n\nTesting approach:\n- Use XCTest framework\n- Mock AVAudioSession if possible for deterministic tests\n- Test both success and failure paths\n- Verify logging output\n\nAcceptance: Unit tests cover AVAudioSession configuration, activation, error handling, and interruption scenarios. All tests pass.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.588979-05:00","updated_at":"2025-10-26T01:01:31.588979-05:00","closed_at":"2025-10-22T19:42:42.075281-05:00","dependencies":[{"issue_id":"voice-code-270","depends_on_id":"voice-code-265","type":"blocks","created_at":"2025-10-26T01:01:31.860566-05:00","created_by":"auto-import"}]}
{"id":"voice-code-271","title":"Add user setting to control locked-screen TTS playback","description":"Add a user-configurable setting to enable or disable TTS playback when the iPhone screen is locked. Some users may prefer TTS to stop when they lock their screen.\n\nImplementation:\n\n1. Add setting to app preferences:\n   - Setting name: Continue playback when locked or Play audio with screen locked\n   - Default value: true (enabled) - most users want this\n   - Store in UserDefaults or app configuration\n\n2. Update AVAudioSession configuration:\n   - Check the setting before configuring audio session category\n   - If enabled: use playback category (allows background playback)\n   - If disabled: use ambient or soloAmbient category (stops when locked)\n\n3. UI considerations:\n   - Add toggle in Settings screen\n   - Clear description explaining what it does\n   - Consider placement with other audio settings\n\n4. Handle setting changes:\n   - If user toggles setting mid-playback, apply on next TTS session\n   - No need to interrupt current playback\n   - Audio session reconfiguration happens before next speech\n\nEdge cases:\n- What happens if user locks screen with setting disabled? (TTS should stop)\n- What if they enable it mid-session? (Takes effect on next TTS)\n- Should silence workaround also be conditional? (Yes, only if setting enabled)\n\nAcceptance: Users can toggle locked-screen playback in settings. When disabled, TTS stops when screen locks. When enabled, TTS continues playing.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.589392-05:00","updated_at":"2025-10-26T01:01:31.589392-05:00","closed_at":"2025-10-22T19:02:54.409536-05:00","dependencies":[{"issue_id":"voice-code-271","depends_on_id":"voice-code-264","type":"blocks","created_at":"2025-10-26T01:01:31.86143-05:00","created_by":"auto-import"}]}
{"id":"voice-code-272","title":"iOS: Track user scroll position to detect manual scrolling","description":"Track whether the user has manually scrolled away from the bottom of the conversation to disable auto-scroll behavior.\n\nTECHNICAL CONTEXT:\nConversationView.swift uses ScrollViewReader to display messages in a ScrollView. Currently, we always auto-scroll on new messages (line ~95-101), but we need to track user scroll position to know when to disable this behavior.\n\nIMPLEMENTATION:\n\nFile: ios/VoiceCode/Views/ConversationView.swift\n\nAdd state variable to track scroll position:\n@State private var isUserScrolledUp = false\n@State private var shouldAutoScroll = true  // User preference to auto-scroll\n\nAdd GeometryReader + PreferenceKey pattern to detect scroll position:\n\n1. Define preference key for scroll offset:\nstruct ScrollOffsetPreferenceKey: PreferenceKey {\n    static var defaultValue: CGFloat = 0\n    static func reduce(value: inout CGFloat, nextValue: () -\u003e CGFloat) {\n        value = nextValue()\n    }\n}\n\n2. Add GeometryReader inside ScrollView to track offset:\nScrollView {\n    GeometryReader { geometry in\n        Color.clear.preference(\n            key: ScrollOffsetPreferenceKey.self,\n            value: geometry.frame(in: .named(\"scroll\")).minY\n        )\n    }\n    .frame(height: 0)\n    \n    LazyVStack(spacing: 12) {\n        // ... existing message views\n    }\n}\n.coordinateSpace(name: \"scroll\")\n.onPreferenceChange(ScrollOffsetPreferenceKey.self) { offset in\n    detectUserScroll(offset: offset)\n}\n\n3. Add detection function:\nprivate func detectUserScroll(offset: CGFloat) {\n    // If user scrolls up more than 50 points from bottom, disable auto-scroll\n    // Negative offset means scrolled up from top\n    isUserScrolledUp = offset \u003c -50\n}\n\nEDGE CASES:\n- Empty session: Don't track scroll position if no messages\n- Single message: Consider user at bottom\n- Rapid scrolling: Debounce detection to avoid flicker\n- View appears: Default to bottom (shouldAutoScroll = true, isUserScrolledUp = false)\n\nTESTING:\n- Open session → default to auto-scroll enabled\n- Scroll up manually → isUserScrolledUp becomes true\n- Scroll back to bottom → isUserScrolledUp becomes false\n- New message arrives while scrolled up → verify auto-scroll disabled\n- New message arrives at bottom → verify auto-scroll still works\n\nREFERENCES:\n- SwiftUI PreferenceKey: https://developer.apple.com/documentation/swiftui/preferencekey\n- CoordinateSpace: https://developer.apple.com/documentation/swiftui/coordinatespace\n\nThis task provides the foundation for voice-code-272 (disable auto-scroll) and voice-code-273 (re-engagement button).","notes":"Implemented scroll position tracking using SwiftUI PreferenceKey pattern.\n\nChanges made to ConversationView.swift:\n- Added ScrollOffsetPreferenceKey PreferenceKey for tracking scroll offset\n- Added @State isUserScrolledUp and unreadWhileScrolledUp\n- Added GeometryReader with .preference() inside ScrollView\n- Added .coordinateSpace(name: \"scroll\") and .onPreferenceChange()\n- Implemented detectUserScroll(offset:) with 50px threshold\n- Resets unreadWhileScrolledUp when user scrolls back to bottom\n\nThe system now accurately detects when users scroll up to read history vs staying at the bottom.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.58974-05:00","updated_at":"2025-10-26T01:01:31.58974-05:00","closed_at":"2025-10-22T19:58:46.009839-05:00"}
{"id":"voice-code-273","title":"iOS: Disable auto-scroll when user scrolls up manually","description":"Modify auto-scroll logic to respect user scroll position - don't auto-scroll when user has manually scrolled up to read history.\n\nDEPENDS ON: voice-code-272 (scroll position tracking)\n\nTECHNICAL CONTEXT:\nCurrently, ConversationView.swift always auto-scrolls to new messages via .onChange(of: messages.count) at lines ~95-101. We need to make this conditional based on whether the user is actively reading older messages.\n\nIMPLEMENTATION:\n\nFile: ios/VoiceCode/Views/ConversationView.swift\n\nModify existing .onChange(of: messages.count) block:\n\nBEFORE:\n.onChange(of: messages.count) { _ in\n    // Auto-scroll to bottom on new message\n    if let lastMessage = messages.last {\n        withAnimation {\n            proxy.scrollTo(lastMessage.id, anchor: .bottom)\n        }\n    }\n}\n\nAFTER:\n.onChange(of: messages.count) { oldCount, newCount in\n    // Only auto-scroll if:\n    // 1. New messages arrived (not initial load)\n    // 2. User hasn't manually scrolled up\n    // 3. Auto-scroll is enabled (user preference)\n    guard newCount \u003e oldCount else { return }\n    guard !isUserScrolledUp else { return }\n    guard shouldAutoScroll else { return }\n    \n    if let lastMessage = messages.last {\n        withAnimation {\n            proxy.scrollTo(lastMessage.id, anchor: .bottom)\n        }\n    }\n}\n\nBEHAVIOR:\n- User at bottom → new message → auto-scroll ✓\n- User scrolled up → new message → no auto-scroll ✓\n- User scrolls back to bottom → next message → auto-scroll ✓\n- User disables auto-scroll preference → never auto-scroll ✓\n\nEDGE CASES:\n- Initial session load: Don't auto-scroll during loading (handled by guard newCount \u003e oldCount)\n- Rapid message arrivals: Animation will queue naturally\n- User sends message: Should always scroll to show their message (add override flag if needed)\n\nTESTING:\n- Open session at bottom, receive message → should auto-scroll\n- Scroll up 100px, receive message → should NOT auto-scroll\n- Scroll back to bottom, receive message → should auto-scroll again\n- Send message while scrolled up → should scroll to show sent message\n- Empty session receives first message → should show message\n\nREFERENCES:\n- Current auto-scroll implementation: ConversationView.swift:95-101\n- Scroll tracking from voice-code-272: isUserScrolledUp state variable\n\nThis task enables the core smart auto-scroll behavior and sets up voice-code-273 (re-engagement button).","notes":"Implemented conditional auto-scroll logic that respects user scroll position.\n\nChanges made to ConversationView.swift:\n- Modified .onChange(of: messages.count) to check isUserScrolledUp\n- Added guard for newCount \u003e oldCount (prevents initial load scroll)\n- When scrolled up: increment unreadWhileScrolledUp counter\n- When at bottom: auto-scroll with animation to newest message\n\nBehavior:\n- User at bottom + new message → auto-scroll ✓\n- User scrolled up + new message → no auto-scroll, increment unread counter ✓\n- User returns to bottom → resume auto-scroll ✓","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.590113-05:00","updated_at":"2025-10-26T01:01:31.590113-05:00","closed_at":"2025-10-22T19:58:52.634948-05:00"}
{"id":"voice-code-274","title":"iOS: Add floating 'Scroll to Bottom' button when scrolled up","description":"Add a floating action button that appears when the user scrolls up, allowing them to quickly jump back to the bottom and re-enable auto-scroll.\n\nDEPENDS ON: voice-code-272 (scroll position tracking), voice-code-273 (conditional auto-scroll)\n\nTECHNICAL CONTEXT:\nWhen users scroll up to read history, auto-scroll is disabled (voice-code-273). We need a clear way for them to return to the bottom and re-engage auto-scroll behavior. A floating button is the standard pattern (see iMessage, Slack, Discord).\n\nDESIGN SPECS:\n- Button appears when isUserScrolledUp = true\n- Button shows unread message count badge if new messages arrived while scrolled up\n- Button position: Bottom-right, above input area, with padding\n- Button style: Circular, blue background, white chevron-down icon\n- Animation: Slide up from bottom with spring animation\n- Tap behavior: Scroll to bottom + reset isUserScrolledUp = false\n\nIMPLEMENTATION:\n\nFile: ios/VoiceCode/Views/ConversationView.swift\n\n1. Add state for unread count while scrolled up:\n@State private var unreadWhileScrolledUp = 0\n\n2. Track unread messages in .onChange(of: messages.count):\n.onChange(of: messages.count) { oldCount, newCount in\n    guard newCount \u003e oldCount else { return }\n    \n    if isUserScrolledUp {\n        // User scrolled up, increment unread counter instead of scrolling\n        unreadWhileScrolledUp += (newCount - oldCount)\n    } else if shouldAutoScroll {\n        // User at bottom, auto-scroll\n        if let lastMessage = messages.last {\n            withAnimation {\n                proxy.scrollTo(lastMessage.id, anchor: .bottom)\n            }\n        }\n    }\n}\n\n3. Add floating button overlay (after .overlay(alignment: .top) for copy confirmation):\n.overlay(alignment: .bottomTrailing) {\n    if isUserScrolledUp {\n        Button(action: {\n            scrollToBottomAndReset(proxy: proxy)\n        }) {\n            ZStack(alignment: .topTrailing) {\n                // Main button\n                Circle()\n                    .fill(Color.blue)\n                    .frame(width: 56, height: 56)\n                    .shadow(radius: 4)\n                \n                Image(systemName: \"chevron.down\")\n                    .font(.system(size: 24, weight: .semibold))\n                    .foregroundColor(.white)\n                \n                // Unread badge\n                if unreadWhileScrolledUp \u003e 0 {\n                    Text(\"\\(unreadWhileScrolledUp)\")\n                        .font(.caption2)\n                        .fontWeight(.bold)\n                        .foregroundColor(.white)\n                        .padding(6)\n                        .background(Color.red)\n                        .clipShape(Circle())\n                        .offset(x: 8, y: -8)\n                }\n            }\n        }\n        .padding(.trailing, 16)\n        .padding(.bottom, 16)\n        .transition(.move(edge: .bottom).combined(with: .opacity))\n    }\n}\n\n4. Add helper function:\nprivate func scrollToBottomAndReset(proxy: ScrollViewProxy) {\n    // Scroll to bottom\n    if let lastMessage = messages.last {\n        withAnimation(.spring()) {\n            proxy.scrollTo(lastMessage.id, anchor: .bottom)\n        }\n    }\n    \n    // Reset state\n    isUserScrolledUp = false\n    unreadWhileScrolledUp = 0\n}\n\n5. Reset unread count when user scrolls to bottom naturally:\nprivate func detectUserScroll(offset: CGFloat) {\n    let wasScrolledUp = isUserScrolledUp\n    isUserScrolledUp = offset \u003c -50\n    \n    // User scrolled back to bottom naturally\n    if wasScrolledUp \u0026\u0026 !isUserScrolledUp {\n        unreadWhileScrolledUp = 0\n    }\n}\n\nVISUAL DESIGN:\n┌─────────────────────────┐\n│  [Messages ScrollView]  │\n│                         │\n│  ← User scrolled up     │\n│                         │\n│                    ╭─╮  │ ← Floating button\n│                    │3│  │ ← Badge (if 3 unread)\n│                    ╰─╯  │\n│                    ▼    │ ← Chevron icon\n└─────────────────────────┘\n  [Input Area]\n\nBEHAVIOR:\n- User scrolls up 60px → Button slides up into view\n- New message arrives → Badge shows \"1\"\n- Another message → Badge updates to \"2\"\n- User taps button → Smooth scroll to bottom, badge disappears, button slides down\n- User scrolls to bottom manually → Badge resets to 0, button slides down\n\nEDGE CASES:\n- Button appears during scroll animation: Use .transition for smooth appearance\n- Multiple rapid messages: Update badge count atomically\n- User scrolls up/down rapidly: Debounce button appearance to avoid flicker\n- Very long messages at bottom: Ensure .bottom anchor shows entire message\n- Empty unread count: Show button without badge\n\nACCESSIBILITY:\n- Add .accessibilityLabel(\"Scroll to bottom\")\n- Add .accessibilityHint(\"Scroll to the newest message\")\n- Badge should read \"\\(count) new messages\"\n\nTESTING:\n- Scroll up → verify button appears\n- Receive message while scrolled up → verify badge shows count\n- Tap button → verify smooth scroll to bottom + badge reset\n- Scroll to bottom manually → verify button disappears + badge reset\n- Receive message at bottom (not scrolled up) → verify button stays hidden\n\nREFERENCES:\n- iMessage floating button pattern\n- SwiftUI .overlay(alignment:): https://developer.apple.com/documentation/swiftui/view/overlay(alignment:content:)\n- Spring animations: https://developer.apple.com/documentation/swiftui/animation/spring(response:dampingfraction:blendDuration:)\n\nThis completes the auto-scroll feature set with intuitive user control.","notes":"Implemented floating scroll-to-bottom button with unread badge.\n\nChanges made to ConversationView.swift:\n- Added @State scrollProxy to store ScrollViewProxy reference\n- Added .overlay(alignment: .bottomTrailing) with floating button\n- Button appears when isUserScrolledUp = true\n- Button shows ZStack with Circle (blue), chevron.down icon, and red badge\n- Badge displays unreadWhileScrolledUp count when \u003e 0\n- Added scrollToBottomAndReset() helper function\n- Included accessibility labels and hints\n- Used .spring() animation for smooth scroll\n- Button slides in/out with .transition(.move + .opacity)\n\nVisual: 56x56 blue circle, white chevron, red badge in top-right corner\nBehavior: Tap → scroll to bottom + reset state + clear badge","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.590664-05:00","updated_at":"2025-10-26T01:01:31.590664-05:00","closed_at":"2025-10-22T19:59:01.2709-05:00"}
{"id":"voice-code-275","title":"iOS: Add initial auto-scroll on session open","description":"When opening a session, automatically scroll to the most recent message so users don't have to manually scroll down.\n\nDEPENDS ON: voice-code-272 (scroll position tracking)\n\nTECHNICAL CONTEXT:\nThis implements the original feature request from voice-code-175. Currently, when opening a session in ConversationView, the ScrollView starts at the top showing the oldest messages. Users must manually scroll to see recent conversation.\n\nIMPLEMENTATION:\n\nFile: ios/VoiceCode/Views/ConversationView.swift\n\nModify loadSessionIfNeeded() to trigger scroll after messages load:\n\nAdd state to track if we've done initial scroll:\n@State private var hasPerformedInitialScroll = false\n\nAdd ScrollViewProxy parameter storage:\n@State private var scrollProxy: ScrollViewProxy?\n\nStore proxy reference in ScrollViewReader:\nScrollViewReader { proxy in\n    ScrollView {\n        // ... existing content\n    }\n    .onAppear {\n        scrollProxy = proxy  // Store for later use\n    }\n}\n\nTrigger scroll after loading:\nprivate func loadSessionIfNeeded() {\n    guard !hasLoadedMessages else { return }\n\n    isLoading = true\n    hasLoadedMessages = true\n\n    // Mark session as active for smart speaking\n    ActiveSessionManager.shared.setActiveSession(session.id)\n\n    // Clear unread count when opening session\n    session.unreadCount = 0\n    try? viewContext.save()\n\n    // Subscribe to the session to load full history\n    client.subscribe(sessionId: session.id.uuidString.lowercased())\n\n    // Stop loading indicator and scroll to bottom after messages populate\n    DispatchQueue.main.asyncAfter(deadline: .now() + 1.0) {\n        isLoading = false\n        \n        // Perform initial scroll to bottom\n        if !hasPerformedInitialScroll, let proxy = scrollProxy, let lastMessage = messages.last {\n            hasPerformedInitialScroll = true\n            // Use non-animated scroll for instant appearance\n            proxy.scrollTo(lastMessage.id, anchor: .bottom)\n        }\n    }\n}\n\nALTERNATIVE APPROACH (simpler):\nInstead of storing proxy, use .onChange(of: isLoading) inside ScrollViewReader:\n\nScrollViewReader { proxy in\n    ScrollView {\n        // ... content\n    }\n    .onChange(of: isLoading) { wasLoading, nowLoading in\n        // When loading finishes and we haven't scrolled yet\n        if wasLoading \u0026\u0026 !nowLoading \u0026\u0026 !hasPerformedInitialScroll {\n            hasPerformedInitialScroll = true\n            if let lastMessage = messages.last {\n                // Non-animated for immediate positioning\n                proxy.scrollTo(lastMessage.id, anchor: .bottom)\n            }\n        }\n    }\n}\n\nBEHAVIOR:\n- User opens session → Loading spinner shows → Messages appear at bottom (newest visible)\n- User opens empty session → No crash, graceful handling\n- User opens session with 1 message → Message visible\n- User returns to already-opened session → No re-scroll (hasPerformedInitialScroll = true)\n\nEDGE CASES:\n- Empty session: Check messages.last before scrolling\n- Single message: Should work identically (scroll to first = scroll to last)\n- Very long session: Scroll should work regardless of message count\n- Session with only system messages: Should still scroll to bottom\n- Fast navigation (open → close → open): Reset hasPerformedInitialScroll in .onAppear\n\nReset flag on view appear (to handle navigation):\n.onAppear {\n    loadSessionIfNeeded()\n    setupVoiceInput()\n    \n    // Reset scroll flag for this session view\n    hasPerformedInitialScroll = false\n    \n    // ... existing draft restoration\n}\n\nTIMING CONSIDERATIONS:\n- Current delay: 1.0 second (matches loading indicator)\n- Messages may populate via CoreData sync before delay completes\n- Consider using .onChange(of: messages.isEmpty) instead of delay:\n\n.onChange(of: messages.isEmpty) { wasEmpty, isEmpty in\n    // Messages just populated\n    if wasEmpty \u0026\u0026 !isEmpty \u0026\u0026 !hasPerformedInitialScroll {\n        hasPerformedInitialScroll = true\n        if let lastMessage = messages.last {\n            proxy.scrollTo(lastMessage.id, anchor: .bottom)\n        }\n    }\n}\n\nTESTING:\n- Open session with 50 messages → should show message #50 (newest)\n- Open session with 1 message → should show that message\n- Open empty session → should not crash\n- Navigate away and back → should re-scroll to bottom\n- Open session, scroll up, close, reopen → should re-scroll to bottom (fresh view)\n\nREFERENCES:\n- ScrollViewProxy.scrollTo: https://developer.apple.com/documentation/swiftui/scrollviewproxy/scrollto(_:anchor:)\n- Current loadSessionIfNeeded: ConversationView.swift:312-333\n\nRECOMMENDED IMPLEMENTATION ORDER:\n1. voice-code-275 (this task) - Basic open-and-scroll\n2. voice-code-272 - Scroll position tracking\n3. voice-code-273 - Conditional auto-scroll\n4. voice-code-274 - Floating button\n\nThis provides immediate value (sessions open to newest message) and sets foundation for smart auto-scroll behavior.","notes":"Implemented initial auto-scroll on session open.\n\nChanges made to ConversationView.swift:\n- Added @State hasPerformedInitialScroll flag\n- Added .onChange(of: isLoading) to trigger scroll when loading completes\n- Reset flag in .onAppear to handle navigation back to session\n- Uses non-animated scrollTo() for instant positioning\n\nWhen a session is opened, it automatically scrolls to the most recent message without requiring manual scrolling.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.591435-05:00","updated_at":"2025-10-26T01:01:31.591435-05:00","closed_at":"2025-10-22T19:58:38.230351-05:00"}
{"id":"voice-code-276","title":"iOS: Write tests for auto-scroll behavior","description":"Comprehensive test suite for auto-scroll functionality including scroll tracking, conditional auto-scroll, and floating button behavior.\n\nDEPENDS ON: voice-code-272, voice-code-273, voice-code-274, voice-code-275\n\nTECHNICAL CONTEXT:\nThe auto-scroll feature has several interacting components that need testing:\n1. Initial scroll on session open (voice-code-275)\n2. Scroll position detection (voice-code-272)\n3. Conditional auto-scroll based on user position (voice-code-273)\n4. Floating scroll-to-bottom button (voice-code-274)\n\nThese tests ensure the feature works correctly and prevent regressions.\n\nTEST FILE STRUCTURE:\n\nCreate: ios/VoiceCodeTests/AutoScrollTests.swift\n\nImport required frameworks:\nimport XCTest\nimport SwiftUI\nimport CoreData\n@testable import VoiceCode\n\nClass structure:\nclass AutoScrollTests: XCTestCase {\n    var testContext: NSManagedObjectContext!\n    var mockClient: MockVoiceCodeClient!\n    var testSession: CDSession!\n    \n    override func setUpWithError() throws {\n        // Create in-memory CoreData stack for testing\n        testContext = createInMemoryContext()\n        mockClient = MockVoiceCodeClient()\n        testSession = createTestSession()\n    }\n    \n    override func tearDownWithError() throws {\n        testContext = nil\n        mockClient = nil\n        testSession = nil\n    }\n}\n\nTEST CASES:\n\n1. Initial Scroll on Open:\n\nfunc testInitialScrollToBottom() {\n    // Given: Session with 10 messages\n    addMessagesToSession(count: 10)\n    \n    // When: ConversationView appears\n    let view = ConversationView(session: testSession, client: mockClient, settings: AppSettings())\n    \n    // Then: Should scroll to message #10 (most recent)\n    // Note: Requires ViewInspector or similar for SwiftUI testing\n    // Verify hasPerformedInitialScroll = true\n    // Verify scrollProxy.scrollTo called with lastMessage.id\n}\n\nfunc testInitialScrollWithEmptySession() {\n    // Given: Session with 0 messages\n    // When: ConversationView appears\n    // Then: Should not crash, no scroll attempted\n}\n\nfunc testInitialScrollWithSingleMessage() {\n    // Given: Session with 1 message\n    addMessagesToSession(count: 1)\n    \n    // When: ConversationView appears\n    // Then: Should scroll to that message\n}\n\n2. Scroll Position Detection:\n\nfunc testScrollPositionDetection_UserScrollsUp() {\n    // Given: ConversationView at bottom\n    let view = createConversationView()\n    \n    // When: User scrolls up 100px (offset = -100)\n    simulateScrollOffset(-100)\n    \n    // Then: isUserScrolledUp should be true\n    XCTAssertTrue(view.isUserScrolledUp)\n}\n\nfunc testScrollPositionDetection_UserAtBottom() {\n    // Given: ConversationView scrolled up\n    let view = createConversationView()\n    simulateScrollOffset(-100)\n    \n    // When: User scrolls back to bottom (offset = 0)\n    simulateScrollOffset(0)\n    \n    // Then: isUserScrolledUp should be false\n    XCTAssertFalse(view.isUserScrolledUp)\n}\n\nfunc testScrollPositionDetection_SmallScroll() {\n    // Given: ConversationView at bottom\n    // When: User scrolls up only 30px (below 50px threshold)\n    simulateScrollOffset(-30)\n    \n    // Then: isUserScrolledUp should still be false\n    XCTAssertFalse(view.isUserScrolledUp)\n}\n\n3. Conditional Auto-Scroll:\n\nfunc testAutoScroll_WhenAtBottom() {\n    // Given: User at bottom of conversation\n    let view = createConversationView()\n    addMessagesToSession(count: 5)\n    \n    // When: New message arrives\n    addMessagesToSession(count: 1)\n    \n    // Then: Should auto-scroll to new message\n    XCTAssertTrue(didScrollToLastMessage())\n}\n\nfunc testNoAutoScroll_WhenScrolledUp() {\n    // Given: User scrolled up reading history\n    let view = createConversationView()\n    addMessagesToSession(count: 5)\n    simulateScrollOffset(-100)\n    \n    // When: New message arrives\n    let messageCountBefore = testSession.messageCount\n    addMessagesToSession(count: 1)\n    \n    // Then: Should NOT auto-scroll\n    XCTAssertFalse(didScrollToLastMessage())\n    // And: unreadWhileScrolledUp should increment\n    XCTAssertEqual(view.unreadWhileScrolledUp, 1)\n}\n\nfunc testAutoScrollResumes_WhenUserScrollsBackToBottom() {\n    // Given: User scrolled up, received message, then scrolled back down\n    let view = createConversationView()\n    simulateScrollOffset(-100)\n    addMessagesToSession(count: 1) // No auto-scroll\n    simulateScrollOffset(0) // Back to bottom\n    \n    // When: Another new message arrives\n    addMessagesToSession(count: 1)\n    \n    // Then: Should auto-scroll again\n    XCTAssertTrue(didScrollToLastMessage())\n}\n\nfunc testAutoScroll_MultipleMessagesWhileScrolledUp() {\n    // Given: User scrolled up\n    simulateScrollOffset(-100)\n    \n    // When: 3 messages arrive\n    addMessagesToSession(count: 3)\n    \n    // Then: unreadWhileScrolledUp should be 3\n    XCTAssertEqual(view.unreadWhileScrolledUp, 3)\n}\n\n4. Floating Button Behavior:\n\nfunc testFloatingButton_AppearsWhenScrolledUp() {\n    // Given: User at bottom\n    let view = createConversationView()\n    \n    // When: User scrolls up\n    simulateScrollOffset(-100)\n    \n    // Then: Floating button should be visible\n    XCTAssertTrue(isFloatingButtonVisible())\n}\n\nfunc testFloatingButton_DisappearsWhenAtBottom() {\n    // Given: User scrolled up (button visible)\n    simulateScrollOffset(-100)\n    \n    // When: User scrolls to bottom\n    simulateScrollOffset(0)\n    \n    // Then: Floating button should be hidden\n    XCTAssertFalse(isFloatingButtonVisible())\n}\n\nfunc testFloatingButton_ShowsUnreadBadge() {\n    // Given: User scrolled up\n    simulateScrollOffset(-100)\n    \n    // When: 2 messages arrive\n    addMessagesToSession(count: 2)\n    \n    // Then: Badge should show \"2\"\n    XCTAssertEqual(getFloatingButtonBadgeCount(), 2)\n}\n\nfunc testFloatingButton_TapScrollsToBottom() {\n    // Given: User scrolled up with 3 unread\n    simulateScrollOffset(-100)\n    addMessagesToSession(count: 3)\n    \n    // When: User taps floating button\n    tapFloatingButton()\n    \n    // Then: Should scroll to bottom\n    XCTAssertTrue(didScrollToLastMessage())\n    // And: isUserScrolledUp should be false\n    XCTAssertFalse(view.isUserScrolledUp)\n    // And: unreadWhileScrolledUp should reset to 0\n    XCTAssertEqual(view.unreadWhileScrolledUp, 0)\n}\n\nfunc testFloatingButton_BadgeResetsOnManualScroll() {\n    // Given: User scrolled up with unread messages\n    simulateScrollOffset(-100)\n    addMessagesToSession(count: 2)\n    \n    // When: User manually scrolls back to bottom\n    simulateScrollOffset(0)\n    \n    // Then: Badge count should reset\n    XCTAssertEqual(view.unreadWhileScrolledUp, 0)\n}\n\n5. Edge Cases:\n\nfunc testAutoScroll_DuringInitialLoad() {\n    // Given: Session is loading\n    let view = createConversationView()\n    view.isLoading = true\n    \n    // When: Messages populate during load\n    addMessagesToSession(count: 5)\n    \n    // Then: Should not trigger auto-scroll (only initial scroll)\n    // Verify .onChange doesn't fire for initial population\n}\n\nfunc testAutoScroll_UserSendsMessage() {\n    // Given: User scrolled up reading history\n    simulateScrollOffset(-100)\n    \n    // When: User sends a message\n    sendUserMessage(\"Test message\")\n    \n    // Then: Should scroll to show user's message (override)\n    XCTAssertTrue(didScrollToLastMessage())\n}\n\nfunc testScrollPositionReset_OnViewReappear() {\n    // Given: User scrolled up, then navigated away\n    simulateScrollOffset(-100)\n    simulateViewDisappear()\n    \n    // When: User returns to conversation\n    simulateViewAppear()\n    \n    // Then: Should perform initial scroll to bottom\n    XCTAssertTrue(view.hasPerformedInitialScroll)\n    XCTAssertFalse(view.isUserScrolledUp)\n}\n\nHELPER FUNCTIONS:\n\nprivate func createInMemoryContext() -\u003e NSManagedObjectContext {\n    let container = NSPersistentContainer(name: \"VoiceCode\")\n    let description = NSPersistentStoreDescription()\n    description.type = NSInMemoryStoreType\n    container.persistentStoreDescriptions = [description]\n    container.loadPersistentStores { _, error in\n        XCTAssertNil(error)\n    }\n    return container.viewContext\n}\n\nprivate func createTestSession() -\u003e CDSession {\n    let session = CDSession(context: testContext)\n    session.id = UUID()\n    session.backendName = \"Test Session\"\n    session.workingDirectory = \"/test\"\n    session.lastModified = Date()\n    return session\n}\n\nprivate func addMessagesToSession(count: Int) {\n    for i in 0..\u003ccount {\n        let message = CDMessage(context: testContext)\n        message.id = UUID()\n        message.session = testSession\n        message.role = i % 2 == 0 ? \"user\" : \"assistant\"\n        message.text = \"Test message \\(i)\"\n        message.timestamp = Date()\n        message.messageStatus = .delivered\n    }\n    try? testContext.save()\n}\n\nTESTING APPROACH:\n\nSince SwiftUI view testing is complex, consider:\n\n1. Unit test the logic functions:\n   - detectUserScroll(offset:)\n   - scrollToBottomAndReset(proxy:)\n   - State transitions\n\n2. Use ViewInspector library for view hierarchy testing:\n   - https://github.com/nalexn/ViewInspector\n   - Allows inspecting SwiftUI view state and hierarchy\n\n3. Manual testing checklist (create test plan document):\n   - All scenarios listed above\n   - Test on different device sizes (iPhone SE, iPhone 15 Pro Max)\n   - Test with very long sessions (1000+ messages)\n   - Test with rapid message arrivals\n\nREFERENCES:\n- XCTest: https://developer.apple.com/documentation/xctest\n- ViewInspector: https://github.com/nalexn/ViewInspector\n- SwiftUI Testing Guide: https://developer.apple.com/documentation/swiftui/testing-swiftui-views\n\nDELIVERABLES:\n1. AutoScrollTests.swift with all test cases passing\n2. Manual test plan document (optional: create as voice-code-277)\n3. 90%+ code coverage for auto-scroll logic\n4. CI integration (if applicable)\n\nThis comprehensive test suite ensures the auto-scroll feature works reliably across all scenarios.","notes":"Created comprehensive test suite for auto-scroll behavior.\n\nCreated file: ios/VoiceCodeTests/AutoScrollTests.swift\n\nTest coverage:\n- Scroll position detection (boundary conditions, thresholds)\n- Unread counter increment/reset logic\n- Auto-scroll conditional logic\n- Initial scroll flag behavior\n- Message insertion with CoreData\n- Edge cases (rapid messages, empty sessions)\n- Accessibility hints (singular/plural)\n- State reset when scrolling to bottom\n\nTotal: 20+ test cases covering all scenarios\nTests use in-memory CoreData for isolation\nIncludes helper functions for creating test sessions and messages\n\nTests verify the logic works correctly without requiring UI testing framework.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.592826-05:00","updated_at":"2025-10-26T01:01:31.592826-05:00","closed_at":"2025-10-22T19:59:09.963473-05:00"}
{"id":"voice-code-277","title":"Epic: Smart auto-scroll with manual re-engagement","description":"Implement intelligent auto-scroll behavior that respects user intent: automatically scroll to new messages when at bottom, pause when reading history, and provide a button to re-engage.\n\nUSER STORY:\nAs a user, when I open a conversation, I want to see the most recent messages immediately. When new messages arrive, I want them to appear automatically if I'm following along. But if I scroll up to read older messages, I don't want to be interrupted by auto-scroll. I should be able to easily jump back to the bottom when I'm ready.\n\nFEATURES:\n\n1. Auto-scroll on session open (voice-code-275)\n   - Open session → show newest message\n   - No manual scrolling needed\n   - Works for sessions of any length\n\n2. Smart scroll position tracking (voice-code-272)\n   - Detect when user manually scrolls up\n   - Track distance from bottom\n   - Threshold: 50px to avoid false positives\n\n3. Conditional auto-scroll (voice-code-273)\n   - Auto-scroll when user at bottom\n   - Pause auto-scroll when user scrolled up\n   - Resume when user returns to bottom\n\n4. Floating re-engagement button (voice-code-274)\n   - Appears when scrolled up\n   - Shows unread message count\n   - One-tap return to bottom\n   - Re-enables auto-scroll\n\n5. Comprehensive testing (voice-code-276)\n   - Unit tests for all scenarios\n   - Manual test plan\n   - Edge case coverage\n\nTASK BREAKDOWN:\n\nSequential implementation (dependencies):\n1. voice-code-275: Initial scroll on open (independent, high value)\n2. voice-code-272: Scroll tracking (foundation)\n3. voice-code-273: Conditional auto-scroll (depends on 272)\n4. voice-code-274: Floating button (depends on 272, 273)\n5. voice-code-276: Testing (depends on all)\n\nParallel implementation (if multiple developers):\n- Dev 1: voice-code-275 (quick win)\n- Dev 2: voice-code-272 + 273 (core logic)\n- Dev 3: voice-code-274 (UI polish)\n- Dev 4: voice-code-276 (testing)\n\nESTIMATED EFFORT:\n- voice-code-275: 2-3 hours (simple)\n- voice-code-272: 3-4 hours (SwiftUI PreferenceKey pattern)\n- voice-code-273: 1-2 hours (logic update)\n- voice-code-274: 4-5 hours (UI + animation)\n- voice-code-276: 4-6 hours (comprehensive tests)\nTotal: ~15-20 hours for full feature\n\nTECHNICAL DESIGN:\n\nArchitecture:\n┌─────────────────────────────────┐\n│     ConversationView.swift      │\n├─────────────────────────────────┤\n│ State Management:               │\n│ • @State isUserScrolledUp       │\n│ • @State shouldAutoScroll       │\n│ • @State unreadWhileScrolledUp  │\n│ • @State hasPerformedInitialScroll │\n├─────────────────────────────────┤\n│ Components:                     │\n│ • ScrollViewReader + proxy      │\n│ • GeometryReader (scroll offset)│\n│ • PreferenceKey (scroll tracking)│\n│ • Floating button overlay       │\n├─────────────────────────────────┤\n│ Logic:                          │\n│ • detectUserScroll(offset:)     │\n│ • scrollToBottomAndReset(proxy:)│\n│ • .onChange(messages.count)     │\n│ • .onAppear initial scroll      │\n└─────────────────────────────────┘\n\nState Machine:\n┌─────────────┐\n│  View Open  │\n│  (initial)  │\n└──────┬──────┘\n       │ .onAppear\n       ▼\n┌─────────────┐  New message   ┌──────────────┐\n│  At Bottom  │───────────────\u003e│ Auto-scroll  │\n│  (scrolling │                │  (smooth)    │\n│   enabled)  │\u003c───────────────│              │\n└──────┬──────┘  Scroll done   └──────────────┘\n       │\n       │ User scrolls up\n       ▼\n┌─────────────┐  New message   ┌──────────────┐\n│ Scrolled Up │───────────────\u003e│ Increment    │\n│ (scrolling  │                │ unread badge │\n│  disabled)  │                │ Show button  │\n└──────┬──────┘                └──────────────┘\n       │\n       │ Tap button OR scroll to bottom\n       ▼\n┌─────────────┐\n│  At Bottom  │ (loop back)\n└─────────────┘\n\nVISUAL DESIGN:\n\nNormal state (at bottom, new message arrives):\n┌───────────────────────────────┐\n│ Message 1                     │\n│ Message 2                     │\n│ Message 3 (new) ← auto-scroll │\n└───────────────────────────────┘\n [Input area]\n\nScrolled up state (new message arrives):\n┌───────────────────────────────┐\n│ Message 1 (reading history)   │\n│ Message 2                     │\n│                          ╭─╮  │\n│                          │2│  │ ← Unread badge\n│                          ╰─╯  │\n│                          ▼   │ ← Float button\n└───────────────────────────────┘\n [Input area]\n (Message 3 below, not visible)\n\nBENEFITS:\n- Better UX: No interruption when reading history\n- Familiar pattern: Matches iMessage, Slack, Discord\n- Discoverable: Floating button is obvious\n- Flexible: Works for all session lengths\n- Tested: Comprehensive test coverage\n\nRISKS \u0026 MITIGATIONS:\n- Risk: Button obstructs content\n  Mitigation: Position in corner, semi-transparent if needed\n\n- Risk: Scroll detection too sensitive\n  Mitigation: 50px threshold, debouncing\n\n- Risk: Animation performance with many messages\n  Mitigation: LazyVStack already used, test with 1000+ messages\n\n- Risk: Button appears during auto-scroll\n  Mitigation: Use proper .transition animations\n\nSUCCESS CRITERIA:\n✓ Open session → newest message visible (0 manual scrolls)\n✓ At bottom, new message → auto-scroll (seamless)\n✓ Scrolled up, new message → no auto-scroll (no interruption)\n✓ Scrolled up, tap button → instant return to bottom\n✓ All tests passing (90%+ coverage)\n✓ No performance regression on large sessions\n\nUSER ACCEPTANCE TESTING:\n- [ ] Open 10 different sessions → all show newest message\n- [ ] Receive 5 messages while at bottom → all auto-scroll\n- [ ] Scroll up, receive 3 messages → no auto-scroll, badge shows 3\n- [ ] Tap button → smooth scroll, badge clears\n- [ ] Scroll to bottom manually → badge clears, button hides\n- [ ] Send message while scrolled up → shows sent message\n\nRELATED ISSUES:\n- Closes: voice-code-175 (original feature request)\n- Implements: voice-code-272, 273, 274, 275, 276\n- Builds on: ConversationView.swift scroll infrastructure\n\nDOCUMENTATION UPDATES NEEDED:\n- Update user guide with auto-scroll behavior\n- Add GIF/video demo to README\n- Document floating button feature\n\nFUTURE ENHANCEMENTS (out of scope):\n- User preference to disable auto-scroll entirely\n- \"Jump to first unread\" instead of newest\n- Keyboard shortcuts (if iPad support added)\n- Auto-scroll speed customization\n\nThis epic provides a complete, production-ready auto-scroll feature that matches modern chat app UX standards.","notes":"✅ EPIC COMPLETE: Smart auto-scroll with manual re-engagement\n\nAll implementation tasks completed:\n\n✓ voice-code-275: Initial auto-scroll on session open\n  - Sessions now open showing newest messages\n  - No manual scrolling required\n\n✓ voice-code-272: Scroll position tracking  \n  - Detects when user scrolls up (50px threshold)\n  - Tracks unread messages while scrolled up\n\n✓ voice-code-273: Conditional auto-scroll\n  - Auto-scrolls when user is at bottom\n  - Pauses when user scrolls up to read history\n  - Resumes when user returns to bottom\n\n✓ voice-code-274: Floating scroll-to-bottom button\n  - Appears when scrolled up\n  - Shows unread message count badge\n  - One-tap to return to bottom\n  - Smooth spring animation\n\n✓ voice-code-276: Comprehensive test suite\n  - 20+ test cases covering all scenarios\n  - Logic tests without UI dependencies\n  - Edge case coverage\n\nImplementation location: ios/VoiceCode/Views/ConversationView.swift\nTests: ios/VoiceCodeTests/AutoScrollTests.swift\n\nUser experience:\n- Open session → newest message visible immediately\n- At bottom → new messages auto-scroll\n- Scrolled up → no interruption, unread badge appears\n- Tap button → smooth scroll back, badge clears\n\nCloses original feature request voice-code-175.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-10-26T01:01:31.593423-05:00","updated_at":"2025-10-26T01:01:31.593423-05:00","closed_at":"2025-10-22T19:59:25.405714-05:00"}
{"id":"voice-code-278","title":"Add recent sessions list to Projects view","description":"Add a top-N feature in the main Projects view that displays the most recent N sessions across all projects. Should show:\n- Session name\n- Project name/path\n- Last modified timestamp\n- Configurable N (e.g., 5, 10, 20 most recent)\n\nConsider placement above or below the projects list. Should be easily scannable and allow quick navigation to recent sessions regardless of their project.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-26T01:01:31.59415-05:00","updated_at":"2025-10-26T01:01:31.59415-05:00","closed_at":"2025-10-23T10:08:23.292546-05:00"}
{"id":"voice-code-279","title":"Backend: Add get-recent-sessions function to replication.clj","description":"Add function to retrieve top N most recently modified sessions across all projects.\n\nContext: Parent feature voice-code-278 adds a recent sessions list to iOS Projects view. Backend needs to maintain and serve this list efficiently rather than having iOS recompute on every message.\n\nImplementation:\n- Add (get-recent-sessions [limit]) function in src/voice_code/replication.clj\n- Function should:\n  - Read from @session-index atom (already contains all session metadata)\n  - Sort sessions by :last-modified timestamp (descending, most recent first)\n  - Take top N sessions (where N = limit parameter, default 10)\n  - Return vector of maps with: {:session-id, :name, :working-directory, :last-modified}\n  - Handle edge cases: empty index, limit \u003e total sessions\n\nData already available in session-index:\n- Session index built by build-index! contains all session metadata\n- Each entry has :working-directory (for display) and file :last-modified from filesystem\n- Index is atom, thread-safe reads\n\nExample return value:\n[{:session-id \"abc-123\"\n  :name \"Fix auth bug\"\n  :working-directory \"/Users/x/code/project1\"\n  :last-modified #inst \"2025-10-22T21:30:00.000-00:00\"}\n {:session-id \"def-456\"\n  :name \"Add feature\"\n  :working-directory \"/Users/x/code/project2\"\n  :last-modified #inst \"2025-10-22T20:15:00.000-00:00\"}]\n\nTesting:\n- Unit test: Create mock session-index with known timestamps, verify ordering\n- Unit test: Verify limit parameter works correctly\n- Unit test: Handle empty index gracefully\n- Manual test: Call from REPL, verify output matches expected order\n\nFiles to modify:\n- src/voice_code/replication.clj: Add get-recent-sessions function\n\nDependencies:\n- None (reads from existing session-index)\n- Session index already maintained by existing code","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.595838-05:00","updated_at":"2025-10-26T01:01:31.595838-05:00","closed_at":"2025-10-22T22:35:21.77165-05:00","dependencies":[{"issue_id":"voice-code-279","depends_on_id":"voice-code-278","type":"blocks","created_at":"2025-10-26T01:01:31.862747-05:00","created_by":"auto-import"}]}
{"id":"voice-code-280","title":"Backend: Add recent_sessions WebSocket message type","description":"Add new WebSocket message type to send recent sessions list to iOS clients.\n\nContext: Part of voice-code-278 (recent sessions in Projects view). Backend will proactively send the recent sessions list to iOS instead of iOS computing it locally, avoiding frontend performance overhead.\n\nProtocol Specification:\nMessage type: recent_sessions\nDirection: Backend → iOS\nWhen sent: On 'connected' response, after session index rebuild\n\nMessage format (snake_case for JSON):\n{\n  \"type\": \"recent_sessions\",\n  \"sessions\": [\n    {\n      \"session_id\": \"abc-123\",\n      \"name\": \"Fix authentication\",\n      \"project_path\": \"/Users/x/code/project\",\n      \"last_modified\": \"2025-10-22T21:30:00Z\"\n    }\n  ],\n  \"limit\": 10\n}\n\nImplementation in src/voice_code/server.clj:\n1. Add send-recent-sessions! helper function\n   - Calls replication/get-recent-sessions with limit (default 10)\n   - Converts kebab-case Clojure keys to snake_case JSON\n   - Formats timestamps as ISO-8601 strings\n   - Sends via WebSocket channel\n\n2. Call send-recent-sessions! after sending 'connected' response\n   - In handle-connect-message! function\n   - After session registration succeeds\n   - Before replaying undelivered messages (if any)\n\n3. Optional: Add explicit client request message (future enhancement)\n   - Client sends: {\"type\": \"get_recent_sessions\", \"limit\": 20}\n   - Server responds with recent_sessions message\n\nKey-naming conversion:\n- Clojure internal: :session-id, :working-directory, :last-modified\n- JSON external: session_id, project_path, last_modified\n- Use Cheshire's :key-fn for automatic conversion\n\nTesting:\n- Unit test: Verify message format matches protocol spec\n- Unit test: Verify kebab-case → snake_case conversion\n- Manual test: Connect iOS client, verify recent_sessions message received\n- Manual test: Verify message contains correctly sorted sessions\n- Manual test: Check logs for message send confirmation\n\nFiles to modify:\n- src/voice_code/server.clj: Add send-recent-sessions! and call site\n- STANDARDS.md: Document new message type in WebSocket Protocol section\n\nDependencies:\n- Depends on voice-code-279 (get-recent-sessions function)\n- Must follow STANDARDS.md WebSocket protocol conventions","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.596426-05:00","updated_at":"2025-10-26T01:01:31.596426-05:00","closed_at":"2025-10-22T22:35:21.787515-05:00","dependencies":[{"issue_id":"voice-code-280","depends_on_id":"voice-code-279","type":"blocks","created_at":"2025-10-26T01:01:31.863756-05:00","created_by":"auto-import"}]}
{"id":"voice-code-281","title":"Backend: Write tests for recent sessions functionality","description":"Write comprehensive tests for recent sessions feature (both get-recent-sessions function and WebSocket message).\n\nContext: Part of voice-code-278. Ensure recent sessions functionality works correctly across edge cases and integrates properly with existing session management.\n\nTest Coverage Required:\n\n1. get-recent-sessions function tests (test/voice_code/replication_test.clj):\n   - Test basic sorting: Create 5 sessions with different timestamps, verify correct descending order\n   - Test limit parameter: Verify returns exactly N sessions when limit \u003c total\n   - Test limit \u003e total sessions: Should return all sessions without error\n   - Test empty session index: Should return empty vector []\n   - Test sessions with identical timestamps: Verify stable ordering\n   - Test malformed session data: Missing :last-modified should be handled gracefully\n\n2. WebSocket message format tests (test/voice_code/server_test.clj):\n   - Test kebab-case → snake_case conversion (:session-id → \"session_id\")\n   - Test timestamp formatting (Clojure inst → ISO-8601 string)\n   - Test message structure matches protocol spec exactly\n   - Test :working-directory → \"project_path\" mapping\n\n3. Integration tests:\n   - Test recent_sessions sent after 'connected' response\n   - Test message not sent if session index empty\n   - Test message reflects actual filesystem state (use temp sessions)\n\nTest Data Setup:\n- Create fixture with mock session-index containing 10+ sessions\n- Use known timestamps for deterministic ordering\n- Include edge cases: very old sessions, future timestamps (clock skew), nil values\n\nAssertions:\n- Verify exact order of returned sessions\n- Verify all required fields present in each session\n- Verify timestamps are valid ISO-8601 format\n- Verify JSON keys use snake_case\n- Verify limit parameter respected\n\nFiles to create/modify:\n- test/voice_code/replication_test.clj: Add get-recent-sessions tests\n- test/voice_code/server_test.clj: Add WebSocket message tests\n\nDependencies:\n- voice-code-279: get-recent-sessions function must exist\n- voice-code-280: WebSocket message handler must exist\n\nSuccess criteria:\n- All tests pass with (clj -M:test)\n- Test coverage includes all edge cases listed above\n- Tests are deterministic (no flaky failures)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.597104-05:00","updated_at":"2025-10-26T01:01:31.597104-05:00","closed_at":"2025-10-22T22:35:21.804904-05:00","dependencies":[{"issue_id":"voice-code-281","depends_on_id":"voice-code-279","type":"blocks","created_at":"2025-10-26T01:01:31.864916-05:00","created_by":"auto-import"},{"issue_id":"voice-code-281","depends_on_id":"voice-code-280","type":"blocks","created_at":"2025-10-26T01:01:31.865843-05:00","created_by":"auto-import"}]}
{"id":"voice-code-282","title":"iOS: Add Recent Sessions section to Projects view","description":"Add 'Recent Sessions' section at top of Projects view to display most recent sessions across all projects.\n\nContext: Part of voice-code-278. Backend sends recent_sessions WebSocket message on connect. iOS receives, stores, and displays this list for quick navigation.\n\nUI Design:\n- Placement: Collapsible section at top of Projects view (above projects list)\n- Section header: 'Recent' with disclosure chevron\n- Default state: Expanded (or remember user preference via UserDefaults)\n- Empty state: Show 'No recent sessions' if list empty\n\nCell Layout (two-line format):\n- Line 1: Session name (bold, primary text color)\n- Line 2: Project name + relative timestamp (e.g., 'hunt910 • 2h ago') in secondary gray color\n- Tap action: Navigate to ConversationView for that session\n- Visual distinction: Slightly different background or separator from projects list\n\nImplementation Details:\n\n1. Data Model:\n   - Add RecentSession struct (if not reusing existing Session model)\n   - Properties: sessionId, name, projectPath, lastModified\n   - Store in @Published var recentSessions: [RecentSession] in appropriate view model\n\n2. WebSocket Message Handler:\n   - Add handler for 'recent_sessions' message type\n   - Parse JSON with snake_case keys: session_id, project_path, last_modified\n   - Convert to Swift model with camelCase properties\n   - Update @Published recentSessions array (triggers UI refresh)\n\n3. Projects View Modifications:\n   - Add 'Recent' section above projects List\n   - Use Section with collapsible header or custom disclosure view\n   - ForEach over recentSessions array\n   - Each row: NavigationLink to ConversationView\n   - Display session name + formatted project path + relative time\n\n4. Time Formatting:\n   - Use RelativeDateTimeFormatter for '2h ago' style timestamps\n   - Fallback to absolute date if \u003e 7 days old\n   - Handle timezone conversion from ISO-8601 UTC to local time\n\n5. Configuration:\n   - UserDefaults key: 'recentSessionsExpanded' (Bool, default true)\n   - Future: UserDefaults key: 'recentSessionsLimit' (Int, default 10)\n\nEdge Cases:\n- Empty recent sessions list: Show empty state message\n- Session no longer exists locally: Handle gracefully (gray out or hide)\n- Very long session names: Truncate with ellipsis\n- Very long project paths: Show basename only or truncate smartly\n\nTesting Requirements:\n- Manual test: Connect, verify recent_sessions message received and displayed\n- Manual test: Tap session row, verify navigates to correct ConversationView\n- Manual test: Toggle section collapse, verify state persists\n- Manual test: Relative timestamps display correctly (mock old/new sessions)\n- Edge case test: Empty list shows appropriate empty state\n- Edge case test: Long names/paths don't break layout\n\nFiles to modify/create:\n- Projects view file (exact path TBD based on iOS codebase structure)\n- WebSocket message handler (add recent_sessions case)\n- View model for storing recent sessions state\n- Possibly: RecentSession.swift model file\n\nDependencies:\n- voice-code-280: Backend must send recent_sessions message\n- Existing Session/Project navigation infrastructure\n\nAcceptance Criteria:\n- Recent section appears at top of Projects view\n- Shows sessions in order received from backend (already sorted)\n- Tapping session navigates correctly\n- UI is visually clean and scannable\n- Works on both iPhone and iPad layouts","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.598481-05:00","updated_at":"2025-10-26T01:01:31.598481-05:00","closed_at":"2025-10-23T10:08:09.252657-05:00","dependencies":[{"issue_id":"voice-code-282","depends_on_id":"voice-code-280","type":"blocks","created_at":"2025-10-26T01:01:31.866897-05:00","created_by":"auto-import"}]}
{"id":"voice-code-283","title":"iOS: Write tests for Recent Sessions UI","description":"Write tests for Recent Sessions functionality in iOS app.\n\nContext: Part of voice-code-278. Verify recent sessions list displays correctly, handles WebSocket messages properly, and navigation works.\n\nTest Coverage Required:\n\n1. WebSocket Message Parsing Tests:\n   - Test parsing valid recent_sessions JSON message\n   - Test snake_case → camelCase conversion (session_id → sessionId)\n   - Test ISO-8601 timestamp parsing to Date objects\n   - Test handling malformed JSON (missing fields, wrong types)\n   - Test empty sessions array\n   - Test large sessions array (100+ items)\n\n2. Data Model Tests:\n   - Test RecentSession model initialization from JSON\n   - Test Codable conformance if applicable\n   - Test equality/comparison if needed for deduplication\n\n3. UI Display Tests (SwiftUI Preview or UI tests):\n   - Test Recent section appears when recentSessions non-empty\n   - Test empty state displays when recentSessions is empty\n   - Test session rows display correct name, project path, timestamp\n   - Test relative time formatting (mock Date for deterministic tests)\n   - Test truncation of long session names\n   - Test truncation of long project paths\n\n4. Navigation Tests:\n   - Test tapping session row navigates to ConversationView\n   - Test correct session ID passed to ConversationView\n   - Test navigation stack includes project context if needed\n\n5. State Persistence Tests:\n   - Test section expanded/collapsed state saved to UserDefaults\n   - Test state restored on app relaunch\n   - Test default state (expanded) on first launch\n\n6. Edge Case Tests:\n   - Test receiving recent_sessions multiple times (e.g., reconnect)\n   - Test session in recent list but not in local projects (should handle gracefully)\n   - Test very old timestamps (years ago)\n   - Test future timestamps (clock skew)\n   - Test duplicate session IDs in recent list\n\nTest Data Fixtures:\n- Create mock recent_sessions JSON messages with known data\n- Use fixed timestamps for deterministic relative time tests\n- Include edge cases: empty list, single item, max items (20+)\n\nMocking Requirements:\n- Mock WebSocket message reception\n- Mock Date.now for relative time formatting tests\n- Mock UserDefaults for state persistence tests\n- Mock navigation for SwiftUI navigation tests\n\nFiles to create:\n- RecentSessionsTests.swift (or similar based on test file organization)\n- May need test fixtures/mocks in separate files\n\nDependencies:\n- voice-code-282: iOS Recent Sessions UI must be implemented\n\nSuccess Criteria:\n- All tests pass in Xcode test suite\n- Tests cover all edge cases listed above\n- Tests are deterministic (no flaky time-based failures)\n- UI tests verify actual rendered output matches expectations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.599515-05:00","updated_at":"2025-10-26T01:01:31.599515-05:00","closed_at":"2025-10-23T10:08:09.253629-05:00","dependencies":[{"issue_id":"voice-code-283","depends_on_id":"voice-code-282","type":"blocks","created_at":"2025-10-26T01:01:31.867928-05:00","created_by":"auto-import"}]}
{"id":"voice-code-284","title":"Documentation: Update STANDARDS.md with recent_sessions protocol","description":"Update STANDARDS.md WebSocket Protocol section to document the new recent_sessions message type.\n\nContext: Part of voice-code-278. The recent_sessions message is a new backend→iOS message type that needs to be documented in the protocol specification.\n\nDocumentation to Add:\n\nLocation: STANDARDS.md, WebSocket Protocol section, 'Backend → Client' subsection\n\nAdd entry for recent_sessions message:\n\n**Recent Sessions List**\n```json\n{\n  \"type\": \"recent_sessions\",\n  \"sessions\": [\n    {\n      \"session_id\": \"\u003cclaude-session-id\u003e\",\n      \"name\": \"\u003csession-name\u003e\",\n      \"project_path\": \"\u003cabsolute-path\u003e\",\n      \"last_modified\": \"\u003cISO-8601-timestamp\u003e\"\n    }\n  ],\n  \"limit\": 10\n}\n```\n\nDescription to include:\n- Sent automatically after 'connected' response\n- Contains top N most recently modified sessions across all projects\n- Sessions ordered by last_modified descending (most recent first)\n- limit field indicates how many sessions were requested (may receive fewer if total sessions \u003c limit)\n- project_path is the session's working directory (absolute path)\n- Session name derived from session metadata or working directory basename\n\nUsage notes:\n- iOS should display this for quick navigation to recent work\n- List may be empty if no sessions exist\n- Sessions already sorted by backend, no client-side sorting needed\n- May be sent multiple times (e.g., on reconnect or index rebuild)\n\nAlso update:\n- Message flow diagram if one exists\n- Any protocol version information\n- Related message types cross-references\n\nFiles to modify:\n- STANDARDS.md: Add recent_sessions documentation to WebSocket Protocol section\n\nDependencies:\n- voice-code-280: Implementation must be complete to ensure accurate documentation\n\nAcceptance Criteria:\n- Documentation matches actual implementation exactly\n- Example JSON is valid and representative\n- Clear explanation of when message is sent\n- Developers can implement client handler from docs alone","status":"closed","priority":3,"issue_type":"task","created_at":"2025-10-26T01:01:31.600346-05:00","updated_at":"2025-10-26T01:01:31.600346-05:00","closed_at":"2025-10-22T22:35:21.819088-05:00","dependencies":[{"issue_id":"voice-code-284","depends_on_id":"voice-code-280","type":"blocks","created_at":"2025-10-26T01:01:31.868942-05:00","created_by":"auto-import"}]}
{"id":"voice-code-285","title":"Siri notification integration: 'Do you want me to read this?'","description":"Explore Siri/notification integration for hands-free response listening when AirPods connected.\n\nWhen Claude response arrives while user has AirPods in, provide easy voice-activated way to have response read aloud.\n\nOptions to explore:\n1. Rich notification with 'Read Aloud' action button\n2. Siri Shortcuts integration for voice command\n3. Notification category that triggers TTS playback\n4. 'Hey Siri, read it' shortcut support\n\nRequirements:\n- Works when app backgrounded\n- Works with locked screen\n- Integrates with existing TTS playback\n- AirPods-aware (optional: only offer when AirPods connected)\n\nLimitation: Can't make Siri automatically ask - requires user to invoke via notification action or Siri command.\n\nRealistic flow:\n1. Response arrives → notification posted\n2. User taps 'Read Aloud' button OR says 'Hey Siri, read it'\n3. App reads full response via existing VoiceOutputManager\n4. Playback continues even if screen locks","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-10-26T01:01:31.60124-05:00","updated_at":"2025-10-26T01:01:31.60124-05:00","closed_at":"2025-10-25T20:11:22.636913-05:00"}
{"id":"voice-code-286","title":"Session rename: Add clear button and remove 'Terminal:' prefix","description":"Improve session renaming UX by making it easier to rename from scratch.\n\nCurrent problems:\n1. When clicking edit (pen icon), hard to clear existing name to start fresh\n2. Auto-generated names use 'Terminal:' prefix which is unwanted\n3. No quick way to clear field without manual deletion\n\nDesired behavior:\n1. When edit mode activated, show 'X' button to clear entire field\n2. Remove 'Terminal:' prefix from auto-generated session names\n3. Make it easy to start typing fresh name\n\nImplementation:\n- Add clearButton(.whileEditing) to TextField in SessionRowContent\n- Update backend session name generation to remove 'Terminal:' prefix\n- OR: Update iOS display logic to strip 'Terminal:' prefix when showing names\n\nFiles to change:\n- ios/VoiceCode/Views/SessionsView.swift (SessionRowContent - add clear button)\n- backend/src/voice_code/replication.clj (generate-session-name - remove Terminal: prefix)\n\nQuick win: Just add .clearButtonMode(.whileEditing) to rename TextField","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-10-26T01:01:31.601857-05:00","updated_at":"2025-10-26T01:01:31.601857-05:00","closed_at":"2025-10-23T19:34:40.930136-05:00"}
{"id":"voice-code-287","title":"Epic: Session Locking to Prevent Concurrent Claude CLI Execution","description":"Implement session locking to prevent users from inadvertently forking sessions by sending prompts before previous Claude CLI commands complete.\n\n## Problem\nWhen users send a new prompt before the previous prompt's Claude CLI execution completes, calling resume on the same session ID can fork the session unintentionally.\n\n## Solution Overview\n- Track in-progress sessions on backend (Clojure atom)\n- Block new prompts for locked sessions\n- Queue user messages instead of discarding them\n- Return appropriate response to iOS client\n- Allow queued message to be sent after lock releases\n\n## Components\n- Backend: Session lock tracking (atom)\n- Backend: Lock acquisition/release logic\n- Backend: Message queueing for locked sessions\n- Frontend: User feedback for locked sessions\n- Frontend: Auto-send queued message when lock releases\n\n## Success Criteria\n- No session forks from concurrent prompts\n- User messages never lost\n- Clear UX feedback when session is locked\n- Queued messages auto-send after lock release","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-10-26T01:01:31.60288-05:00","updated_at":"2025-10-26T01:01:31.60288-05:00","closed_at":"2025-10-25T20:09:30.154914-05:00"}
{"id":"voice-code-288","title":"Backend: Add session lock state atom","description":"Create an atom to track which Claude session IDs currently have in-flight Claude CLI executions.\n\nContext: Prevent concurrent prompts from forking sessions by tracking which sessions are currently executing.\n\nRequirements:\n- Create atom in voice_code.replication: (def session-locks (atom #{}))\n- Use set for O(1) lookup\n- Document purpose clearly\n\nFile: backend/src/voice_code/replication.clj\n\nTests:\n- Verify atom stores/retrieves session IDs correctly\n- Test basic set operations\n\nAcceptance:\n- session-locks atom exists with clear docstring\n- Tests pass","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.604011-05:00","updated_at":"2025-10-26T01:01:31.604011-05:00","closed_at":"2025-10-25T20:12:09.481781-05:00","dependencies":[{"issue_id":"voice-code-288","depends_on_id":"voice-code-287","type":"blocks","created_at":"2025-10-26T01:01:31.870074-05:00","created_by":"auto-import"}]}
{"id":"voice-code-289","title":"Backend: Add lock acquisition and release functions","description":"Implement atomic functions to acquire and release session locks.\n\nContext: Before calling Claude CLI, acquire lock. After CLI completes (success or error), release it.\n\nRequirements:\n- Function: (acquire-session-lock! session-id) returns true if acquired, false if already locked\n- Function: (release-session-lock! session-id) always succeeds\n- Use swap! for atomic operations\n- Log lock lifecycle events\n\nFile: backend/src/voice_code/replication.clj\n\nImplementation:\n(defn acquire-session-lock! [session-id]\n  (let [acquired? (atom false)]\n    (swap! session-locks\n      (fn [locks]\n        (if (contains? locks session-id)\n          locks\n          (do (reset! acquired? true)\n              (conj locks session-id)))))\n    (when @acquired?\n      (log/info \"Acquired session lock\" {:session-id session-id}))\n    @acquired?))\n\n(defn release-session-lock! [session-id]\n  (swap! session-locks disj session-id)\n  (log/info \"Released session lock\" {:session-id session-id}))\n\nTests:\n- acquire returns true when available\n- acquire returns false when already locked\n- concurrent acquire attempts (only one succeeds)\n- release removes lock\n- release is idempotent\n\nAcceptance:\n- Both functions work atomically\n- Logs show lock lifecycle\n- Tests prove no race conditions","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.605007-05:00","updated_at":"2025-10-26T01:01:31.605007-05:00","closed_at":"2025-10-25T20:12:17.366313-05:00","dependencies":[{"issue_id":"voice-code-289","depends_on_id":"voice-code-288","type":"blocks","created_at":"2025-10-26T01:01:31.871256-05:00","created_by":"auto-import"}]}
{"id":"voice-code-29","title":"Test session persistence across app restarts","description":"","status":"closed","priority":2,"issue_type":"task","assignee":"ios","created_at":"2025-10-26T01:01:31.605952-05:00","updated_at":"2025-10-26T01:01:31.605952-05:00","closed_at":"2025-10-23T19:10:14.164116-05:00"}
{"id":"voice-code-290","title":"Backend: Add session_locked WebSocket message type","description":"Define new WebSocket message type to inform iOS when a prompt is rejected because session is locked.\n\nContext: When iOS sends a prompt but session is locked, tell iOS the session is busy so it can disable input.\n\nRequirements:\n- New message type: session_locked\n- Include session-id that is locked\n- Update STANDARDS.md with message spec\n\nMessage Format (Backend to iOS):\n{\n  \"type\": \"session_locked\",\n  \"message\": \"Session is currently processing a prompt. Please wait.\",\n  \"session_id\": \"\u003cclaude-session-id\u003e\"\n}\n\nFile: backend/src/voice_code/websocket.clj\n\nAdd helper:\n(defn send-session-locked [channel session-id]\n  (send-message channel\n    {:type \"session_locked\"\n     :message \"Session is currently processing a prompt. Please wait.\"\n     :session_id session-id}))\n\nFile: STANDARDS.md - add to Backend to Client section\n\nTests:\n- Message contains all required fields\n- Valid JSON with snake_case keys\n\nAcceptance:\n- session_locked message type defined\n- STANDARDS.md documents it\n- Helper function exists","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.606975-05:00","updated_at":"2025-10-26T01:01:31.606975-05:00","closed_at":"2025-10-25T20:12:09.481673-05:00","dependencies":[{"issue_id":"voice-code-290","depends_on_id":"voice-code-287","type":"blocks","created_at":"2025-10-26T01:01:31.872689-05:00","created_by":"auto-import"}]}
{"id":"voice-code-291","title":"Backend: Integrate lock check in prompt handler","description":"Modify prompt handler to check if session is locked before calling Claude CLI.\n\nContext: Before executing Claude CLI, check if session already locked. If locked, reject prompt with session_locked message.\n\nRequirements:\n- Check lock BEFORE calling Claude CLI\n- If locked: send session_locked message, return early (do NOT call Claude CLI)\n- If not locked: acquire lock and proceed\n- New sessions (no session-id) always proceed (cannot be locked)\n\nFile: backend/src/voice_code/websocket.clj\n\nImplementation in prompt handler:\n(defn handle-prompt [{:keys [text session-id working-directory ios-session-id channel]}]\n  (let [claude-session-id (or session-id (generate-new-session-id))]\n    (if (replication/acquire-session-lock! claude-session-id)\n      (do\n        (log/info \"Lock acquired, processing prompt\" {:session-id claude-session-id})\n        ;; existing Claude CLI execution logic\n        )\n      (do\n        (log/info \"Session locked, rejecting prompt\" {:session-id claude-session-id})\n        (send-session-locked channel claude-session-id)))))\n\nTests:\n- Lock acquired: Claude CLI called\n- Lock NOT acquired: session_locked sent, CLI NOT called\n- New session: always proceeds\n- Integration: simulate locked session, verify rejection\n\nAcceptance:\n- Lock check before every Claude CLI call\n- Locked sessions reject prompts\n- iOS receives session_locked message\n- Tests prove correct behavior","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.608494-05:00","updated_at":"2025-10-26T01:01:31.608494-05:00","closed_at":"2025-10-25T22:59:12.557495-05:00","dependencies":[{"issue_id":"voice-code-291","depends_on_id":"voice-code-289","type":"blocks","created_at":"2025-10-26T01:01:31.874148-05:00","created_by":"auto-import"},{"issue_id":"voice-code-291","depends_on_id":"voice-code-290","type":"blocks","created_at":"2025-10-26T01:01:31.875531-05:00","created_by":"auto-import"}]}
{"id":"voice-code-292","title":"Backend: Release lock after Claude CLI completes or errors","description":"Ensure session lock is always released after Claude CLI execution completes (success or error).\n\nContext: CRITICAL - Lock MUST be released after Claude CLI completes, otherwise sessions will be permanently locked.\n\nRequirements:\n- Release lock in finally block (guarantees release even on exception)\n- Log lock release\n- Ensure lock released for both success and error cases\n\nFile: backend/src/voice_code/websocket.clj\n\nImplementation:\n(defn handle-prompt [{:keys [text session-id working-directory ios-session-id channel]}]\n  (let [claude-session-id (or session-id (generate-new-session-id))]\n    (if (replication/acquire-session-lock! claude-session-id)\n      (try\n        (log/info \"Lock acquired, processing prompt\" {:session-id claude-session-id})\n        (let [result (replication/claude-cli-session ...)]\n          (send-response channel result)\n          result)\n        (finally\n          (replication/release-session-lock! claude-session-id)))\n      (do\n        (log/info \"Session locked, rejecting prompt\" {:session-id claude-session-id})\n        (send-session-locked channel claude-session-id)))))\n\nTests:\n- Lock released after successful CLI execution\n- Lock released after CLI error/exception\n- Lock released even if send-response throws\n- No permanently locked sessions possible\n\nAcceptance:\n- Lock always released (even on error)\n- finally block guarantees cleanup\n- Tests prove robustness under error conditions\n- No possibility of orphaned locks from exceptions","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.609485-05:00","updated_at":"2025-10-26T01:01:31.609485-05:00","closed_at":"2025-10-25T22:59:12.557695-05:00","dependencies":[{"issue_id":"voice-code-292","depends_on_id":"voice-code-291","type":"blocks","created_at":"2025-10-26T01:01:31.87695-05:00","created_by":"auto-import"}]}
{"id":"voice-code-293","title":"Frontend: Handle session_locked message","description":"Add iOS handler for session_locked WebSocket message to display feedback and disable input. When backend sends session_locked, iOS must show user the session is busy and prevent sending more prompts. Add case in WebSocket message handler. Set state indicating session is locked. Display notification showing session is busy. State cleared when response arrives. Files: WebSocketClient.swift and ConversationView.swift. Add sessionIsLocked state and lockedMessage state. Handle session_locked message type. Clear state on response. Show banner overlay when locked. Tests: verify state changes and UI feedback.","design":"Threading considerations: WebSocket callbacks arrive on background thread. ALL state mutations (lockedSessions.insert/remove) must dispatch to main thread using DispatchQueue.main.async since lockedSessions is @Published/@State. Pattern: receive message on background → parse JSON → DispatchQueue.main.async { update state }. SwiftUI @State/@Published handles thread-safe reads automatically.","notes":"IMPORTANT: Track lock state per session, not globally. Use Set\u003cString\u003e of locked session IDs. When session_locked received, add that session-id to locked set. When response received, remove that session-id from locked set. Only disable input if CURRENT session is in locked set. This allows switching between sessions - each has independent lock state.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.610606-05:00","updated_at":"2025-10-26T01:01:31.610606-05:00","closed_at":"2025-10-25T20:12:17.36611-05:00","dependencies":[{"issue_id":"voice-code-293","depends_on_id":"voice-code-290","type":"blocks","created_at":"2025-10-26T01:01:31.878632-05:00","created_by":"auto-import"}]}
{"id":"voice-code-294","title":"Frontend: Disable voice and text input while session locked","description":"Prevent user from sending prompts (voice or text) while session is locked. Use sessionIsLocked state from previous task to disable both voice recording and text input. Disable microphone button when sessionIsLocked is true. Disable text send button when sessionIsLocked is true. Show visual feedback (grayed out, disabled state). Display status text like Processing previous prompt. File: ConversationView.swift. Apply .disabled(sessionIsLocked) to send controls. Update UI to show disabled state clearly. Tests: verify both voice and text input disabled when locked, verify re-enabled when unlocked, verify visual feedback is clear. Acceptance: User cannot send voice or text while locked, clear visual indication, controls re-enable after response.","design":"Threading: sendPrompt called from main thread (user action). Optimistically lock BEFORE sending to prevent race: lockedSessions.insert(sessionId) then send WebSocket message. This prevents user from double-tapping send button. Lock added on main thread (synchronous), send happens async. If backend rejects (already locked), user sees session_locked response which is idempotent (already in set).","notes":"Input should be disabled based on whether CURRENT session is locked, not global state. Use computed property like: var currentSessionLocked: Bool { lockedSessions.contains(currentSession.claudeSessionId) }. When user switches sessions, input controls automatically update. Session A can be locked while Session B is unlocked - user can work in Session B.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.611597-05:00","updated_at":"2025-10-26T01:01:31.611597-05:00","closed_at":"2025-10-25T22:59:12.556895-05:00","dependencies":[{"issue_id":"voice-code-294","depends_on_id":"voice-code-293","type":"blocks","created_at":"2025-10-26T01:01:31.879897-05:00","created_by":"auto-import"}]}
{"id":"voice-code-295","title":"Backend: Add session lock cleanup on disconnect","description":"Clean up session locks when WebSocket disconnects to prevent orphaned locks. If WebSocket disconnects while Claude CLI running, lock may remain indefinitely. Need cleanup to release locks for disconnected sessions. Track mapping of ios-session-id to claude-session-id. On disconnect, release any locks for that iOS session. File: voice_code.replication.clj - add (def ios-to-claude-session (atom {})). Update acquire-session-lock! to track mapping. File: voice_code.websocket.clj - on disconnect, look up claude-session-id and release lock. Log cleanup actions. Tests: verify disconnect releases lock, verify reconnect works, verify idempotent cleanup. Acceptance: Disconnected sessions do not leave orphaned locks, logs show cleanup, tests prove correct behavior.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.613012-05:00","updated_at":"2025-10-26T01:01:31.613012-05:00","closed_at":"2025-10-25T22:59:12.558012-05:00","dependencies":[{"issue_id":"voice-code-295","depends_on_id":"voice-code-289","type":"blocks","created_at":"2025-10-26T01:01:31.881277-05:00","created_by":"auto-import"}]}
{"id":"voice-code-296","title":"Documentation: Update STANDARDS.md with session locking","description":"Document session locking protocol in STANDARDS.md WebSocket Protocol section. Explain lock prevents concurrent prompts from forking sessions. Document session_locked message type format. Explain flow: prompt sent, lock acquired, second prompt rejected with session_locked, first completes and releases lock, user can send again. Add sequence diagram showing lock acquisition, rejection, and release. Document that frontend should disable input when session_locked received. File: STANDARDS.md - add Session Locking subsection to WebSocket Protocol. Include message format, behavior description, and sequence example. Acceptance: Complete documentation of locking protocol, clear for new developers.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.614372-05:00","updated_at":"2025-10-26T01:01:31.614372-05:00","closed_at":"2025-10-25T22:59:12.55843-05:00","dependencies":[{"issue_id":"voice-code-296","depends_on_id":"voice-code-290","type":"blocks","created_at":"2025-10-26T01:01:31.882786-05:00","created_by":"auto-import"},{"issue_id":"voice-code-296","depends_on_id":"voice-code-292","type":"blocks","created_at":"2025-10-26T01:01:31.884177-05:00","created_by":"auto-import"}]}
{"id":"voice-code-297","title":"Integration testing: End-to-end session locking tests","description":"Write integration tests verifying complete session locking flow. Test scenarios: 1) Basic lock - send prompt locks session, second prompt rejected with session_locked, first completes and releases lock. 2) Multiple sessions - prompts to different sessions do not interfere. 3) Lock released on error - Claude CLI error still releases lock. 4) Disconnect cleanup - disconnect releases lock, reconnect can use session. 5) New session always proceeds - no session-id means new session, never locked. File: backend/test/voice_code/session_locking_test.clj. Mock WebSocket connections. Control timing for concurrent requests. Verify lock state, messages sent, lock release. Tests must be deterministic. Mock Claude CLI to avoid real API calls. Acceptance: All 5 scenarios pass consistently, tests catch regressions, clear failure messages.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.615369-05:00","updated_at":"2025-10-26T01:01:31.615369-05:00","closed_at":"2025-10-25T22:59:12.558286-05:00","dependencies":[{"issue_id":"voice-code-297","depends_on_id":"voice-code-292","type":"blocks","created_at":"2025-10-26T01:01:31.887012-05:00","created_by":"auto-import"},{"issue_id":"voice-code-297","depends_on_id":"voice-code-295","type":"blocks","created_at":"2025-10-26T01:01:31.888878-05:00","created_by":"auto-import"}]}
{"id":"voice-code-298","title":"Epic completion: Verify session locking feature complete","description":"Final validation that session locking feature works correctly before closing epic. Checklist: Backend - session-locks atom exists, acquire and release functions work atomically, session_locked message type defined, prompt handler checks locks, lock released in finally block, disconnect cleanup works. Frontend - session_locked handler implemented, UI shows locked state, voice and text input disabled when locked, input re-enabled after unlock. Documentation - STANDARDS.md documents protocol and message format. Testing - unit tests for lock functions, integration tests pass, manual testing with iOS app complete. Acceptance criteria from epic - no session forks from concurrent prompts, clear UX feedback, users cannot send while locked, lock always released. Run full test suite. Manual test with iOS. Close epic if all pass.","notes":"Add voice-code-299 to dependencies. Verify per-session lock tracking works correctly - switching between sessions should show correct lock state for each. Test: lock Session A, switch to Session B (unlocked), send prompt in B (should work), switch back to A (should be locked or unlocked based on whether A completed).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.616448-05:00","updated_at":"2025-10-26T01:01:31.616448-05:00","closed_at":"2025-10-25T22:59:12.558153-05:00","dependencies":[{"issue_id":"voice-code-298","depends_on_id":"voice-code-288","type":"blocks","created_at":"2025-10-26T01:01:31.892434-05:00","created_by":"auto-import"},{"issue_id":"voice-code-298","depends_on_id":"voice-code-289","type":"blocks","created_at":"2025-10-26T01:01:31.893824-05:00","created_by":"auto-import"},{"issue_id":"voice-code-298","depends_on_id":"voice-code-290","type":"blocks","created_at":"2025-10-26T01:01:31.895206-05:00","created_by":"auto-import"},{"issue_id":"voice-code-298","depends_on_id":"voice-code-291","type":"blocks","created_at":"2025-10-26T01:01:31.896451-05:00","created_by":"auto-import"},{"issue_id":"voice-code-298","depends_on_id":"voice-code-292","type":"blocks","created_at":"2025-10-26T01:01:31.897798-05:00","created_by":"auto-import"},{"issue_id":"voice-code-298","depends_on_id":"voice-code-293","type":"blocks","created_at":"2025-10-26T01:01:31.898879-05:00","created_by":"auto-import"},{"issue_id":"voice-code-298","depends_on_id":"voice-code-294","type":"blocks","created_at":"2025-10-26T01:01:31.900051-05:00","created_by":"auto-import"},{"issue_id":"voice-code-298","depends_on_id":"voice-code-295","type":"blocks","created_at":"2025-10-26T01:01:31.901377-05:00","created_by":"auto-import"},{"issue_id":"voice-code-298","depends_on_id":"voice-code-296","type":"blocks","created_at":"2025-10-26T01:01:31.90256-05:00","created_by":"auto-import"},{"issue_id":"voice-code-298","depends_on_id":"voice-code-297","type":"blocks","created_at":"2025-10-26T01:01:31.904063-05:00","created_by":"auto-import"}]}
{"id":"voice-code-299","title":"Frontend: Add check_lock_status on session switch and reconnect","description":"Request lock status from backend when switching sessions or reconnecting to ensure frontend has accurate lock state. When user switches to a session, we don't know if backend has it locked. Two approaches: Option A (recommended for v1) - Optimistic: assume unlocked, discover on first prompt attempt. Simple, no extra messages. Acceptable UX - one round-trip if wrong. Option B - Proactive: send check_lock_status message when switching sessions or reconnecting. Backend responds with current lock state. More accurate but more complex. Recommend Option A for v1. If we implement Option B later, need new message types: check_lock_status (iOS to Backend with session_id) and lock_status (Backend to iOS with session_id and is_locked boolean). Add to STANDARDS.md if implementing Option B. Test reconnect scenario and session switch with locked sessions.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.617473-05:00","updated_at":"2025-10-26T01:01:31.617473-05:00","closed_at":"2025-10-25T22:59:12.557862-05:00","dependencies":[{"issue_id":"voice-code-299","depends_on_id":"voice-code-293","type":"blocks","created_at":"2025-10-26T01:01:31.905169-05:00","created_by":"auto-import"}]}
{"id":"voice-code-30","title":"Set up Tailscale on server and iPhone","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.618935-05:00","updated_at":"2025-10-26T01:01:31.618935-05:00","closed_at":"2025-10-17T17:47:56.62732-05:00"}
{"id":"voice-code-300","title":"Remove backendName from session locking","description":"Current bug: Session locking uses session.backendName but backend sends turn_complete with session.id (iOS UUID). This causes mismatch and sessions never unlock.\n\nRoot cause: ConversationView.swift:408 locks using session.backendName, but:\n- Line 407/432: We send session.id.uuidString.lowercased() to backend as resume_session_id\n- Backend echoes this UUID in turn_complete message\n- iOS checks lockedSessions.contains(session.backendName) which doesn't match\n- Result: Button stays gray/locked forever\n\nSolution: Replace all backendName usage in locking with session.id.uuidString.lowercased()\n\nFiles to fix:\n- ios/VoiceCode/Views/ConversationView.swift:58-61 (isSessionLocked check)\n- ios/VoiceCode/Views/ConversationView.swift:65-67 (manualUnlock)\n- ios/VoiceCode/Views/ConversationView.swift:408 (optimistic lock)\n\nThe backendName field is legacy/unused for actual backend communication.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-10-26T01:01:31.62027-05:00","updated_at":"2025-10-26T01:01:31.62027-05:00","closed_at":"2025-10-25T20:09:30.154586-05:00"}
{"id":"voice-code-301","title":"Remove or repurpose backendName field from CDSession","description":"After fixing the locking bug (voice-code-300), backendName is no longer used for its original purpose.\n\nCurrent state:\n- backendName was supposed to store 'Claude session ID' distinct from iOS UUID\n- In practice, iOS UUID = Claude session ID for all sessions\n- Field is now redundant with session.id\n- Migration code (VoiceCodeClient.swift:619-649) sets backendName = session.id.uuidString.lowercased()\n\nOptions:\n1. Remove backendName entirely and use session.id everywhere\n2. Repurpose for a different use case (e.g., store user-friendly name)\n3. Keep for backward compatibility but mark deprecated\n\nDecision needed: What should we do with this field?","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.621379-05:00","updated_at":"2025-10-26T01:01:31.621379-05:00","closed_at":"2025-10-25T20:12:09.481565-05:00","dependencies":[{"issue_id":"voice-code-301","depends_on_id":"voice-code-300","type":"blocks","created_at":"2025-10-26T01:01:31.90692-05:00","created_by":"auto-import"}]}
{"id":"voice-code-302","title":"Remove backendName migration code","description":"After deciding what to do with backendName field (voice-code-301), remove the migration code that's no longer needed.\n\nMigration code location:\n- ios/VoiceCode/Managers/VoiceCodeClient.swift:619-649 (migrateExistingSessionsBackendName)\n- ios/VoiceCode/Managers/VoiceCodeClient.swift:48 (init calls migration)\n\nThis migration was added to fix sessions that had display names in backendName instead of UUIDs. Once we stop using backendName for locking, this migration serves no purpose.","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-10-26T01:01:31.622355-05:00","updated_at":"2025-10-26T01:01:31.622355-05:00","closed_at":"2025-10-25T20:12:17.366453-05:00","dependencies":[{"issue_id":"voice-code-302","depends_on_id":"voice-code-301","type":"blocks","created_at":"2025-10-26T01:01:31.908405-05:00","created_by":"auto-import"}]}
{"id":"voice-code-303","title":"Update tests to use session.id for locking","description":"After fixing session locking to use session.id instead of backendName (voice-code-300), update all tests that reference session locking.\n\nNo tests currently verify the locking behavior uses the correct identifier. Add tests to verify:\n1. Lock is set using session.id.uuidString.lowercased()\n2. turn_complete unlock uses session.id that matches what was locked\n3. Manual unlock uses session.id\n4. Multiple sessions can be locked independently by their session.id\n\nExisting locking tests in VoiceCodeClientTests.swift (lines 963-1078) don't verify the correct identifier is used - they just test the locking mechanism itself.","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.623836-05:00","updated_at":"2025-10-26T01:01:31.623836-05:00","closed_at":"2025-10-25T20:09:36.781237-05:00","dependencies":[{"issue_id":"voice-code-303","depends_on_id":"voice-code-300","type":"blocks","created_at":"2025-10-26T01:01:31.909943-05:00","created_by":"auto-import"}]}
{"id":"voice-code-304","title":"epic","description":"Replace backend recent_sessions message with frontend-computed Recent Sessions list from CoreData. This eliminates duplicate data fetching, allows user-configurable limits, and provides real-time updates via existing session_created push notifications.\n\n## Background\nCurrently, Recent Sessions are fetched via a separate recent_sessions WebSocket message that duplicates data already in session_list. The backend hardcodes a limit of 5 sessions, which doesn't match user expectations (some users want 3).\n\n## Current Architecture\n- Backend sends session_list (50 sessions) on connect\n- Backend sends recent_sessions (5 sessions) on connect\n- Both messages contain the same session metadata\n- iOS stores session_list in CoreData via SessionSyncManager\n- iOS stores recent_sessions in @State var recentSessions: [RecentSession]\n\n## Proposed Architecture\n- Backend sends only session_list (50 sessions) on connect\n- Backend sends session_created when new sessions detected (already implemented)\n- iOS computes Recent Sessions from CoreData based on user settings\n- Single source of truth: CoreData\n\n## Benefits\n- Eliminates duplicate network request\n- User-configurable limit (frontend setting)\n- Real-time updates via session_created (already implemented)\n- Simpler codebase (less message types)\n- No backend dependency for display preference\n\n## Technical Details\nRecent Sessions data flow:\n1. Initial: session_list → SessionSyncManager.handleSessionList() → CoreData\n2. Real-time: Filesystem watcher → session_created → SessionSyncManager.handleSessionCreated() → CoreData\n3. Display: DirectoryListView computes from CoreData.sorted().prefix(limit)\n\nAll necessary data (session_id, name, working_directory, last_modified, message_count) is already in CoreData from session_list and session_created messages.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.624962-05:00","updated_at":"2025-10-26T01:01:31.624962-05:00","closed_at":"2025-10-25T20:12:09.481444-05:00"}
{"id":"voice-code-305","title":"task","description":"Add a user-configurable setting for how many sessions to show in the Recent Sessions section.\n\nLocation: ios/VoiceCode/Models/AppSettings.swift\n\nImplementation:\n1. Add @AppStorage property: @AppStorage(\"recentSessionsLimit\") var recentSessionsLimit: Int = 3\n2. Add UI in SettingsView.swift with Stepper for values 1-10\n\nDefault: 3 sessions\nTesting: Verify setting persists across restarts and updates display immediately","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-24T17:05:20.781205-05:00","updated_at":"2025-10-25T20:12:17.365952-05:00","closed_at":"2025-10-25T20:12:17.365952-05:00","dependencies":[{"issue_id":"voice-code-305","depends_on_id":"voice-code-304","type":"blocks","created_at":"2025-10-24T17:05:20.782266-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-306","title":"task","description":"Replace @State var recentSessions with computed property deriving from CoreData.\n\nLocation: ios/VoiceCode/VoiceCodeApp.swift and DirectoryListView.swift\n\nRemove:\n- @State private var recentSessions\n- onRecentSessionsReceived callback\n\nAdd to DirectoryListView:\nprivate var recentSessions: [RecentSession] {\n  sessions.filter { !$0.markedDeleted }\n    .sorted { $0.lastModified \u003e $1.lastModified }\n    .prefix(settings.recentSessionsLimit)\n    .map { RecentSession(from: $0) }\n}\n\nAdd RecentSession.init(from: CDSession)\n\nTesting: Verify display, limit changes, new sessions appear, deleted sessions hidden","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-24T17:05:20.833632-05:00","updated_at":"2025-10-25T20:12:25.088967-05:00","closed_at":"2025-10-25T20:12:25.088967-05:00","dependencies":[{"issue_id":"voice-code-306","depends_on_id":"voice-code-304","type":"blocks","created_at":"2025-10-24T17:05:20.834507-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-306","depends_on_id":"voice-code-305","type":"blocks","created_at":"2025-10-24T17:05:20.834889-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-307","title":"task","description":"Clean up unused WebSocket callback and model after migrating to CoreData-based Recent Sessions.\n\nFiles to modify:\n- ios/VoiceCode/Managers/VoiceCodeClient.swift\n- ios/VoiceCode/Models/RecentSession.swift\n\nChanges in VoiceCodeClient.swift:\n1. Remove property: var onRecentSessionsReceived: (([[String: Any]]) -\u003e Void)?\n2. Remove case handler in receiveMessage(): case \"recent_sessions\"\n\nFile to delete:\n- ios/VoiceCode/Models/RecentSession.swift (entire file)\n  Note: Functionality replaced by RecentSession.init(from: CDSession) in DirectoryListView\n\nTesting:\n- Verify app compiles without errors\n- Verify no references to RecentSession model remain\n- Verify Recent Sessions display still works via CoreData\n- Verify no console errors about unhandled recent_sessions messages\n\nDependencies:\n- Must complete voice-code-306 first (converted to computed property)\n- Ensures no code still depends on old RecentSession model","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-24T17:05:56.264521-05:00","updated_at":"2025-10-24T17:05:56.264521-05:00"}
{"id":"voice-code-308","title":"task","description":"Remove backend function that sends recent_sessions message, now unused after iOS migration.\n\nFile: backend/src/voice_code/server.clj\n\nRemove function:\n- send-recent-sessions! (lines 133-145)\n  Sends {:type :recent-sessions} message with limited session list\n\nRemove function call in handle-message:\n- In \"connect\" case, remove: (send-recent-sessions! channel limit)\n- Remove: (let [limit (or (:recent-sessions-limit data) 5)] ...)\n\nKeep unchanged:\n- session_list message (still needed for Projects list)\n- session_created message (still needed for real-time updates)\n\nTesting:\n- Verify backend compiles without errors\n- Verify connect message still sends session_list\n- Verify iOS Recent Sessions still populates from session_list\n- Verify no backend errors about missing recent-sessions-limit\n\nDependencies:\n- Must complete voice-code-324 first (iOS no longer expects message)\n- Ensures no clients still depend on recent_sessions message","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-24T17:05:56.320509-05:00","updated_at":"2025-10-26T15:43:40.322361-05:00","dependencies":[{"issue_id":"voice-code-308","depends_on_id":"voice-code-307","type":"blocks","created_at":"2025-10-26T15:43:40.35908-05:00","created_by":"auto-import"}]}
{"id":"voice-code-309","title":"task","description":"Remove backend helper function that queries recent sessions, now unused.\n\nFile: backend/src/voice_code/replication.clj\n\nRemove function:\n- get-recent-sessions (takes limit parameter)\n  Returns N most recently modified sessions sorted by :last-modified\n\nKeep unchanged:\n- get-all-sessions (still used by session_list)\n- get-session-metadata (still used for individual lookups)\n\nRationale:\n- Only caller was send-recent-sessions! (removed in voice-code-326)\n- Session sorting/limiting now done client-side from CoreData\n- Reduces backend complexity\n\nTesting:\n- Verify backend compiles without errors\n- Verify session_list still works (uses get-all-sessions)\n- Run backend tests: clj -M:test\n- Verify no remaining references to get-recent-sessions\n\nDependencies:\n- Must complete voice-code-326 first (removed send-recent-sessions!)\n- Ensures function has no remaining callers","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-24T17:05:56.374819-05:00","updated_at":"2025-10-26T15:43:40.321829-05:00","dependencies":[{"issue_id":"voice-code-309","depends_on_id":"voice-code-308","type":"blocks","created_at":"2025-10-26T15:43:40.35949-05:00","created_by":"auto-import"}]}
{"id":"voice-code-31","title":"Test full voice workflow: speak → Claude → listen","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.632028-05:00","updated_at":"2025-10-26T01:01:31.632028-05:00","closed_at":"2025-10-23T19:10:14.211242-05:00","dependencies":[{"issue_id":"voice-code-31","depends_on_id":"voice-code-13","type":"blocks","created_at":"2025-10-26T01:01:31.918242-05:00","created_by":"auto-import"},{"issue_id":"voice-code-31","depends_on_id":"voice-code-29","type":"blocks","created_at":"2025-10-26T01:01:31.919188-05:00","created_by":"auto-import"},{"issue_id":"voice-code-31","depends_on_id":"voice-code-30","type":"blocks","created_at":"2025-10-26T01:01:31.920097-05:00","created_by":"auto-import"}]}
{"id":"voice-code-310","title":"task","description":"Update WebSocket protocol documentation to reflect removal of recent_sessions message.\n\nFile: STANDARDS.md\n\nRemove from Backend → Client section:\n- Recent Sessions message type and example JSON\n- References to recent_sessions_limit parameter in connect message\n\nUpdate \"Connection Flow\" section:\n- Remove \"Recent Sessions\" step after connected confirmation\n- Document that Recent Sessions computed client-side from session_list\n\nAdd clarification:\n- session_list provides 50 most recent sessions for both Projects and Recent\n- Client computes Recent Sessions by sorting/limiting session_list data\n- User can configure Recent Sessions limit in app settings (not backend)\n\nTesting:\n- Review documentation for accuracy\n- Verify all message types match implementation\n- Check for any other references to recent_sessions or recent-sessions-limit\n\nDependencies:\n- Complete after all code changes (voice-code-305 through voice-code-325)\n- Ensures documentation matches final implementation","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-24T17:05:56.427245-05:00","updated_at":"2025-10-26T15:43:40.321219-05:00","dependencies":[{"issue_id":"voice-code-310","depends_on_id":"voice-code-309","type":"blocks","created_at":"2025-10-26T15:43:40.359998-05:00","created_by":"auto-import"}]}
{"id":"voice-code-311","title":"task","description":"Comprehensive testing of Recent Sessions after migration to client-side implementation.\n\nTest scenarios:\n\n1. Initial connection:\n   - Launch app, verify Recent Sessions populated\n   - Verify count matches recentSessionsLimit setting\n   - Verify sorted by lastModified descending\n\n2. User setting:\n   - Change recentSessionsLimit in Settings (e.g., 3 → 5)\n   - Verify Recent Sessions count updates immediately\n   - Verify setting persists after app restart\n\n3. New session creation:\n   - Create session in terminal (cd to project, run claude)\n   - Verify session appears in Recent Sessions automatically\n   - Verify sorted to top (most recent)\n\n4. Manual refresh:\n   - Tap refresh button in DirectoryListView\n   - Verify Recent Sessions updates with any backend changes\n   - Verify limit still respected\n\n5. Session deletion:\n   - Delete session via swipe gesture\n   - Verify removed from Recent Sessions immediately\n   - Verify doesn't reappear after refresh\n\n6. Edge cases:\n   - Set limit to 1, verify only 1 session shown\n   - Set limit to 10 with \u003c10 sessions, verify all shown\n   - Disconnect/reconnect network, verify data persists\n\nAcceptance criteria:\n- All scenarios pass without errors\n- No console warnings about missing recent_sessions\n- Performance: Recent section renders quickly (\u003c100ms)\n- Memory: No leaks from computed property","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-24T17:05:56.482526-05:00","updated_at":"2025-10-24T17:05:56.482526-05:00","dependencies":[{"issue_id":"voice-code-311","depends_on_id":"voice-code-307","type":"blocks","created_at":"2025-10-26T15:43:40.360254-05:00","created_by":"auto-import"},{"issue_id":"voice-code-311","depends_on_id":"voice-code-308","type":"blocks","created_at":"2025-10-26T15:43:40.360498-05:00","created_by":"auto-import"},{"issue_id":"voice-code-311","depends_on_id":"voice-code-309","type":"blocks","created_at":"2025-10-26T15:43:40.360728-05:00","created_by":"auto-import"},{"issue_id":"voice-code-311","depends_on_id":"voice-code-310","type":"blocks","created_at":"2025-10-26T15:43:40.360984-05:00","created_by":"auto-import"}]}
{"id":"voice-code-312","title":"Revert navigation title from 'Untethered' to 'Projects'","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.635382-05:00","updated_at":"2025-10-26T01:01:31.635382-05:00","closed_at":"2025-10-25T20:09:30.154378-05:00","dependencies":[{"issue_id":"voice-code-312","depends_on_id":"voice-code-315","type":"parent-child","created_at":"2025-10-26T01:01:31.925619-05:00","created_by":"auto-import"}]}
{"id":"voice-code-313","title":"Change section header from 'Untethered' back to 'Projects'","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.636006-05:00","updated_at":"2025-10-26T01:01:31.636006-05:00","closed_at":"2025-10-25T20:09:30.154162-05:00","dependencies":[{"issue_id":"voice-code-313","depends_on_id":"voice-code-315","type":"parent-child","created_at":"2025-10-26T01:01:31.926343-05:00","created_by":"auto-import"}]}
{"id":"voice-code-314","title":"Shorten 'Recent Sessions' section header to 'Recent'","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.636569-05:00","updated_at":"2025-10-26T01:01:31.636569-05:00","closed_at":"2025-10-25T20:09:30.153987-05:00","dependencies":[{"issue_id":"voice-code-314","depends_on_id":"voice-code-315","type":"parent-child","created_at":"2025-10-26T01:01:31.927298-05:00","created_by":"auto-import"}]}
{"id":"voice-code-315","title":"Navigation UX refinement: Projects-first hierarchy","description":"Refine navigation titles and section headers to emphasize directory/project organization while keeping minimal changes from current structure.\n\nChanges:\n- Home screen navigation title: 'Untethered' → 'Projects'\n- Section header for directories: 'Untethered' → 'Projects'\n- Section header for recent: 'Recent Sessions' → 'Recent'\n\nThis keeps the directory-first mental model while making back buttons more intuitive ('← Projects' instead of '← Untethered').","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-10-26T01:01:31.637267-05:00","updated_at":"2025-10-26T01:01:31.637267-05:00","closed_at":"2025-10-25T20:09:30.153359-05:00"}
{"id":"voice-code-316","title":"Implement session locking for compaction","description":"Apply session locking pattern (like prompts) to session compaction to prevent concurrent operations. Backend: acquire lock before compaction, send session_locked if busy, release on completion/error. iOS: track lock state, disable compaction UI for locked sessions, unlock on compaction_complete/error.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-10-26T01:01:31.637939-05:00","updated_at":"2025-10-26T01:01:31.637939-05:00","closed_at":"2025-10-25T20:12:09.481142-05:00"}
{"id":"voice-code-317","title":"Add session locking to compaction to prevent concurrent operations","description":"Apply the existing session locking pattern (used for prompts) to session compaction. This prevents race conditions when multiple clients try to compact the same session simultaneously, or when compaction runs while a prompt is in progress.\n\nContext: Session locking already exists in replication.clj (acquire-session-lock!, release-session-lock!). Prompts use this in server.clj handle-message. Need to apply same pattern to compact_session handler.\n\nSuccess criteria:\n- Backend rejects compaction requests for locked sessions\n- iOS tracks compaction lock state per-session\n- UI disabled during compaction (like during prompts)\n- Clean lock release on success/error","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-10-26T01:01:31.638616-05:00","updated_at":"2025-10-26T01:01:31.638616-05:00","closed_at":"2025-10-25T20:12:17.365609-05:00","dependencies":[{"issue_id":"voice-code-317","depends_on_id":"voice-code-318","type":"blocks","created_at":"2025-10-26T01:01:31.928228-05:00","created_by":"auto-import"},{"issue_id":"voice-code-317","depends_on_id":"voice-code-319","type":"blocks","created_at":"2025-10-26T01:01:31.929264-05:00","created_by":"auto-import"},{"issue_id":"voice-code-317","depends_on_id":"voice-code-320","type":"blocks","created_at":"2025-10-26T01:01:31.930369-05:00","created_by":"auto-import"}]}
{"id":"voice-code-318","title":"Backend: Wrap compact_session handler with session lock acquire/release","description":"Modify server.clj compact_session handler (line ~475-508):\n\n1. Try acquire-session-lock! for claude-session-id BEFORE async/go block\n2. If locked: send session_locked message, return early\n3. If unlocked: wrap compaction in try/finally\n4. In finally: always release-session-lock!\n5. Include session-id in compaction_error responses (for iOS unlock)\n\nPattern reference: See handle-message prompt handler (line ~410-473) for exact pattern.\n\nFiles: backend/src/voice_code/server.clj\n\nTest: Send concurrent compact_session requests, verify second gets session_locked.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.639434-05:00","updated_at":"2025-10-26T01:01:31.639434-05:00","closed_at":"2025-10-25T20:12:09.480998-05:00"}
{"id":"voice-code-319","title":"iOS: Track compaction lock state and disable UI for locked sessions","description":"Update iOS VoiceCodeClient to handle compaction locking:\n\n1. Add session-id to compactSession() method tracking\n2. Handle session_locked message during compaction (same as prompts)\n3. Handle compaction_complete - unlock session\n4. Handle compaction_error - unlock session (error already has session-id)\n5. Update UI to disable compact button for locked sessions\n\nPattern reference: See existing prompt lock handling in VoiceCodeClient.\n\nFiles: \n- iOS/voice-code/Managers/VoiceCodeClient.swift\n- iOS session UI views (wherever compact button lives)\n\nTest: Trigger compaction, verify UI disables until compaction_complete.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.640136-05:00","updated_at":"2025-10-26T01:01:31.640136-05:00","closed_at":"2025-10-25T20:12:09.480531-05:00"}
{"id":"voice-code-32","title":"Test text input workflow","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.640601-05:00","updated_at":"2025-10-26T01:01:31.640601-05:00","closed_at":"2025-10-23T19:10:14.21158-05:00","dependencies":[{"issue_id":"voice-code-32","depends_on_id":"voice-code-13","type":"blocks","created_at":"2025-10-26T01:01:31.931133-05:00","created_by":"auto-import"},{"issue_id":"voice-code-32","depends_on_id":"voice-code-29","type":"blocks","created_at":"2025-10-26T01:01:31.931951-05:00","created_by":"auto-import"},{"issue_id":"voice-code-32","depends_on_id":"voice-code-30","type":"blocks","created_at":"2025-10-26T01:01:31.932877-05:00","created_by":"auto-import"}]}
{"id":"voice-code-320","title":"Write integration test for concurrent compaction lock behavior","description":"Add integration test verifying session locking during compaction:\n\nTest scenario:\n1. Start compaction on session A\n2. While compaction running, attempt second compaction on session A\n3. Verify second request receives session_locked message\n4. Wait for first compaction to complete\n5. Verify session unlocked after completion\n6. Verify third compaction attempt succeeds\n\nPattern reference: See backend/test/voice_code/integration_session_locking_test.clj for prompt locking tests.\n\nFiles: backend/test/voice_code/integration_compaction_locking_test.clj (new file)\n\nSuccess: Test passes, catches regression if lock removed.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.641117-05:00","updated_at":"2025-10-26T01:01:31.641117-05:00","closed_at":"2025-10-25T20:12:09.481929-05:00"}
{"id":"voice-code-321","title":"New session creation doesn't navigate to the session","description":"When creating a new session via the + button in DirectoryListView or SessionsForDirectoryView, the session is created successfully but the app returns to the sessions list instead of opening the new session.\n\nRoot Cause:\n- DirectoryListView.swift:235 and SessionsForDirectoryView.swift:185 create CDSession and save to CoreData\n- Sheet closes but no navigation occurs\n- NavigationLinks only work for existing sessions in the list\n- Child views don't have access to navigationPath from RootView.swift:29\n\nDesign Options:\n\nOption 1 (Recommended): Pass NavigationPath Binding Down\n- Add @Binding var navigationPath: NavigationPath parameter to DirectoryListView and SessionsForDirectoryView\n- After creating session, append UUID to path: navigationPath.append(sessionId)\n- Triggers navigation to SessionLookupView → ConversationView\n- Pros: Simple, explicit, follows existing navigation pattern\n- Cons: Slightly more verbose prop drilling\n\nOption 2: Environment Object\n- Create NavigationCoordinator environment object to manage navigation\n- Child views call coordinator.navigateToSession(sessionId)\n- Pros: Cleaner API, no prop drilling\n- Cons: More indirection, harder to debug\n\nOption 3: Completion Callback\n- Pass onSessionCreated: (UUID) -\u003e Void callback to child views\n- RootView handles navigation when callback invoked\n- Pros: Clear separation of concerns\n- Cons: Callback hell for deeply nested views\n\nRecommendation: Option 1\n- Minimal changes to existing architecture\n- Explicit data flow matches SwiftUI best practices\n- Easy to test and debug\n- Consistent with how showingSettings is already passed down","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-10-25T17:55:50.485169-05:00","updated_at":"2025-10-26T22:46:42.950356-05:00","closed_at":"2025-10-26T22:46:42.950357-05:00"}
{"id":"voice-code-322","title":"New session creation doesn't navigate to the session","description":"When creating a new session via the + button in DirectoryListView or SessionsForDirectoryView, the session is created successfully but the app returns to the sessions list instead of opening the new session.\n\nRoot Cause:\n- DirectoryListView.swift:235 and SessionsForDirectoryView.swift:185 create CDSession and save to CoreData\n- Sheet closes but no navigation occurs\n- NavigationLinks only work for existing sessions in the list\n- Child views don't have access to navigationPath from RootView.swift:29\n\nDesign Options:\n\nOption 1 (Recommended): Pass NavigationPath Binding Down\n- Add @Binding var navigationPath: NavigationPath parameter to DirectoryListView and SessionsForDirectoryView\n- After creating session, append UUID to path: navigationPath.append(sessionId)\n- Triggers navigation to SessionLookupView → ConversationView\n- Pros: Simple, explicit, follows existing navigation pattern\n- Cons: Slightly more verbose prop drilling\n\nOption 2: Environment Object\n- Create NavigationCoordinator environment object to manage navigation\n- Child views call coordinator.navigateToSession(sessionId)\n- Pros: Cleaner API, no prop drilling\n- Cons: More indirection, harder to debug\n\nOption 3: Completion Callback\n- Pass onSessionCreated: (UUID) -\u003e Void callback to child views\n- RootView handles navigation when callback invoked\n- Pros: Clear separation of concerns\n- Cons: Callback hell for deeply nested views\n\nRecommendation: Option 1\n- Minimal changes to existing architecture\n- Explicit data flow matches SwiftUI best practices\n- Easy to test and debug\n- Consistent with how showingSettings is already passed down","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-10-26T15:43:40.305927-05:00","updated_at":"2025-10-26T15:43:40.305927-05:00","closed_at":"2025-10-26T01:03:30.958963-05:00"}
{"id":"voice-code-323","title":"task","description":"Update WebSocket protocol documentation to reflect removal of recent_sessions message.\n\nFile: STANDARDS.md\n\nRemove from Backend → Client section:\n- Recent Sessions message type and example JSON\n- References to recent_sessions_limit parameter in connect message\n\nUpdate \"Connection Flow\" section:\n- Remove \"Recent Sessions\" step after connected confirmation\n- Document that Recent Sessions computed client-side from session_list\n\nAdd clarification:\n- session_list provides 50 most recent sessions for both Projects and Recent\n- Client computes Recent Sessions by sorting/limiting session_list data\n- User can configure Recent Sessions limit in app settings (not backend)\n\nTesting:\n- Review documentation for accuracy\n- Verify all message types match implementation\n- Check for any other references to recent_sessions or recent-sessions-limit\n\nDependencies:\n- Complete after all code changes (voice-code-305 through voice-code-325)\n- Ensures documentation matches final implementation","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T15:43:40.306973-05:00","updated_at":"2025-10-26T15:43:40.319982-05:00","closed_at":"2025-10-26T01:03:56.724405-05:00","dependencies":[{"issue_id":"voice-code-323","depends_on_id":"voice-code-325","type":"blocks","created_at":"2025-10-26T15:43:40.344559-05:00","created_by":"import-remap"}]}
{"id":"voice-code-324","title":"task","description":"Clean up unused WebSocket callback and model after migrating to CoreData-based Recent Sessions.\n\nFiles to modify:\n- ios/VoiceCode/Managers/VoiceCodeClient.swift\n- ios/VoiceCode/Models/RecentSession.swift\n\nChanges in VoiceCodeClient.swift:\n1. Remove property: var onRecentSessionsReceived: (([[String: Any]]) -\u003e Void)?\n2. Remove case handler in receiveMessage(): case \"recent_sessions\"\n\nFile to delete:\n- ios/VoiceCode/Models/RecentSession.swift (entire file)\n  Note: Functionality replaced by RecentSession.init(from: CDSession) in DirectoryListView\n\nTesting:\n- Verify app compiles without errors\n- Verify no references to RecentSession model remain\n- Verify Recent Sessions display still works via CoreData\n- Verify no console errors about unhandled recent_sessions messages\n\nDependencies:\n- Must complete voice-code-306 first (converted to computed property)\n- Ensures no code still depends on old RecentSession model","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T15:43:40.308201-05:00","updated_at":"2025-10-26T15:43:40.308201-05:00","closed_at":"2025-10-26T01:03:30.959845-05:00","dependencies":[{"issue_id":"voice-code-324","depends_on_id":"voice-code-306","type":"blocks","created_at":"2025-10-26T15:43:40.347912-05:00","created_by":"import-remap"}]}
{"id":"voice-code-325","title":"task","description":"Remove backend helper function that queries recent sessions, now unused.\n\nFile: backend/src/voice_code/replication.clj\n\nRemove function:\n- get-recent-sessions (takes limit parameter)\n  Returns N most recently modified sessions sorted by :last-modified\n\nKeep unchanged:\n- get-all-sessions (still used by session_list)\n- get-session-metadata (still used for individual lookups)\n\nRationale:\n- Only caller was send-recent-sessions! (removed in voice-code-326)\n- Session sorting/limiting now done client-side from CoreData\n- Reduces backend complexity\n\nTesting:\n- Verify backend compiles without errors\n- Verify session_list still works (uses get-all-sessions)\n- Run backend tests: clj -M:test\n- Verify no remaining references to get-recent-sessions\n\nDependencies:\n- Must complete voice-code-326 first (removed send-recent-sessions!)\n- Ensures function has no remaining callers","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T15:43:40.309144-05:00","updated_at":"2025-10-26T15:43:40.318196-05:00","closed_at":"2025-10-26T01:03:45.488484-05:00","dependencies":[{"issue_id":"voice-code-325","depends_on_id":"voice-code-326","type":"blocks","created_at":"2025-10-26T15:43:40.34827-05:00","created_by":"import-remap"}]}
{"id":"voice-code-326","title":"task","description":"Remove backend function that sends recent_sessions message, now unused after iOS migration.\n\nFile: backend/src/voice_code/server.clj\n\nRemove function:\n- send-recent-sessions! (lines 133-145)\n  Sends {:type :recent-sessions} message with limited session list\n\nRemove function call in handle-message:\n- In \"connect\" case, remove: (send-recent-sessions! channel limit)\n- Remove: (let [limit (or (:recent-sessions-limit data) 5)] ...)\n\nKeep unchanged:\n- session_list message (still needed for Projects list)\n- session_created message (still needed for real-time updates)\n\nTesting:\n- Verify backend compiles without errors\n- Verify connect message still sends session_list\n- Verify iOS Recent Sessions still populates from session_list\n- Verify no backend errors about missing recent-sessions-limit\n\nDependencies:\n- Must complete voice-code-324 first (iOS no longer expects message)\n- Ensures no clients still depend on recent_sessions message","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T15:43:40.310147-05:00","updated_at":"2025-10-26T15:43:40.317705-05:00","closed_at":"2025-10-26T01:03:38.627736-05:00","dependencies":[{"issue_id":"voice-code-326","depends_on_id":"voice-code-324","type":"blocks","created_at":"2025-10-26T15:43:40.347573-05:00","created_by":"import-remap"}]}
{"id":"voice-code-327","title":"task","description":"Comprehensive testing of Recent Sessions after migration to client-side implementation.\n\nTest scenarios:\n\n1. Initial connection:\n   - Launch app, verify Recent Sessions populated\n   - Verify count matches recentSessionsLimit setting\n   - Verify sorted by lastModified descending\n\n2. User setting:\n   - Change recentSessionsLimit in Settings (e.g., 3 → 5)\n   - Verify Recent Sessions count updates immediately\n   - Verify setting persists after app restart\n\n3. New session creation:\n   - Create session in terminal (cd to project, run claude)\n   - Verify session appears in Recent Sessions automatically\n   - Verify sorted to top (most recent)\n\n4. Manual refresh:\n   - Tap refresh button in DirectoryListView\n   - Verify Recent Sessions updates with any backend changes\n   - Verify limit still respected\n\n5. Session deletion:\n   - Delete session via swipe gesture\n   - Verify removed from Recent Sessions immediately\n   - Verify doesn't reappear after refresh\n\n6. Edge cases:\n   - Set limit to 1, verify only 1 session shown\n   - Set limit to 10 with \u003c10 sessions, verify all shown\n   - Disconnect/reconnect network, verify data persists\n\nAcceptance criteria:\n- All scenarios pass without errors\n- No console warnings about missing recent_sessions\n- Performance: Recent section renders quickly (\u003c100ms)\n- Memory: No leaks from computed property","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T15:43:40.31119-05:00","updated_at":"2025-10-26T15:43:40.31119-05:00","closed_at":"2025-10-26T01:03:56.725471-05:00","dependencies":[{"issue_id":"voice-code-327","depends_on_id":"voice-code-305","type":"blocks","created_at":"2025-10-26T15:43:40.34507-05:00","created_by":"import-remap"},{"issue_id":"voice-code-327","depends_on_id":"voice-code-306","type":"blocks","created_at":"2025-10-26T15:43:40.345565-05:00","created_by":"import-remap"},{"issue_id":"voice-code-327","depends_on_id":"voice-code-324","type":"blocks","created_at":"2025-10-26T15:43:40.346022-05:00","created_by":"import-remap"},{"issue_id":"voice-code-327","depends_on_id":"voice-code-326","type":"blocks","created_at":"2025-10-26T15:43:40.346414-05:00","created_by":"import-remap"},{"issue_id":"voice-code-327","depends_on_id":"voice-code-325","type":"blocks","created_at":"2025-10-26T15:43:40.34679-05:00","created_by":"import-remap"},{"issue_id":"voice-code-327","depends_on_id":"voice-code-323","type":"blocks","created_at":"2025-10-26T15:43:40.34716-05:00","created_by":"import-remap"}]}
{"id":"voice-code-328","title":"Fix Claude CLI JSON truncation by using file-based output redirection","description":"Problem: Claude CLI produces truncated JSON output causing parse failures. Process exits with code 0 but stdout contains incomplete JSON cutting off mid-string at ~75KB. Root cause: shell/sh captures output to in-memory strings which get truncated. Solution: Replace with file-based redirection using clojure.java.process. Modify invoke-claude and compact-session functions in backend/src/voice_code/claude.clj to redirect stdout/stderr to temp files, read with slurp after completion, and delete in finally block. See project for full implementation details.","notes":"## Problem\n\nClaude CLI is producing truncated JSON output that causes parsing failures. The process exits with code 0 (success) but stdout contains incomplete JSON that cuts off mid-string at positions like 75KB or 66KB.\n\nError signature:\nFailed to parse response: Unexpected end-of-input: was expecting closing quote for a string value at line: 1, column: 75727\n\nRoot cause: Using clojure.java.shell/sh captures output to in-memory strings. The Claude CLI output is being truncated before the process completes, possibly due to buffer overflow, pipe size limits (approx 64KB), or CLI bugs.\n\nEvidence:\n- Exit code is 0 (success) but JSON is incomplete\n- Truncation happens at consistent sizes (approx 66KB, 75KB)\n- No stderr output indicating errors\n- Stack trace shows Jackson JSON parser hitting EOF mid-string\n\n## Solution\n\nReplace in-memory output capture with file-based redirection using clojure.java.process (available in Clojure 1.12.3).\n\nFiles to modify: backend/src/voice_code/claude.clj\n\nFunctions to update:\n1. invoke-claude - Main CLI invocation (line 24-88)\n2. compact-session - Session compaction (line 224+)\n\nKey changes:\n- Add namespace import: clojure.java.process as proc\n- Create temp files with java.io.File/createTempFile\n- Use proc/to-file to redirect stdout/stderr\n- Use proc/exit-ref and deref to wait for completion\n- Read files with slurp AFTER process completes\n- Always delete temp files in finally block\n\nTesting:\n- Run clj -M:test to ensure no regressions\n- Test with prompts that produce large outputs\n- Verify temp files are cleaned up\n\nReferences:\n- clojure.java.process docs: https://clojure.github.io/clojure/branch-master/clojure.java.process-api.html\n- Current implementation: backend/src/voice_code/claude.clj:24-88\n- Error logs: backend/server.log (search for Failed to parse response)","status":"open","priority":0,"issue_type":"task","created_at":"2025-10-26T22:37:48.465435-05:00","updated_at":"2025-10-26T22:38:07.213691-05:00"}
{"id":"voice-code-33","title":"Test session switching","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.64262-05:00","updated_at":"2025-10-26T01:01:31.64262-05:00","closed_at":"2025-10-23T19:10:14.211783-05:00","dependencies":[{"issue_id":"voice-code-33","depends_on_id":"voice-code-29","type":"blocks","created_at":"2025-10-26T01:01:31.934438-05:00","created_by":"auto-import"},{"issue_id":"voice-code-33","depends_on_id":"voice-code-30","type":"blocks","created_at":"2025-10-26T01:01:31.935661-05:00","created_by":"auto-import"}]}
{"id":"voice-code-34","title":"Test error scenarios (network drop, timeout, etc.)","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.643175-05:00","updated_at":"2025-10-26T01:01:31.643175-05:00","closed_at":"2025-10-23T19:10:14.211993-05:00","dependencies":[{"issue_id":"voice-code-34","depends_on_id":"voice-code-13","type":"blocks","created_at":"2025-10-26T01:01:31.936239-05:00","created_by":"auto-import"},{"issue_id":"voice-code-34","depends_on_id":"voice-code-29","type":"blocks","created_at":"2025-10-26T01:01:31.936832-05:00","created_by":"auto-import"}]}
{"id":"voice-code-35","title":"Fix issues discovered in integration testing","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.643652-05:00","updated_at":"2025-10-26T01:01:31.643652-05:00","closed_at":"2025-10-23T19:10:14.164328-05:00","dependencies":[{"issue_id":"voice-code-35","depends_on_id":"voice-code-31","type":"blocks","created_at":"2025-10-26T01:01:31.937444-05:00","created_by":"auto-import"},{"issue_id":"voice-code-35","depends_on_id":"voice-code-32","type":"blocks","created_at":"2025-10-26T01:01:31.938007-05:00","created_by":"auto-import"},{"issue_id":"voice-code-35","depends_on_id":"voice-code-33","type":"blocks","created_at":"2025-10-26T01:01:31.938988-05:00","created_by":"auto-import"},{"issue_id":"voice-code-35","depends_on_id":"voice-code-34","type":"blocks","created_at":"2025-10-26T01:01:31.940166-05:00","created_by":"auto-import"}]}
{"id":"voice-code-36","title":"Improve error messages","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.644198-05:00","updated_at":"2025-10-26T01:01:31.644198-05:00","closed_at":"2025-10-23T19:09:45.900353-05:00","dependencies":[{"issue_id":"voice-code-36","depends_on_id":"voice-code-35","type":"blocks","created_at":"2025-10-26T01:01:31.94117-05:00","created_by":"auto-import"}]}
{"id":"voice-code-37","title":"Add loading indicators","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.644681-05:00","updated_at":"2025-10-26T01:01:31.644681-05:00","closed_at":"2025-10-23T19:09:08.935889-05:00","dependencies":[{"issue_id":"voice-code-37","depends_on_id":"voice-code-35","type":"blocks","created_at":"2025-10-26T01:01:31.942044-05:00","created_by":"auto-import"}]}
{"id":"voice-code-38","title":"Polish UI transitions","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.645348-05:00","updated_at":"2025-10-26T01:01:31.645348-05:00","closed_at":"2025-10-23T19:09:45.90068-05:00","dependencies":[{"issue_id":"voice-code-38","depends_on_id":"voice-code-35","type":"blocks","created_at":"2025-10-26T01:01:31.943116-05:00","created_by":"auto-import"}]}
{"id":"voice-code-39","title":"Test on different iPhone models/iOS versions","description":"","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.645928-05:00","updated_at":"2025-10-26T01:01:31.645928-05:00","closed_at":"2025-10-23T19:10:14.164534-05:00","dependencies":[{"issue_id":"voice-code-39","depends_on_id":"voice-code-35","type":"blocks","created_at":"2025-10-26T01:01:31.94414-05:00","created_by":"auto-import"}]}
{"id":"voice-code-40","title":"Write setup instructions","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.646648-05:00","updated_at":"2025-10-26T01:01:31.646648-05:00","closed_at":"2025-10-23T19:10:05.151291-05:00","dependencies":[{"issue_id":"voice-code-40","depends_on_id":"voice-code-35","type":"blocks","created_at":"2025-10-26T01:01:31.945549-05:00","created_by":"auto-import"}]}
{"id":"voice-code-41","title":"Document known limitations","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.647319-05:00","updated_at":"2025-10-26T01:01:31.647319-05:00","closed_at":"2025-10-23T19:10:05.151622-05:00","dependencies":[{"issue_id":"voice-code-41","depends_on_id":"voice-code-35","type":"blocks","created_at":"2025-10-26T01:01:31.946661-05:00","created_by":"auto-import"}]}
{"id":"voice-code-42","title":"Create troubleshooting guide","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.648162-05:00","updated_at":"2025-10-26T01:01:31.648162-05:00","closed_at":"2025-10-23T19:10:05.151792-05:00","dependencies":[{"issue_id":"voice-code-42","depends_on_id":"voice-code-35","type":"blocks","created_at":"2025-10-26T01:01:31.947722-05:00","created_by":"auto-import"}]}
{"id":"voice-code-43","title":"Record demo video","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.648852-05:00","updated_at":"2025-10-26T01:01:31.648852-05:00","closed_at":"2025-10-22T17:03:20.11049-05:00","dependencies":[{"issue_id":"voice-code-43","depends_on_id":"voice-code-40","type":"blocks","created_at":"2025-10-26T01:01:31.948739-05:00","created_by":"auto-import"},{"issue_id":"voice-code-43","depends_on_id":"voice-code-41","type":"blocks","created_at":"2025-10-26T01:01:31.949853-05:00","created_by":"auto-import"}]}
{"id":"voice-code-44","title":"Tag v0.1.0 release","description":"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-26T01:01:31.649667-05:00","updated_at":"2025-10-26T01:01:31.649667-05:00","closed_at":"2025-10-23T19:10:05.151932-05:00","dependencies":[{"issue_id":"voice-code-44","depends_on_id":"voice-code-40","type":"blocks","created_at":"2025-10-26T01:01:31.951041-05:00","created_by":"auto-import"},{"issue_id":"voice-code-44","depends_on_id":"voice-code-41","type":"blocks","created_at":"2025-10-26T01:01:31.951971-05:00","created_by":"auto-import"},{"issue_id":"voice-code-44","depends_on_id":"voice-code-42","type":"blocks","created_at":"2025-10-26T01:01:31.953465-05:00","created_by":"auto-import"},{"issue_id":"voice-code-44","depends_on_id":"voice-code-43","type":"blocks","created_at":"2025-10-26T01:01:31.954447-05:00","created_by":"auto-import"}]}
{"id":"voice-code-47","title":"Fix tilde expansion in working directory paths","description":"The Examples shows ~/code/voice-code but the server fails with 'Cannot run program in directory ~/code/mono: No such file or directory'. Java's ProcessBuilder doesn't expand tildes - need to expand ~ to actual home directory in invoke-claude before passing to shell/sh","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.650443-05:00","updated_at":"2025-10-26T01:01:31.650443-05:00","closed_at":"2025-10-17T17:21:36.504931-05:00"}
{"id":"voice-code-48","title":"Improve markdown rendering for Claude Code responses","description":"Better render markdown when showing responses from Claude Code for improved readability and proper formatting","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-26T01:01:31.651286-05:00","updated_at":"2025-10-26T01:01:31.651286-05:00","closed_at":"2025-10-23T19:10:05.256094-05:00"}
{"id":"voice-code-49","title":"Exclude code blocks from text-to-speech","description":"Code blocks should be visible in the markdown display but not read aloud. Code is important to see but terrible to hear spoken.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-26T01:01:31.652549-05:00","updated_at":"2025-10-26T01:01:31.652549-05:00","closed_at":"2025-10-18T18:35:21.505247-05:00"}
{"id":"voice-code-50","title":"Enable text-to-speech playback when iPhone is locked","description":"Configure AVAudioSession with playback category and enable Audio background mode so users can hear Claude Code responses even when their iPhone screen is locked. Requires: 1) Enable 'Audio \u0026 AirPlay' background capability in Xcode, 2) Set AVAudioSession category to .playback, 3) Handle iOS TTS background limitations (may stop after 30-60s, workaround with silence snippet)","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-10-26T01:01:31.653735-05:00","updated_at":"2025-10-26T01:01:31.653735-05:00","closed_at":"2025-10-22T19:20:33.430776-05:00"}
{"id":"voice-code-61","title":"Backend: Continue tasks after disconnect","description":"Keep Claude CLI invocations running even if WebSocket disconnects. Store responses in session when they complete. Associate running tasks with session UUID (not WebSocket channel). Add task completion callback that stores result in session.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-10-26T01:01:31.654598-05:00","updated_at":"2025-10-26T01:01:31.654598-05:00","closed_at":"2025-10-23T19:09:56.189824-05:00"}
{"id":"voice-code-62","title":"Backend: Task status tracking","description":"Track running Claude tasks per session (started, in-progress, completed, failed). Add task metadata: start time, prompt text, status. Provide 'task-status' query API. Clean up completed task records after delivery.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-10-26T01:01:31.655795-05:00","updated_at":"2025-10-26T01:01:31.655795-05:00","closed_at":"2025-10-23T19:09:56.190177-05:00","dependencies":[{"issue_id":"voice-code-62","depends_on_id":"voice-code-61","type":"blocks","created_at":"2025-10-26T01:01:31.955832-05:00","created_by":"auto-import"}]}
{"id":"voice-code-63","title":"iOS: Handle delayed responses","description":"Display loading indicators for in-progress tasks. Show task status in message list. Handle responses that arrive after app was closed/backgrounded. Show local notifications when long-running tasks complete. Update UI when delayed responses arrive.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-10-26T01:01:31.657137-05:00","updated_at":"2025-10-26T01:01:31.657137-05:00","closed_at":"2025-10-23T19:09:56.190388-05:00"}
{"id":"voice-code-64","title":"Test: Session persistence","description":"Unit tests for session storage and loading. Test message buffering and retrieval. Test session metadata tracking. Test EDN serialization/deserialization. Test concurrent session access. Verify sessions survive backend restart.","notes":"Test minimal session storage. Verify iOS UUID → Claude session ID mapping persists. Test undelivered queue operations (add, deliver, remove). Verify sessions survive backend restart. Test that we DON'T store full conversation history (that's Claude's job).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.658264-05:00","updated_at":"2025-10-26T01:01:31.658264-05:00","closed_at":"2025-10-23T19:09:19.493309-05:00"}
{"id":"voice-code-65","title":"Test: Message replay","description":"Integration tests for reconnection scenarios. Test message replay without duplicates. Test sequence number tracking. Test replay with multiple missed messages. Test reconnection after various disconnect scenarios (network, app close, etc).","notes":"Integration tests for reconnection. Test undelivered message replay. Test ACK protocol. Test reconnection after disconnect. Verify conversation continuity via Claude's --resume (not our storage). Test that delivered messages are removed from queue.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.659713-05:00","updated_at":"2025-10-26T01:01:31.659713-05:00","closed_at":"2025-10-23T19:09:19.493655-05:00"}
{"id":"voice-code-66","title":"Test: Long-running tasks","description":"Simulate 20+ minute Claude responses. Test app close/reopen during long task. Test task completion after disconnect. Test multiple simultaneous long tasks. Verify responses delivered correctly after reconnection.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.661214-05:00","updated_at":"2025-10-26T01:01:31.661214-05:00","closed_at":"2025-10-23T19:09:56.240404-05:00","dependencies":[{"issue_id":"voice-code-66","depends_on_id":"voice-code-61","type":"blocks","created_at":"2025-10-26T01:01:31.957576-05:00","created_by":"auto-import"},{"issue_id":"voice-code-66","depends_on_id":"voice-code-62","type":"blocks","created_at":"2025-10-26T01:01:31.958563-05:00","created_by":"auto-import"},{"issue_id":"voice-code-66","depends_on_id":"voice-code-63","type":"blocks","created_at":"2025-10-26T01:01:31.959427-05:00","created_by":"auto-import"}]}
{"id":"voice-code-67","title":"Test: Concurrent sessions","description":"Test multiple sessions from same iOS device. Test session isolation (messages don't cross sessions). Test WebSocket association correctness. Test session switching. Verify each session maintains independent state.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-26T01:01:31.662471-05:00","updated_at":"2025-10-26T01:01:31.662471-05:00","closed_at":"2025-10-23T19:09:56.240773-05:00"}
{"id":"voice-code-68","title":"Backend: Add session cleanup job","description":"Background task to remove sessions inactive \u003e 30 days. Run cleanup on startup and periodically (daily). Archive old session data before deletion. Add configurable retention policy. Log cleanup actions for monitoring.","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-10-26T01:01:31.66346-05:00","updated_at":"2025-10-26T01:01:31.66346-05:00","closed_at":"2025-10-23T19:10:05.043803-05:00"}
{"id":"voice-code-69","title":"iOS: Add sync status indicators","description":"Show sync state in UI (synced/syncing/offline). Display pending message count. Show reconnection attempts. Add visual feedback for message delivery status. Update connection indicator with more detail.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-26T01:01:31.664644-05:00","updated_at":"2025-10-26T01:01:31.664644-05:00","closed_at":"2025-10-23T19:10:05.044124-05:00"}
{"id":"voice-code-70","title":"Backend: Clean up undelivered queue","description":"Compress old messages (\u003e 7 days). Implement message retention limits (max messages per session). Add storage metrics/monitoring. Optimize EDN file format. Add incremental saves for large sessions.","notes":"Periodically clean up very old undelivered messages (\u003e7 days). These indicate iOS never reconnected. Archive or delete based on policy. Much simpler than original plan since we're not storing full history.","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-10-26T01:01:31.666017-05:00","updated_at":"2025-10-26T01:01:31.666017-05:00","closed_at":"2025-10-23T19:10:05.044483-05:00"}
{"id":"voice-code-71","title":"Documentation: Reconnection protocol \u0026 troubleshooting","description":"Document reconnection protocol in DESIGN.md. Add troubleshooting guide for common issues. Document message format and sequencing. Update README with session persistence features. Add examples for testing reconnection.","status":"closed","priority":2,"issue_type":"chore","created_at":"2025-10-26T01:01:31.667313-05:00","updated_at":"2025-10-26T01:01:31.667313-05:00","closed_at":"2025-10-23T19:10:05.044665-05:00","dependencies":[{"issue_id":"voice-code-71","depends_on_id":"voice-code-65","type":"blocks","created_at":"2025-10-26T01:01:31.961258-05:00","created_by":"auto-import"}]}
{"id":"voice-code-72","title":"Add text-only mode where responses are not spoken","description":"Add a mode or toggle where Claude responses are displayed as text but not read aloud via text-to-speech. This is useful when the user wants to read silently or is in an environment where audio is not appropriate.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-26T01:01:31.668413-05:00","updated_at":"2025-10-26T01:01:31.668413-05:00","closed_at":"2025-10-23T19:09:56.436068-05:00"}
{"id":"voice-code-73","title":"\"Write","description":"","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-26T01:01:31.669634-05:00","updated_at":"2025-10-26T01:01:31.669634-05:00","closed_at":"2025-10-17T17:31:24.730402-05:00"}
{"id":"voice-code-74","title":"Build session metadata index system","description":"Scan .jsonl files on startup to extract metadata and build in-memory index.\n\n- Scan .claude/projects directory recursively for .jsonl files\n- Extract metadata: session-id, name, working-dir, created-at, last-modified, message-count, preview\n- Build in-memory map: session-id to metadata\n- Persist index to .claude/.session-index.edn for fast reload\n- Load from persisted index on subsequent startups","acceptance_criteria":"Can build index from 100+ .jsonl files, index persists to .edn, subsequent startups load from .edn (\u003c1 second), contains all required metadata fields","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-26T01:01:31.671001-05:00","updated_at":"2025-10-26T01:01:31.671001-05:00","closed_at":"2025-10-22T18:28:23.711791-05:00","dependencies":[{"issue_id":"voice-code-74","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.96265-05:00","created_by":"auto-import"}]}
{"id":"voice-code-75","title":"Implement .jsonl parser","description":"Parse Claude Code .jsonl format to extract messages.\n\n- Parse .jsonl files (one JSON object per line)\n- Extract message fields: role, text, timestamp\n- Handle incremental parsing (read only new lines since last position)\n- Track last-read byte position per file for incremental reads\n- Error handling for malformed JSON lines (skip and log)\n- Return structured message list","acceptance_criteria":"Can parse full .jsonl file into message list, can parse only new lines incrementally (given last position), handles malformed JSON gracefully, returns normalized message structure","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-26T01:01:31.672619-05:00","updated_at":"2025-10-26T01:01:31.672619-05:00","closed_at":"2025-10-22T18:28:23.711985-05:00","dependencies":[{"issue_id":"voice-code-75","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.963895-05:00","created_by":"auto-import"}]}
{"id":"voice-code-76","title":"Add filesystem watcher with debouncing","description":"Watch .claude/projects for file changes using Java NIO WatchService.\n\n- Use Java NIO WatchService to watch directory\n- Listen for: ENTRY_CREATE, ENTRY_MODIFY, ENTRY_DELETE events\n- Implement debouncing: wait 200ms of quiet before processing\n- Implement parse-retry: retry up to 3 times if parse fails (100ms between retries)\n- Update metadata index when files change\n- Handle partial writes (debouncing prevents reading mid-write)","acceptance_criteria":"Detects new .jsonl files (ENTRY_CREATE), detects modifications (ENTRY_MODIFY) with debouncing, handles partial writes without errors (debounce + retry), updates index when files change","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-26T01:01:31.673996-05:00","updated_at":"2025-10-26T01:01:31.673996-05:00","closed_at":"2025-10-22T18:28:23.712187-05:00","dependencies":[{"issue_id":"voice-code-76","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.964856-05:00","created_by":"auto-import"}]}
{"id":"voice-code-77","title":"Implement selective file watching","description":"Track subscribed sessions and only watch their .jsonl files.\n\n- Maintain atom of subscribed session IDs\n- When iOS subscribes: add to set, start watching that specific .jsonl file\n- When iOS unsubscribes: remove from set, stop watching file\n- Always watch parent directory for new file creation (ENTRY_CREATE)\n- Only send updates for subscribed sessions\n- Limit to ~5-10 watched files per client","acceptance_criteria":"Only watches .jsonl files for subscribed sessions, always detects new session creation, unwatches when client unsubscribes, performance: \u003c5% CPU overhead with 10 subscriptions","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-26T01:01:31.674916-05:00","updated_at":"2025-10-26T01:01:31.674916-05:00","closed_at":"2025-10-22T18:28:23.71234-05:00","dependencies":[{"issue_id":"voice-code-77","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.965861-05:00","created_by":"auto-import"}]}
{"id":"voice-code-78","title":"Add session_list message handler","description":"Send session metadata index to iOS on connection.\n\n- On WebSocket connection (after hello), send session_list message\n- Include all session metadata from index\n- Format: {type: session_list, sessions: [{session_id, name, working_directory, last_modified, message_count, preview}]}\n- Performance target: \u003c1 second to send 666 sessions\n- Use snake_case for JSON keys (per standards)","acceptance_criteria":"Sends complete session list on connection, JSON format matches protocol spec, performance: \u003c1s for 666 sessions over local network, iOS can parse and display immediately","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-26T01:01:31.676318-05:00","updated_at":"2025-10-26T01:01:31.676318-05:00","closed_at":"2025-10-22T18:28:23.712504-05:00","dependencies":[{"issue_id":"voice-code-78","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.967193-05:00","created_by":"auto-import"}]}
{"id":"voice-code-79","title":"Add session_subscribe message handler","description":"Parse .jsonl file on-demand and send full conversation history.\n\n- Handle subscribe message from iOS: {type: subscribe, session_id: \"...\"}\n- Parse requested .jsonl file (lazy load)\n- Extract all messages from file\n- Send session_history: {type: session_history, session_id: \"...\", messages: [...]}\n- Add session to watched set (start monitoring for changes)\n- Track last-read position for incremental updates","acceptance_criteria":"Parses .jsonl on subscribe (lazy), sends full message history to iOS, adds to watched sessions set, handles missing files gracefully (error message)","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-26T01:01:31.678299-05:00","updated_at":"2025-10-26T01:01:31.678299-05:00","closed_at":"2025-10-22T18:28:23.712651-05:00","dependencies":[{"issue_id":"voice-code-79","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.968066-05:00","created_by":"auto-import"}]}
{"id":"voice-code-80","title":"Add session_updated message handler","description":"Send incremental updates for watched sessions.\n\n- Triggered by filesystem watcher (after debouncing)\n- Parse only new messages (using last-read position)\n- Send to subscribed iOS clients: {type: session_updated, session_id: \"...\", messages: [new messages]}\n- Update last-read position after successful parse\n- Only send to iOS clients subscribed to this session","acceptance_criteria":"Sends only new messages (incremental), triggered by file modification events, updates tracked position after send, only sends to subscribed clients","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-26T01:01:31.679272-05:00","updated_at":"2025-10-26T01:01:31.679272-05:00","closed_at":"2025-10-22T18:28:23.712796-05:00","dependencies":[{"issue_id":"voice-code-80","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.9691-05:00","created_by":"auto-import"}]}
{"id":"voice-code-81","title":"Add session_created message handler","description":"Broadcast new session creation to all iOS clients.\n\n- Triggered by filesystem watcher (ENTRY_CREATE event)\n- Extract metadata from new .jsonl file\n- Add to metadata index\n- Broadcast to all connected iOS clients: {type: session_created, session_id: \"...\", name: \"...\", ...}\n- iOS will auto-subscribe to new sessions","acceptance_criteria":"Detects new .jsonl files immediately, extracts and indexes metadata, broadcasts to all connected clients, iOS receives and can auto-subscribe","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-26T01:01:31.680547-05:00","updated_at":"2025-10-26T01:01:31.680547-05:00","closed_at":"2025-10-22T18:28:23.71294-05:00","dependencies":[{"issue_id":"voice-code-81","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.970129-05:00","created_by":"auto-import"}]}
{"id":"voice-code-82","title":"Add session_deleted message handler","description":"Track iOS client deletions and stop replication.\n\n- Handle session_deleted from iOS: {type: session_deleted, session_id: \"...\"}\n- Track deleted sessions per iOS client (in client state map)\n- Unsubscribe from session (stop watching)\n- Ignore future updates for this session for this client\n- Do NOT delete backend .jsonl file (file remains on dev machine)","acceptance_criteria":"Unsubscribes from deleted session, stops sending updates to that iOS client, file remains on backend (not deleted), other clients still receive updates","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-26T01:01:31.682036-05:00","updated_at":"2025-10-26T01:01:31.682036-05:00","closed_at":"2025-10-22T18:28:23.713418-05:00","dependencies":[{"issue_id":"voice-code-82","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.971968-05:00","created_by":"auto-import"}]}
{"id":"voice-code-83","title":"Update prompt handler for new/resume distinction","description":"Support new_session_id vs resume_session_id fields.\n\n- Parse new_session_id field: call claude --session-id \u003cid\u003e \"prompt\"\n- Parse resume_session_id field: call claude --resume \u003cid\u003e \"prompt\"\n- Remove direct response message (responses come via subscription)\n- iOS generates UUID for new sessions\n- Send only ack, responses come via session_updated\n\nProtocol:\n- {type: prompt, new_session_id: \"...\", text: \"...\"} → --session-id\n- {type: prompt, resume_session_id: \"...\", text: \"...\"} → --resume","acceptance_criteria":"Handles new_session_id correctly (--session-id), handles resume_session_id correctly (--resume), no direct response message, responses flow through subscription path","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-26T01:01:31.683078-05:00","updated_at":"2025-10-26T01:01:31.683078-05:00","closed_at":"2025-10-22T18:28:23.713561-05:00","dependencies":[{"issue_id":"voice-code-83","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.973015-05:00","created_by":"auto-import"}]}
{"id":"voice-code-84","title":"Remove old session persistence logic","description":"Clean up iOS session UUID mapping and sessions.edn storage.\n\n- Remove sessions.edn file and storage logic\n- Remove channel-to-session atom mapping\n- Remove iOS session UUID → Claude session ID mapping\n- Remove register-channel! and related functions\n- Simplify to pure session replication (no session state management)\n- Update tests to reflect new architecture","acceptance_criteria":"sessions.edn storage removed, iOS session UUID mapping removed, code simplified (session replication only), all tests passing with new architecture","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-26T01:01:31.684012-05:00","updated_at":"2025-10-26T01:01:31.684012-05:00","closed_at":"2025-10-22T18:28:23.713727-05:00","dependencies":[{"issue_id":"voice-code-84","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.973951-05:00","created_by":"auto-import"}]}
{"id":"voice-code-85","title":"Add session naming logic","description":"Generate default names for sessions.\n\n- Terminal sessions: \"Terminal: \u003cdir-name\u003e - \u003ctimestamp\u003e\"\n- iOS sessions: \"Voice: \u003cdir-name\u003e - \u003ctimestamp\u003e\"\n- Detect forks: \"\u003cparent-name\u003e (fork)\" or \"\u003cparent-name\u003e (compacted)\" if \u003c1min\n- Extract working directory from .jsonl or parent folder\n- Format timestamp: YYYY-MM-DD HH:MM\n- Include name in session metadata\n\nLogic:\n- If session created \u003c1min after parent: \"(compacted)\"\n- Otherwise: \"(fork)\"\n- Determine Terminal vs Voice by checking if iOS client initiated","acceptance_criteria":"Generates meaningful default names, detects and labels forks appropriately, includes working directory and timestamp, names appear in session_list and session_created","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-26T01:01:31.68506-05:00","updated_at":"2025-10-26T01:01:31.68506-05:00","closed_at":"2025-10-22T18:28:23.713873-05:00","dependencies":[{"issue_id":"voice-code-85","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.975088-05:00","created_by":"auto-import"}]}
{"id":"voice-code-86","title":"Write tests for replication system","description":"Comprehensive test coverage for new replication architecture.\n\nTests:\n- Index building from 100+ .jsonl files\n- Incremental file parsing (new lines only)\n- Debouncing and parse-retry logic\n- Selective file watching (subscribe/unsubscribe)\n- Protocol messages: session_list, session_subscribe, session_history, session_updated, session_created\n- New vs resume prompt handling (--session-id vs --resume)\n- Session naming generation\n- Deletion handling","acceptance_criteria":"All tests passing, coverage for core replication logic, integration tests for file watching, protocol message tests","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-26T01:01:31.686885-05:00","updated_at":"2025-10-26T01:01:31.686885-05:00","closed_at":"2025-10-22T18:28:23.71401-05:00","dependencies":[{"issue_id":"voice-code-86","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.976021-05:00","created_by":"auto-import"}]}
{"id":"voice-code-87","title":"Design CoreData schema","description":"Design CoreData schema for session and message storage.\n\nEntities:\n- Session: id (UUID), backendName (String), localName (String?), workingDir (String), lastModified (Date), messageCount (Int), preview (String), isDeleted (Bool)\n- Message: id (UUID), sessionId (UUID), role (String), text (String), timestamp (Date), status (MessageStatus enum), serverTimestamp (Date?)\n\nRelationships:\n- Session.messages → [Message]\n- Message.session → Session\n\nEnums:\n- MessageStatus: .sending, .confirmed, .error","acceptance_criteria":"CoreData model file created, entities defined with all fields, relationships configured, compiles without errors","status":"closed","priority":0,"issue_type":"task","assignee":"ios","created_at":"2025-10-26T01:01:31.688468-05:00","updated_at":"2025-10-26T01:01:31.688468-05:00","closed_at":"2025-10-22T18:28:23.714141-05:00","dependencies":[{"issue_id":"voice-code-87","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.976852-05:00","created_by":"auto-import"}]}
{"id":"voice-code-88","title":"Implement session metadata sync","description":"Handle session_list message and store metadata in CoreData.\n\n- Receive session_list on WebSocket connection\n- Parse sessions array\n- Store in CoreData (Session entities)\n- Display in sessions list view\n- Support pagination (20 sessions per page initially)\n- Load more on scroll","acceptance_criteria":"Receives session_list, stores all sessions in CoreData, displays in UI with pagination, \"load more\" works correctly","notes":"Updated to clarify handling of session_created broadcasts. This task covers both initial session_list and ongoing session_created messages for terminal sessions.","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-26T01:01:31.689517-05:00","updated_at":"2025-10-26T01:01:31.689517-05:00","closed_at":"2025-10-22T18:28:23.71428-05:00","dependencies":[{"issue_id":"voice-code-88","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.97774-05:00","created_by":"auto-import"}]}
{"id":"voice-code-89","title":"Implement lazy session loading","description":"Load full conversation when user opens a session.\n\n- When user taps session: send subscribe message\n- Receive session_history response\n- Parse messages array\n- Store messages in CoreData (linked to session)\n- Display in conversation view\n- Show loading indicator during fetch","acceptance_criteria":"Sends subscribe on session open, receives and stores session_history, displays messages in conversation view, loading indicator shown","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-26T01:01:31.690381-05:00","updated_at":"2025-10-26T01:01:31.690381-05:00","closed_at":"2025-10-22T18:28:23.714419-05:00","dependencies":[{"issue_id":"voice-code-89","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.978837-05:00","created_by":"auto-import"}]}
{"id":"voice-code-90","title":"Implement incremental message updates","description":"Handle session_updated messages and update CoreData.\n\n- Receive session_updated messages from WebSocket\n- Parse new messages array\n- Append to CoreData for that session\n- Update UI in real-time (if session is open)\n- Update session preview and message count in list view","acceptance_criteria":"Receives session_updated, appends new messages to CoreData, UI updates in real-time, session list shows updated preview/count","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-26T01:01:31.691056-05:00","updated_at":"2025-10-26T01:01:31.691056-05:00","closed_at":"2025-10-22T18:28:23.714559-05:00","dependencies":[{"issue_id":"voice-code-90","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.979904-05:00","created_by":"auto-import"}]}
{"id":"voice-code-91","title":"Implement optimistic UI for prompts","description":"Display user prompts immediately with optimistic UI pattern.\n\n- When user sends prompt: create Message with status .sending\n- Add to CoreData immediately\n- Display in conversation view (show sending indicator)\n- When session_updated arrives: reconcile by matching text\n- Update status to .confirmed, add serverTimestamp\n- Handle case where message not found (backend-originated prompt)","acceptance_criteria":"User prompts appear instantly, reconciliation works correctly, status updates from .sending to .confirmed, backend prompts handled gracefully","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-26T01:01:31.692693-05:00","updated_at":"2025-10-26T01:01:31.692693-05:00","closed_at":"2025-10-22T18:28:23.714731-05:00","dependencies":[{"issue_id":"voice-code-91","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.980682-05:00","created_by":"auto-import"}]}
{"id":"voice-code-92","title":"Update prompt sending logic","description":"Use new_session_id vs resume_session_id fields for prompts.\n\n- Generate UUID for new sessions (before sending prompt)\n- Send subscribe(uuid) before prompt for new sessions\n- Use new_session_id field for new sessions\n- Use resume_session_id field for existing sessions\n- Remove iOS session UUID from protocol\n- Working directory from session or user selection\n\nMessage format:\n- New: {type: prompt, new_session_id: uuid, text: \"...\", working_directory: \"...\"}\n- Resume: {type: prompt, resume_session_id: uuid, text: \"...\", working_directory: \"...\"}","acceptance_criteria":"Generates UUIDs for new sessions, sends subscribe before prompt, uses correct field (new_session_id vs resume_session_id), iOS session UUID removed","notes":"This task includes auto-subscribe logic for new sessions. When creating a new session, iOS generates UUID and sends subscribe BEFORE sending the prompt, ensuring it receives all updates including the initial response.","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-26T01:01:31.693633-05:00","updated_at":"2025-10-26T01:01:31.693633-05:00","closed_at":"2025-10-22T18:28:23.714893-05:00","dependencies":[{"issue_id":"voice-code-92","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.981572-05:00","created_by":"auto-import"}]}
{"id":"voice-code-93","title":"Implement smart speaking logic","description":"Only speak messages for active/open session.\n\n- Track currently active session ID\n- When session_updated arrives: check if message is for active session\n- If active session + assistant message: speak it\n- If background session: buffer message, update badge count\n- Show unread count in session list\n- Mark as read when user opens session","acceptance_criteria":"Only speaks messages for active session, background sessions show badge count, unread count visible in list, mark as read works","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-26T01:01:31.694417-05:00","updated_at":"2025-10-26T01:01:31.694417-05:00","closed_at":"2025-10-22T18:28:23.715036-05:00","dependencies":[{"issue_id":"voice-code-93","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.98296-05:00","created_by":"auto-import"}]}
{"id":"voice-code-94","title":"Add long-press \"Read Aloud\" menu","description":"Add context menu to read historical messages aloud.\n\n- Long-press on any message: show context menu\n- Menu option: \"Read Aloud\"\n- Trigger TTS for that message text\n- Interrupt current playback if needed\n- Works for both user and assistant messages","acceptance_criteria":"Long-press shows context menu, \"Read Aloud\" option present, TTS plays selected message, interrupts current playback","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-26T01:01:31.695134-05:00","updated_at":"2025-10-26T01:01:31.695134-05:00","closed_at":"2025-10-22T18:28:23.715179-05:00","dependencies":[{"issue_id":"voice-code-94","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.983932-05:00","created_by":"auto-import"}]}
{"id":"voice-code-95","title":"Implement session deletion","description":"Allow users to delete sessions locally.\n\n- Swipe to delete gesture in session list\n- Send session_deleted message to backend\n- Mark session as deleted in CoreData (isDeleted = true)\n- Hide from UI (filter out deleted sessions)\n- Send unsubscribe message\n- No backend file deletion (local only)","acceptance_criteria":"Swipe to delete works, sends session_deleted to backend, marks as deleted in CoreData, hidden from UI, unsubscribe sent","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-26T01:01:31.695664-05:00","updated_at":"2025-10-26T01:01:31.695664-05:00","closed_at":"2025-10-22T18:28:23.715314-05:00","dependencies":[{"issue_id":"voice-code-95","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.985156-05:00","created_by":"auto-import"}]}
{"id":"voice-code-96","title":"Add session renaming","description":"Allow users to rename sessions locally.\n\n- Edit button or gesture in session detail view\n- Text field to enter custom name\n- Store in localName field (CoreData)\n- Display: localName ?? backendName\n- No backend sync (local only)\n- Update UI immediately on change","acceptance_criteria":"Can edit session name, stores in localName field, displays custom name if set, falls back to backendName, no backend sync","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-26T01:01:31.696184-05:00","updated_at":"2025-10-26T01:01:31.696184-05:00","closed_at":"2025-10-22T18:28:23.71545-05:00","dependencies":[{"issue_id":"voice-code-96","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.986107-05:00","created_by":"auto-import"}]}
{"id":"voice-code-97","title":"Test terminal to iOS sync","description":"End-to-end test: terminal session appears on iOS.\n\nSteps:\n1. Start backend and iOS app\n2. Create new Claude session from terminal\n3. Verify iOS receives session_created message\n4. Verify session appears in iOS session list\n5. Verify auto-subscription works\n6. Send prompt from terminal\n7. Verify iOS receives session_updated\n8. Verify messages display correctly","acceptance_criteria":"Terminal sessions appear on iOS, auto-subscription works, messages sync correctly, end-to-end flow complete","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.696622-05:00","updated_at":"2025-10-26T01:01:31.696622-05:00","closed_at":"2025-10-18T14:23:21.42793-05:00"}
{"id":"voice-code-98","title":"Test iOS to iOS sync","description":"End-to-end test: iOS session syncs to other iOS clients.\n\nSteps:\n1. Start backend and iOS app\n2. Create new session from iOS (send prompt with new_session_id)\n3. Backend creates .jsonl file\n4. Verify filesystem watcher detects new file\n5. Verify messages sync via session_updated\n6. Connect second iOS client\n7. Verify session appears in session_list\n8. Verify can subscribe and see full history","acceptance_criteria":"iOS sessions create backend files, sync via file watching works, other iOS clients receive sessions, full history available","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.697355-05:00","updated_at":"2025-10-26T01:01:31.697355-05:00","closed_at":"2025-10-18T14:23:21.428742-05:00"}
{"id":"voice-code-99","title":"Test session forking","description":"Test concurrent resume creates fork that appears on iOS.\n\nSteps:\n1. Create session from terminal\n2. iOS subscribes to session\n3. From terminal: resume same session (concurrent)\n4. Claude creates fork (session-id-fork-1.jsonl)\n5. Verify filesystem watcher detects new fork file\n6. Verify iOS receives session_created for fork\n7. Verify iOS auto-subscribes to fork\n8. Verify fork name includes \"(fork)\" or \"(compacted)\"","acceptance_criteria":"Concurrent resume creates fork, fork detected by watcher, iOS receives session_created, auto-subscription works, fork naming correct","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-26T01:01:31.698218-05:00","updated_at":"2025-10-26T01:01:31.698218-05:00","closed_at":"2025-10-22T18:28:23.715596-05:00","dependencies":[{"issue_id":"voice-code-99","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-26T01:01:31.986991-05:00","created_by":"auto-import"}]}
