{"id":"voice-code-100","title":"Test deletion workflow","description":"Test session deletion on iOS stops replication.\n\nSteps:\n1. iOS has session subscribed\n2. User swipes to delete session\n3. iOS sends session_deleted message\n4. Verify backend stops sending updates to that iOS client\n5. Verify backend .jsonl file still exists\n6. Verify other iOS clients still receive updates\n7. Create new prompt from terminal in deleted session\n8. Verify first iOS client does NOT receive update\n9. Verify other clients DO receive update","acceptance_criteria":"Deletion stops replication for that client only, backend file remains, other clients unaffected, updates filtered correctly","status":"open","priority":0,"issue_type":"task","created_at":"2025-10-16T22:55:57.878165-05:00","updated_at":"2025-10-16T22:55:57.878165-05:00","dependencies":[{"issue_id":"voice-code-100","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.936018-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-101","title":"Performance testing","description":"Test performance with 1000+ sessions.\n\nTests:\n1. Index build time with 1000+ .jsonl files\n2. Measure session_list send time (should be \u003c2s)\n3. Measure per-session load time (should be \u003c200ms)\n4. Verify file watching overhead with 10 subscriptions (\u003c5% CPU)\n5. Memory usage with 1000 sessions in index (~10MB)\n6. Test pagination in iOS (20 sessions/page loads quickly)\n7. Test incremental updates (new message appears \u003c1s after terminal prompt)","acceptance_criteria":"All performance targets met, system scales to 1000+ sessions, no degradation with active watching, memory usage acceptable","status":"open","priority":0,"issue_type":"task","created_at":"2025-10-16T22:56:05.676732-05:00","updated_at":"2025-10-16T22:56:05.676732-05:00","dependencies":[{"issue_id":"voice-code-101","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.955166-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-102","title":"Create manual test infrastructure","description":"","design":"Create Clojure-based manual test infrastructure in manual_test/ directory:\n- manual_test/voice_code/fixtures.clj - Shared fixtures (start/stop server, etc.)\n- manual_test/voice_code/websocket_client.clj - WebSocket client helper using http-kit\n- manual_test/voice_code/test_*.clj - Individual test files\n- Makefile with targets: test-manual-startup, test-manual-protocol, etc.\n- deps.edn :manual-test alias with manual_test as extra path\n\nTests in manual_test/ can invoke Claude CLI (cost money) while regular tests in test/ are free.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-17T09:58:03.444986-05:00","updated_at":"2025-10-17T16:52:28.05795-05:00","closed_at":"2025-10-17T16:52:28.05795-05:00"}
{"id":"voice-code-103","title":"Manual test: Backend startup and session discovery","description":"","acceptance_criteria":"Server starts successfully, session index loads from disk with correct count, filesystem watcher initializes watching all project subdirectories. File: manual_test/voice_code/test_03_startup.clj. Free to run (no Claude invocations).","notes":"✅ PASSED - All assertions passed. Tests session discovery, metadata extraction, and index persistence.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-17T09:58:13.184067-05:00","updated_at":"2025-10-17T16:36:22.472262-05:00","closed_at":"2025-10-17T16:36:22.472262-05:00","dependencies":[{"issue_id":"voice-code-103","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-17T09:58:13.185082-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-104","title":"Manual test: WebSocket protocol (connect, subscribe, ping)","description":"","acceptance_criteria":"Connect without session_id returns session-list message. Subscribe returns session-history. Ping returns pong. File: manual_test/voice_code/test_04_protocol.clj. Free to run.","notes":"✅ PASSED (after fixes) - Tests ping/pong, connect→session-list, subscribe→session-history. Fixed to expect session-list instead of old 'connected' message.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-17T09:58:25.522536-05:00","updated_at":"2025-10-17T16:36:22.472499-05:00","closed_at":"2025-10-17T16:36:22.472499-05:00","dependencies":[{"issue_id":"voice-code-104","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-17T09:58:25.523729-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-105","title":"Manual test: Filesystem watcher (new sessions and updates)","description":"","acceptance_criteria":"Watcher detects new .jsonl file creation, broadcasts session-created message within 2 seconds, metadata includes all fields. File: manual_test/voice_code/test_05_watcher_new.clj. COSTS MONEY (invokes Claude CLI).","notes":"⚠️ RUNS BUT FAILS (~$0.15 spent) - Claude CLI successfully creates sessions, but filesystem watcher doesn't detect new .jsonl files. No session_created/session_updated broadcasts received. Root cause: Watcher not adding new sessions to index in real-time.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-17T09:58:40.906113-05:00","updated_at":"2025-10-17T16:38:32.889948-05:00","closed_at":"2025-10-17T16:38:32.889948-05:00","dependencies":[{"issue_id":"voice-code-105","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-17T09:58:40.907234-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-106","title":"Manual test: Prompt sending with new_session_id","description":"","acceptance_criteria":"Prompt with new_session_id creates new Claude session, returns ack then response, .jsonl file created with correct session_id, session-created broadcast sent. File: manual_test/voice_code/test_06_prompt_new.clj. COSTS MONEY.","notes":"✅ PASSED (~$0.05 spent) - Creates new Claude session via WebSocket with new_session_id. Verifies .jsonl file creation and proper session ID handling.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-17T09:58:49.366025-05:00","updated_at":"2025-10-17T16:38:32.890207-05:00","closed_at":"2025-10-17T16:38:32.890207-05:00","dependencies":[{"issue_id":"voice-code-106","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-17T09:58:49.367146-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-106","depends_on_id":"voice-code-111","type":"blocks","created_at":"2025-10-17T11:15:01.228306-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-107","title":"Manual test: Prompt sending with resume_session_id","description":"","acceptance_criteria":"Prompt with resume_session_id appends to existing session, maintains conversation context, .jsonl file appended not recreated, session-updated broadcast if subscribed. File: manual_test/voice_code/test_07_prompt_resume.clj. COSTS MONEY.","notes":"✅ PASSED (~$0.10 spent, after fixes) - Tests resume_session_id maintains context. Claude correctly remembered number 42. Fixed kebab-case field names and project folder detection. Verifies .jsonl file appended not recreated.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-17T09:58:56.342318-05:00","updated_at":"2025-10-17T16:38:32.890329-05:00","closed_at":"2025-10-17T16:38:32.890329-05:00","dependencies":[{"issue_id":"voice-code-107","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-17T09:58:56.342987-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-107","depends_on_id":"voice-code-111","type":"blocks","created_at":"2025-10-17T11:15:01.243041-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-108","title":"Manual test: Multi-client broadcast","description":"","acceptance_criteria":"Multiple WebSocket clients receive same session-created broadcast, messages identical across clients, broadcast timing within 200ms. File: manual_test/voice_code/test_08_broadcast.clj. Free to run.","notes":"❌ FAILED - Fixture issue (session ID nil) + expects non-existent protocol messages. Needs same fixture fix as test 05 + protocol expectations rewrite.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-17T09:59:04.004053-05:00","updated_at":"2025-10-17T16:36:22.472804-05:00","closed_at":"2025-10-17T16:36:22.472804-05:00","dependencies":[{"issue_id":"voice-code-108","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-17T09:59:04.005027-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-108","depends_on_id":"voice-code-111","type":"blocks","created_at":"2025-10-17T11:15:01.257464-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-109","title":"Manual test: Error handling","description":"","acceptance_criteria":"Invalid JSON handled gracefully, unknown message types return error, missing required fields return descriptive errors, connection stays open after errors. File: manual_test/voice_code/test_09_errors.clj. Free to run.","notes":"⚠️ PARTIAL (4/6 passing) - Tests 07a-07d pass (prompt before connect, invalid type, missing fields). Tests 07e-07f fail (non-existent resume_session_id, conflicting session IDs). Edge case error handling needs adjustment.","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-17T09:59:11.171127-05:00","updated_at":"2025-10-17T16:36:22.47291-05:00","closed_at":"2025-10-17T16:36:22.47291-05:00","dependencies":[{"issue_id":"voice-code-109","depends_on_id":"voice-code-102","type":"blocks","created_at":"2025-10-17T09:59:11.171909-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-110","title":"Fix WebSocket protocol mismatch in session list response","description":"Test 02 expects 'session-list' message type after connect, but server sends different format. Need to either update server to send session-list message type per STANDARDS.md, or update STANDARDS.md and tests to match actual implementation. Test failure location: backend/manual_test/tests/02_protocol_test.clj:54-56","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-17T11:07:09.492876-05:00","updated_at":"2025-10-17T15:15:11.816026-05:00","closed_at":"2025-10-17T15:15:11.816026-05:00"}
{"id":"voice-code-111","title":"Fix Test 07 error: test expects 'connected' message but not receiving it","description":"Test 07 (error handling) sub-test 'test-error-both-new-and-resume-session-id' fails with 'Expected message not received: Connected'. The test expects a 'connected' confirmation after connect message, but isn't receiving it. Need to investigate if this is a test issue or server protocol issue. Location: backend/manual_test/tests/07_error_test.clj:193","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-17T11:07:20.215845-05:00","updated_at":"2025-10-17T17:32:16.754825-05:00","closed_at":"2025-10-17T17:32:16.754825-05:00"}
{"id":"voice-code-112","title":"Test 02 subscribe test needs sessions to validate","description":"The subscribe test in Test 02 was skipped because no sessions were available to subscribe to. Need to either: 1) Pre-populate test sessions before running the test, or 2) Make the test create its own session to subscribe to, or 3) Document that this test requires existing sessions. Location: backend/manual_test/tests/02_protocol_test.clj (subscribe test)","notes":"Root cause identified: WebSocket client cannot receive large payloads even with 20 messages. Server successfully sends session-history (logs confirm) but client times out waiting. Solutions: 1) Further reduce to 5-10 messages, 2) Implement pagination, 3) Investigate WebSocket frame size limits. Status: 4/5 protocol tests pass, only subscribe test fails.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-17T11:07:29.164746-05:00","updated_at":"2025-10-17T17:33:33.350163-05:00","closed_at":"2025-10-17T17:33:33.350163-05:00"}
{"id":"voice-code-113","title":"Backend optimizations for WebSocket payload size limits","description":"Changes made during manual testing: 1) Limited session-list to 50 most recent sessions (was 663), 2) Limited session-history to 20 most recent messages (was full history), 3) Added validation to reject prompts with both new_session_id and resume_session_id, 4) Changed connect response to send session-list. These prevent WebSocket frame size issues.","acceptance_criteria":"Session list limited to reasonable size, session history limited, validation prevents conflicting parameters","status":"closed","priority":2,"issue_type":"task","assignee":"backend","created_at":"2025-10-17T11:58:42.660512-05:00","updated_at":"2025-10-17T17:33:11.260537-05:00","closed_at":"2025-10-17T17:33:11.260537-05:00"}
{"id":"voice-code-114","title":"Filesystem watcher doesn't detect new Claude sessions","description":"Test 03 revealed that when Claude CLI creates new .jsonl files, the filesystem watcher doesn't detect them or broadcast session_created/session_updated messages.\n\nRoot cause: Watcher not adding new sessions to index in real-time.\n\nSteps to reproduce:\n1. Start backend server\n2. Connect WebSocket client\n3. Create new Claude session via CLI with --session-id \u003cuuid\u003e\n4. Expected: Receive session_created broadcast\n5. Actual: No broadcast received, 'Session not found' when trying to subscribe\n\nFiles involved:\n- backend/src/voice_code/replication.clj (watcher implementation)\n- backend/manual_test/tests/03_watcher_test.clj (test that fails)\n\nImpact: Terminal→iOS sync completely broken. Sessions created from terminal won't appear on iOS.","status":"closed","priority":0,"issue_type":"bug","assignee":"backend","created_at":"2025-10-17T13:17:20.881067-05:00","updated_at":"2025-10-17T15:06:23.026154-05:00","closed_at":"2025-10-17T15:06:23.026154-05:00"}
{"id":"voice-code-115","title":"Test 06 (broadcast) needs fixture and protocol fixes","description":"Test 06 fails due to:\n1. Fixture not running (session ID is nil) - same issue as test 05 had\n2. Test expects protocol messages that don't exist\n\nNeeds:\n- Apply same fixture fix as test 05 (call setup in -main)\n- Update protocol expectations to match actual server behavior\n\nFile: backend/manual_test/tests/06_broadcast_test.clj","status":"closed","priority":2,"issue_type":"bug","assignee":"backend","created_at":"2025-10-17T13:17:20.968818-05:00","updated_at":"2025-10-17T17:15:16.8605-05:00","closed_at":"2025-10-17T17:15:16.8605-05:00"}
{"id":"voice-code-116","title":"Test 07 edge cases fail (07e, 07f)","description":"Test 07 has 4/6 tests passing. Edge case tests fail:\n\n07e (non-existent resume_session_id): \n- Server may handle this differently than expected\n- Need to verify error response format\n\n07f (both new_session_id and resume_session_id):\n- Server correctly validates mutually exclusive params\n- Error message not reaching client properly\n\nFile: backend/manual_test/tests/07_error_test.clj\n\nMay need to adjust server error responses or test expectations.","status":"closed","priority":2,"issue_type":"bug","assignee":"backend","created_at":"2025-10-17T13:17:21.064121-05:00","updated_at":"2025-10-17T17:08:07.593609-05:00","closed_at":"2025-10-17T17:08:07.593609-05:00"}
{"id":"voice-code-117","title":"Session Replication Architecture","description":"Complete implementation of session replication architecture from REPLICATION_ARCHITECTURE.md.\n\nThis epic tracks the migration from iOS session UUID mapping to a unified session replication system where all Claude Code sessions (terminal and iOS) sync to iOS devices via filesystem watching and WebSocket broadcasts.\n\n## Architecture Overview\n- Backend watches ~/.claude/projects for .jsonl files\n- Maintains fast in-memory metadata index\n- Broadcasts session_created/session_updated to all iOS clients\n- iOS stores sessions in CoreData with lazy loading\n- Optimistic UI for instant feedback\n- Client-side filtering for deletion/renaming\n\n## Phases\n**Phase 1: Backend (COMPLETE)** - voice-code-74 through voice-code-86\n- Metadata index system ✓\n- Filesystem watcher ✓\n- Protocol handlers ✓\n- Session naming ✓\n- Manual tests ✓\n\n**Phase 2: iOS (IN PROGRESS)** - voice-code-87 through voice-code-96\n- CoreData schema\n- Session metadata sync\n- Lazy loading\n- Incremental updates\n- Optimistic UI\n- Prompt sending\n- Deletion/renaming\n\n**Phase 3: Testing** - voice-code-141 through voice-code-101\n- Terminal to iOS sync\n- iOS to iOS sync\n- Session forking\n- Deletion workflow\n- Performance testing\n\n## References\n- REPLICATION_ARCHITECTURE.md\n- STANDARDS.md (WebSocket protocol)","acceptance_criteria":"All replication tasks complete (74-101), backend fully tested, iOS implementation complete, end-to-end workflows validated, performance targets met","status":"open","priority":0,"issue_type":"epic","created_at":"2025-10-17T17:45:30.931052-05:00","updated_at":"2025-10-18T14:46:51.29465-05:00"}
{"id":"voice-code-118","title":"Consolidate backend Makefile into root Makefile","description":"The project has two Makefiles: root (iOS tests) and backend/ (Clojure tests). Consolidate into single root Makefile with sections for iOS and backend. Use 'cd backend \u0026\u0026' for backend targets. Maintain all existing targets from both files.","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-17T19:24:34.007544-05:00","updated_at":"2025-10-17T19:24:34.007544-05:00"}
{"id":"voice-code-119","title":"Connection status not refreshed after saving server settings","description":"When configuring server settings for the first time, Test Connection works successfully, but after clicking Save, the app still shows 'disconnected'. The real connection should be refreshed/attempted after saving settings.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-17T22:33:31.958921-05:00","updated_at":"2025-10-18T17:23:33.678411-05:00","closed_at":"2025-10-18T17:23:33.678411-05:00"}
{"id":"voice-code-120","title":"Backend sends session_updated with 0 messages after filtering warmup","description":"The handle-file-modified function in replication.clj checks if new-messages is non-empty BEFORE filtering sidechain messages. This causes session_updated messages with empty message arrays to be sent to iOS clients when only warmup messages were added.\n\nBug location: backend/src/voice_code/replication.clj handle-file-modified function\n\nFix: Move the (when (seq new-messages)) check to AFTER (filter-sidechain-messages new-messages)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-18T01:56:33.371738-05:00","updated_at":"2025-10-18T02:46:48.636877-05:00","closed_at":"2025-10-18T02:46:48.636877-05:00"}
{"id":"voice-code-121","title":"Backend re-sends all messages instead of just new ones on session creation","description":"When handle-file-created detects a new session, it doesn't initialize the file-positions atom for that session. This causes subsequent handle-file-modified calls to re-parse the entire file from the beginning, re-sending all messages instead of just new ones.\n\nEvidence: Triple reconciliation in logs (lines 86-88 of console.out) shows all messages being reconciled again after new session creation.\n\nBug location: backend/src/voice_code/replication.clj handle-file-created function\n\nFix: Initialize file-positions when creating session metadata in handle-file-created","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-18T01:56:33.587-05:00","updated_at":"2025-10-18T02:46:48.637472-05:00","closed_at":"2025-10-18T02:46:48.637472-05:00"}
{"id":"voice-code-122","title":"Backend includes non-UUID .jsonl files in session list","description":"The extract-session-id-from-path function in replication.clj accepts any .jsonl filename as a valid session ID without validating that it's a UUID. This causes 'Invalid or missing session_id in session data' warnings in iOS when non-UUID .jsonl files exist in Claude projects.\n\nEvidence: Line 8 of console.out shows iOS warning about invalid session_id\n\nBug location: backend/src/voice_code/replication.clj extract-session-id-from-path function\n\nFix: Add UUID validation to extract-session-id-from-path and filter out invalid sessions","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-18T01:56:33.802846-05:00","updated_at":"2025-10-18T02:46:48.637907-05:00","closed_at":"2025-10-18T02:46:48.637907-05:00"}
{"id":"voice-code-123","title":"iOS subscribes twice when creating new session","description":"When creating a new session from SessionsView, the app subscribes to the session in two places:\n1. SessionsView.swift:125 - when sending the prompt that creates the session\n2. ConversationView.swift:151 - when the view appears after navigation\n\nThis causes duplicate 'Client subscribing to session' log entries and duplicate optimistic message creation (though messages don't duplicate in UI).\n\nEvidence: Lines 24-27 and 48-49 in console.out show double subscription and double optimistic message creation\n\nBug locations:\n- ios/VoiceCode/Views/SessionsView.swift:125\n- ios/VoiceCode/Views/ConversationView.swift:151\n\nFix: Remove one of the subscribe calls (likely the one in SessionsView since ConversationView should handle subscription)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-18T01:56:35.281828-05:00","updated_at":"2025-10-18T02:46:48.638185-05:00","closed_at":"2025-10-18T02:46:48.638185-05:00"}
{"id":"voice-code-124","title":"Existing sessions not loading - only new UI sessions populate","description":"When the app starts, existing Claude Code sessions from the filesystem are not appearing in the session list. Only newly created sessions from the iOS UI are showing up.\n\nExpected behavior: On app launch, the backend should send session_list with all existing .jsonl files from ~/.claude/projects, and iOS should display them in the SessionsView.\n\nActual behavior: Session list appears empty or only shows sessions created after the app was opened.\n\nThis blocks the ability to resume existing conversations and makes the app appear to lose history.\n\nRelated: This makes voice-code-123 (double subscription) harder to notice, since long-press to open sessions doesn't work if sessions aren't loaded.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-18T02:13:02.893514-05:00","updated_at":"2025-10-18T02:46:48.639015-05:00","closed_at":"2025-10-18T02:46:48.639015-05:00"}
{"id":"voice-code-125","title":"Session list interaction is not intuitive - tap vs long-press unclear","description":"The SessionsView interaction model is confusing and doesn't follow iOS conventions:\n\nCurrent behavior:\n- Tapping a session highlights it and shows a checkmark\n- Nothing material happens after the tap\n- Requires long-press to open the session (but this is broken per voice-code-124)\n- The checkbox appears to serve no clear function\n\nExpected behavior (choose one approach):\n\nOption A - Single tap opens session:\n- Tap a session → immediately navigate to ConversationView\n- Remove checkbox UI entirely\n- This matches standard iOS list behavior (Settings, Mail, Messages, etc.)\n\nOption B - Checkbox has real function:\n- Keep checkbox for multi-select (e.g., bulk delete, bulk operations)\n- Add a visible action button or toolbar when sessions are selected\n- Require explicit 'Open' button or different gesture to open a single session\n\nRecommendation: Option A is more intuitive. iOS users expect a single tap on a list item to open it. Checkboxes should only appear during explicit 'Edit' or 'Select' modes.\n\nFiles involved:\n- ios/VoiceCode/Views/SessionsView.swift\n- Session list UI implementation","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-10-18T02:13:05.243116-05:00","updated_at":"2025-10-18T02:46:48.639412-05:00","closed_at":"2025-10-18T02:46:48.639412-05:00"}
{"id":"voice-code-126","title":"Stale session index causes existing sessions not to load messages","description":"The initialize-index! function loads a cached session index from disk without validating it against the filesystem. When the cached index is stale (e.g., from a test run), iOS receives an outdated session list and cannot load messages from existing sessions.\n\nBug: Backend loaded index with 1 test session from /var/folders/temp, but filesystem had 712 real sessions.\nImpact: iOS showed sessions in list but couldn't load their messages (Session not found warnings in backend logs).\nFix: Added validate-index function that checks index count against filesystem and validates sample files exist. Index is rebuilt if validation fails.\nTest coverage: Added test-validate-index with 5 test cases covering all validation scenarios.\nTests passing: 70 tests, 371 assertions, 0 failures.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-18T08:50:31.691785-05:00","updated_at":"2025-10-18T08:50:36.180332-05:00","closed_at":"2025-10-18T08:50:36.180332-05:00"}
{"id":"voice-code-127","title":"Case-sensitive session lookup prevents iOS sessions from loading","description":"iOS sends uppercase UUIDs (e.g., 6F362136-EF8D-48FB-87C4-82AC582A2618) but backend files use lowercase (e.g., 6f362136-ef8d-48fb-87c4-82ac582a2618.jsonl). Session lookups in get-session-metadata, subscribe-to-session!, unsubscribe-from-session!, and is-subscribed? were case-sensitive, causing Session not found errors.\n\nRoot cause: iOS generates UUIDs via UUID().uuidString which uses uppercase hex digits. Claude CLI uses lowercase. The session-index map keys are lowercase (from filenames) but lookups did not normalize the input session-id.\n\nFix: Modified 4 functions in replication.clj to normalize session-id to lowercase using str/lower-case before lookups or set operations.\n\nTest coverage: Added test-case-insensitive-session-operations with 4 test scenarios covering all case combinations.\n\nBug locations: backend/src/voice_code/replication.clj and backend/test/voice_code/replication_test.clj\n\nTests passing: 71 tests, 388 assertions, 0 failures.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-18T09:06:54.459358-05:00","updated_at":"2025-10-18T09:06:59.507565-05:00","closed_at":"2025-10-18T09:06:59.507565-05:00"}
{"id":"voice-code-128","title":"Backend: Index keys are uppercase but lookups use lowercase","description":"Case-sensitivity mismatch in session index. Index is built with uppercase UUID keys from filenames, but get-session-metadata normalizes to lowercase for lookups. This causes sessions with uppercase UUIDs (from iOS) to appear missing even though they exist on disk.\n\nRoot cause: build-index! in replication.clj:175-195 uses session-id as-is from filename (uppercase), but get-session-metadata:279-282 normalizes to lowercase.\n\nFix: Normalize session-id to lowercase in build-index! before using as map key: (assoc acc (str/lower-case session-id) metadata)\n\nImpact: ~11+ sessions with uppercase UUIDs cannot be found via lookup despite being in the index.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-10-18T10:44:06.534053-05:00","updated_at":"2025-10-18T10:44:06.534053-05:00"}
{"id":"voice-code-129","title":"Delete SessionManagerTests.swift (tests deleted SessionManager)","description":"SessionManagerTests.swift (208 lines, 14 tests) tests the SessionManager class that was deleted in commit 0ae654a during the architecture consolidation.\n\nSince SessionManager no longer exists (replaced by CoreData CDSession), these tests are obsolete and should be deleted.\n\nFile: ios/VoiceCodeTests/SessionManagerTests.swift\n\nContext: We consolidated the app to use CoreData exclusively, removing the old in-memory SessionManager and Session models.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-18T12:16:32.535702-05:00","updated_at":"2025-10-18T12:21:49.847435-05:00","closed_at":"2025-10-18T12:21:49.847435-05:00"}
{"id":"voice-code-130","title":"Clean up ModelTests.swift (remove Session tests, keep Message tests)","description":"ModelTests.swift (153 lines, 9 tests) tests both Message and Session models.\n\nKeep: Message tests - Message struct is still used as a DTO for WebSocket communication\nRemove: Session tests - Session struct was deleted in commit 0ae654a (replaced by CDSession)\n\nSession-related tests to remove:\n- testSessionCreation\n- testSessionAddMessage  \n- testSessionUpdateClaudeSessionId\n- testSessionCodable\n\nMessage tests are still valid since Message is used by VoiceCodeClient.\n\nFile: ios/VoiceCodeTests/ModelTests.swift","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-18T12:16:32.658287-05:00","updated_at":"2025-10-18T12:21:49.848087-05:00","closed_at":"2025-10-18T12:21:49.848087-05:00"}
{"id":"voice-code-131","title":"Better label non-user messages (tool results, etc.)","description":"Currently tool call results and other system messages show as 'User' role. We should distinguish these from actual user prompts so that 'User' label is reserved only for real prompts from a person. This will make the conversation view clearer about what is actually user input vs tool output or other content types.","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-18T13:30:57.169958-05:00","updated_at":"2025-10-18T13:30:57.169958-05:00"}
{"id":"voice-code-132","title":"Improve long-press menu focus to highlight entire message","description":"When long-pressing on a message to get the Copy / Read Aloud menu, it would look better if the entire message container was in focus rather than just the text box. This is a nice-to-have UX improvement for better visual feedback.","status":"open","priority":3,"issue_type":"task","created_at":"2025-10-18T13:30:57.545725-05:00","updated_at":"2025-10-18T13:30:57.545725-05:00"}
{"id":"voice-code-133","title":"Group sessions by working directory on Sessions page","description":"Organize the main Sessions page to show the cwd (current working directory) as the group title for each session group. Sorting of cwd directories should remain time-based so that the directory with the most recent session appears at the top. This will help users navigate sessions by project/directory context.","notes":"Implementation complete:\n- Sessions now grouped by working directory in SessionsView\n- Groups sorted by most recent modification date\n- Sessions within each group sorted by modification date\n- Each section header shows directory path and session count\n- + button in each section header pre-populates create dialog with that directory\n- Main + button in toolbar pre-populates with most recently used directory\n- 9 comprehensive tests added and passing in SessionGroupingTests.swift\n\nRemaining: Manual testing in iOS app to verify UI behavior","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-10-18T13:30:57.905318-05:00","updated_at":"2025-10-18T14:55:16.67994-05:00"}
{"id":"voice-code-134","title":"Remove Tailscale setup from Help (or remove Help entirely)","description":"Remove the Tailscale setup information from the Help section. We don't want third-party product names like that in our product. Consider whether the entire Help section should be removed or if it should contain different content.","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-18T13:30:58.257246-05:00","updated_at":"2025-10-18T13:30:58.257246-05:00"}
{"id":"voice-code-135","title":"Add config setting for default directory for new sessions","description":"Add a configuration setting in the iOS app that allows the user to optionally specify a default directory for new sessions. Currently defaults to / when one is not provided. Need to determine if this requires frontend-only changes or also backend modifications.","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-18T13:30:58.577266-05:00","updated_at":"2025-10-18T13:30:58.577266-05:00"}
{"id":"voice-code-136","title":"Fix session auto-closing issue (some sessions still affected)","description":"Some sessions (not all) are still auto-closing after being opened, despite the previous fix in commit 7f40d7e that made session an @ObservedObject. Previous context: User reported session opening then immediately closing. Logs showed session opens, receives session_history with 0 messages (backend filtered sidechain messages), then onDisappear fires and session unsubscribes. Need to investigate why this still happens for some sessions after the property wrapper fix.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-10-18T13:30:59.360045-05:00","updated_at":"2025-10-18T13:30:59.360045-05:00"}
{"id":"voice-code-137","title":"Fix 'Sending...' spinner to stop when backend receives message","description":"The 'Sending...' spinner currently keeps spinning until Claude Code responds to the user's message. Under our new async architecture, it should stop as soon as the backend receives the message (when we get backend acknowledgment), not wait for the full Claude response. This will provide better user feedback about message delivery status.","status":"open","priority":2,"issue_type":"bug","created_at":"2025-10-18T13:31:00.290468-05:00","updated_at":"2025-10-18T13:31:00.290468-05:00"}
{"id":"voice-code-138","title":"Add clearable server errors list feature","description":"Create a feature to show a list of server errors that can be cleared by the user. Currently transient errors appear below the 'Tap to Speak' button. Consider options: keep current inline error display, or add a button/icon that navigates to a dedicated errors view where users can see error history and clear individual or all errors. This will provide better error visibility and management for users dealing with connection or server issues.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-10-18T13:31:47.330169-05:00","updated_at":"2025-10-18T13:31:47.330169-05:00"}
{"id":"voice-code-139","title":"Backend: Index keys are uppercase but lookups use lowercase","description":"Case-sensitivity mismatch in session index. Index is built with uppercase UUID keys from filenames, but get-session-metadata normalizes to lowercase for lookups. This causes sessions with uppercase UUIDs (from iOS) to appear missing even though they exist on disk.\n\nRoot cause: build-index! in replication.clj:175-195 uses session-id as-is from filename (uppercase), but get-session-metadata:279-282 normalizes to lowercase.\n\nFix: Normalize session-id to lowercase in build-index! before using as map key: (assoc acc (str/lower-case session-id) metadata)\n\nImpact: ~11+ sessions with uppercase UUIDs cannot be found via lookup despite being in the index.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-18T14:46:51.293635-05:00","updated_at":"2025-10-18T18:26:46.133435-05:00","closed_at":"2025-10-18T18:26:46.133435-05:00"}
{"id":"voice-code-140","title":"Test iOS to iOS sync","description":"End-to-end test: iOS session syncs to other iOS clients.\n\nSteps:\n1. Start backend and iOS app\n2. Create new session from iOS (send prompt with new_session_id)\n3. Backend creates .jsonl file\n4. Verify filesystem watcher detects new file\n5. Verify messages sync via session_updated\n6. Connect second iOS client\n7. Verify session appears in session_list\n8. Verify can subscribe and see full history","acceptance_criteria":"iOS sessions create backend files, sync via file watching works, other iOS clients receive sessions, full history available","status":"open","priority":0,"issue_type":"task","created_at":"2025-10-18T14:46:51.293861-05:00","updated_at":"2025-10-18T14:46:51.293861-05:00","dependencies":[{"issue_id":"voice-code-140","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-18T14:46:51.300791-05:00","created_by":"import-remap"}]}
{"id":"voice-code-141","title":"Test terminal to iOS sync","description":"End-to-end test: terminal session appears on iOS.\n\nSteps:\n1. Start backend and iOS app\n2. Create new Claude session from terminal\n3. Verify iOS receives session_created message\n4. Verify session appears in iOS session list\n5. Verify auto-subscription works\n6. Send prompt from terminal\n7. Verify iOS receives session_updated\n8. Verify messages display correctly","acceptance_criteria":"Terminal sessions appear on iOS, auto-subscription works, messages sync correctly, end-to-end flow complete","status":"open","priority":0,"issue_type":"task","created_at":"2025-10-18T14:46:51.294039-05:00","updated_at":"2025-10-18T14:46:51.294039-05:00","dependencies":[{"issue_id":"voice-code-141","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-18T14:46:51.300027-05:00","created_by":"import-remap"}]}
{"id":"voice-code-142","title":"Unknown message type 'session_deleted' in WebSocket handler","description":"Console shows WARNING: Unknown message type {:type session_deleted}\n\nThe WebSocket message handler is receiving messages with type 'session_deleted' but has no handler for this message type.\n\nNeeds investigation:\n1. Is this a valid message type that should be handled?\n2. Should it be added to the WebSocket protocol spec in STANDARDS.md?\n3. Or is something incorrectly sending this message type?\n\nCurrent protocol (per STANDARDS.md) defines: connect, prompt, set_directory, ping, message_ack (client→backend) and hello, connected, ack, response, error, pong, replay (backend→client).\n\n'session_deleted' is not in the spec.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-10-18T14:46:51.303618-05:00","updated_at":"2025-10-18T14:46:51.303618-05:00"}
{"id":"voice-code-143","title":"Auto-speak for active session not working","description":"Auto-speak functionality is not working for the active session - responses never trigger speech output.\n\nExpected behavior: When a session has auto-speak enabled and receives a response from Claude, the response should be automatically spoken.\n\nActual behavior: Responses are received but never spoken, even when auto-speak is enabled.\n\nNeeds investigation:\n1. Is the auto-speak flag being properly stored/retrieved from session state?\n2. Is the response handler checking the auto-speak flag?\n3. Is the speech synthesis being triggered with the response text?\n4. Are there any errors in the audio/speech pipeline?\n5. Does manual 'speak' work, indicating this is specifically an auto-trigger issue?","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-18T14:48:27.130115-05:00","updated_at":"2025-10-18T15:55:47.852565-05:00","closed_at":"2025-10-18T15:55:47.852565-05:00"}
{"id":"voice-code-144","title":"Session messages showing 'No messages yet' despite having messages","description":"Bug: Sessions displayed '11 messages' on list page but showed 'No messages yet' when opened\n\nRoot Cause:\n- System messages have different structure: {type: 'system', content: '...'}\n- User/Assistant messages: {type: 'user/assistant', message: {content: '...'}}\n- iOS extractText() only checked for nested message.content, failing for system messages\n- This caused 'Invalid message data, missing role or text' errors (12 occurrences in console)\n\nFix Applied:\n- Updated extractText() in SessionSyncManager.swift:424-466 to handle both formats\n- First checks nested message.content (user/assistant)\n- Falls back to top-level content (system messages)\n- Added 2 new tests: testExtractTextFromSystemMessage, testExtractTextFromSystemMessageWithPlainContent\n- All 25 SessionSyncManager tests pass\n\nFiles Modified:\n- ios/VoiceCode/Managers/SessionSyncManager.swift (extractText function)\n- ios/VoiceCodeTests/SessionSyncManagerTests.swift (added 2 tests)\n\nImpact: System messages (like /status commands) now display correctly in conversation view","notes":"COMPLETE FIX: Added support for all 3 message formats (user/assistant/system/summary). All 26 tests pass. Summary messages with 'summary' field now display correctly.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-10-18T15:08:37.738898-05:00","updated_at":"2025-10-18T15:18:51.995902-05:00","closed_at":"2025-10-18T15:18:51.995904-05:00"}
{"id":"voice-code-145","title":"Hide server sessions with zero or only system messages","description":"Feature: Hide sessions that were created on the server (not in the frontend) if they have zero messages or only contain system messages.\n\nContext:\n- Some sessions appear in the list but contain no useful content\n- These sessions clutter the UI and provide no value to users\n- Only affects server-created sessions (not user-initiated sessions from FE)\n\nAcceptance Criteria:\n- Sessions created in frontend are always shown (regardless of content)\n- Server sessions with 0 messages are hidden from session list\n- Server sessions with only system messages are hidden from session list\n- Server sessions with at least one user/assistant/summary message are shown\n- Filtering happens in SessionsView after fetching from CoreData\n\nImplementation Notes:\n- Add field to CDSession to track if session was created in frontend\n- Update SessionsListView to filter out server sessions with no/system-only content\n- May need to check message types in CoreData query or computed property\n- Consider performance impact of filtering large session lists\n\nRelated:\n- voice-code-144 (message parsing fixes)\n- voice-code-133 (session grouping)","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-18T15:44:18.444234-05:00","updated_at":"2025-10-18T17:45:44.996521-05:00","closed_at":"2025-10-18T17:45:44.996521-05:00"}
{"id":"voice-code-146","title":"Filter summary messages from iOS display","description":"Summary messages (like 401 errors) are being synced to iOS and displayed to users. These are Claude Code internal messages that should be filtered out.\n\nRoot cause: SessionSyncManager.handleSessionUpdated processes all message types without filtering.\n\nFix: Add filtering in handleSessionUpdated to skip messages where type == 'summary'\n\nImpact: Users see confusing error messages that aren't relevant to their conversations.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-18T16:33:03.845951-05:00","updated_at":"2025-10-18T16:35:23.86677-05:00","closed_at":"2025-10-18T16:35:23.86677-05:00"}
{"id":"voice-code-147","title":"Filter system messages from iOS display","description":"System messages (like local command notifications) are being synced to iOS and displayed to users. These are Claude Code internal messages that should be filtered out.\n\nRoot cause: SessionSyncManager.handleSessionUpdated processes all message types without filtering.\n\nFix: Add filtering in handleSessionUpdated to skip messages where type == 'system'\n\nImpact: Users see internal system notifications that clutter their conversation view.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-18T16:33:04.291713-05:00","updated_at":"2025-10-18T16:35:23.867415-05:00","closed_at":"2025-10-18T16:35:23.867415-05:00"}
{"id":"voice-code-148","title":"Write tests for message type filtering","description":"Add tests to SessionSyncManagerTests to verify that summary and system messages are filtered out during sync.\n\nTest cases:\n1. Verify summary messages are not created in CoreData\n2. Verify system messages are not created in CoreData\n3. Verify user and assistant messages are still created\n4. Verify message count is correct after filtering","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-18T16:33:09.636768-05:00","updated_at":"2025-10-18T16:35:23.867857-05:00","closed_at":"2025-10-18T16:35:23.867857-05:00"}
{"id":"voice-code-149","title":"Delete existing summary/system messages from iOS CoreData","description":"After implementing message filtering, existing summary and system messages are still in the iOS CoreData database and visible to users.\n\nSolution: Add a one-time migration/cleanup that deletes all CDMessage records where role == 'summary' or role == 'system'.\n\nThis should run on app launch after the filtering code is deployed.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-18T16:39:40.447372-05:00","updated_at":"2025-10-18T16:55:46.861526-05:00","closed_at":"2025-10-18T16:55:46.861526-05:00"}
{"id":"voice-code-150","title":"Default to first premium voice on first launch","description":"When the app is installed and launched for the first time, automatically select the first available premium voice instead of defaulting to a basic voice.\n\nCurrent behavior: App likely defaults to first available voice regardless of quality\n\nDesired behavior:\n1. On first launch, check if any premium voices are available\n2. If premium voices exist, set the default to the first premium voice\n3. If no premium voices, fall back to first available voice\n4. Store this selection in AppSettings so it persists\n\nImplementation:\n- Add first-launch detection (using UserDefaults flag)\n- Query AVSpeechSynthesisVoice.speechVoices() for premium voices\n- Filter for premium quality voices\n- Set default voice in AppSettings\n- Mark first-launch as complete\n\nBenefits: Better out-of-box experience with higher quality voice synthesis","status":"open","priority":2,"issue_type":"feature","created_at":"2025-10-18T16:46:17.66643-05:00","updated_at":"2025-10-18T16:46:17.66643-05:00"}
{"id":"voice-code-151","title":"Refresh sessions list after server settings update","description":"When server configuration is updated in settings, the sessions list does not refresh automatically. Users must exit and restart the app to see the sessions populate.\n\nCurrent behavior:\n1. User updates server URL/port in settings\n2. User saves settings\n3. Sessions list remains empty\n4. User must force quit and restart app to see sessions\n\nExpected behavior:\n1. User updates server URL/port in settings\n2. User saves settings\n3. App automatically reconnects to new server\n4. Sessions list refreshes and populates with sessions from new server\n\nImplementation:\n- In SettingsView, after saving server settings, trigger client.reconnect()\n- SessionsListView should observe connection state changes\n- When connection is established, automatically request sessions list\n- Clear any cached sessions from previous server\n\nRelated to voice-code-119 (connection status refresh) but specifically about sessions list population.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-10-18T16:50:19.854885-05:00","updated_at":"2025-10-18T17:23:33.76711-05:00","closed_at":"2025-10-18T17:23:33.76711-05:00"}
{"id":"voice-code-152","title":"Auto-read uses wrong voice instead of configured voice","description":"Auto-read for new messages was using default system voice instead of the user's configured voice from Settings.\n\nRoot cause: SessionSyncManager.handleSessionUpdated:309 called speak(text) without passing the voiceIdentifier parameter.\n\nFix: \n- Added appSettings parameter to SessionSyncManager\n- Updated speak() call to pass settings.selectedVoiceIdentifier\n- Wired appSettings through VoiceCodeClient → SessionSyncManager\n- Added tests to verify voice configuration path\n\nFiles changed:\n- SessionSyncManager.swift: Added appSettings parameter, updated speak() call\n- VoiceCodeClient.swift: Added appSettings parameter, passed to SessionSyncManager\n- VoiceCodeApp.swift: Passed settings when creating VoiceCodeClient\n- ReadAloudTests.swift: Added tests for voice selection\n\nImpact: Auto-read now respects user's voice selection from Settings.","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-10-18T17:54:18.946102-05:00","updated_at":"2025-10-18T17:54:24.337426-05:00","closed_at":"2025-10-18T17:54:24.337427-05:00"}
{"id":"voice-code-153","title":"Centralize voice selection to prevent inconsistency","description":"","notes":"Centralized voice management in VoiceOutputManager to prevent voice selection inconsistency. VoiceOutputManager now owns AppSettings and provides speak(text) for automatic voice selection and speakWithVoice(text, voiceIdentifier:) for overrides. Removed appSettings from SessionSyncManager and VoiceCodeClient. All call sites now use consistent voice.","status":"closed","priority":0,"issue_type":"feature","created_at":"2025-10-18T18:04:05.900756-05:00","updated_at":"2025-10-18T18:04:20.73323-05:00","closed_at":"2025-10-18T18:04:20.733231-05:00"}
{"id":"voice-code-154","title":"Fix subscription loss on reconnection","description":"Implement client-side fix to restore subscriptions when iOS app reconnects to backend after network interruption. Current issue: ConversationView subscribes on onAppear, but reconnection doesn't trigger onAppear, causing message loss.\n\nSolution: Track active subscriptions in VoiceCodeClient and automatically resubscribe on reconnection.\n\nBenefits:\n- Zero backend changes (no deployment coordination)\n- Fixes root cause immediately\n- Low risk, high confidence\n- Can ship independently\n\nSee RECONNECTION_FIX_REVIEW.md for full analysis.","status":"open","priority":0,"issue_type":"epic","created_at":"2025-10-18T19:48:45.411368-05:00","updated_at":"2025-10-18T19:48:45.411368-05:00"}
{"id":"voice-code-155","title":"Track active subscriptions in VoiceCodeClient","description":"Add activeSubscriptions property to VoiceCodeClient to track which sessions are currently subscribed.\n\nImplementation:\n- Add private var activeSubscriptions = Set\u003cString\u003e()\n- Update subscribe() to insert session ID into set\n- Update unsubscribe() to remove session ID from set\n- Track subscriptions across reconnections\n\nLocation: ios/VoiceCode/Managers/VoiceCodeClient.swift\n\nCurrent code:\n- subscribe() at line 327\n- unsubscribe() at line 336","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-18T19:48:54.058524-05:00","updated_at":"2025-10-18T19:58:32.716368-05:00","closed_at":"2025-10-18T19:58:32.71637-05:00"}
{"id":"voice-code-156","title":"Implement auto-resubscribe on reconnection","description":"Restore subscriptions when client reconnects to backend after network interruption.\n\nImplementation:\n- In handleMessage() under connected case (line 187-193)\n- After reconnectionAttempts = 0\n- Iterate through activeSubscriptions set\n- Call subscribe() for each session ID\n- Log resubscription activity\n\nLocation: ios/VoiceCode/Managers/VoiceCodeClient.swift:187-193\n\nDepends on: voice-code-155 (subscription tracking)","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-18T19:49:05.213538-05:00","updated_at":"2025-10-18T19:58:37.253864-05:00","closed_at":"2025-10-18T19:58:37.253865-05:00","dependencies":[{"issue_id":"voice-code-156","depends_on_id":"voice-code-155","type":"blocks","created_at":"2025-10-18T19:49:05.215214-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-157","title":"Add unit tests for subscription tracking","description":"Write unit tests to verify subscription tracking behavior.\n\nTest cases:\n1. Subscribe adds session ID to activeSubscriptions\n2. Unsubscribe removes session ID from activeSubscriptions\n3. Multiple subscribe calls are idempotent\n4. Multiple unsubscribe calls are safe\n5. activeSubscriptions persists across method calls\n\nLocation: ios/VoiceCodeTests/VoiceCodeClientTests.swift\n\nUse existing test patterns from VoiceCodeClientTests.swift","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-18T19:49:10.224077-05:00","updated_at":"2025-10-18T19:58:37.263771-05:00","closed_at":"2025-10-18T19:58:37.263772-05:00","dependencies":[{"issue_id":"voice-code-157","depends_on_id":"voice-code-155","type":"blocks","created_at":"2025-10-18T19:49:10.225518-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-158","title":"Add integration test for reconnection scenario","description":"Create integration test to verify subscriptions are restored after reconnection.\n\nTest scenario:\n1. Connect client and subscribe to session A\n2. Simulate network disconnect (close WebSocket)\n3. Reconnect client (new WebSocket connection)\n4. Verify subscribe message sent for session A\n5. Verify session updates are received\n\nLocation: ios/VoiceCodeTests/IntegrationTests.swift or new file\n\nMock WebSocket connection to simulate disconnect/reconnect cycle","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-18T19:49:15.468219-05:00","updated_at":"2025-10-18T19:58:37.273387-05:00","closed_at":"2025-10-18T19:58:37.273389-05:00","dependencies":[{"issue_id":"voice-code-158","depends_on_id":"voice-code-156","type":"blocks","created_at":"2025-10-18T19:49:15.470389-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-159","title":"Manual test: Verify subscription restore on network interruption","description":"Manually validate that subscriptions are restored after real network interruption.\n\nTest procedure:\n1. Launch iOS app and connect to backend\n2. Open ConversationView for session A\n3. Verify subscription sent (check logs)\n4. Enable airplane mode to force disconnect\n5. From terminal, send prompt to session A (creates new message)\n6. Disable airplane mode to reconnect\n7. Verify iOS receives connected message\n8. Verify iOS sends subscribe message for session A\n9. Verify new message appears in ConversationView\n\nSuccess criteria:\n- Message appears without manual refresh\n- No user intervention required\n- Logs show resubscription occurred\n\nLocation: Manual testing on physical device or simulator with network conditioning","status":"open","priority":0,"issue_type":"task","created_at":"2025-10-18T19:49:23.008287-05:00","updated_at":"2025-10-18T19:49:23.008287-05:00","dependencies":[{"issue_id":"voice-code-159","depends_on_id":"voice-code-156","type":"blocks","created_at":"2025-10-18T19:49:23.010743-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-160","title":"Test edge case: Multiple sessions in navigation stack","description":"Validate that multiple backgrounded ConversationViews maintain subscriptions across reconnection.\n\nTest procedure:\n1. Open ConversationView for session A\n2. Navigate to session B (A is backgrounded in nav stack)\n3. Navigate to session C (A and B are backgrounded)\n4. Enable airplane mode\n5. From terminal, send prompts to sessions A, B, and C\n6. Disable airplane mode\n7. Verify all three sessions resubscribe\n8. Navigate back through stack: C -\u003e B -\u003e A\n9. Verify all messages appeared in each session\n\nSuccess criteria:\n- All three sessions show new messages\n- No messages lost during reconnection\n- Backgrounded sessions continue receiving updates\n\nEdge case validation for multi-session UI pattern","status":"open","priority":1,"issue_type":"task","created_at":"2025-10-18T19:49:30.148777-05:00","updated_at":"2025-10-18T19:49:30.148777-05:00","dependencies":[{"issue_id":"voice-code-160","depends_on_id":"voice-code-156","type":"blocks","created_at":"2025-10-18T19:49:30.150979-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-161","title":"Test edge case: Reconnection during active prompt","description":"Validate behavior when network interruption occurs while prompt is being processed.\n\nTest procedure:\n1. Open ConversationView for session A\n2. Send prompt that takes \u003e5 seconds to process\n3. During processing, enable airplane mode\n4. Wait for disconnect\n5. Disable airplane mode to reconnect\n6. Verify subscription restored\n7. Verify response appears when Claude completes\n\nSuccess criteria:\n- Response arrives after reconnection\n- No duplicate prompts sent\n- UI shows correct status during reconnection\n\nTests interaction between optimistic messages, prompt processing, and reconnection","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-18T19:49:36.541486-05:00","updated_at":"2025-10-18T19:49:36.541486-05:00","dependencies":[{"issue_id":"voice-code-161","depends_on_id":"voice-code-156","type":"blocks","created_at":"2025-10-18T19:49:36.543455-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-162","title":"Add logging for subscription lifecycle debugging","description":"Enhance logging to make subscription lifecycle visible for debugging.\n\nAdd logging for:\n- Subscribe: session ID added to activeSubscriptions\n- Unsubscribe: session ID removed from activeSubscriptions\n- Reconnection: list of sessions being resubscribed\n- State: current activeSubscriptions count\n\nFormat:\n- Use consistent prefix: [VoiceCodeClient:Subscriptions]\n- Include session ID (first 8 chars for brevity)\n- Log at appropriate levels (debug for routine, info for reconnection)\n\nLocation: ios/VoiceCode/Managers/VoiceCodeClient.swift\n\nEnables easier troubleshooting of subscription issues in production","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-18T19:49:46.044792-05:00","updated_at":"2025-10-18T19:49:46.044792-05:00","dependencies":[{"issue_id":"voice-code-162","depends_on_id":"voice-code-155","type":"blocks","created_at":"2025-10-18T19:49:46.047052-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-163","title":"Update documentation with reconnection behavior","description":"Document the subscription restoration behavior in relevant files.\n\nUpdates needed:\n1. Add section to STANDARDS.md WebSocket Protocol explaining auto-resubscribe\n2. Update architecture notes about client-side subscription tracking\n3. Document expected behavior on reconnection\n\nLocation: STANDARDS.md (WebSocket Protocol section)\n\nInclude:\n- How activeSubscriptions are tracked\n- When resubscription occurs (on connected message)\n- User-visible behavior (transparent reconnection)\n\nEnsures future developers understand the reconnection mechanism","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-18T19:49:55.373695-05:00","updated_at":"2025-10-18T19:49:55.373695-05:00","dependencies":[{"issue_id":"voice-code-163","depends_on_id":"voice-code-159","type":"blocks","created_at":"2025-10-18T19:49:55.374956-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-164","title":"Backend: extract-working-dir only reads first line, misses cwd in warmup messages","description":"When session files start with error/summary messages before warmup, extract-working-dir reads first line which has no cwd field, falls back to placeholder working directory.\n\nRoot cause: replication.clj:90-119 extract-working-dir only reads first line with (first (line-seq rdr))\n\nExample session 5c5198ac-f97a-4e3f-9e4b-dcc61c0a3769:\n- Line 1-2: type=summary error messages (no cwd)\n- Line 3: Warmup message with cwd=/Users/travisbrown/code/mono/active/voice-code\n- Index has: working-directory=[from project: -Users-travisbrown-code-mono-active-voice-code]\n\nImpact: iOS app receives placeholder paths, commands fail with 'No such file or directory'\n\nFix: Search first N lines (e.g., 10) for cwd field instead of only first line\nAlternative: Filter out non-user/assistant messages when searching for cwd","notes":"When session files start with error/summary messages before warmup, extract-working-dir reads first line which has no cwd field, falls back to placeholder working directory.\n\nRoot cause: replication.clj:90-119 extract-working-dir only reads first line with (first (line-seq rdr))\n\nWhen cwd not found, falls back to project-name-\u003eworking-dir which derives path from parent directory name. Directory names like -Users-travisbrown-code-mono-active-voice-code use dashes instead of slashes. Function detects dash prefix and returns placeholder: [from project: -Users-travisbrown-code-mono-active-voice-code]\n\nExample session 5c5198ac-f97a-4e3f-9e4b-dcc61c0a3769:\n- Line 1-2: type=summary error messages (no cwd)\n- Line 3: Warmup message with cwd=/Users/travisbrown/code/mono/active/voice-code\n- Backend reads line 1, no cwd found, uses placeholder\n- Index stores: working-directory=[from project: -Users-travisbrown-code-mono-active-voice-code]\n- iOS receives placeholder, tries to use as actual path\n- Commands fail: Cannot run program in directory [from project: ...] No such file or directory\n\nImpact: iOS app receives invalid paths, all commands fail\n\nFix: Search first N lines (e.g., 10) for cwd field instead of only first line","status":"open","priority":0,"issue_type":"bug","created_at":"2025-10-19T15:33:11.968687-05:00","updated_at":"2025-10-19T15:45:48.554365-05:00"}
{"id":"voice-code-165","title":"iOS: Sessions not appearing after server restart despite being recent","description":"User reports that some recent sessions (from today Oct 19) don't appear in iOS app even after restarting both backend and frontend.\n\nInvestigation findings:\n- Backend has 819 total sessions, 32 from today\n- Backend filters to top 50 most recent sessions (message-count \u003e 0)\n- 50th session is from Oct 11, so all Oct 19 sessions should be included\n- Commit 9df78db added clearAllSessions() and auto-restore subscriptions\n\nPossible causes:\n1. clearAllSessions() clears CoreData but auto-restored subscriptions might restore sessions not in top 50\n2. Race condition between session_list and auto-restored subscriptions\n3. handleSessionHistory doesn't check if session exists in CoreData (line 95-100 SessionSyncManager.swift)\n4. Filter logic in handleSessionCreated (lines 57-62) might be too aggressive\n\nNeed to:\n- Verify which sessions are missing from iOS\n- Check iOS logs for warnings about 'Session not found for history'\n- Test subscription restoration with sessions outside top 50\n- Consider whether 50-session limit is appropriate or needs to be configurable","status":"open","priority":1,"issue_type":"bug","created_at":"2025-10-19T15:34:43.787874-05:00","updated_at":"2025-10-19T15:34:43.787874-05:00"}
{"id":"voice-code-166","title":"iOS: Cannot create new sessions - filtered out by messageCount \u003e 0 predicate","description":"User flow broken: Cannot create new sessions in iOS app. When user taps New Session button, enters name and working directory, and saves, the session disappears immediately and user cannot find it to send the first prompt.\n\nUSER BEHAVIOR:\n1. User opens iOS app (SessionsView shows list of sessions from backend)\n2. User taps + button to create new session\n3. User enters session name and working directory in NewSessionView\n4. User taps Save/Create\n5. Sheet dismisses but new session does NOT appear in SessionsView list\n6. User cannot find session to send initial prompt\n7. No prompt ever reaches backend, no session file created\n\nROOT CAUSE:\nSessionsView.swift line 15-17 uses fetchActiveSessions() to display sessions\nCDSession.swift line 35 has predicate: markedDeleted == NO AND messageCount \u003e 0\nWhen createNewSession() creates session (SessionsView.swift line 152-179), it sets messageCount = 0\nFetch request immediately filters out the new session because messageCount is 0\nSession exists in CoreData but is invisible in UI\n\nHISTORY:\nThis broke in commit e2d76d9 which added 3-layer zero-message filtering:\n- Layer 1: Backend don't broadcast if messageCount = 0\n- Layer 2: iOS Database filter messageCount \u003e 0 (THIS IS THE PROBLEM)\n- Layer 3: iOS Handler validate messageCount in handleSessionCreated\n\nLayer 2 was intended to hide old empty sessions from backend, but it also hides brand new locally-created sessions before user can send first message.\n\nFIX OPTIONS:\n\nOption 1: Remove messageCount \u003e 0 from fetchActiveSessions predicate\n- Simple, allows all non-deleted sessions to show\n- Old empty sessions from backend would reappear (bad UX)\n\nOption 2: Add flag to distinguish local vs backend sessions\n- Add isLocallyCreated boolean to CDSession\n- Set true when created in createNewSession()\n- Predicate: markedDeleted == NO AND (messageCount \u003e 0 OR isLocallyCreated == YES)\n- Clear flag when first message arrives from backend\n- Prevents old empty backend sessions while allowing new local ones\n\nOption 3: Don't create session until first prompt sent\n- Refactor: Hold session name/workingDir in state\n- Show temporary new session UI\n- Create CDSession only when user sends first prompt\n- More complex, changes UX flow\n\nRECOMMENDED: Option 2\nCleanest separation between locally-created sessions (which should always show) and backend sessions (which should only show if non-empty).\n\nFILES AFFECTED:\n- ios/VoiceCode/Models/CDSession.swift (add isLocallyCreated attribute)\n- ios/VoiceCode/Models/VoiceCode.xcdatamodeld (update CoreData schema)\n- ios/VoiceCode/Views/SessionsView.swift (set isLocallyCreated=true in createNewSession)\n- ios/VoiceCode/Managers/SessionSyncManager.swift (clear isLocallyCreated when syncing from backend)","status":"open","priority":0,"issue_type":"bug","created_at":"2025-10-19T16:03:13.694944-05:00","updated_at":"2025-10-19T16:03:13.694944-05:00"}
{"id":"voice-code-167","title":"Backend: Support running multiple instances on different ports","description":"Currently the backend can only run one instance because multiple instances would have file conflicts. We need to support running multiple backend instances on different ports (e.g., 8080 and 8081) for development and testing purposes.\n\nCURRENT SITUATION:\nPort configuration is in resources/config.edn at :server :port (default 8080). No command-line argument support.\n\nFILE CONFLICT ISSUES:\n\n1. Session Index File (~/.claude/.session-index.edn)\n   - SHARED between all instances\n   - Both instances read/write same file\n   - Race condition: simultaneous save-index! calls\n   - Last write wins, losing updates from other instance\n   - Each instance has separate in-memory session-index atom\n   - Updates from one instance invisible to the other\n\n2. Filesystem Watcher\n   - Both instances watch same ~/.claude/projects/ directory\n   - Both receive same filesystem events\n   - Both try to update session-index and save to disk\n   - Both broadcast session-created/updated events to their respective clients\n   - Race condition on every file event\n\n3. File Positions Atom (file-positions)\n   - In-memory only, not persisted\n   - Each instance tracks separately\n   - When file modified, both watchers see event\n   - Both parse incrementally from their last position\n   - Could cause duplicate message broadcasts to clients\n\n4. Session Data Files (~/.claude/projects/**/*.jsonl)\n   - Read-only for backend (Claude Code CLI writes them)\n   - No conflict - safe to read from multiple processes\n\nRECOMMENDED SOLUTION:\n\nMake session index file port-specific:\n- Use ~/.claude/.session-index-8080.edn for port 8080\n- Use ~/.claude/.session-index-8081.edn for port 8081\n- Each instance maintains isolated state\n- Both can watch filesystem independently\n- No coordination needed between instances\n\nIMPLEMENTATION PLAN:\n\n1. Pass port parameter through replication namespace\n   - Add port parameter to get-index-file-path function\n   - Store port in defonce or pass through function calls\n   - Update path to use port: (str home \"/.claude/.session-index-\" port \".edn\")\n\n2. Thread port from server.clj to replication.clj\n   - server/-main already has port from config\n   - Pass port to repl/initialize-index! \n   - Pass port to repl/start-watcher! (may need to store in watcher-state)\n   - Update all save-index! and load-index calls to use port\n\n3. Update function signatures:\n   - get-index-file-path [port]\n   - save-index! [index port]\n   - load-index [port]\n   - initialize-index! [port]\n\n4. Consider storing port in namespace state:\n   - Add (defonce current-port (atom nil))\n   - Set during initialize-index!\n   - Use in get-index-file-path without parameter\n\nFILES TO MODIFY:\n- backend/src/voice_code/replication.clj (get-index-file-path, save-index!, load-index, initialize-index!)\n- backend/src/voice_code/server.clj (-main function to pass port)\n\nTESTING:\n- Start two backend instances on different ports\n- Create session in one instance, verify both see filesystem event\n- Verify each instance maintains separate session index file\n- Verify no race conditions or lost updates\n- Verify clients on each port receive correct broadcasts\n\nALTERNATIVE CONSIDERED:\nDisable filesystem watcher on secondary instances - rejected because both instances should be fully functional.\n\nCONTEXT:\nThis came up during work on voice-code-164 (working directory bug). We needed to run a second backend instance for testing without interfering with the primary instance being used for active development.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-10-19T16:29:11.269418-05:00","updated_at":"2025-10-19T16:29:11.269418-05:00"}
{"id":"voice-code-170","title":"iOS: Persist draft prompts across app lifecycle","description":"Epic to preserve user's draft prompt text when backgrounding app or switching sessions. Prevents data loss and improves UX.\n\nPROBLEM:\nUsers lose their typed prompt text when:\n1. Switching to another app and returning\n2. App being backgrounded\n3. Navigating away from session detail view\n4. App crashes or is force-quit\n\nSOLUTION OVERVIEW:\nCreate a draft management system that:\n- Stores draft text per-session in UserDefaults\n- Auto-saves on every text change\n- Restores draft when viewing a session\n- Clears draft after prompt is sent\n- Prevents cross-session contamination\n\nTECHNICAL APPROACH:\n- Add DraftManager class (similar to AppSettings pattern)\n- Use dictionary [sessionID: draftText] stored in UserDefaults\n- Integrate with ConversationView to auto-save/restore\n- Handle edge cases (nil session IDs, empty drafts, cleanup)\n\nSUB-TASKS:\nSee voice-code-170 through voice-code-173","notes":"CLOSED: Original approach with parameter threading caused Swift compiler type-checking timeout. \n\nReplaced by voice-code-176 which uses @EnvironmentObject instead of parameter threading.\n\nvoice-code-171 (DraftManager class) is complete and reusable.\nvoice-code-172, 173, 174 are obsolete - replaced by new approach.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-10-19T21:15:52.429671-05:00","updated_at":"2025-10-19T22:12:47.393797-05:00","closed_at":"2025-10-19T22:12:47.393798-05:00"}
{"id":"voice-code-172","title":"iOS: Integrate DraftManager with VoiceCodeApp","description":"Add DraftManager instance to VoiceCodeApp and pass to views that need it.\n\nPARENT EPIC: voice-code-170\nDEPENDS ON: voice-code-171\n\nCHANGES:\nFile: ios/VoiceCode/VoiceCodeApp.swift\n\n1. Add @StateObject for DraftManager (around line 12):\n   @StateObject private var draftManager = DraftManager()\n\n2. Pass to RootView and down the hierarchy:\n   RootView(client: client, settings: settings, voiceOutput: voiceOutput, draftManager: draftManager, showingSettings: $showingSettings)\n\n3. Update RootView to accept and forward draftManager parameter\n\n4. Update SessionsListView to accept and forward draftManager parameter\n\n5. Pass draftManager to ConversationView when navigating (SessionsView.swift line 88-92)\n\nTESTING:\n- Verify app compiles after adding parameter threading\n- Verify DraftManager instance is shared across all views","notes":"Obsolete - parameter threading approach abandoned due to Swift compiler limitations. See voice-code-176 for new @EnvironmentObject approach.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-19T21:16:16.616445-05:00","updated_at":"2025-10-19T22:12:52.024979-05:00","closed_at":"2025-10-19T22:12:52.02498-05:00"}
{"id":"voice-code-173","title":"iOS: Update ConversationView to use DraftManager","description":"Modify ConversationView to save and restore draft text using DraftManager.\n\nPARENT EPIC: voice-code-170\nDEPENDS ON: voice-code-172\n\nCHANGES:\nFile: ios/VoiceCode/Views/ConversationView.swift\n\n1. Add DraftManager parameter to ConversationView init:\n   @ObservedObject var draftManager: DraftManager\n\n2. Change promptText from @State to computed property or keep @State but sync with DraftManager\n\n3. Add onAppear to restore draft:\n   .onAppear {\n       if let sessionID = session.id {\n           promptText = draftManager.getDraft(sessionID: sessionID)\n       }\n   }\n\n4. Add onChange to auto-save draft:\n   .onChange(of: promptText) { _, newValue in\n       if let sessionID = session.id {\n           draftManager.saveDraft(sessionID: sessionID, text: newValue)\n       }\n   }\n\n5. Clear draft after sending (line 134):\n   if let sessionID = session.id {\n       draftManager.clearDraft(sessionID: sessionID)\n   }\n   promptText = \"\"\n\n6. Handle edge case: session.id is nil (guard against it)\n\nTESTING:\n- Type partial prompt, background app, return - verify text restored\n- Type partial prompt, navigate away, return - verify text restored  \n- Send prompt - verify draft is cleared\n- Switch between sessions - verify each has independent draft\n- Restart app - verify drafts persist","notes":"Obsolete - parameter threading approach abandoned. See voice-code-176 for new @EnvironmentObject approach.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-19T21:16:25.618162-05:00","updated_at":"2025-10-19T22:12:55.965176-05:00","closed_at":"2025-10-19T22:12:55.965177-05:00"}
{"id":"voice-code-174","title":"iOS: Add draft cleanup on session deletion","description":"Clean up stored drafts when sessions are deleted to prevent storage bloat.\n\nPARENT EPIC: voice-code-170\nDEPENDS ON: voice-code-171\n\nCHANGES:\nFile: ios/VoiceCode/Managers/DraftManager.swift\n\nAdd method:\nfunc cleanupDraft(sessionID: String) {\n    drafts.removeValue(forKey: sessionID)\n}\n\nFile: ios/VoiceCode/Views/SessionsView.swift\n\nWhen deleting session (around line 104 where deleteSession is called):\n- Call draftManager.cleanupDraft(sessionID: session.id)\n- Do this before or after CoreData deletion\n\nOPTIONAL ENHANCEMENT:\nAdd periodic cleanup to remove drafts for sessions that no longer exist in CoreData:\n- Run on app launch or periodically\n- Query all session IDs from CoreData\n- Remove drafts for IDs not in CoreData\n\nTESTING:\n- Delete session with draft text\n- Verify draft is removed from UserDefaults\n- Verify storage size doesn't grow indefinitely","notes":"Obsolete - cleanup logic will be implemented in voice-code-176 using @EnvironmentObject approach.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-19T21:16:33.424956-05:00","updated_at":"2025-10-19T22:13:01.092755-05:00","closed_at":"2025-10-19T22:13:01.092756-05:00"}
{"id":"voice-code-176","title":"Backend: Index keys are uppercase but lookups use lowercase","description":"Case-sensitivity mismatch in session index. Index is built with uppercase UUID keys from filenames, but get-session-metadata normalizes to lowercase for lookups. This causes sessions with uppercase UUIDs (from iOS) to appear missing even though they exist on disk.\n\nRoot cause: build-index! in replication.clj:175-195 uses session-id as-is from filename (uppercase), but get-session-metadata:279-282 normalizes to lowercase.\n\nFix: Normalize session-id to lowercase in build-index! before using as map key: (assoc acc (str/lower-case session-id) metadata)\n\nImpact: ~11+ sessions with uppercase UUIDs cannot be found via lookup despite being in the index.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-10-19T22:12:47.383642-05:00","updated_at":"2025-10-19T22:12:47.383642-05:00"}
{"id":"voice-code-177","title":"iOS: Draft persistence using @EnvironmentObject pattern","description":"Epic to preserve user's draft prompt text using SwiftUI @EnvironmentObject pattern instead of parameter threading.\n\nSUPERSEDES: voice-code-170 (parameter threading approach caused Swift compiler timeout)\nREUSES: voice-code-171 (DraftManager class already implemented and tested)\n\nPROBLEM:\nUsers lose typed prompt text when:\n1. Switching to another app and returning\n2. App being backgrounded\n3. Navigating away from session detail view\n4. App crashes or is force-quit\n\nSOLUTION ARCHITECTURE:\nUse SwiftUI @EnvironmentObject to inject DraftManager throughout view hierarchy without explicit parameter passing.\n\nBENEFITS:\n- No view signature changes (avoids Swift compiler type-checking timeout)\n- Idiomatic SwiftUI pattern\n- DraftManager class already complete with tests\n- Simple integration - just 2 files need changes\n\nTECHNICAL APPROACH:\n1. VoiceCodeApp creates @StateObject DraftManager\n2. Inject via .environmentObject() modifier (1 line)\n3. ConversationView accesses via @EnvironmentObject\n4. Auto-save/restore draft per session\n5. Clean up on session delete\n\nIMPLEMENTATION:\n- voice-code-177: Inject DraftManager as environment object in VoiceCodeApp\n- voice-code-178: Update ConversationView to use @EnvironmentObject\n- voice-code-179: Add draft cleanup on session deletion\n\nCONTEXT FOR NEW DEVELOPERS:\n- iOS 18.5 deployment target\n- DraftManager class: ios/VoiceCode/Managers/DraftManager.swift (complete)\n- Tests: ios/VoiceCodeTests/DraftManagerTests.swift (6 tests passing)\n- Storage: UserDefaults key sessionDrafts as [String: String]\n- Pattern reference: AppSettings uses same @Published + didSet pattern\n\nESTIMATED EFFORT: 30-45 minutes total","notes":"COMPLETED: All tasks finished successfully.\n\nImplementation used @EnvironmentObject pattern (idiomatic SwiftUI) instead of parameter threading.\n\nCompleted tasks:\n- voice-code-171: DraftManager class (REUSED from previous work)\n- voice-code-178: Inject DraftManager via @EnvironmentObject ✅\n- voice-code-179: ConversationView draft auto-save/restore ✅  \n- voice-code-180: Cleanup drafts on session deletion ✅\n\nAll builds passing. Ready for testing.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-10-19T22:13:16.557837-05:00","updated_at":"2025-10-19T22:18:37.496255-05:00","closed_at":"2025-10-19T22:18:37.496257-05:00"}
{"id":"voice-code-178","title":"iOS: Inject DraftManager via @EnvironmentObject","description":"Add DraftManager to app environment so all child views can access it without parameter passing.\n\nPARENT EPIC: voice-code-177\nDEPENDS ON: voice-code-171 (DraftManager class - COMPLETE)\n\nCONTEXT:\nDraftManager class already exists and is tested (voice-code-171).\nNeed to make it available throughout view hierarchy using SwiftUI @EnvironmentObject pattern.\n\nCHANGES NEEDED:\n\nFile: ios/VoiceCode/VoiceCodeApp.swift\n\n1. Create @StateObject after line 10:\n   @StateObject private var draftManager = DraftManager()\n\n2. Inject into environment after line 14 (inside WindowGroup):\n   RootView(settings: settings)\n       .environment(\\.managedObjectContext, persistenceController.container.viewContext)\n       .environmentObject(draftManager)  // ← ADD THIS LINE\n\nThat's it! No other changes needed for this task.\n\nTESTING:\n- App should compile and run\n- No runtime errors\n- DraftManager accessible from any child view via @EnvironmentObject\n\nREFERENCE:\nSimilar pattern used for other managers:\n- PersistenceController passed via .environment()\n- We're adding DraftManager via .environmentObject()\n\nDifference: .environment() for value types, .environmentObject() for ObservableObject","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-19T22:13:27.52631-05:00","updated_at":"2025-10-19T22:15:24.211106-05:00","closed_at":"2025-10-19T22:15:24.211108-05:00"}
{"id":"voice-code-179","title":"iOS: Use @EnvironmentObject in ConversationView for drafts","description":"Update ConversationView to access DraftManager from environment and implement auto-save/restore logic.\n\nPARENT EPIC: voice-code-177\nDEPENDS ON: voice-code-178\n\nCONTEXT:\nConversationView.swift currently has @State private var promptText.\nNeed to sync this with DraftManager to persist across app lifecycle.\n\nCHANGES NEEDED:\n\nFile: ios/VoiceCode/Views/ConversationView.swift\n\n1. Add @EnvironmentObject property (around line 14, with other properties):\n   @EnvironmentObject var draftManager: DraftManager\n\n2. Keep existing @State (line 17):\n   @State private var promptText = \"\"\n   (Keep this - UI needs @State for TextField binding)\n\n3. Add .onAppear modifier to restore draft:\n   .onAppear {\n       if let sessionID = session.id {\n           promptText = draftManager.getDraft(sessionID: sessionID)\n       }\n   }\n\n4. Add .onChange modifier to auto-save draft:\n   .onChange(of: promptText) { oldValue, newValue in\n       if let sessionID = session.id {\n           draftManager.saveDraft(sessionID: sessionID, text: newValue)\n       }\n   }\n\n5. Update sendPrompt to clear draft (around line 134):\n   // After successful send, before setting promptText = \"\"\n   if let sessionID = session.id {\n       draftManager.clearDraft(sessionID: sessionID)\n   }\n   promptText = \"\"\n\nEDGE CASES:\n- session.id might be nil: Use guard/if let to safely unwrap\n- Empty text: DraftManager.saveDraft already handles (removes entry)\n- Multiple sessions: Each has independent draft (DraftManager uses dictionary)\n\nTESTING:\n- Type partial prompt, background app, return → text should restore\n- Type partial prompt, navigate away, return → text should restore\n- Send prompt → draft should clear\n- Switch sessions → each session has own draft\n- Kill app, relaunch → drafts persist\n\nLOCATION HINTS:\n- Current @State promptText: line 17\n- ConversationTextInputView usage: around line 131-136\n- sendPrompt logic: look for where promptText is cleared","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-19T22:13:42.439437-05:00","updated_at":"2025-10-19T22:17:29.336313-05:00","closed_at":"2025-10-19T22:17:29.336314-05:00"}
{"id":"voice-code-180","title":"iOS: Clean up drafts when session deleted","description":"Remove stored draft text when user deletes a session to prevent storage bloat.\n\nPARENT EPIC: voice-code-177\nDEPENDS ON: voice-code-178\n\nCONTEXT:\nUserDefaults will accumulate draft entries for deleted sessions over time.\nNeed to clean up drafts when sessions are deleted.\n\nCHANGES NEEDED:\n\nFile: ios/VoiceCode/Views/SessionsView.swift\n\n1. Access DraftManager via @EnvironmentObject (around line 11):\n   @EnvironmentObject var draftManager: DraftManager\n\n2. In deleteSession function (around line 104):\n   Before or after viewContext.delete(session):\n   if let sessionID = session.id {\n       draftManager.cleanupDraft(sessionID: sessionID)\n   }\n\nLOCATION:\n- deleteSession function is in SessionsView.swift\n- Currently deletes from CoreData around line 104-110\n- Just add draft cleanup before viewContext.save()\n\nTESTING:\n- Create draft in session (type partial prompt)\n- Delete that session\n- Check UserDefaults: draft should be removed\n- Verify via: UserDefaults.standard.dictionary(forKey: \"sessionDrafts\")\n\nOPTIONAL ENHANCEMENT (P2):\nAdd bulk cleanup on app launch to remove orphaned drafts:\n- In DraftManager.init or separate method\n- Fetch all valid session IDs from CoreData\n- Remove drafts where sessionID not in valid set\n- Only run if draft count \u003e 100 (performance)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-19T22:13:53.634233-05:00","updated_at":"2025-10-19T22:18:30.318263-05:00","closed_at":"2025-10-19T22:18:30.318265-05:00"}
{"id":"voice-code-181","title":"Epic: Fix session list whiplash on first open (immediate fix)","description":"Fix the immediate cause of session list whiplash when opening a session for the first time.\n\n## Problem\nWhen a user taps a session in the session list that hasn't been opened since app launch:\n1. Session opens briefly (ConversationView appears)\n2. View immediately closes and pops back to session list\n3. Session jumps to a different position in the list\n4. User must find and re-open the session\n\nThis only happens on first open after app receives session from backend.\n\n## Root Cause\nThe issue occurs in SessionSyncManager.swift handleSessionHistory() method (line 109-152). When ConversationView opens (line 200 onAppear), it calls loadSessionIfNeeded() which subscribes to the session (line 244). The backend responds with a session_history message containing the full conversation history.\n\nWhen handleSessionHistory() processes this history replay, it ALWAYS updates session.lastModified = Date() on line 137, even though this is existing historical data, not new activity. This causes:\n1. CoreData saveContext() triggers @FetchRequest observer in SessionsView\n2. @FetchRequest re-sorts by lastModified descending (CDSession.swift:38)\n3. Session moves to top of list\n4. NavigationLink breaks because session position changed in array\n5. View pops back to session list\n\n## Solution\nRemove the lastModified update from handleSessionHistory() at SessionSyncManager.swift:137. History replay represents existing activity that already has a lastModified timestamp from the backend. We should only update lastModified when truly NEW messages arrive (which happens in handleSessionUpdated()).\n\n## Scope\n- Modify SessionSyncManager.swift handleSessionHistory() method\n- Write tests to verify lastModified is NOT updated during history replay\n- Write tests to verify lastModified IS still updated for new messages\n- Verify fix resolves the whiplash issue\n\n## Out of Scope\nThis is a tactical fix. It does NOT address the underlying architectural fragility of position-based navigation. That will be addressed in a separate epic for ID-based navigation refactoring.","status":"closed","priority":0,"issue_type":"epic","created_at":"2025-10-20T20:57:47.35428-05:00","updated_at":"2025-10-20T21:12:19.19279-05:00","closed_at":"2025-10-20T21:12:19.192791-05:00"}
{"id":"voice-code-182","title":"Understand the session history flow and identify the bug location","description":"## Context\nThis task helps you understand how session history loading works and where the bug occurs.\n\n## Background: What is Session History?\nIn this app, sessions represent conversations with Claude. When you open a session for the first time after app launch, the iOS app needs to load the full conversation history from the backend server. This is called 'session history replay'.\n\nThe flow works like this:\n1. User taps a session in SessionsView (the list of all sessions)\n2. ConversationView opens and displays the conversation\n3. ConversationView.swift line 200-201: onAppear lifecycle method fires\n4. Line 230-250: loadSessionIfNeeded() method executes\n5. Line 244: client.subscribe(sessionId:) sends a 'subscribe' message to backend via WebSocket\n6. Backend responds with a 'session_history' message containing all messages in that conversation\n7. VoiceCodeClient.swift line 283-289: Receives the session_history message\n8. SessionSyncManager.swift line 109-152: handleSessionHistory() processes the message\n\n## The Bug Location\nOpen ios/VoiceCode/Managers/SessionSyncManager.swift and find the handleSessionHistory() method (starts around line 109).\n\nLook at lines 135-137:\n\n\u001b[1;38;5;196mWelcome to Swift!\u001b[0m\n\n\u001b[1mSubcommands:\u001b[0m\n\n  \u001b[1mswift build\u001b[0m      Build Swift packages\n  \u001b[1mswift package\u001b[0m    Create and work on packages\n  \u001b[1mswift run\u001b[0m        Run a program from a package\n  \u001b[1mswift test\u001b[0m       Run package tests\n  \u001b[1mswift repl\u001b[0m       Experiment with Swift code interactively\n\n  Use \u001b[1m`swift --version`\u001b[0m for Swift version information.\n\n  Use \u001b[1m`swift --help`\u001b[0m for descriptions of available options and flags.\n\n  Use \u001b[1m`swift help \u003csubcommand\u003e`\u001b[0m for more information about a subcommand.\n\nLine 137 sets lastModified to the current time (Date()). This is incorrect because:\n- We're replaying EXISTING history, not creating new activity\n- The backend already sent us the correct lastModified timestamp in the session_list\n- Updating it to 'now' makes the session jump to the top of the list\n\n## Why Does This Cause Whiplash?\nSessionsView displays sessions in a list sorted by lastModified (most recent first). The list uses SwiftUI's @FetchRequest which automatically re-sorts when CoreData changes.\n\nWhen we update lastModified:\n1. CoreData saves the change (line 145-146)\n2. @FetchRequest in SessionsView.swift (line 17-20) observes the change\n3. The fetch request re-sorts: CDSession.swift line 38 sorts by lastModified descending\n4. The session moves from its original position to the top of the list\n5. SwiftUI's NavigationLink is position-based (SessionsView.swift line 110-114)\n6. The NavigationLink's reference becomes invalid because the array position changed\n7. Navigation pops back to the session list\n\n## Your Task\n1. Read through the code files mentioned above\n2. Trace the flow from ConversationView.onAppear to handleSessionHistory()\n3. Locate line 137 in SessionSyncManager.swift\n4. Understand why updating lastModified during history replay is semantically incorrect\n5. Note that handleSessionUpdated() (line 238-349) DOES need to update lastModified because it handles NEW messages\n6. Write a comment in this task explaining the difference between handleSessionHistory() and handleSessionUpdated()\n\n## Success Criteria\n- You can explain the flow from session tap to whiplash\n- You understand why line 137 is the bug\n- You can explain why handleSessionUpdated() should keep its lastModified update","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-20T20:58:09.626124-05:00","updated_at":"2025-10-20T21:07:22.472513-05:00","closed_at":"2025-10-20T21:07:22.472515-05:00","dependencies":[{"issue_id":"voice-code-182","depends_on_id":"voice-code-181","type":"blocks","created_at":"2025-10-20T20:58:09.628052-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-183","title":"Remove lastModified update from handleSessionHistory method","description":"Context: Fix the bug by removing the problematic lastModified update from handleSessionHistory.\n\nWhat to change:\n- File: ios/VoiceCode/Managers/SessionSyncManager.swift\n- Method: handleSessionHistory() (line 109-152)\n- Line to remove: 137\n\nWhy remove this line:\nThe handleSessionHistory() method processes EXISTING conversation history being replayed from the backend. This history already happened in the past. The backend already sent us the correct lastModified timestamp in the session_list message. Setting lastModified = Date() incorrectly marks the session as modified right now.\n\nThe fix:\n1. Open ios/VoiceCode/Managers/SessionSyncManager.swift\n2. Find handleSessionHistory() method (starts around line 109)\n3. Locate line 137: session.lastModified = Date()\n4. REMOVE line 137\n5. Keep line 136 (messageCount update is correct)\n6. Add a comment explaining why we do not update lastModified during history replay\n\nImportant: Do NOT remove lastModified from handleSessionUpdated() method (line 306). That update is correct because handleSessionUpdated() receives NEW messages being created right now.\n\nSuccess criteria:\n- Line 137 in handleSessionHistory() removed or commented out\n- Line 306 in handleSessionUpdated() still present\n- Code compiles without errors\n- Comment added explaining the reasoning","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-20T20:58:33.382199-05:00","updated_at":"2025-10-20T21:09:19.841949-05:00","closed_at":"2025-10-20T21:09:19.84195-05:00","dependencies":[{"issue_id":"voice-code-183","depends_on_id":"voice-code-181","type":"blocks","created_at":"2025-10-20T20:58:33.38377-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-183","depends_on_id":"voice-code-182","type":"blocks","created_at":"2025-10-20T20:58:33.384177-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-184","title":"Write test: Verify lastModified NOT updated during session history replay","description":"Context: Write a test to verify that our fix works - lastModified should NOT be updated when replaying session history.\n\nTest location:\nCreate or add to: ios/VoiceCodeTests/SessionSyncManagerTests.swift\n\nTest purpose:\nVerify that when handleSessionHistory() is called with existing messages, the session lastModified timestamp is NOT changed to the current time. This ensures sessions do not jump to the top of the list when opened for the first time.\n\nTest implementation:\n1. Create a test method: testHandleSessionHistory_DoesNotUpdateLastModified()\n2. Setup: Create a test session in CoreData with a known lastModified timestamp (e.g., 1 hour ago)\n3. Capture the original lastModified value\n4. Call sessionSyncManager.handleSessionHistory() with mock message data\n5. Wait for the async background context to complete\n6. Fetch the session again from CoreData\n7. Assert that session.lastModified equals the original timestamp (has NOT changed)\n8. Assert that session.messageCount HAS been updated to match the history count\n\nMock data format:\nThe messages array should contain dictionaries matching the Claude Code jsonl format with fields: type (user or assistant), message object with content, timestamp, uuid.\n\nReference existing tests:\nLook at ios/VoiceCodeTests/CoreDataTests.swift and ios/VoiceCodeTests/SessionDeletionTests.swift for examples of how to set up CoreData test contexts and wait for async operations.\n\nSuccess criteria:\n- Test file created or updated\n- Test passes with the fix applied\n- Test would fail if line 137 (lastModified = Date()) were added back\n- Test verifies messageCount IS updated (showing we are processing the history)\n- Test uses proper async expectations to wait for background context saves","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-20T20:58:47.388461-05:00","updated_at":"2025-10-20T21:11:31.724888-05:00","closed_at":"2025-10-20T21:11:31.724889-05:00","dependencies":[{"issue_id":"voice-code-184","depends_on_id":"voice-code-181","type":"blocks","created_at":"2025-10-20T20:58:47.390032-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-184","depends_on_id":"voice-code-183","type":"blocks","created_at":"2025-10-20T20:58:47.390597-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-185","title":"Write test: Verify lastModified IS updated for new messages","description":"Context: Write a test to verify that lastModified IS still updated when NEW messages arrive (not history replay).\n\nTest location:\nAdd to: ios/VoiceCodeTests/SessionSyncManagerTests.swift\n\nTest purpose:\nVerify that when handleSessionUpdated() is called with new messages arriving in real-time, the session lastModified timestamp IS updated to the current time. This is the correct behavior for new activity.\n\nDifference from previous test:\n- Previous test (voice-code-184): Tests handleSessionHistory() which should NOT update lastModified\n- This test: Tests handleSessionUpdated() which SHOULD update lastModified\n\nTest implementation:\n1. Create test method: testHandleSessionUpdated_UpdatesLastModified()\n2. Setup: Create a test session in CoreData with lastModified set to 1 hour ago\n3. Capture the original lastModified value\n4. Call sessionSyncManager.handleSessionUpdated() with mock new message data\n5. Wait for async background context to complete\n6. Fetch the session again from CoreData\n7. Assert that session.lastModified is GREATER than the original timestamp (has been updated)\n8. Assert that the new lastModified is within the last few seconds (approximately Date())\n9. Assert that session.messageCount has been incremented\n\nMock data format:\nMessages array should match the Claude Code jsonl format. Include at least one assistant message to simulate a new response from Claude.\n\nWhy this test is important:\nThis verifies we did not accidentally break the correct behavior. When new messages arrive during active conversation, we WANT the session to move to the top of the list because it represents recent activity.\n\nSuccess criteria:\n- Test passes with current code\n- Test verifies lastModified IS updated to recent time\n- Test verifies messageCount is incremented\n- Test distinguishes between history replay and new message arrival\n- Test uses proper async expectations","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-20T20:59:00.290142-05:00","updated_at":"2025-10-20T21:11:31.73898-05:00","closed_at":"2025-10-20T21:11:31.738981-05:00","dependencies":[{"issue_id":"voice-code-185","depends_on_id":"voice-code-181","type":"blocks","created_at":"2025-10-20T20:59:00.292128-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-185","depends_on_id":"voice-code-183","type":"blocks","created_at":"2025-10-20T20:59:00.292543-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-186","title":"Manual verification: Test the whiplash fix on device","description":"Context: Manually verify that the fix resolves the session list whiplash issue on a real device or simulator.\n\nPrerequisites:\n- Code fix applied (voice-code-183 completed)\n- Tests written and passing (voice-code-184 and voice-code-185 completed)\n- Backend server running and accessible\n- iOS app built and installed on device or simulator\n\nTest setup:\n1. Start the backend server (cd to voice-code directory, run: make run)\n2. Ensure backend has at least 3-5 sessions with conversation history\n3. Build and run the iOS app in Xcode\n4. Connect to the backend (check Settings if needed)\n5. Verify you see the session list populated\n\nTest procedure - Before fix (verify the bug exists):\nIf testing on a branch without the fix, you should observe:\n1. Tap a session in the middle of the list that has not been opened yet\n2. ConversationView opens briefly\n3. View immediately pops back to session list\n4. Session has moved to a different position (usually top)\n5. Must tap again to open successfully\n\nTest procedure - After fix (verify bug is resolved):\n1. Force quit and restart the app to clear any cached state\n2. Wait for session list to load from backend\n3. Note the current order of sessions in the list\n4. Tap a session in the middle of the list that has not been opened yet\n5. VERIFY: ConversationView opens and STAYS open\n6. VERIFY: Conversation history loads and displays\n7. Return to session list (back button)\n8. VERIFY: Session is in the SAME position as before (did not jump to top)\n9. Repeat for 2-3 different sessions to confirm consistency\n\nAdditional test scenarios:\n1. Test with sessions from different working directories\n2. Test with sessions that have many messages (50+)\n3. Test with sessions that have few messages (1-5)\n4. Test after app has been in background and returns to foreground\n\nWhat to look for:\n- No navigation popping immediately after opening session\n- Session position in list remains stable\n- Session order only changes when NEW messages arrive (expected behavior)\n\nSuccess criteria:\n- Session opens and stays open on first tap\n- Session position in list does not change from opening/viewing history\n- No whiplash or navigation disruption\n- Behavior consistent across multiple sessions","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-20T20:59:20.658882-05:00","updated_at":"2025-10-20T21:11:37.915408-05:00","closed_at":"2025-10-20T21:11:37.91541-05:00","dependencies":[{"issue_id":"voice-code-186","depends_on_id":"voice-code-181","type":"blocks","created_at":"2025-10-20T20:59:20.66012-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-186","depends_on_id":"voice-code-183","type":"blocks","created_at":"2025-10-20T20:59:20.66047-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-186","depends_on_id":"voice-code-184","type":"blocks","created_at":"2025-10-20T20:59:20.660791-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-186","depends_on_id":"voice-code-185","type":"blocks","created_at":"2025-10-20T20:59:20.661088-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-187","title":"Code review and documentation update","description":"Context: Review the changes and update documentation to explain the distinction between history replay and new message handling.\n\nCode review checklist:\n1. Review the change in SessionSyncManager.swift handleSessionHistory()\n2. Verify line 137 was removed (lastModified = Date())\n3. Verify line 306 in handleSessionUpdated() is still present\n4. Verify comments were added explaining the reasoning\n5. Check that both test files pass\n6. Review test coverage for edge cases\n\nDocumentation to add:\nAdd a comment block above handleSessionHistory() method explaining:\n- This method processes EXISTING history (replay from backend)\n- History replay should not update lastModified timestamp\n- The correct lastModified comes from the backend session_list\n- Only handleSessionUpdated() should update lastModified for NEW messages\n\nAdd a comment block above handleSessionUpdated() method explaining:\n- This method processes NEW messages arriving in real-time\n- New messages should update lastModified to current time\n- This ensures active sessions move to top of list (expected behavior)\n\nCode review questions to answer:\n1. Does the fix make semantic sense (history replay vs new activity)?\n2. Are there any other places in the code that might have similar issues?\n3. Could this same pattern apply to messageCount updates?\n4. Should we add logging to distinguish history replay from new messages?\n\nAdditional documentation:\nUpdate docs/session-list-refresh-issue.md:\n- Add a section documenting the fix that was implemented\n- Explain which option was chosen and why\n- Note that this is a tactical fix and ID-based navigation is still recommended\n- Add date of fix and link to relevant task IDs\n\nSuccess criteria:\n- Comments added to both methods explaining their different purposes\n- Documentation file updated with fix details\n- Code review questions answered in task comments\n- No other instances of this pattern found in codebase","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-20T20:59:37.33393-05:00","updated_at":"2025-10-20T21:12:09.912361-05:00","closed_at":"2025-10-20T21:12:09.912362-05:00","dependencies":[{"issue_id":"voice-code-187","depends_on_id":"voice-code-181","type":"blocks","created_at":"2025-10-20T20:59:37.334936-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-187","depends_on_id":"voice-code-183","type":"blocks","created_at":"2025-10-20T20:59:37.33531-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-187","depends_on_id":"voice-code-184","type":"blocks","created_at":"2025-10-20T20:59:37.335612-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-187","depends_on_id":"voice-code-185","type":"blocks","created_at":"2025-10-20T20:59:37.335882-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-187","depends_on_id":"voice-code-186","type":"blocks","created_at":"2025-10-20T20:59:37.336148-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-188","title":"Epic: Refactor to ID-based navigation (long-term fix)","description":"Refactor SessionsView navigation from position-based to ID-based to permanently fix session list whiplash and improve architecture.\n\n## Problem\nThe current navigation implementation in SessionsView uses SwiftUI NavigationLink inside a ForEach that iterates over @FetchRequest results. This creates a position-based navigation dependency where the NavigationLink is tied to the specific index position in the FetchedResults array.\n\nWhen CoreData updates and re-sorts the underlying array during active navigation, the NavigationLink reference becomes invalid and navigation pops back to the list. This causes the whiplash issue.\n\n## Current Implementation\nSessionsView.swift lines 109-114:\nForEach iterates over sessions sorted by lastModified\nNavigationLink(destination: ConversationView(session: session))\nNavigation is implicitly tied to array position\n\n## Root Architectural Issue\nPosition-based navigation is fragile because:\n- FetchedResults array can re-sort at any time when CoreData changes\n- Animations on @FetchRequest make this visible and disruptive\n- Any code that updates session metadata can break active navigation\n- Makes the app brittle and hard to maintain\n\n## Solution: ID-Based Navigation\nRefactor to use SwiftUI value-based navigation pattern:\n- Use NavigationStack with NavigationPath state\n- Navigate by session UUID, not by position\n- Use navigationDestination(for: UUID.self) to resolve session by ID\n- Navigation remains stable regardless of array re-sorting\n\n## Benefits\n- Immune to CoreData re-sorting during navigation\n- Aligns with SwiftUI best practices\n- Enables future features: deep linking, state restoration, URL schemes\n- More maintainable and robust architecture\n- Follows iOS HIG recommendations for list-detail navigation\n\n## Scope\n- Refactor SessionsView to use NavigationStack and NavigationPath\n- Replace NavigationLink with value-based navigation\n- Add navigationDestination for UUID type\n- Update navigation state management\n- Write tests for navigation stability during CoreData updates\n- Verify all navigation flows still work correctly\n- Test deep linking scenarios (if applicable)\n\n## Out of Scope\n- Backend changes (purely iOS refactor)\n- Other navigation flows outside SessionsView -\u003e ConversationView\n- Changes to ConversationView itself (except navigation-related state)\n\n## Dependencies\nThis epic is independent of voice-code-181 (immediate fix). Can be implemented in parallel or after.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-10-20T21:00:00.230274-05:00","updated_at":"2025-10-20T21:32:55.420384-05:00","closed_at":"2025-10-20T21:32:55.420385-05:00"}
{"id":"voice-code-189","title":"Research SwiftUI NavigationStack and value-based navigation","description":"Context: Learn about SwiftUI value-based navigation and how it differs from traditional NavigationLink patterns.\n\n## What is NavigationStack?\nNavigationStack is a SwiftUI container introduced in iOS 16 that manages a stack of views using a NavigationPath. It replaces the older NavigationView pattern and provides better programmatic control over navigation state.\n\n## What is Value-Based Navigation?\nInstead of embedding a destination view directly in NavigationLink, you navigate using a value (like a UUID). The navigation system looks up the destination based on that value.\n\nTraditional position-based:\nForEach(sessions) { session in\n  NavigationLink(destination: ConversationView(session: session)) {\n    SessionRow(session: session)\n  }\n}\n\nValue-based:\nForEach(sessions) { session in\n  NavigationLink(value: session.id) {\n    SessionRow(session: session)\n  }\n}\n.navigationDestination(for: UUID.self) { sessionId in\n  // Look up session by ID and create view\n  if let session = findSession(by: sessionId) {\n    ConversationView(session: session)\n  }\n}\n\n## Why Value-Based is Better\nPosition-based navigation breaks when the array re-sorts because NavigationLink is tied to a specific index. Value-based navigation uses the UUID to look up the session fresh each time, so it does not matter if the array position changes.\n\n## Research Tasks\n1. Read Apple documentation on NavigationStack and NavigationPath\n2. Read Apple documentation on navigationDestination modifier\n3. Study example code in Apple sample projects (search for navigationDestination)\n4. Find 2-3 blog posts or tutorials on migrating from NavigationView to NavigationStack\n5. Understand how NavigationPath works as state storage for navigation stack\n\n## Key Concepts to Understand\n- NavigationPath: Type-erased collection storing navigation state\n- navigationDestination(for:): Modifier that maps values to destinations\n- Value types: Any Hashable type can be used (UUID, String, custom types)\n- Multiple destination types: Can have different navigationDestination for different types\n- Programmatic navigation: Can append to NavigationPath to navigate programmatically\n\n## Resources\n- Apple WWDC 2022 session on NavigationStack\n- SwiftUI documentation for NavigationStack\n- SwiftUI documentation for navigationDestination\n- Apple sample code: Food Truck app (uses NavigationStack extensively)\n\n## Deliverable\nWrite a summary in this task describing:\n1. How NavigationPath stores navigation state\n2. How navigationDestination looks up views by value\n3. Why this approach is immune to array re-sorting\n4. Any potential gotchas or edge cases to be aware of\n5. Links to 2-3 useful resources\n\nSuccess criteria:\n- Understand the difference between position-based and value-based navigation\n- Can explain how navigationDestination works\n- Found and reviewed Apple documentation\n- Ready to implement the pattern in our codebase","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-20T21:00:20.101937-05:00","updated_at":"2025-10-20T21:19:41.9402-05:00","closed_at":"2025-10-20T21:19:41.940201-05:00","dependencies":[{"issue_id":"voice-code-189","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-20T21:00:20.104351-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-190","title":"Audit current navigation structure and identify all touch points","description":"Context: Map out all the navigation touch points in the current implementation before refactoring.\n\n## Files to Audit\n1. ios/VoiceCode/VoiceCodeApp.swift - App entry point and top-level navigation structure\n2. ios/VoiceCode/Views/SessionsView.swift - Main session list view with NavigationLink\n3. ios/VoiceCode/Views/ConversationView.swift - Destination view for session navigation\n4. ios/VoiceCode/Views/ContentView.swift - May contain navigation wrapper\n\n## What to Document\nFor each file, identify:\n1. Current navigation container (NavigationView or NavigationStack?)\n2. Where NavigationLink is used\n3. What state is passed to ConversationView\n4. Any programmatic navigation (isPresented, NavigationLink with tag/selection)\n5. Any navigation-related @State or @Binding variables\n\n## Specific Questions to Answer\n1. Does VoiceCodeApp.swift use NavigationView or NavigationStack?\n2. Is there a ContentView that wraps SessionsView?\n3. How many NavigationLink instances exist in SessionsView?\n4. Are there any other navigation paths to ConversationView besides from SessionsView?\n5. Does ConversationView navigate to any other views?\n6. Are there any sheets, fullScreenCovers, or other modal presentations?\n7. Is there any deep linking or URL handling code?\n\n## Navigation Flow Diagram\nCreate a simple text diagram showing:\n- App entry point\n- Top-level navigation container\n- SessionsView -\u003e ConversationView navigation\n- Any other navigation relationships\n- Modal presentations (sheets, alerts, etc)\n\nExample format:\nVoiceCodeApp\n  └─ NavigationView (or NavigationStack?)\n      └─ SessionsView\n          ├─ NavigationLink -\u003e ConversationView\n          ├─ Sheet -\u003e NewSessionView\n          └─ Sheet -\u003e SettingsView\n\n## Navigation State Inventory\nList all navigation-related state:\n- Is there a @State var for selected session?\n- Is there any navigationBarItems or toolbar navigation?\n- Are there any programmatic dismiss/pop operations?\n\n## Deliverable\nDocument findings in this task with:\n1. List of all navigation touch points\n2. Navigation flow diagram\n3. State inventory\n4. Any concerns or questions about the refactor\n5. Estimate of refactor scope (how many files need changes)\n\nSuccess criteria:\n- All navigation paths documented\n- Understand current navigation architecture\n- Identified all files that need modification\n- Ready to plan the refactor implementation","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-20T21:00:36.491471-05:00","updated_at":"2025-10-20T21:20:30.00067-05:00","closed_at":"2025-10-20T21:20:30.000671-05:00","dependencies":[{"issue_id":"voice-code-190","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-20T21:00:36.492606-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-190","depends_on_id":"voice-code-189","type":"blocks","created_at":"2025-10-20T21:00:36.492886-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-191","title":"Design the ID-based navigation architecture","description":"Context: Design the new navigation architecture using NavigationStack and value-based navigation.\n\nDesign Constraints:\n1. Must support iOS 16+ (NavigationStack requirement)\n2. Must maintain all existing functionality\n3. Should be backward compatible with current session management\n4. Must handle session lookup by UUID efficiently\n5. Should support future deep linking if needed\n\nArchitecture Decisions to Make:\n\n1. Where to Place NavigationStack\n- Option A: Wrap entire app in NavigationStack at VoiceCodeApp level\n- Option B: Wrap SessionsView in NavigationStack\n- Option C: Use NavigationStack in ContentView wrapper\n\n2. NavigationPath Storage\n- Option A: @State var navigationPath in SessionsView\n- Option B: @StateObject NavigationManager as environment object\n- Option C: @AppStorage for persistence across app restarts\n\n3. Session Lookup Strategy\n- Option A: Use @FetchRequest in navigationDestination closure\n- Option B: Pass sessions array via environment\n- Option C: Create a SessionManager to handle lookups\n\n4. Handling Missing Sessions\nWhat if UUID is in NavigationPath but session no longer exists (deleted)?\n- Option A: Show error view with back button\n- Option B: Pop navigation automatically\n- Option C: Show empty state with explanation\n\n5. Backward Compatibility\nDo we need to support iOS 15? If yes, need both implementations with availability checks.\n\nDeliverable: Post design document with architecture decisions, code structure diagram, pseudo-code for key components, migration path, and testing strategy.\n\nSuccess criteria: Clear architectural plan, all decisions documented with rationale, issues identified with mitigation strategies, ready for implementation.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-20T21:01:03.015863-05:00","updated_at":"2025-10-20T21:21:13.065406-05:00","closed_at":"2025-10-20T21:21:13.065406-05:00","dependencies":[{"issue_id":"voice-code-191","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-20T21:01:03.017526-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-191","depends_on_id":"voice-code-189","type":"blocks","created_at":"2025-10-20T21:01:03.018098-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-191","depends_on_id":"voice-code-190","type":"blocks","created_at":"2025-10-20T21:01:03.018335-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-192","title":"Implement NavigationStack wrapper and NavigationPath state","description":"Context: Implement the NavigationStack container and NavigationPath state management based on the design from voice-code-191.\n\nPrerequisites:\n- Design decisions finalized in voice-code-191\n- Architecture documented and reviewed\n\nImplementation Steps:\n\n1. Determine NavigationStack Placement\nBased on design decision, implement NavigationStack in the appropriate location:\n- If VoiceCodeApp: Wrap the root view in NavigationStack\n- If SessionsView: Add NavigationStack wrapper\n- If ContentView: Create or modify ContentView to include NavigationStack\n\n2. Add NavigationPath State\nAdd state variable to manage navigation stack:\n@State private var navigationPath = NavigationPath()\n\nLocation depends on design decision. If using environment object, create NavigationManager class.\n\n3. Update VoiceCodeApp.swift (if needed)\nIf NavigationStack goes at app level:\n- Import SwiftUI\n- Wrap body content in NavigationStack(path: dollar-sign-navigationPath)\n- Pass navigationPath to child views if needed\n\n4. Create NavigationManager (if using environment object)\nIf design calls for environment object:\n- Create new file: NavigationManager.swift\n- Implement ObservableObject with @Published var path = NavigationPath()\n- Add helper methods: navigate(to sessionId: UUID), pop(), popToRoot()\n- Inject as environment object in VoiceCodeApp\n\n5. Handle Environment Injection\nIf using environment object:\n- Add .environmentObject(navigationManager) in VoiceCodeApp\n- Access with @EnvironmentObject var navigationManager in child views\n\n6. Verify Compilation\nAt this stage, code should compile but navigation will not work yet (NavigationLink not updated).\n\nCode Review Points:\n- NavigationStack properly wraps content\n- NavigationPath state initialized\n- State management approach matches design\n- No compilation errors\n- Existing navigation still works (old NavigationLink untouched for now)\n\nSuccess criteria:\n- NavigationStack implemented at designed location\n- NavigationPath state exists and accessible\n- Code compiles without errors\n- Existing functionality unaffected (no regressions)\n- Ready for next step (updating NavigationLink)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-20T21:01:19.419566-05:00","updated_at":"2025-10-20T21:22:31.321758-05:00","closed_at":"2025-10-20T21:22:31.321759-05:00","dependencies":[{"issue_id":"voice-code-192","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-20T21:01:19.420868-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-192","depends_on_id":"voice-code-191","type":"blocks","created_at":"2025-10-20T21:01:19.421192-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-193","title":"Refactor SessionsView NavigationLink to value-based pattern","description":"Context: Convert SessionsView from position-based NavigationLink to value-based NavigationLink.\n\nCurrent Implementation (SessionsView.swift line 109-114):\nThe ForEach iterates over sessions and creates NavigationLink with embedded destination:\nNavigationLink(destination: ConversationView(...))\n\nThis couples navigation to array position.\n\nNew Implementation:\nUse NavigationLink with value parameter instead of destination.\n\nStep-by-Step Implementation:\n\n1. Locate the NavigationLink\nFile: ios/VoiceCode/Views/SessionsView.swift\nCurrent location: Around line 110-114 inside ForEach loop\n\n2. Replace NavigationLink Signature\nChange from:\nNavigationLink(destination: ConversationView(session: session, client: client, voiceOutput: voiceOutput, settings: settings))\n\nChange to:\nNavigationLink(value: session.id)\n\nKeep the closure content (the SessionRow view) unchanged.\n\n3. Update the Closure\nThe closure body should remain the same:\nNavigationLink(value: session.id) {\n  CDSessionRowContent(session: session)\n}\n\n4. Keep swipeActions Unchanged\nThe swipeActions for delete should remain as-is.\n\n5. Verify Other NavigationLinks\nCheck if there are any other NavigationLink instances in SessionsView (there should not be any others in the session list, but verify).\n\nExpected Result After This Change:\n- NavigationLink no longer creates destination view immediately\n- Navigation is triggered by appending session.id (UUID) to NavigationPath\n- Destination view will be resolved in navigationDestination modifier (implemented in next task)\n\nImportant Notes:\n- Do NOT implement navigationDestination yet (that is next task)\n- Navigation will be broken temporarily after this change\n- This is expected - we are doing incremental refactoring\n- Keep all other SessionsView functionality unchanged\n\nTesting After This Change:\n- Code should compile\n- Tapping sessions will not navigate (expected, navigationDestination not added yet)\n- No crashes or errors\n\nSuccess criteria:\n- NavigationLink changed to use value parameter\n- session.id (UUID) passed as value\n- Destination parameter removed\n- Code compiles without errors\n- Ready for navigationDestination implementation","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-20T21:01:36.291819-05:00","updated_at":"2025-10-20T21:23:03.583496-05:00","closed_at":"2025-10-20T21:23:03.583498-05:00","dependencies":[{"issue_id":"voice-code-193","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-20T21:01:36.29308-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-193","depends_on_id":"voice-code-192","type":"blocks","created_at":"2025-10-20T21:01:36.293417-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-194","title":"Implement navigationDestination for UUID to resolve ConversationView","description":"Context: Implement the navigationDestination modifier to resolve session UUIDs to ConversationView.\n\nWhat is navigationDestination:\nThis SwiftUI modifier maps values in the NavigationPath to destination views. When NavigationLink pushes a UUID onto the path, navigationDestination looks up the session and creates the ConversationView.\n\nImplementation Location:\nAdd navigationDestination modifier to SessionsView or the NavigationStack container (depends on design decision in voice-code-191).\n\nStep-by-Step Implementation:\n\n1. Add navigationDestination Modifier\nIf NavigationStack is in SessionsView, add after the List view.\nIf NavigationStack is in parent view, add there.\n\nExample placement in SessionsView:\nAdd after the closing brace of the Group/List, before .navigationTitle\n\n2. Implement the Modifier\n.navigationDestination(for: UUID.self) { sessionId in\n  // Lookup session by UUID\n  // Create ConversationView if session exists\n}\n\n3. Session Lookup Strategy\nInside the closure, you need to find the session with matching UUID from the @FetchRequest results.\n\nOption A - Direct lookup from sessions FetchedResults:\nif let session = sessions.first(where: { dollarsign-0.id == sessionId }) {\n  ConversationView(session: session, client: client, voiceOutput: voiceOutput, settings: settings)\n}\n\nOption B - Fresh CoreData fetch:\nFetch session from viewContext using CDSession.fetchSession(id: sessionId)\n\nChoose based on design decision. Option A is simpler and reuses existing @FetchRequest.\n\n4. Handle Missing Session Case\nWhat if session was deleted or does not exist?\nAdd an else clause to handle this:\n\nelse {\n  SessionNotFoundView(sessionId: sessionId)\n}\n\nCreate a simple SessionNotFoundView:\nstruct SessionNotFoundView: View {\n  let sessionId: UUID\n  var body: some View {\n    VStack {\n      Text(\"Session not found\")\n      Text(sessionId.uuidString).font(.caption)\n      // Navigation back button will appear automatically\n    }\n  }\n}\n\n5. Complete Implementation Example\n.navigationDestination(for: UUID.self) { sessionId in\n  if let session = sessions.first(where: { dollarsign-0.id == sessionId }) {\n    ConversationView(session: session, client: client, voiceOutput: voiceOutput, settings: settings)\n  } else {\n    SessionNotFoundView(sessionId: sessionId)\n  }\n}\n\n6. Test Navigation\nBuild and run the app:\n- Tap a session in the list\n- Should navigate to ConversationView\n- Navigation should stay stable (no whiplash)\n- Back button should work\n- Try opening multiple sessions in sequence\n\nSuccess criteria:\n- navigationDestination implemented for UUID type\n- Session lookup working correctly\n- ConversationView renders with correct session\n- Missing session case handled gracefully\n- Navigation stable during CoreData updates\n- No whiplash when opening sessions\n- All navigation flows working correctly","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-20T21:01:54.907396-05:00","updated_at":"2025-10-20T21:23:39.4913-05:00","closed_at":"2025-10-20T21:23:39.491301-05:00","dependencies":[{"issue_id":"voice-code-194","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-20T21:01:54.909399-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-194","depends_on_id":"voice-code-193","type":"blocks","created_at":"2025-10-20T21:01:54.909971-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-195","title":"Write tests for ID-based navigation stability","description":"Context: Write comprehensive tests to verify that ID-based navigation remains stable when CoreData updates and re-sorts sessions.\n\nTest File:\nCreate: ios/VoiceCodeTests/NavigationStabilityTests.swift\n\nTest Purpose:\nVerify that unlike the old position-based navigation, ID-based navigation does not break when the underlying sessions array re-sorts during active navigation.\n\nTest 1: Navigation Stability During Session Update\nSimulate the original whiplash scenario:\n1. Setup: Create test environment with NavigationPath and sessions\n2. Navigate to a session (append UUID to NavigationPath)\n3. Simulate session_history update that changes lastModified\n4. Verify NavigationPath still contains the same UUID\n5. Verify destination view can still resolve the session\n\nThis test proves that updating lastModified does not break navigation anymore.\n\nTest 2: Navigation with Session Re-ordering\n1. Setup: Create 5 sessions with different lastModified times\n2. Navigate to session in middle of list (position 2)\n3. Update another session lastModified to move it above current session\n4. Verify navigation destination still resolves correctly\n5. Verify no navigation pop occurs\n\nTest 3: Session Lookup Performance\n1. Create 100 sessions in CoreData\n2. Navigate to session by UUID\n3. Measure time to resolve session in navigationDestination\n4. Verify lookup completes in under 100ms\n\nTest 4: Missing Session Handling\n1. Create NavigationPath with UUID that does not exist in CoreData\n2. Attempt to resolve destination\n3. Verify graceful error handling (SessionNotFoundView appears)\n4. Verify no crash occurs\n\nTest 5: Multiple Navigation and Back\n1. Navigate to session A\n2. Navigate back\n3. Navigate to session B\n4. Navigate back\n5. Navigate to session A again\n6. Verify all transitions work correctly\n\nTest 6: Session Deletion During Navigation\n1. Navigate to session A\n2. While on ConversationView, delete session A from another context\n3. Navigate back\n4. Verify session no longer appears in list\n5. Verify no crash occurs\n\nTesting Approach:\nUse XCTest with ViewInspector or SwiftUI testing to verify navigation state. May need to expose NavigationPath for testing via environment or test helpers.\n\nMock Data Setup:\nCreate helper functions to:\n- Generate test sessions with specific UUIDs and timestamps\n- Simulate CoreData updates\n- Create test NavigationPath states\n\nSuccess criteria:\n- All 6 tests written and passing\n- Tests verify navigation stability during CoreData changes\n- Tests cover edge cases (missing session, deletion, re-ordering)\n- Performance test validates efficient session lookup\n- Tests would fail with old position-based navigation (proving fix works)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-20T21:02:14.141296-05:00","updated_at":"2025-10-20T21:27:38.585874-05:00","closed_at":"2025-10-20T21:27:38.585876-05:00","dependencies":[{"issue_id":"voice-code-195","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-20T21:02:14.142723-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-195","depends_on_id":"voice-code-194","type":"blocks","created_at":"2025-10-20T21:02:14.143259-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-196","title":"Manual testing: Verify navigation stability across all scenarios","description":"Context: Comprehensive manual testing of the ID-based navigation refactor to ensure all functionality works and whiplash is eliminated.\n\nTest Environment Setup:\n1. Build and install app on iOS device or simulator (iOS 16+ required)\n2. Connect to backend server with multiple sessions\n3. Ensure at least 10 sessions exist with varied lastModified times\n4. Have sessions from multiple working directories\n\nTest Scenarios:\n\nScenario 1: Basic Navigation (Regression Test)\n1. Tap any session in the list\n2. Verify ConversationView opens\n3. Verify conversation history loads\n4. Verify back button returns to list\n5. Verify session still in same position after return\nRepeat for 5 different sessions.\n\nScenario 2: No Whiplash on First Open (Primary Fix)\n1. Force quit app and restart\n2. Wait for session list to load\n3. Note position of a session in middle of list\n4. Tap that session (first open since app launch)\n5. Verify ConversationView opens and STAYS open (no whiplash)\n6. Verify history loads without navigation disruption\n7. Return to list\n8. Verify session position unchanged\nThis is the key test - should not exhibit the original bug.\n\nScenario 3: Navigation During Backend Updates\n1. Open a session\n2. While viewing conversation, send a message from terminal (backend)\n3. Verify new message appears in iOS app\n4. Verify navigation remains stable (no pop)\n5. Verify session moves to top of list when you go back (expected)\n\nScenario 4: Rapid Session Switching\n1. Tap session A\n2. Immediately tap back\n3. Tap session B\n4. Immediately tap back\n5. Tap session C\nVerify all transitions smooth, no crashes, no animation glitches.\n\nScenario 5: Session Deletion\n1. Open session A\n2. Navigate back to list\n3. Swipe to delete session A\n4. Verify session removed from list\n5. Verify no crash or navigation issues\n\nScenario 6: Session Creation\n1. Create new session from SessionsView\n2. Verify new session appears at top of list\n3. Tap new session\n4. Verify navigation works\n5. Send a message\n6. Verify everything functions correctly\n\nScenario 7: Working Directory Groups\n1. Verify sessions grouped by working directory\n2. Tap session from different working directory groups\n3. Verify navigation works for all groups\n4. Verify group order updates correctly\n\nScenario 8: Background/Foreground Transitions\n1. Open a session\n2. Background the app (home button)\n3. Wait 10 seconds\n4. Bring app to foreground\n5. Verify still on ConversationView\n6. Verify no navigation disruption\n\nScenario 9: Large Session List Performance\nIf you have 50+ sessions:\n1. Scroll through entire list\n2. Tap session near bottom\n3. Verify navigation is responsive\n4. Measure time from tap to ConversationView appearing\nShould be under 500ms.\n\nScenario 10: Edge Cases\n1. Session with 0 messages (if any exist)\n2. Session with 100+ messages\n3. Session with very long name\n4. Session with special characters in working directory path\n\nIssues to Watch For:\n- Navigation popping unexpectedly\n- Whiplash or flickering\n- Crashes\n- Slow navigation (over 1 second delay)\n- Sessions appearing in wrong order\n- Missing sessions\n- Back button not working\n- Toolbar buttons not functioning\n\nSuccess criteria:\n- All 10 scenarios pass without issues\n- No whiplash observed in any scenario\n- Navigation smooth and responsive\n- No regressions in existing functionality\n- Performance acceptable (under 500ms navigation)\n- Edge cases handled gracefully","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-20T21:02:39.796284-05:00","updated_at":"2025-10-20T21:27:49.235091-05:00","closed_at":"2025-10-20T21:27:49.235092-05:00","dependencies":[{"issue_id":"voice-code-196","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-20T21:02:39.798612-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-196","depends_on_id":"voice-code-194","type":"blocks","created_at":"2025-10-20T21:02:39.799159-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-196","depends_on_id":"voice-code-195","type":"blocks","created_at":"2025-10-20T21:02:39.799519-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-197","title":"Performance profiling: Measure navigation and session lookup performance","description":"Context: Profile the performance of ID-based navigation to ensure session lookup by UUID is efficient and does not introduce performance regressions.\n\nTools to Use:\n1. Xcode Instruments - Time Profiler\n2. Xcode Instruments - Allocations\n3. SwiftUI View Body profiling\n4. Manual timing measurements\n\nPerformance Metrics to Measure:\n\nMetric 1: Session Lookup Time\nMeasure time to find session by UUID in navigationDestination closure.\n- Test with 10 sessions\n- Test with 100 sessions\n- Test with 500 sessions\n\nTarget: Under 10ms for 100 sessions, under 50ms for 500 sessions.\n\nImplementation: Add os_signpost markers around session lookup code.\n\nMetric 2: Navigation Transition Time\nMeasure time from NavigationLink tap to ConversationView appearing.\n- User taps session\n- Time until ConversationView onAppear fires\n\nTarget: Under 300ms on device, under 100ms on simulator.\n\nMetric 3: Memory Usage During Navigation\nUse Instruments Allocations to measure:\n- Memory before navigation\n- Memory after navigation\n- Memory after returning to list\n\nTarget: No memory leaks, reasonable memory growth (under 10MB per navigation).\n\nMetric 4: FetchRequest Performance\nMeasure @FetchRequest update time when sessions re-sort:\n- Trigger CoreData update that changes sort order\n- Measure time for @FetchRequest to reflect changes\n\nTarget: Under 50ms for 100 sessions.\n\nProfiling Procedure:\n\n1. Setup Large Dataset\nCreate test database with 100+ sessions using a script or test helper.\n\n2. Run Time Profiler\n- Open Xcode Instruments\n- Select Time Profiler\n- Run app\n- Navigate to multiple sessions\n- Look for bottlenecks in session lookup\n\n3. Run Allocations Profiler\n- Open Xcode Instruments\n- Select Allocations\n- Run app\n- Navigate to sessions and back multiple times\n- Check for memory leaks or excessive allocations\n\n4. Add Performance Tests\nCreate XCTestCase for performance:\n- testSessionLookupPerformance()\n- testNavigationPerformance()\n\nUse XCTest measure blocks:\nmeasure {\n  // Session lookup code\n}\n\n5. Compare with Baseline\nIf possible, measure old position-based navigation for comparison.\nDocument any performance differences.\n\nPerformance Optimization Opportunities:\n\nIf session lookup is slow:\n- Consider caching UUID to session mapping\n- Use Dictionary instead of linear search through FetchedResults\n- Optimize CoreData fetch request\n\nIf navigation is slow:\n- Profile ConversationView initialization\n- Check for unnecessary view updates\n- Optimize @FetchRequest predicates\n\nDeliverables:\n\n1. Performance Report\nDocument for each metric:\n- Baseline measurement\n- Target threshold\n- Actual measurement\n- Pass/fail status\n\n2. Instruments Screenshots\nCapture key findings from Time Profiler and Allocations.\n\n3. Performance Tests\nAdd to test suite with baseline expectations.\n\n4. Optimization Recommendations\nIf any metrics fail, document recommended optimizations.\n\nSuccess criteria:\n- All performance metrics meet targets\n- No memory leaks detected\n- Performance tests passing\n- No regressions vs old navigation (if measurable)\n- Report documents findings and any concerns","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-20T21:03:03.620973-05:00","updated_at":"2025-10-20T21:27:49.248776-05:00","closed_at":"2025-10-20T21:27:49.248777-05:00","dependencies":[{"issue_id":"voice-code-197","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-20T21:03:03.623086-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-197","depends_on_id":"voice-code-194","type":"blocks","created_at":"2025-10-20T21:03:03.625772-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-198","title":"Documentation: Update architecture docs and add migration guide","description":"Context: Document the new ID-based navigation architecture and create migration guide for future developers.\n\nDocumentation to Create/Update:\n\n1. Architecture Documentation\nCreate or update: docs/ios-navigation-architecture.md\n\nContent should include:\n- Overview of NavigationStack and NavigationPath pattern\n- Why we use ID-based navigation instead of position-based\n- Diagram showing navigation flow from SessionsView to ConversationView\n- How session lookup works in navigationDestination\n- How to add new navigation destinations in the future\n- Best practices for SwiftUI navigation in this codebase\n\n2. Migration Guide\nCreate: docs/navigation-migration-guide.md\n\nDocument the migration from old to new pattern:\n- What changed and why\n- Before/after code examples\n- How to migrate other navigation flows to this pattern\n- Common pitfalls to avoid\n- Testing checklist for navigation changes\n\n3. Code Comments\nAdd comprehensive comments in:\n\nSessionsView.swift:\n- Comment above NavigationStack explaining its purpose\n- Comment above navigationDestination explaining session lookup\n- Comment explaining why we use UUID values instead of destination\n\nVoiceCodeApp.swift (or wherever NavigationStack root is):\n- Comment explaining navigation hierarchy\n- Comment on NavigationPath state management\n\n4. Update Session List Refresh Issue Doc\nUpdate: docs/session-list-refresh-issue.md\n\nAdd new section:\n- Document that Epic voice-code-188 implemented the long-term fix\n- Explain how ID-based navigation solved the root cause\n- Mark the issue as resolved\n- Keep original problem description for historical reference\n\n5. Developer Onboarding Guide\nUpdate: docs/developer-guide.md (create if does not exist)\n\nAdd section on Navigation:\n- How our navigation is structured\n- How to navigate programmatically\n- How to add new navigation destinations\n- How to test navigation changes\n\n6. Inline Code Documentation\nAdd doc comments to key components:\n\nNavigationManager class (if created):\nDocument all public methods and properties.\n\nSessionNotFoundView:\nDocument when this appears and how to prevent it.\n\nnavigationDestination closure:\nAdd inline comments explaining the lookup logic.\n\n7. Performance Considerations\nDocument in architecture doc:\n- Session lookup performance characteristics\n- When to optimize (threshold of sessions)\n- Alternative lookup strategies if needed at scale\n\n8. Future Enhancements\nDocument potential future improvements:\n- Deep linking support (URL schemes)\n- State restoration across app restarts\n- NavigationPath persistence\n- Multi-level navigation hierarchies\n\nDocumentation Review Checklist:\n- All new patterns documented\n- Code examples accurate and tested\n- Diagrams clear and helpful\n- Migration guide complete\n- No outdated information\n- Links between related docs\n- Formatted consistently\n\nDeliverables:\n1. ios-navigation-architecture.md created/updated\n2. navigation-migration-guide.md created\n3. session-list-refresh-issue.md updated\n4. Code comments added to all key files\n5. Developer guide updated\n6. All documentation reviewed for accuracy\n\nSuccess criteria:\n- New developer can understand navigation architecture from docs\n- Migration guide enables porting pattern to other navigation flows\n- All decisions documented with rationale\n- Code comments explain non-obvious implementation details\n- Documentation accurate and up-to-date","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-20T21:03:26.24602-05:00","updated_at":"2025-10-20T21:28:52.635749-05:00","closed_at":"2025-10-20T21:28:52.635752-05:00","dependencies":[{"issue_id":"voice-code-198","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-20T21:03:26.24731-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-198","depends_on_id":"voice-code-194","type":"blocks","created_at":"2025-10-20T21:03:26.247625-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-198","depends_on_id":"voice-code-195","type":"blocks","created_at":"2025-10-20T21:03:26.247969-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-198","depends_on_id":"voice-code-196","type":"blocks","created_at":"2025-10-20T21:03:26.248295-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-199","title":"Cleanup: Remove deprecated position-based navigation code and comments","description":"Context: Clean up any deprecated code, remove obsolete comments, and ensure codebase reflects the new ID-based navigation pattern consistently.\n\nCode Cleanup Tasks:\n\n1. Remove Unused Navigation State\nSearch for any @State variables related to old navigation pattern:\n- @State var selectedSession\n- @State var isNavigationActive\n- Tag/selection based NavigationLink state\n\nIf found and no longer used, remove them.\n\n2. Remove Commented-Out Code\nSearch for commented-out NavigationLink or NavigationView code that was part of the old implementation. Remove if no longer needed.\n\n3. Update Variable Names\nEnsure variable names reflect new pattern:\n- navigationPath (not navigationState or similar)\n- sessionId (not sessionIndex)\n\n4. Remove Obsolete Helpers\nCheck for any helper functions that were specific to position-based navigation and are no longer needed.\n\n5. Update Imports\nRemove any imports that are no longer used after refactor:\n- Check for unused Combine imports\n- Check for unused CoreData imports in navigation-specific files\n\n6. Clean Up TODO Comments\nSearch for TODO comments related to navigation issues:\n- TODOs about fixing whiplash\n- TODOs about improving navigation stability\n- Mark as resolved or remove if completed\n\n7. Verify NavigationView Removal\nEnsure no files still use deprecated NavigationView:\nSearch codebase for NavigationView usage (should be NavigationStack now).\n\n8. Consistent Naming Conventions\nEnsure all navigation-related code uses consistent naming:\n- Methods: navigateToSession, not goToSession or showSession\n- Variables: navigationPath, not navPath or path\n- Comments: Use NavigationStack, not navigation stack or nav stack\n\n9. Remove Debug Logging\nRemove any debug print statements added during refactor:\n- Search for print statements in SessionsView, ConversationView\n- Keep important logging, remove temporary debug logs\n\n10. Code Formatting\nRun SwiftFormat or SwiftLint to ensure consistent formatting:\n- Proper indentation\n- Consistent spacing\n- Line length limits\n\n11. Asset Cleanup\nCheck if any navigation-related assets are unused:\n- Images for old navigation patterns\n- Deprecated colors or styles\n\n12. Dependency Cleanup\nReview Package.swift or Podfile:\n- Remove any dependencies added for old navigation pattern\n- Ensure no unused navigation libraries\n\nFiles to Review:\n- SessionsView.swift\n- ConversationView.swift\n- VoiceCodeApp.swift\n- NavigationManager.swift (if created)\n- Any other files modified during refactor\n\nSearch Patterns to Use:\ngit grep NavigationView\ngit grep selectedSession\ngit grep TODO navigation\ngit grep FIXME navigation\ngit grep print.*navigation (for debug logs)\n\nCleanup Verification:\n1. Full text search for old navigation patterns\n2. Build and run app - no warnings\n3. No unused imports or variables\n4. All TODOs resolved or tracked in Beads\n5. Code passes linter checks\n\nSuccess criteria:\n- No deprecated NavigationView usage\n- No unused navigation state variables\n- No commented-out old navigation code\n- All TODO/FIXME navigation comments addressed\n- Code formatting consistent\n- No unnecessary debug logging\n- Clean git diff (only intentional changes)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-20T21:03:48.968778-05:00","updated_at":"2025-10-20T21:32:45.7541-05:00","closed_at":"2025-10-20T21:32:45.754101-05:00","dependencies":[{"issue_id":"voice-code-199","depends_on_id":"voice-code-188","type":"blocks","created_at":"2025-10-20T21:03:48.970094-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-199","depends_on_id":"voice-code-194","type":"blocks","created_at":"2025-10-20T21:03:48.970477-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-199","depends_on_id":"voice-code-196","type":"blocks","created_at":"2025-10-20T21:03:48.970815-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-200","title":"Session updates for sessions outside top-50 are silently dropped","description":"Problem: Backend broadcasts session_updated messages to all connected clients whenever any session file changes. However, iOS only receives the top 50 sessions (sorted by last_modified) in the initial session_list. If a session outside the top-50 receives an update, iOS doesn't have it in CoreData and silently drops the update with 'Session not found for update' warning.\n\nImpact: Sessions that become active after initial connection won't appear in the iOS UI until app reconnects and gets fresh session_list. Users won't see sessions that move into relevance via updates.\n\nExample scenario:\n1. iOS connects, receives top 50 sessions (by last_modified)\n2. Session #51 receives new messages, becomes most recently modified\n3. Backend broadcasts session_updated for session #51\n4. iOS logs warning and ignores it (doesn't have session #51)\n5. Session #51 remains invisible until app reconnects\n\nRoot cause: SessionSyncManager.swift:249-252 guard statement returns early if session not found in CoreData.\n\nSolution approach: Create session from session_updated message if it doesn't exist. We have session-id and messages - can derive metadata (last-modified=now, message-count, preview). Name and working-directory will be incomplete initially but will sync on next session_list refresh.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-10-20T21:25:59.33893-05:00","updated_at":"2025-10-20T21:25:59.33893-05:00"}
{"id":"voice-code-201","title":"Modify handleSessionUpdated to create missing sessions","description":"Modify SessionSyncManager.handleSessionUpdated() to create sessions that don't exist in CoreData instead of returning early.\n\nLocation: ios/VoiceCode/Managers/SessionSyncManager.swift:240-252\n\nCurrent behavior: guard statement returns early if session not found, logging warning and dropping the update.\n\nRequired change: Replace guard with conditional creation. If session exists, use it. If not, create new CDSession with: id from sessionId parameter, empty backendName and workingDirectory (will sync later), markedDeleted=false, unreadCount=0, isLocallyCreated=false.\n\nThe rest of handleSessionUpdated already handles deriving metadata: lastModified=Date(), messageCount increment, preview extraction, and message creation.\n\nTesting: Verify session appears in UI when created from update, metadata syncs on next session_list, no duplicates, existing sessions work normally.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-20T21:26:18.554424-05:00","updated_at":"2025-10-20T21:45:44.528489-05:00","closed_at":"2025-10-20T21:45:44.528491-05:00","dependencies":[{"issue_id":"voice-code-201","depends_on_id":"voice-code-200","type":"blocks","created_at":"2025-10-20T21:26:18.556416-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-202","title":"Write tests for session creation from session_updated","description":"Write tests in SessionSyncManagerTests.swift to verify session creation from session_updated messages.\n\nTest cases to add:\n\n1. Test session_updated creates missing session:\n   - Clear CoreData, ensure no sessions exist\n   - Call handleSessionUpdated with session-id not in database\n   - Verify CDSession created with correct id, messages added\n   - Verify metadata: lastModified set to now, messageCount matches messages.count\n   - Verify backendName and workingDirectory are empty strings\n\n2. Test created session syncs metadata on next session_list:\n   - Create session via handleSessionUpdated (empty name/workingDirectory)\n   - Call handleSessionList with full metadata for same session-id\n   - Verify backendName and workingDirectory populated correctly\n\n3. Test no duplicate sessions created:\n   - Call handleSessionUpdated twice for same session-id\n   - Verify only one CDSession exists in CoreData\n   - Verify messageCount reflects all messages\n\n4. Test existing session flow unchanged:\n   - Create session via handleSessionList first\n   - Call handleSessionUpdated for same session-id\n   - Verify session updated (not created)\n   - Verify metadata preserved\n\n5. Test unread count behavior for created sessions:\n   - Create session via handleSessionUpdated (not active)\n   - Verify unreadCount incremented correctly\n   - Make session active, send another update\n   - Verify unreadCount not incremented\n\nLocation: ios/VoiceCodeTests/SessionSyncManagerTests.swift","status":"closed","priority":1,"issue_type":"task","created_at":"2025-10-20T21:26:29.304311-05:00","updated_at":"2025-10-20T21:45:48.485681-05:00","closed_at":"2025-10-20T21:45:48.485682-05:00","dependencies":[{"issue_id":"voice-code-202","depends_on_id":"voice-code-201","type":"blocks","created_at":"2025-10-20T21:26:29.305521-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-203","title":"Add integration test for session appearing after update","description":"Add integration test verifying complete user flow: session outside top-50 becomes visible after receiving update.\n\nTest scenario:\n1. Mock backend with 51+ sessions\n2. Connect iOS client, receive session_list with top 50 (sorted by last_modified)\n3. Verify session #51 not in CoreData\n4. Simulate backend sending session_updated for session #51 (with new messages)\n5. Verify session #51 now appears in CoreData\n6. Verify session appears in SessionsView UI\n7. Verify incomplete metadata (empty name/workingDirectory)\n8. Reconnect and receive fresh session_list\n9. Verify metadata now complete\n\nThis test validates the full fix end-to-end, ensuring sessions moving into relevance via updates appear correctly.\n\nConsider adding to: ios/VoiceCodeTests/SessionSyncManagerTests.swift or creating new integration test file.","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-20T21:26:38.601384-05:00","updated_at":"2025-10-20T21:26:38.601384-05:00","dependencies":[{"issue_id":"voice-code-203","depends_on_id":"voice-code-201","type":"blocks","created_at":"2025-10-20T21:26:38.603083-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-204","title":"Consider deriving session name from first message","description":"Enhancement: When creating session from session_updated, derive a meaningful name from the first message instead of leaving backendName empty.\n\nCurrent approach: Set backendName to empty string, wait for session_list to provide name.\n\nProposed enhancement: Extract first user message text and generate name similar to backend logic. This provides better UX - session has meaningful name immediately instead of showing empty/default.\n\nImplementation:\n- In handleSessionUpdated when creating new session\n- Find first message with role=user in messages array\n- Extract text and take first ~50 chars or first sentence\n- Set session.backendName to derived name\n- Still allow session_list to override with canonical backend name\n\nBenefits:\n- Better immediate UX when session appears\n- Consistent with backend naming convention\n- Falls back gracefully if no user message found\n\nConsideration: May not be necessary if session_list sync happens quickly. Evaluate priority based on real-world reconnection frequency.","status":"open","priority":3,"issue_type":"task","created_at":"2025-10-20T21:26:48.317166-05:00","updated_at":"2025-10-20T21:26:48.317166-05:00","dependencies":[{"issue_id":"voice-code-204","depends_on_id":"voice-code-201","type":"blocks","created_at":"2025-10-20T21:26:48.31954-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-205","title":"Document session sync behavior in protocol spec","description":"Update STANDARDS.md WebSocket protocol documentation to describe session sync behavior, especially edge cases.\n\nAdd to STANDARDS.md protocol section:\n\n1. Session Discovery section:\n   - session_list returns top 50 sessions sorted by last_modified descending\n   - Clients receive updates for ALL sessions via session_updated broadcasts\n   - Sessions outside top-50 may appear via session_updated messages\n   - Clients should create sessions from session_updated if not in local store\n\n2. Session Metadata Completeness:\n   - session_list provides complete metadata (id, name, working_directory, last_modified, message_count)\n   - session_updated provides id and messages only\n   - Clients creating sessions from session_updated should use placeholder metadata\n   - Metadata will sync on next session_list or reconnection\n\n3. Edge Cases:\n   - Session outside top-50 receives update -\u003e Client creates with partial metadata\n   - Session deleted from filesystem -\u003e session_deleted broadcast removes from all clients\n   - Session moves into top-50 -\u003e Appears in next session_list with complete metadata\n\nLocation: /Users/travisbrown/code/mono/active/voice-code/STANDARDS.md (WebSocket Protocol section)","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-20T21:26:59.128799-05:00","updated_at":"2025-10-20T21:26:59.128799-05:00","dependencies":[{"issue_id":"voice-code-205","depends_on_id":"voice-code-200","type":"blocks","created_at":"2025-10-20T21:26:59.129743-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-206","title":"Add copy session ID to clipboard feature","description":"Add ability to copy session UUID to clipboard via long-press interaction. Consider two possible locations:\n1. Session list view - long-press on a session\n2. Session detail view - long-press on a message\n\nDeveloper should evaluate UX of both approaches and choose the most appropriate implementation. Feature should provide haptic feedback and visual confirmation when ID is copied.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-10-20T22:13:27.759929-05:00","updated_at":"2025-10-20T22:13:27.759929-05:00"}
{"id":"voice-code-207","title":"Sessions don't re-sort when receiving updates","description":"Problem: When a session receives new messages via session_updated, it becomes visible (after voice-code-201 fix) but doesn't bubble to the top of the session list. The session list sorting is based on lastModified from the initial session_list, not updated dynamically as new messages arrive.\n\nImpact: Sessions with new activity remain buried in the list until the app reconnects or manually refreshes. User has to scroll through potentially many sessions to find the one with recent activity.\n\nCurrent behavior:\n- Session list is sorted by lastModified descending\n- SessionSyncManager.handleSessionUpdated updates session.lastModified = Date()\n- But SwiftUI @FetchRequest doesn't automatically re-sort when lastModified changes\n- Session stays in its original position until view refreshes\n\nExpected behavior:\n- When session receives session_updated message, it should jump to the top of the list\n- Most recently active sessions should always be at the top\n\nRoot cause: FetchRequest in SessionsView.swift uses CDSession.fetchActiveSessions() which sorts by lastModified, but SwiftUI doesn't automatically re-sort when that property changes in CoreData.\n\nSolution approach:\n1. Ensure lastModified updates trigger FetchRequest refresh (may need to mark as @objc dynamic or check fetch request cache policy)\n2. Verify background context saves properly propagate to view context\n3. Consider adding explicit context.refresh() or notification observer\n4. Test that sessions visually re-sort when receiving updates\n\nRelated: voice-code-200 (session visibility), voice-code-201 (session creation from updates)","status":"open","priority":2,"issue_type":"bug","created_at":"2025-10-20T22:24:03.423582-05:00","updated_at":"2025-10-20T22:24:03.423582-05:00"}
{"id":"voice-code-208","title":"3-tier navigation: Directories → Sessions → Conversations","description":"Epic: Restructure iOS app navigation from 2-tier to 3-tier for better session organization and discovery.\n\nCurrent UX (2-tier):\n- Sessions list (all sessions grouped by directory, all expanded)\n- Click session → Conversation view\n\nProposed UX (3-tier):\n- Directories list (sorted by most recent activity)\n- Click directory → Sessions list (for that directory only)\n- Click session → Conversation view\n\nUser Problem:\nWith many sessions across multiple projects, the current flat list is overwhelming. Users need to scroll through potentially 50+ sessions to find what they want. Grouping by directory with drill-down navigation provides better information architecture.\n\nBenefits:\n- Clearer mental model: \"Which project?\" → \"Which session?\" → \"What messages?\"\n- Less overwhelming: See 5-10 directories instead of 50 sessions\n- Faster navigation: Unread badges at directory level show where attention is needed\n- Better use of screen space: Each level optimized for its content\n\nDesign Specifications:\n\nDirectory Row Format:\n  📁 voice-code                                [2]\n  /Users/travis/code/mono/active/voice-code\n  3 sessions • 2 minutes ago\n\n- Directory name extracted from path (last component)\n- Full path in secondary text\n- Session count + relative timestamp\n- Aggregate unread badge (red capsule)\n- Folder icon for visual consistency\n\nNavigation Model:\n- Push navigation (NavigationLink) for native iOS feel\n- Natural back button at each level\n- State: Remember location during session, reset to directories on relaunch\n- After creating session: Navigate directly to conversation\n- After deleting session: Pop back to sessions list\n\nNew Session Creation:\n- Top level (Directories): + button → choose directory or enter custom\n- Directory level (Sessions): + button → pre-filled with current directory\n- Toolbar consistent across all levels: Refresh, +, Settings\n\nEmpty States:\n- No directories: \"No sessions yet - create one to get started\"\n- No sessions in directory: \"No sessions in [path] yet\"\n\nUnread Badges:\n- Directory level: Aggregate unread across all sessions\n- Session level: Individual session unread count\n- Matches iOS Mail/Messages pattern\n\nPull-to-Refresh:\n- Available at all navigation levels\n- Haptic feedback\n- \"Updated just now\" confirmation\n\nCurrent Code Structure:\n- SessionsView.swift: Contains SessionsListView (current 2-tier implementation)\n- Uses @FetchRequest with CDSession.fetchActiveSessions()\n- Already groups sessions by workingDirectory\n- CDSession model has: id, displayName, workingDirectory, lastModified, unreadCount, messageCount\n\nRelated Issues:\n- voice-code-207: Sessions need to re-sort on updates (affects all levels)\n- voice-code-200: Session visibility improvements (completed)","status":"open","priority":2,"issue_type":"epic","created_at":"2025-10-20T23:02:53.860659-05:00","updated_at":"2025-10-20T23:02:53.860659-05:00"}
{"id":"voice-code-209","title":"Create DirectoryListView for top-level navigation","description":"Create the top-level Directories view that shows working directories sorted by most recent activity.\n\nLocation: Create new file ios/VoiceCode/Views/DirectoryListView.swift\n\nRequirements:\n\n1. Data Model:\n   - Compute list of unique working directories from CDSession entities\n   - For each directory, calculate:\n     * Total session count\n     * Aggregate unread count (sum of all session.unreadCount)\n     * Most recent lastModified timestamp across all sessions\n     * Directory name (last path component, e.g., \"voice-code\" from \"/Users/travis/code/voice-code\")\n   - Sort directories by most recent lastModified descending\n\n2. Directory Row UI (DirectoryRowContent view):\n   - Line 1: HStack with folder icon (SF Symbol \"folder.fill\") + directory name (headline font) + unread badge (if \u003e 0)\n   - Line 2: Full working directory path (caption font, secondary color, lineLimit: 1)\n   - Line 3: HStack with session count + bullet + relative timestamp (caption2 font, secondary color)\n   \n   Example:\n   📁 voice-code                                [2]\n   /Users/travis/code/mono/active/voice-code\n   3 sessions • 2 minutes ago\n\n3. Unread Badge:\n   - Only show if aggregate unread count \u003e 0\n   - Red capsule background, white text, bold font\n   - Same styling as session unread badges\n\n4. Navigation:\n   - Use NavigationLink(value:) to push to SessionsForDirectoryView\n   - Pass working directory path as navigation value\n   - Navigation destination shows sessions filtered to that directory\n\n5. Toolbar:\n   - Refresh button (arrow.clockwise) - calls client.requestSessionList()\n   - Plus button - shows NewSessionView sheet\n   - Settings button (gear) - shows settings\n\n6. Empty State:\n   - When no sessions exist at all\n   - Show folder icon (large), \"No sessions yet\", helpful text\n   - Encourage creating first session\n\n7. Pull-to-Refresh:\n   - Use .refreshable modifier\n   - Calls client.requestSessionList()\n   - Shows activity indicator during refresh\n\nImplementation Notes:\n- Use @FetchRequest to get all CDSession entities with fetchActiveSessions()\n- Compute groupedDirectories in a computed property similar to current SessionsListView.groupedSessions\n- Extract directory name using: (path as NSString).lastPathComponent\n- Calculate relative timestamp using RelativeDateTimeFormatter\n- Follow existing code patterns from SessionsListView.swift\n- Use @Environment(\\.managedObjectContext) for CoreData access\n- Inject VoiceCodeClient, AppSettings, VoiceOutputManager via @ObservedObject\n\nTesting:\n- Verify directories sorted by most recent activity\n- Verify unread badges aggregate correctly\n- Verify navigation pushes to correct directory\n- Verify empty state shows when no sessions\n- Verify pull-to-refresh works","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-20T23:03:14.688497-05:00","updated_at":"2025-10-20T23:15:28.476069-05:00","closed_at":"2025-10-20T23:15:28.476072-05:00","dependencies":[{"issue_id":"voice-code-209","depends_on_id":"voice-code-208","type":"blocks","created_at":"2025-10-20T23:03:14.689706-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-210","title":"Create SessionsForDirectoryView for directory-specific sessions","description":"Create the second-tier view that shows sessions for a specific working directory.\n\nLocation: Create new file ios/VoiceCode/Views/SessionsForDirectoryView.swift\n\nPurpose: When user taps a directory in DirectoryListView, show only sessions for that directory.\n\nRequirements:\n\n1. Input Parameters:\n   - workingDirectory: String (the directory path to filter by)\n   - client: VoiceCodeClient (@ObservedObject)\n   - settings: AppSettings (@ObservedObject)\n   - voiceOutput: VoiceOutputManager (@ObservedObject)\n   - @Environment(\\.managedObjectContext) for CoreData\n\n2. Data Fetching:\n   - Create @FetchRequest that filters CDSession by workingDirectory\n   - Use NSPredicate: format: \"workingDirectory == %@ AND markedDeleted == NO\", workingDirectory\n   - Sort by lastModified descending (most recent first)\n   - This ensures only sessions for THIS directory are shown\n\n3. Session Row UI:\n   - Reuse existing CDSessionRowContent component from SessionsView.swift\n   - Shows: session name, session ID prefix, working directory, message count, preview, unread badge\n   - Same visual design as current implementation\n\n4. Navigation:\n   - Use NavigationLink(value: session.id) to push to ConversationView\n   - Navigation destination looks up session by UUID and shows ConversationView\n   - Reuse existing navigation pattern from SessionsView.swift\n\n5. Toolbar:\n   - Refresh button (arrow.clockwise) - calls client.requestSessionList()\n   - Plus button - shows NewSessionView sheet with workingDirectory pre-filled\n   - Settings button (gear) - shows settings\n   - All three buttons in trailing position\n\n6. Navigation Title:\n   - Extract directory name from path: (workingDirectory as NSString).lastPathComponent\n   - Use .navigationTitle(directoryName)\n   - Example: \"voice-code\" instead of full path\n   - Subtitle could show full path in .navigationBarTitleDisplayMode(.large) mode\n\n7. Empty State:\n   - When directory has no sessions\n   - Show tray icon, \"No sessions in [directoryName]\", helpful text\n   - Suggest creating a new session with + button\n\n8. Swipe Actions:\n   - Swipe-to-delete on session rows\n   - Calls deleteSession() method (same logic as current SessionsListView)\n   - Marks session.markedDeleted = true\n   - Sends session_deleted message to backend\n   - Unsubscribes from session\n\n9. Pull-to-Refresh:\n   - Use .refreshable modifier\n   - Calls client.requestSessionList()\n   - Shows activity indicator during refresh\n\n10. Session Deletion Logic:\n    - Copy deleteSession() method from SessionsView.swift\n    - Mark session.markedDeleted = true\n    - Clean up draft via draftManager.cleanupDraft(sessionID:)\n    - Unsubscribe: client.unsubscribe(sessionId:)\n    - Send session_deleted message to backend\n    - Save context\n\nImplementation Notes:\n- This view is very similar to current SessionsListView but filtered to one directory\n- Extract directory name for title: let directoryName = (workingDirectory as NSString).lastPathComponent\n- Pre-fill NewSessionView with workingDirectory when + button tapped\n- Follow existing patterns from SessionsView.swift for consistency\n- Use List with ForEach over filtered sessions\n- NavigationLink should use .navigationDestination(for: UUID.self) pattern\n\nFetchRequest Example:\n@FetchRequest var sessions: FetchedResults\u003cCDSession\u003e\n\ninit(workingDirectory: String, ...) {\n    self.workingDirectory = workingDirectory\n    _sessions = FetchRequest\u003cCDSession\u003e(\n        sortDescriptors: [NSSortDescriptor(keyPath: \\CDSession.lastModified, ascending: false)],\n        predicate: NSPredicate(format: \"workingDirectory == %@ AND markedDeleted == NO\", workingDirectory),\n        animation: .default\n    )\n}\n\nTesting:\n- Verify only sessions for specified directory appear\n- Verify navigation to conversation works\n- Verify + button pre-fills directory\n- Verify swipe-to-delete works\n- Verify empty state shows correctly\n- Verify pull-to-refresh updates list","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-20T23:03:57.06582-05:00","updated_at":"2025-10-20T23:15:28.491871-05:00","closed_at":"2025-10-20T23:15:28.491872-05:00","dependencies":[{"issue_id":"voice-code-210","depends_on_id":"voice-code-209","type":"blocks","created_at":"2025-10-20T23:03:57.06681-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-211","title":"Update app navigation to use DirectoryListView as root","description":"Update VoiceCodeApp.swift and related navigation code to use DirectoryListView as the root view instead of SessionsListView.\n\nLocation: ios/VoiceCode/VoiceCodeApp.swift\n\nCurrent Structure:\n- VoiceCodeApp → NavigationStack → SessionsListView (2-tier)\n\nTarget Structure:\n- VoiceCodeApp → NavigationStack → DirectoryListView → SessionsForDirectoryView → ConversationView (3-tier)\n\nRequirements:\n\n1. Update VoiceCodeApp.swift:\n   - Change root view from SessionsListView to DirectoryListView\n   - Keep existing NavigationStack wrapper\n   - Maintain all @StateObject injections (client, settings, voiceOutput, draftManager, etc.)\n   - Pass all required dependencies to DirectoryListView\n\n2. Navigation Path Setup:\n   - NavigationStack should handle two navigation types:\n     * String (working directory path) - navigates to SessionsForDirectoryView\n     * UUID (session ID) - navigates to ConversationView\n   - Use .navigationDestination(for: String.self) for directory navigation\n   - Use .navigationDestination(for: UUID.self) for session navigation\n   - Both navigationDestination modifiers should be on NavigationStack\n\n3. Navigation Destination Handlers:\n   \n   For directories (String):\n   .navigationDestination(for: String.self) { workingDirectory in\n       SessionsForDirectoryView(\n           workingDirectory: workingDirectory,\n           client: client,\n           settings: settings,\n           voiceOutput: voiceOutput,\n           showingSettings: $showingSettings\n       )\n       .environment(\\.managedObjectContext, persistenceController.container.viewContext)\n       .environmentObject(draftManager)\n   }\n   \n   For sessions (UUID):\n   .navigationDestination(for: UUID.self) { sessionId in\n       // Look up session from CoreData\n       // Show ConversationView or \"Session Not Found\" message\n   }\n\n4. Session Lookup Logic:\n   - For UUID navigation destination, need to fetch CDSession by ID\n   - Cannot use @FetchRequest in navigationDestination closure\n   - Options:\n     a) Pass viewContext and perform fetch directly\n     b) Use SessionLookupView wrapper that has @FetchRequest\n     c) Store navigation session in @State and use onChange\n   - Recommended: Create SessionLookupView(sessionId: UUID) wrapper view\n\n5. Create SessionLookupView Helper:\n   - New view: ios/VoiceCode/Views/SessionLookupView.swift\n   - Takes sessionId: UUID parameter\n   - Uses @FetchRequest to fetch session by ID\n   - If found: shows ConversationView(session:)\n   - If not found: shows \"Session Not Found\" error message\n   - This keeps navigation destination clean and SwiftUI-friendly\n\n6. Preserve Existing Behavior:\n   - Settings sheet should still work (@State var showingSettings)\n   - NewSessionView sheet should still work\n   - All dependency injection should flow through navigation hierarchy\n   - Draft manager should be accessible via @EnvironmentObject at all levels\n\n7. Remove Old Code:\n   - SessionsListView can eventually be deleted (after SessionsForDirectoryView is confirmed working)\n   - Keep CDSessionRowContent component (reused in SessionsForDirectoryView)\n   - Keep NewSessionView (reused in both DirectoryListView and SessionsForDirectoryView)\n\n8. Testing Requirements:\n   - Verify app launches to DirectoryListView\n   - Verify tapping directory navigates to SessionsForDirectoryView\n   - Verify tapping session navigates to ConversationView\n   - Verify back button works at each level\n   - Verify settings and new session creation still work\n   - Verify deep linking (if applicable) still works\n   - Verify state preservation during navigation\n\nImplementation Notes:\n- NavigationStack supports heterogeneous navigation paths (String and UUID)\n- Each .navigationDestination(for:) handles one type\n- Directory navigation: DirectoryListView → SessionsForDirectoryView\n- Session navigation: SessionsForDirectoryView → ConversationView (via SessionLookupView)\n- Keep dependency injection consistent across all views\n- Use .environment() and .environmentObject() to pass context and managers\n\nExample VoiceCodeApp Structure:\nstruct VoiceCodeApp: App {\n    @StateObject private var client = VoiceCodeClient(...)\n    @StateObject private var settings = AppSettings()\n    @StateObject private var voiceOutput = VoiceOutputManager()\n    @StateObject private var draftManager = DraftManager()\n    let persistenceController = PersistenceController.shared\n    \n    @State private var showingSettings = false\n    \n    var body: some Scene {\n        WindowGroup {\n            NavigationStack {\n                DirectoryListView(\n                    client: client,\n                    settings: settings,\n                    voiceOutput: voiceOutput,\n                    showingSettings: $showingSettings\n                )\n                .navigationDestination(for: String.self) { workingDirectory in\n                    SessionsForDirectoryView(...)\n                }\n                .navigationDestination(for: UUID.self) { sessionId in\n                    SessionLookupView(sessionId: sessionId, ...)\n                }\n            }\n            .environment(\\.managedObjectContext, persistenceController.container.viewContext)\n            .environmentObject(draftManager)\n            .sheet(isPresented: $showingSettings) {\n                SettingsView(...)\n            }\n        }\n    }\n}\n\nTesting:\n- Launch app, verify DirectoryListView appears\n- Tap directory, verify SessionsForDirectoryView appears with filtered sessions\n- Tap session, verify ConversationView appears\n- Tap back from conversation, verify SessionsForDirectoryView appears\n- Tap back from sessions, verify DirectoryListView appears\n- Verify settings button works at all levels\n- Verify new session creation works at all levels","status":"closed","priority":2,"issue_type":"task","created_at":"2025-10-20T23:04:26.753407-05:00","updated_at":"2025-10-20T23:15:28.50436-05:00","closed_at":"2025-10-20T23:15:28.504361-05:00","dependencies":[{"issue_id":"voice-code-211","depends_on_id":"voice-code-209","type":"blocks","created_at":"2025-10-20T23:04:26.754898-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-211","depends_on_id":"voice-code-210","type":"blocks","created_at":"2025-10-20T23:04:26.755558-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-212","title":"Add relative timestamp formatting for directory rows","description":"Add relative timestamp formatting utility for displaying \"2 minutes ago\", \"3 hours ago\", etc. in directory and session rows.\n\nLocation: Create ios/VoiceCode/Utilities/RelativeTimeFormatter.swift\n\nPurpose: Convert Date objects to human-readable relative timestamps like iOS Mail/Messages.\n\nRequirements:\n\n1. Create RelativeTimeFormatter utility:\n   - Input: Date object\n   - Output: String like \"just now\", \"2 minutes ago\", \"3 hours ago\", \"2 days ago\", \"Jan 15\"\n\n2. Time Formatting Rules:\n   - \u003c 1 minute: \"just now\"\n   - \u003c 1 hour: \"X minutes ago\" (e.g., \"5 minutes ago\")\n   - \u003c 24 hours: \"X hours ago\" (e.g., \"3 hours ago\")\n   - \u003c 7 days: \"X days ago\" (e.g., \"2 days ago\")\n   - \u003e= 7 days: Abbreviated date \"MMM d\" (e.g., \"Jan 15\", \"Oct 20\")\n   - Different year: \"MMM d, yyyy\" (e.g., \"Dec 25, 2024\")\n\n3. Implementation Approach:\n   - Use Foundation's RelativeDateTimeFormatter for \u003c 7 days\n   - Use DateFormatter for \u003e= 7 days\n   - Detect if date is in current year vs. past year\n   - Cache formatters (DateFormatter initialization is expensive)\n\n4. API Design:\n   extension Date {\n       func relativeFormatted() -\u003e String\n   }\n   \n   Usage:\n   Text(session.lastModified.relativeFormatted())\n\n5. Locale Support:\n   - Use system locale from RelativeDateTimeFormatter\n   - Automatically adapts to user's language/region\n   - Respects 12/24 hour time preferences\n\n6. Example Implementation:\n   \n   static let relativeFormatter: RelativeDateTimeFormatter = {\n       let formatter = RelativeDateTimeFormatter()\n       formatter.unitsStyle = .full // \"2 minutes ago\" not \"2 min ago\"\n       return formatter\n   }()\n   \n   static let dateFormatter: DateFormatter = {\n       let formatter = DateFormatter()\n       formatter.dateFormat = \"MMM d\"\n       return formatter\n   }()\n   \n   static let dateFormatterWithYear: DateFormatter = {\n       let formatter = DateFormatter()\n       formatter.dateFormat = \"MMM d, yyyy\"\n       return formatter\n   }()\n   \n   extension Date {\n       func relativeFormatted() -\u003e String {\n           let now = Date()\n           let interval = now.timeIntervalSince(self)\n           \n           // Less than 1 minute\n           if interval \u003c 60 {\n               return \"just now\"\n           }\n           \n           // Less than 7 days: use RelativeDateTimeFormatter\n           if interval \u003c 7 * 24 * 60 * 60 {\n               return RelativeTimeFormatter.relativeFormatter.localizedString(for: self, relativeTo: now)\n           }\n           \n           // 7+ days: use date format\n           let calendar = Calendar.current\n           if calendar.isDate(self, equalTo: now, toGranularity: .year) {\n               return RelativeTimeFormatter.dateFormatter.string(from: self)\n           } else {\n               return RelativeTimeFormatter.dateFormatterWithYear.string(from: self)\n           }\n       }\n   }\n\n7. Usage in Views:\n   - DirectoryRowContent: session.lastModified.relativeFormatted()\n   - Could also use in SessionRowContent for consistency\n   - Updates automatically when view refreshes\n\n8. Edge Cases:\n   - Future dates: Show \"just now\" (shouldn't happen but defensive)\n   - Very old dates (years ago): Show \"MMM d, yyyy\"\n   - Nil dates: Caller should handle (optional Date? should use ?? \"Never\")\n\n9. Performance Considerations:\n   - Cache formatter instances (static let)\n   - Don't create new formatters on each call\n   - Formatting is fast enough for List with 50-100 items\n\nTesting:\n- Verify \"just now\" for dates \u003c 1 minute ago\n- Verify \"X minutes ago\" for recent dates\n- Verify \"X hours ago\" for dates today\n- Verify \"X days ago\" for dates this week\n- Verify \"MMM d\" for dates \u003e 7 days in current year\n- Verify \"MMM d, yyyy\" for dates in past years\n- Verify locale support (test with different system languages)","status":"open","priority":3,"issue_type":"task","created_at":"2025-10-20T23:04:50.892869-05:00","updated_at":"2025-10-20T23:04:50.892869-05:00","dependencies":[{"issue_id":"voice-code-212","depends_on_id":"voice-code-209","type":"blocks","created_at":"2025-10-20T23:04:50.894481-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-213","title":"Add unit tests for 3-tier navigation","description":"Add comprehensive unit tests for DirectoryListView, SessionsForDirectoryView, and navigation behavior.\n\nLocation: Create ios/VoiceCodeTests/DirectoryNavigationTests.swift\n\nPurpose: Ensure 3-tier navigation works correctly, directories are computed and sorted properly, and UI displays correct data.\n\nRequirements:\n\n1. Test Directory Grouping and Sorting:\n   - Create multiple sessions across different working directories\n   - Verify directories list is computed correctly\n   - Verify directories sorted by most recent session.lastModified descending\n   - Verify directory names extracted correctly from paths\n\n2. Test Aggregate Unread Counts:\n   - Create sessions with various unreadCount values\n   - Verify directory unread count = sum of all session unreadCounts in that directory\n   - Verify unread badge shows correct total\n   - Verify badge hidden when unread count = 0\n\n3. Test Session Filtering by Directory:\n   - Create sessions in multiple directories\n   - Verify SessionsForDirectoryView shows only sessions for specified directory\n   - Verify sessions sorted by lastModified descending\n   - Verify sessions in other directories not shown\n\n4. Test Navigation State:\n   - Verify NavigationStack handles String (directory) navigation\n   - Verify NavigationStack handles UUID (session) navigation  \n   - Verify back navigation works correctly\n   - Verify navigation path maintained during session\n\n5. Test Empty States:\n   - No sessions at all → DirectoryListView shows empty state\n   - Directory with no sessions → SessionsForDirectoryView shows empty state\n   - Verify empty state messages correct\n\n6. Test Directory Name Extraction:\n   - Test paths: \"/Users/travis/code/voice-code\" → \"voice-code\"\n   - Test paths: \"/tmp\" → \"tmp\"\n   - Test paths: \"\" (empty) → handle gracefully\n   - Test paths: \"/\" (root) → handle gracefully\n   - Use (path as NSString).lastPathComponent\n\n7. Test Most Recent Timestamp Calculation:\n   - Directory with 3 sessions, different lastModified times\n   - Verify directory shows most recent timestamp\n   - Update one session's lastModified, verify directory timestamp updates\n\n8. Test Session Count Per Directory:\n   - Create 5 sessions in dir A, 3 in dir B\n   - Verify dir A shows \"5 sessions\"\n   - Verify dir B shows \"3 sessions\"\n   - Verify singular \"1 session\" for directory with one session\n\n9. Mock Data Setup:\n   Helper methods to create test data:\n   \n   func createSession(\n       workingDirectory: String,\n       lastModified: Date,\n       unreadCount: Int32,\n       messageCount: Int32\n   ) -\u003e CDSession {\n       let session = CDSession(context: context)\n       session.id = UUID()\n       session.workingDirectory = workingDirectory\n       session.lastModified = lastModified\n       session.unreadCount = unreadCount\n       session.messageCount = messageCount\n       session.backendName = \"Test Session\"\n       session.markedDeleted = false\n       session.preview = \"Preview\"\n       try! context.save()\n       return session\n   }\n\n10. Test Cases to Write:\n    - testDirectoriesGroupedCorrectly()\n    - testDirectoriesSortedByMostRecent()\n    - testDirectoryAggregateUnreadCount()\n    - testDirectorySessionCount()\n    - testDirectoryNameExtraction()\n    - testSessionsFilteredByDirectory()\n    - testSessionsSortedByLastModified()\n    - testEmptyDirectoriesList()\n    - testEmptySessionsInDirectory()\n    - testDirectoryWithSingleSession()\n    - testDirectoryWithMultipleSessions()\n    - testUnreadBadgeHiddenWhenZero()\n    - testUnreadBadgeShownWhenNonZero()\n\n11. CoreData Test Setup:\n    - Use in-memory PersistenceController for tests\n    - Create fresh context for each test\n    - Clean up after each test\n    \n    override func setUpWithError() throws {\n        persistenceController = PersistenceController(inMemory: true)\n        context = persistenceController.container.viewContext\n    }\n    \n    override func tearDownWithError() throws {\n        context = nil\n        persistenceController = nil\n    }\n\n12. Computed Property Testing:\n    - Test computed properties like groupedDirectories\n    - Test sorting logic\n    - Test filtering logic\n    - Use snapshot testing or manual verification\n\n13. Edge Cases:\n    - Empty working directory string\n    - Working directory = \"/\" (root)\n    - Very long directory paths\n    - Special characters in paths\n    - Multiple sessions with identical timestamps\n    - Sessions marked as deleted (should be filtered out)\n\nImplementation Notes:\n- Use XCTest framework\n- Import @testable import VoiceCode to access internal methods\n- Use in-memory CoreData store for isolation\n- Create helper methods for common test data setup\n- Follow existing test patterns from SessionSyncManagerTests.swift\n- Use XCTAssertEqual, XCTAssertTrue, XCTAssertNotNil for assertions\n- Test both successful cases and edge cases\n\nTesting:\n- Run all tests: xcodebuild test -scheme VoiceCode -only-testing:VoiceCodeTests/DirectoryNavigationTests\n- Verify all tests pass\n- Verify test coverage for grouping, sorting, filtering, navigation","status":"open","priority":2,"issue_type":"task","created_at":"2025-10-20T23:05:20.654893-05:00","updated_at":"2025-10-20T23:05:20.654893-05:00","dependencies":[{"issue_id":"voice-code-213","depends_on_id":"voice-code-209","type":"blocks","created_at":"2025-10-20T23:05:20.656401-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-213","depends_on_id":"voice-code-210","type":"blocks","created_at":"2025-10-20T23:05:20.656835-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-213","depends_on_id":"voice-code-211","type":"blocks","created_at":"2025-10-20T23:05:20.657094-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-214","title":"Update NewSessionView to work with directory-first navigation","description":"Update NewSessionView to support both directory-level and top-level session creation, with improved UX for directory selection.\n\nLocation: ios/VoiceCode/Views/SessionsView.swift (NewSessionView component)\n\nCurrent Behavior:\n- NewSessionView has text field for working directory\n- User must type full path manually\n- Used from SessionsListView only\n\nTarget Behavior:\n- When opened from DirectoryListView (top-level): Show directory picker or text field\n- When opened from SessionsForDirectoryView: Pre-fill and lock directory field\n- Make directory selection easier with suggestions\n\nRequirements:\n\n1. Add Context Awareness:\n   - New parameter: prefilledDirectory: String? = nil\n   - If prefilledDirectory provided: Lock that field, show as read-only\n   - If nil: Show directory selection UI\n\n2. Directory Selection UI (when not pre-filled):\n   Option A - Picker from existing directories:\n   - Show Picker with list of existing working directories\n   - Plus \"Custom...\" option to enter new path\n   - Default to most recently used directory\n   \n   Option B - Text field with suggestions:\n   - TextField with autocomplete\n   - Show list of existing directories as suggestions below\n   - Tap suggestion to fill field\n   \n   Recommendation: Option A (Picker) for simpler UX\n\n3. Pre-filled Directory Display:\n   - When prefilledDirectory provided:\n   - Show directory in Text (not TextField)\n   - Add label \"Working Directory: [path]\"\n   - Gray out and non-editable\n   - User understands session will be created in this directory\n\n4. Form Structure (Pre-filled):\n   Section(header: Text(\"Session Details\")) {\n       TextField(\"Session Name\", text: $name)\n       \n       // Pre-filled, read-only\n       VStack(alignment: .leading) {\n           Text(\"Working Directory\")\n               .font(.caption)\n               .foregroundColor(.secondary)\n           Text(prefilledDirectory ?? \"\")\n               .font(.body)\n       }\n   }\n\n5. Form Structure (Top-level):\n   Section(header: Text(\"Session Details\")) {\n       TextField(\"Session Name\", text: $name)\n       \n       Picker(\"Working Directory\", selection: $selectedDirectory) {\n           ForEach(existingDirectories, id: \\.self) { dir in\n               Text((dir as NSString).lastPathComponent).tag(dir)\n           }\n           Text(\"Custom...\").tag(\"__custom__\")\n       }\n       \n       if selectedDirectory == \"__custom__\" {\n           TextField(\"Custom Directory Path\", text: $customDirectory)\n               .autocapitalization(.none)\n               .disableAutocorrection(true)\n       }\n   }\n\n6. Data Flow:\n   - DirectoryListView: Calls NewSessionView(prefilledDirectory: nil, onCreate: ...)\n   - SessionsForDirectoryView: Calls NewSessionView(prefilledDirectory: workingDirectory, onCreate: ...)\n   - onCreate closure receives (name: String, workingDirectory: String)\n   - Parent view creates session in CoreData\n\n7. Existing Directories List:\n   - Pass as parameter: existingDirectories: [String]\n   - Computed in parent view from @FetchRequest sessions\n   - Extract unique working directories: Set(sessions.map { $0.workingDirectory })\n   - Sorted by most recent usage (or alphabetically)\n\n8. Validation:\n   - Disable Create button if name.isEmpty\n   - Disable Create button if directory.isEmpty (when custom entry)\n   - Show validation error for invalid paths (optional)\n\n9. Updated API:\n   struct NewSessionView: View {\n       @Binding var name: String\n       @Binding var workingDirectory: String\n       let prefilledDirectory: String? // New parameter\n       let existingDirectories: [String] // New parameter\n       let onCreate: () -\u003e Void\n       let onCancel: () -\u003e Void\n       \n       @State private var selectedDirectory: String\n       @State private var showCustomPath: Bool = false\n       \n       init(...) {\n           // If pre-filled, use that\n           // Otherwise default to first existing directory\n       }\n   }\n\n10. Usage Examples:\n    \n    From DirectoryListView:\n    NewSessionView(\n        name: $newSessionName,\n        workingDirectory: $newWorkingDirectory,\n        prefilledDirectory: nil,\n        existingDirectories: Array(Set(sessions.map { $0.workingDirectory })),\n        onCreate: { ... },\n        onCancel: { ... }\n    )\n    \n    From SessionsForDirectoryView:\n    NewSessionView(\n        name: $newSessionName,\n        workingDirectory: .constant(workingDirectory), // Constant binding\n        prefilledDirectory: workingDirectory,\n        existingDirectories: [],\n        onCreate: { ... },\n        onCancel: { ... }\n    )\n\n11. Examples Section:\n    - Keep existing examples for custom paths\n    - Add note: \"Or choose from existing directories above\"\n    - Update examples to be more relevant\n\n12. Empty Directories Case:\n    - If existingDirectories.isEmpty (first session ever)\n    - Show TextField for manual entry\n    - Provide helpful examples\n    - Default to FileManager.default.currentDirectoryPath\n\nImplementation Notes:\n- Maintain backward compatibility during transition\n- prefilledDirectory = nil means top-level creation\n- prefilledDirectory = some path means directory-level creation\n- Use Picker for better UX than manual typing\n- Extract directory name for display: (path as NSString).lastPathComponent\n- Sort existing directories by most recent use for better UX\n\nTesting:\n- Verify pre-filled directory is read-only\n- Verify picker shows existing directories\n- Verify custom directory entry works\n- Verify validation prevents empty fields\n- Verify Create button disabled appropriately\n- Verify Cancel button works\n- Test with 0 existing directories (first session)\n- Test with 5+ existing directories","status":"open","priority":3,"issue_type":"task","created_at":"2025-10-20T23:05:54.455784-05:00","updated_at":"2025-10-20T23:05:54.455784-05:00","dependencies":[{"issue_id":"voice-code-214","depends_on_id":"voice-code-209","type":"blocks","created_at":"2025-10-20T23:05:54.457567-05:00","created_by":"travisbrown"},{"issue_id":"voice-code-214","depends_on_id":"voice-code-210","type":"blocks","created_at":"2025-10-20T23:05:54.458225-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-215","title":"Add swipe actions for directories","description":"Add swipe actions on directory rows for bulk operations (mark all read, etc.).\n\nLocation: ios/VoiceCode/Views/DirectoryListView.swift\n\nPurpose: Allow users to perform actions on all sessions within a directory at once.\n\nRequirements:\n\n1. Swipe Actions to Implement:\n   \n   Primary Action - Mark All Read:\n   - Swipe left on directory row\n   - Blue button with checkmark icon\n   - Sets unreadCount = 0 for all sessions in that directory\n   - Provides haptic feedback\n   - Most common action, non-destructive\n   \n   Secondary Action - Archive/Hide All (Optional):\n   - Could add in future\n   - Not in initial scope\n\n2. Mark All Read Implementation:\n   \n   .swipeActions(edge: .trailing) {\n       Button {\n           markAllReadInDirectory(workingDirectory)\n       } label: {\n           Label(\"Mark All Read\", systemImage: \"checkmark.circle.fill\")\n       }\n       .tint(.blue)\n   }\n   \n   func markAllReadInDirectory(_ directory: String) {\n       let fetchRequest = CDSession.fetchRequest()\n       fetchRequest.predicate = NSPredicate(\n           format: \"workingDirectory == %@ AND markedDeleted == NO\",\n           directory\n       )\n       \n       if let sessions = try? viewContext.fetch(fetchRequest) {\n           for session in sessions {\n               session.unreadCount = 0\n           }\n           \n           do {\n               try viewContext.save()\n               // Optional: Send mark_read message to backend for each session\n               // Or add new backend message type: mark_directory_read\n           } catch {\n               print(\"Failed to mark all read: \\(error)\")\n           }\n       }\n   }\n\n3. Haptic Feedback:\n   - Use UIImpactFeedbackGenerator on successful action\n   - Provides tactile confirmation\n   \n   let generator = UIImpactFeedbackGenerator(style: .medium)\n   generator.impactOccurred()\n\n4. Visual Feedback:\n   - Unread badge should disappear immediately after action\n   - View should update reactively (SwiftUI + CoreData)\n   - No need for manual refresh\n\n5. Backend Synchronization:\n   - Consider whether to notify backend of mark-all-read\n   - If backend tracks read state, send message for each session\n   - If backend doesn't track read state, no action needed\n   - Check existing protocol for mark_read message type\n\n6. Edge Cases:\n   - Directory with 0 unread messages: Action still available, no-op\n   - Directory with 50+ sessions: Could be slow, consider progress indicator\n   - Offline mode: Queue messages for later sync (if applicable)\n\n7. Alternative Actions (Future):\n   - \"Delete All\" (destructive, needs confirmation alert)\n   - \"Archive All\" (hide but don't delete)\n   - \"Export All\" (export sessions to file)\n   - Not in scope for initial implementation\n\n8. Confirmation Dialogs:\n   - Mark All Read: No confirmation needed (non-destructive, easy to undo by receiving new messages)\n   - Delete All: Would need confirmation alert (destructive)\n\n9. Accessibility:\n   - Ensure swipe actions have accessibility labels\n   - Support VoiceOver\n   - Ensure button tap targets are large enough\n\nImplementation Notes:\n- Use .swipeActions modifier on NavigationLink or row container\n- Mark All Read is the most valuable action (reduces cognitive load)\n- Keep swipe actions simple, avoid too many options\n- Follow iOS Mail pattern: swipe for common actions\n- Ensure viewContext saves properly trigger UI updates\n- Test with many sessions to ensure performance\n\nTesting:\n- Verify swipe action appears on directory row\n- Verify Mark All Read sets all session unreadCounts to 0\n- Verify unread badge disappears from directory row\n- Verify haptic feedback occurs\n- Verify action works with 1 session, 10 sessions, 50 sessions\n- Verify action is no-op when already all read\n- Verify accessibility labels present","status":"open","priority":3,"issue_type":"task","created_at":"2025-10-20T23:06:20.343483-05:00","updated_at":"2025-10-20T23:06:20.343483-05:00","dependencies":[{"issue_id":"voice-code-215","depends_on_id":"voice-code-209","type":"blocks","created_at":"2025-10-20T23:06:20.345262-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-30","title":"Set up Tailscale on server and iPhone","description":"","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-13T22:17:34.247689-05:00","updated_at":"2025-10-17T17:47:56.62732-05:00","closed_at":"2025-10-17T17:47:56.62732-05:00"}
{"id":"voice-code-47","title":"Fix tilde expansion in working directory paths","description":"The Examples shows ~/code/voice-code but the server fails with 'Cannot run program in directory ~/code/mono: No such file or directory'. Java's ProcessBuilder doesn't expand tildes - need to expand ~ to actual home directory in invoke-claude before passing to shell/sh","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-14T21:17:39.392349-05:00","updated_at":"2025-10-17T17:21:36.504931-05:00","closed_at":"2025-10-17T17:21:36.504931-05:00"}
{"id":"voice-code-49","title":"Exclude code blocks from text-to-speech","description":"Code blocks should be visible in the markdown display but not read aloud. Code is important to see but terrible to hear spoken.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-10-14T21:30:59.411847-05:00","updated_at":"2025-10-18T18:35:21.505247-05:00","closed_at":"2025-10-18T18:35:21.505247-05:00"}
{"id":"voice-code-73","title":"\"Write","description":"","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-16T22:51:51.743518-05:00","updated_at":"2025-10-17T17:31:24.730402-05:00","closed_at":"2025-10-17T17:31:24.730402-05:00"}
{"id":"voice-code-74","title":"Build session metadata index system","description":"Scan .jsonl files on startup to extract metadata and build in-memory index.\n\n- Scan .claude/projects directory recursively for .jsonl files\n- Extract metadata: session-id, name, working-dir, created-at, last-modified, message-count, preview\n- Build in-memory map: session-id to metadata\n- Persist index to .claude/.session-index.edn for fast reload\n- Load from persisted index on subsequent startups","acceptance_criteria":"Can build index from 100+ .jsonl files, index persists to .edn, subsequent startups load from .edn (\u003c1 second), contains all required metadata fields","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-16T22:52:20.331367-05:00","updated_at":"2025-10-17T09:48:50.563147-05:00","closed_at":"2025-10-17T09:48:50.563147-05:00","dependencies":[{"issue_id":"voice-code-74","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.48993-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-75","title":"Implement .jsonl parser","description":"Parse Claude Code .jsonl format to extract messages.\n\n- Parse .jsonl files (one JSON object per line)\n- Extract message fields: role, text, timestamp\n- Handle incremental parsing (read only new lines since last position)\n- Track last-read byte position per file for incremental reads\n- Error handling for malformed JSON lines (skip and log)\n- Return structured message list","acceptance_criteria":"Can parse full .jsonl file into message list, can parse only new lines incrementally (given last position), handles malformed JSON gracefully, returns normalized message structure","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-16T22:52:28.433104-05:00","updated_at":"2025-10-17T09:48:50.563851-05:00","closed_at":"2025-10-17T09:48:50.563851-05:00","dependencies":[{"issue_id":"voice-code-75","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.501942-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-76","title":"Add filesystem watcher with debouncing","description":"Watch .claude/projects for file changes using Java NIO WatchService.\n\n- Use Java NIO WatchService to watch directory\n- Listen for: ENTRY_CREATE, ENTRY_MODIFY, ENTRY_DELETE events\n- Implement debouncing: wait 200ms of quiet before processing\n- Implement parse-retry: retry up to 3 times if parse fails (100ms between retries)\n- Update metadata index when files change\n- Handle partial writes (debouncing prevents reading mid-write)","acceptance_criteria":"Detects new .jsonl files (ENTRY_CREATE), detects modifications (ENTRY_MODIFY) with debouncing, handles partial writes without errors (debounce + retry), updates index when files change","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-16T22:52:36.699982-05:00","updated_at":"2025-10-17T09:48:50.564111-05:00","closed_at":"2025-10-17T09:48:50.564111-05:00","dependencies":[{"issue_id":"voice-code-76","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.514947-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-77","title":"Implement selective file watching","description":"Track subscribed sessions and only watch their .jsonl files.\n\n- Maintain atom of subscribed session IDs\n- When iOS subscribes: add to set, start watching that specific .jsonl file\n- When iOS unsubscribes: remove from set, stop watching file\n- Always watch parent directory for new file creation (ENTRY_CREATE)\n- Only send updates for subscribed sessions\n- Limit to ~5-10 watched files per client","acceptance_criteria":"Only watches .jsonl files for subscribed sessions, always detects new session creation, unwatches when client unsubscribes, performance: \u003c5% CPU overhead with 10 subscriptions","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-16T22:52:44.372774-05:00","updated_at":"2025-10-17T09:48:50.564354-05:00","closed_at":"2025-10-17T09:48:50.564354-05:00","dependencies":[{"issue_id":"voice-code-77","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.527678-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-78","title":"Add session_list message handler","description":"Send session metadata index to iOS on connection.\n\n- On WebSocket connection (after hello), send session_list message\n- Include all session metadata from index\n- Format: {type: session_list, sessions: [{session_id, name, working_directory, last_modified, message_count, preview}]}\n- Performance target: \u003c1 second to send 666 sessions\n- Use snake_case for JSON keys (per standards)","acceptance_criteria":"Sends complete session list on connection, JSON format matches protocol spec, performance: \u003c1s for 666 sessions over local network, iOS can parse and display immediately","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-16T22:52:52.303266-05:00","updated_at":"2025-10-17T09:48:50.56454-05:00","closed_at":"2025-10-17T09:48:50.56454-05:00","dependencies":[{"issue_id":"voice-code-78","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.54393-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-79","title":"Add session_subscribe message handler","description":"Parse .jsonl file on-demand and send full conversation history.\n\n- Handle subscribe message from iOS: {type: subscribe, session_id: \"...\"}\n- Parse requested .jsonl file (lazy load)\n- Extract all messages from file\n- Send session_history: {type: session_history, session_id: \"...\", messages: [...]}\n- Add session to watched set (start monitoring for changes)\n- Track last-read position for incremental updates","acceptance_criteria":"Parses .jsonl on subscribe (lazy), sends full message history to iOS, adds to watched sessions set, handles missing files gracefully (error message)","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-16T22:53:01.262046-05:00","updated_at":"2025-10-17T09:48:50.564714-05:00","closed_at":"2025-10-17T09:48:50.564714-05:00","dependencies":[{"issue_id":"voice-code-79","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.557991-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-80","title":"Add session_updated message handler","description":"Send incremental updates for watched sessions.\n\n- Triggered by filesystem watcher (after debouncing)\n- Parse only new messages (using last-read position)\n- Send to subscribed iOS clients: {type: session_updated, session_id: \"...\", messages: [new messages]}\n- Update last-read position after successful parse\n- Only send to iOS clients subscribed to this session","acceptance_criteria":"Sends only new messages (incremental), triggered by file modification events, updates tracked position after send, only sends to subscribed clients","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-16T22:53:08.200542-05:00","updated_at":"2025-10-17T09:48:50.56491-05:00","closed_at":"2025-10-17T09:48:50.56491-05:00","dependencies":[{"issue_id":"voice-code-80","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.580333-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-81","title":"Add session_created message handler","description":"Broadcast new session creation to all iOS clients.\n\n- Triggered by filesystem watcher (ENTRY_CREATE event)\n- Extract metadata from new .jsonl file\n- Add to metadata index\n- Broadcast to all connected iOS clients: {type: session_created, session_id: \"...\", name: \"...\", ...}\n- iOS will auto-subscribe to new sessions","acceptance_criteria":"Detects new .jsonl files immediately, extracts and indexes metadata, broadcasts to all connected clients, iOS receives and can auto-subscribe","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-16T22:53:16.509673-05:00","updated_at":"2025-10-17T09:48:50.565107-05:00","closed_at":"2025-10-17T09:48:50.565107-05:00","dependencies":[{"issue_id":"voice-code-81","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.597567-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-82","title":"Add session_deleted message handler","description":"Track iOS client deletions and stop replication.\n\n- Handle session_deleted from iOS: {type: session_deleted, session_id: \"...\"}\n- Track deleted sessions per iOS client (in client state map)\n- Unsubscribe from session (stop watching)\n- Ignore future updates for this session for this client\n- Do NOT delete backend .jsonl file (file remains on dev machine)","acceptance_criteria":"Unsubscribes from deleted session, stops sending updates to that iOS client, file remains on backend (not deleted), other clients still receive updates","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-16T22:53:23.853474-05:00","updated_at":"2025-10-17T09:48:50.565295-05:00","closed_at":"2025-10-17T09:48:50.565295-05:00","dependencies":[{"issue_id":"voice-code-82","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.611699-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-83","title":"Update prompt handler for new/resume distinction","description":"Support new_session_id vs resume_session_id fields.\n\n- Parse new_session_id field: call claude --session-id \u003cid\u003e \"prompt\"\n- Parse resume_session_id field: call claude --resume \u003cid\u003e \"prompt\"\n- Remove direct response message (responses come via subscription)\n- iOS generates UUID for new sessions\n- Send only ack, responses come via session_updated\n\nProtocol:\n- {type: prompt, new_session_id: \"...\", text: \"...\"} → --session-id\n- {type: prompt, resume_session_id: \"...\", text: \"...\"} → --resume","acceptance_criteria":"Handles new_session_id correctly (--session-id), handles resume_session_id correctly (--resume), no direct response message, responses flow through subscription path","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-16T22:53:33.011989-05:00","updated_at":"2025-10-17T09:48:50.56549-05:00","closed_at":"2025-10-17T09:48:50.56549-05:00","dependencies":[{"issue_id":"voice-code-83","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.634188-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-84","title":"Remove old session persistence logic","description":"Clean up iOS session UUID mapping and sessions.edn storage.\n\n- Remove sessions.edn file and storage logic\n- Remove channel-to-session atom mapping\n- Remove iOS session UUID → Claude session ID mapping\n- Remove register-channel! and related functions\n- Simplify to pure session replication (no session state management)\n- Update tests to reflect new architecture","acceptance_criteria":"sessions.edn storage removed, iOS session UUID mapping removed, code simplified (session replication only), all tests passing with new architecture","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-16T22:53:40.407256-05:00","updated_at":"2025-10-17T09:48:50.565636-05:00","closed_at":"2025-10-17T09:48:50.565636-05:00","dependencies":[{"issue_id":"voice-code-84","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.651891-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-85","title":"Add session naming logic","description":"Generate default names for sessions.\n\n- Terminal sessions: \"Terminal: \u003cdir-name\u003e - \u003ctimestamp\u003e\"\n- iOS sessions: \"Voice: \u003cdir-name\u003e - \u003ctimestamp\u003e\"\n- Detect forks: \"\u003cparent-name\u003e (fork)\" or \"\u003cparent-name\u003e (compacted)\" if \u003c1min\n- Extract working directory from .jsonl or parent folder\n- Format timestamp: YYYY-MM-DD HH:MM\n- Include name in session metadata\n\nLogic:\n- If session created \u003c1min after parent: \"(compacted)\"\n- Otherwise: \"(fork)\"\n- Determine Terminal vs Voice by checking if iOS client initiated","acceptance_criteria":"Generates meaningful default names, detects and labels forks appropriately, includes working directory and timestamp, names appear in session_list and session_created","status":"closed","priority":0,"issue_type":"feature","assignee":"backend","created_at":"2025-10-16T22:53:49.745702-05:00","updated_at":"2025-10-17T09:48:50.565814-05:00","closed_at":"2025-10-17T09:48:50.565814-05:00","dependencies":[{"issue_id":"voice-code-85","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.667367-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-86","title":"Write tests for replication system","description":"Comprehensive test coverage for new replication architecture.\n\nTests:\n- Index building from 100+ .jsonl files\n- Incremental file parsing (new lines only)\n- Debouncing and parse-retry logic\n- Selective file watching (subscribe/unsubscribe)\n- Protocol messages: session_list, session_subscribe, session_history, session_updated, session_created\n- New vs resume prompt handling (--session-id vs --resume)\n- Session naming generation\n- Deletion handling","acceptance_criteria":"All tests passing, coverage for core replication logic, integration tests for file watching, protocol message tests","status":"closed","priority":0,"issue_type":"task","assignee":"backend","created_at":"2025-10-16T22:53:59.609647-05:00","updated_at":"2025-10-17T09:48:50.565967-05:00","closed_at":"2025-10-17T09:48:50.565967-05:00","dependencies":[{"issue_id":"voice-code-86","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.686853-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-87","title":"Design CoreData schema","description":"Design CoreData schema for session and message storage.\n\nEntities:\n- Session: id (UUID), backendName (String), localName (String?), workingDir (String), lastModified (Date), messageCount (Int), preview (String), isDeleted (Bool)\n- Message: id (UUID), sessionId (UUID), role (String), text (String), timestamp (Date), status (MessageStatus enum), serverTimestamp (Date?)\n\nRelationships:\n- Session.messages → [Message]\n- Message.session → Session\n\nEnums:\n- MessageStatus: .sending, .confirmed, .error","acceptance_criteria":"CoreData model file created, entities defined with all fields, relationships configured, compiles without errors","status":"closed","priority":0,"issue_type":"task","assignee":"ios","created_at":"2025-10-16T22:54:14.891234-05:00","updated_at":"2025-10-17T17:55:11.355372-05:00","closed_at":"2025-10-17T17:55:11.355372-05:00","dependencies":[{"issue_id":"voice-code-87","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.704345-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-88","title":"Implement session metadata sync","description":"Handle session_list message and store metadata in CoreData.\n\n- Receive session_list on WebSocket connection\n- Parse sessions array\n- Store in CoreData (Session entities)\n- Display in sessions list view\n- Support pagination (20 sessions per page initially)\n- Load more on scroll","acceptance_criteria":"Receives session_list, stores all sessions in CoreData, displays in UI with pagination, \"load more\" works correctly","notes":"Updated to clarify handling of session_created broadcasts. This task covers both initial session_list and ongoing session_created messages for terminal sessions.","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-16T22:54:23.075193-05:00","updated_at":"2025-10-17T17:58:43.371981-05:00","closed_at":"2025-10-17T17:58:43.371981-05:00","dependencies":[{"issue_id":"voice-code-88","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.722447-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-89","title":"Implement lazy session loading","description":"Load full conversation when user opens a session.\n\n- When user taps session: send subscribe message\n- Receive session_history response\n- Parse messages array\n- Store messages in CoreData (linked to session)\n- Display in conversation view\n- Show loading indicator during fetch","acceptance_criteria":"Sends subscribe on session open, receives and stores session_history, displays messages in conversation view, loading indicator shown","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-16T22:54:29.59329-05:00","updated_at":"2025-10-17T18:12:11.550002-05:00","closed_at":"2025-10-17T18:12:11.550002-05:00","dependencies":[{"issue_id":"voice-code-89","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.741392-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-90","title":"Implement incremental message updates","description":"Handle session_updated messages and update CoreData.\n\n- Receive session_updated messages from WebSocket\n- Parse new messages array\n- Append to CoreData for that session\n- Update UI in real-time (if session is open)\n- Update session preview and message count in list view","acceptance_criteria":"Receives session_updated, appends new messages to CoreData, UI updates in real-time, session list shows updated preview/count","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-16T22:54:36.248463-05:00","updated_at":"2025-10-17T18:18:27.80231-05:00","closed_at":"2025-10-17T18:18:27.80231-05:00","dependencies":[{"issue_id":"voice-code-90","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.756403-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-91","title":"Implement optimistic UI for prompts","description":"Display user prompts immediately with optimistic UI pattern.\n\n- When user sends prompt: create Message with status .sending\n- Add to CoreData immediately\n- Display in conversation view (show sending indicator)\n- When session_updated arrives: reconcile by matching text\n- Update status to .confirmed, add serverTimestamp\n- Handle case where message not found (backend-originated prompt)","acceptance_criteria":"User prompts appear instantly, reconciliation works correctly, status updates from .sending to .confirmed, backend prompts handled gracefully","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-16T22:54:43.752348-05:00","updated_at":"2025-10-17T18:24:00.025281-05:00","closed_at":"2025-10-17T18:24:00.025281-05:00","dependencies":[{"issue_id":"voice-code-91","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.777476-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-92","title":"Update prompt sending logic","description":"Use new_session_id vs resume_session_id fields for prompts.\n\n- Generate UUID for new sessions (before sending prompt)\n- Send subscribe(uuid) before prompt for new sessions\n- Use new_session_id field for new sessions\n- Use resume_session_id field for existing sessions\n- Remove iOS session UUID from protocol\n- Working directory from session or user selection\n\nMessage format:\n- New: {type: prompt, new_session_id: uuid, text: \"...\", working_directory: \"...\"}\n- Resume: {type: prompt, resume_session_id: uuid, text: \"...\", working_directory: \"...\"}","acceptance_criteria":"Generates UUIDs for new sessions, sends subscribe before prompt, uses correct field (new_session_id vs resume_session_id), iOS session UUID removed","notes":"This task includes auto-subscribe logic for new sessions. When creating a new session, iOS generates UUID and sends subscribe BEFORE sending the prompt, ensuring it receives all updates including the initial response.","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-16T22:54:51.459293-05:00","updated_at":"2025-10-17T19:28:50.476732-05:00","closed_at":"2025-10-17T19:28:50.476732-05:00","dependencies":[{"issue_id":"voice-code-92","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.792511-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-93","title":"Implement smart speaking logic","description":"Only speak messages for active/open session.\n\n- Track currently active session ID\n- When session_updated arrives: check if message is for active session\n- If active session + assistant message: speak it\n- If background session: buffer message, update badge count\n- Show unread count in session list\n- Mark as read when user opens session","acceptance_criteria":"Only speaks messages for active session, background sessions show badge count, unread count visible in list, mark as read works","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-16T22:54:58.774589-05:00","updated_at":"2025-10-17T19:40:49.856756-05:00","closed_at":"2025-10-17T19:40:49.856756-05:00","dependencies":[{"issue_id":"voice-code-93","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.810632-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-94","title":"Add long-press \"Read Aloud\" menu","description":"Add context menu to read historical messages aloud.\n\n- Long-press on any message: show context menu\n- Menu option: \"Read Aloud\"\n- Trigger TTS for that message text\n- Interrupt current playback if needed\n- Works for both user and assistant messages","acceptance_criteria":"Long-press shows context menu, \"Read Aloud\" option present, TTS plays selected message, interrupts current playback","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-16T22:55:05.79065-05:00","updated_at":"2025-10-17T19:47:40.04061-05:00","closed_at":"2025-10-17T19:47:40.04061-05:00","dependencies":[{"issue_id":"voice-code-94","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.832692-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-95","title":"Implement session deletion","description":"Allow users to delete sessions locally.\n\n- Swipe to delete gesture in session list\n- Send session_deleted message to backend\n- Mark session as deleted in CoreData (isDeleted = true)\n- Hide from UI (filter out deleted sessions)\n- Send unsubscribe message\n- No backend file deletion (local only)","acceptance_criteria":"Swipe to delete works, sends session_deleted to backend, marks as deleted in CoreData, hidden from UI, unsubscribe sent","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-16T22:55:14.723884-05:00","updated_at":"2025-10-17T19:52:30.143813-05:00","closed_at":"2025-10-17T19:52:30.143813-05:00","dependencies":[{"issue_id":"voice-code-95","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.849215-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-96","title":"Add session renaming","description":"Allow users to rename sessions locally.\n\n- Edit button or gesture in session detail view\n- Text field to enter custom name\n- Store in localName field (CoreData)\n- Display: localName ?? backendName\n- No backend sync (local only)\n- Update UI immediately on change","acceptance_criteria":"Can edit session name, stores in localName field, displays custom name if set, falls back to backendName, no backend sync","status":"closed","priority":0,"issue_type":"feature","assignee":"ios","created_at":"2025-10-16T22:55:21.150448-05:00","updated_at":"2025-10-17T19:55:33.263092-05:00","closed_at":"2025-10-17T19:55:33.263092-05:00","dependencies":[{"issue_id":"voice-code-96","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.865005-05:00","created_by":"travisbrown"}]}
{"id":"voice-code-97","title":"Test terminal to iOS sync","description":"End-to-end test: terminal session appears on iOS.\n\nSteps:\n1. Start backend and iOS app\n2. Create new Claude session from terminal\n3. Verify iOS receives session_created message\n4. Verify session appears in iOS session list\n5. Verify auto-subscription works\n6. Send prompt from terminal\n7. Verify iOS receives session_updated\n8. Verify messages display correctly","acceptance_criteria":"Terminal sessions appear on iOS, auto-subscription works, messages sync correctly, end-to-end flow complete","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-16T22:55:34.797134-05:00","updated_at":"2025-10-18T14:23:21.42793-05:00","closed_at":"2025-10-18T14:23:21.42793-05:00"}
{"id":"voice-code-98","title":"Test iOS to iOS sync","description":"End-to-end test: iOS session syncs to other iOS clients.\n\nSteps:\n1. Start backend and iOS app\n2. Create new session from iOS (send prompt with new_session_id)\n3. Backend creates .jsonl file\n4. Verify filesystem watcher detects new file\n5. Verify messages sync via session_updated\n6. Connect second iOS client\n7. Verify session appears in session_list\n8. Verify can subscribe and see full history","acceptance_criteria":"iOS sessions create backend files, sync via file watching works, other iOS clients receive sessions, full history available","status":"closed","priority":0,"issue_type":"task","created_at":"2025-10-16T22:55:42.763758-05:00","updated_at":"2025-10-18T14:23:21.428742-05:00","closed_at":"2025-10-18T14:23:21.428742-05:00"}
{"id":"voice-code-99","title":"Test session forking","description":"Test concurrent resume creates fork that appears on iOS.\n\nSteps:\n1. Create session from terminal\n2. iOS subscribes to session\n3. From terminal: resume same session (concurrent)\n4. Claude creates fork (session-id-fork-1.jsonl)\n5. Verify filesystem watcher detects new fork file\n6. Verify iOS receives session_created for fork\n7. Verify iOS auto-subscribes to fork\n8. Verify fork name includes \"(fork)\" or \"(compacted)\"","acceptance_criteria":"Concurrent resume creates fork, fork detected by watcher, iOS receives session_created, auto-subscription works, fork naming correct","status":"open","priority":0,"issue_type":"task","created_at":"2025-10-16T22:55:51.300792-05:00","updated_at":"2025-10-16T22:55:51.300792-05:00","dependencies":[{"issue_id":"voice-code-99","depends_on_id":"voice-code-117","type":"parent-child","created_at":"2025-10-17T17:45:49.91757-05:00","created_by":"travisbrown"}]}
