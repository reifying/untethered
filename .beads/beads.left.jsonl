{"id":"voice-code-orchestration-4ba","content_hash":"9d054979a6474d8ae0681fb3b0eeb132c8e4ac39273acf16bdb2569d95bba9b0","title":"Add model support to recipes with commit step","description":"Add ability to specify model per recipe step. Add commit step after successful code review using Haiku model.","design":"# Design: Model Support for Recipes with Commit Step\n\n## Overview\n\nAdd the ability to specify a model per recipe step, enabling routine commits to use fast/cheap models (Haiku) while complex implementation steps use more capable models.\n\n## Changes Required\n\n### 1. Recipe Schema Changes (`recipes.clj`)\n\nAdd optional `:model` field at both recipe level (default) and step level (override):\n\n```clojure\n{:id :implement-and-review\n :model \"sonnet\"  ; default model for all steps (optional)\n :steps\n {:implement\n  {:prompt \"Run bd ready and implement the task.\"\n   :outcomes #{:complete :other}\n   :on-outcome {...}}\n  \n  :commit\n  {:prompt \"Commit the changes for this task.\"\n   :model \"haiku\"  ; fast/cheap model for straightforward commits\n   :outcomes #{:committed :nothing-to-commit :other}\n   :on-outcome {...}}}}\n```\n\nModel resolution order:\n1. Step-level `:model` (if present)\n2. Recipe-level `:model` (if present)  \n3. Claude CLI default (if neither specified)\n\nValid model values: `\"haiku\"`, `\"sonnet\"`, `\"opus\"` (matches Claude Code CLI)\n\n### 2. Updated Recipe Flow\n\nCurrent flow:\n```\n:implement -\u003e :code-review -\u003e (issues? :fix : exit)\n                   ^            |\n                   +------------+\n```\n\nNew flow with commit step:\n```\n:implement -\u003e :code-review -\u003e (issues? :fix : :commit) -\u003e exit\n                   ^            |\n                   +------------+\n```\n\n### 3. Complete Updated Recipe Definition\n\n```clojure\n(defn implement-and-review-recipe\n  []\n  {:id :implement-and-review\n   :label \"Implement \u0026 Review\"\n   :description \"Implement task, review code, fix issues, and commit\"\n   :initial-step :implement\n   :steps\n   {:implement\n    {:prompt \"Run bd ready and implement the task.\"\n     :outcomes #{:complete :other}\n     :on-outcome\n     {:complete {:next-step :code-review}\n      :other {:action :exit :reason \"user-provided-other\"}}}\n\n    :code-review\n    {:prompt \"Perform a code review on the task that you just completed.\"\n     :outcomes #{:no-issues :issues-found :other}\n     :on-outcome\n     {:no-issues {:next-step :commit}\n      :issues-found {:next-step :fix}\n      :other {:action :exit :reason \"user-provided-other\"}}}\n\n    :fix\n    {:prompt \"Address the issues found.\"\n     :outcomes #{:complete :other}\n     :on-outcome\n     {:complete {:next-step :code-review}\n      :other {:action :exit :reason \"user-provided-other\"}}}\n\n    :commit\n    {:prompt \"Commit and push the changes you made for this task. Use the beads task ID in the commit message.\"\n     :model \"haiku\"\n     :outcomes #{:committed :nothing-to-commit :other}\n     :on-outcome\n     {:committed {:action :exit :reason \"task-committed\"}\n      :nothing-to-commit {:action :exit :reason \"no-changes-to-commit\"}\n      :other {:action :exit :reason \"user-provided-other\"}}}}\n\n   :guardrails\n   {:max-step-visits 3\n    :max-total-steps 20\n    :exit-on-other true}})\n```\n\n### 4. Server Changes (`server.clj`)\n\nAdd helper function and update `execute-recipe-step`:\n\n```clojure\n(defn get-step-model \n  \"Get model for a step. Resolution: step :model \u003e recipe :model \u003e nil\"\n  [recipe step-name]\n  (or (get-in recipe [:steps step-name :model])\n      (:model recipe)))\n\n;; In execute-recipe-step, update invoke-claude-async call:\n(claude/invoke-claude-async\n step-prompt\n callback-fn\n :resume-session-id session-id\n :working-directory working-dir\n :model (get-step-model recipe current-step)  ; NEW\n :timeout-ms 86400000)\n```\n\n### 5. Validation Updates (`recipes.clj`)\n\nAdd model validation to `validate-recipe`:\n\n```clojure\n(def valid-models #{\"haiku\" \"sonnet\" \"opus\"})\n\n(defn validate-model [model context]\n  (when (and model (not (contains? valid-models model)))\n    {:error (str \"Invalid model '\" model \"' at \" context \". Valid: \" valid-models)}))\n\n;; In validate-recipe, add checks for:\n;; - Recipe-level :model (if present)\n;; - Per-step :model (if present)\n```\n\nUpdate specs:\n\n```clojure\n(s/def ::model #{\"haiku\" \"sonnet\" \"opus\"})\n\n(s/def ::step-def\n  (s/keys :req-un [::prompt ::outcomes ::on-outcome]\n          :opt-un [::model]))\n\n(s/def ::recipe\n  (s/keys :req-un [::id ::description ::initial-step ::steps]\n          :opt-un [::guardrails ::model]))\n```\n\n### 6. Logging Enhancement\n\nLog model being used for each step:\n\n```clojure\n(log/info \"Executing recipe step\"\n          {:session-id session-id\n           :recipe-id (:recipe-id orch-state)\n           :step current-step\n           :model (get-step-model recipe current-step)  ; NEW\n           :step-count (:step-count orch-state)})\n```\n\n## Files to Modify\n\n1. `backend/src/voice_code/recipes.clj`\n   - Add `valid-models` set\n   - Update `implement-and-review-recipe` with commit step\n   - Update `validate-recipe` to check model values\n   - Update specs for `::model`, `::step-def`, `::recipe`\n\n2. `backend/src/voice_code/server.clj`\n   - Add `get-step-model` helper function\n   - Update `execute-recipe-step` to pass `:model` to `invoke-claude-async`\n   - Update logging to include model\n\n3. `backend/test/voice_code/recipes_test.clj`\n   - Add tests for model validation\n   - Add tests for commit step\n\n4. `backend/test/voice_code/server_test.clj`\n   - Add tests for `get-step-model` resolution\n   - Add integration test for recipe with model switching\n\n## Design Decisions\n\n1. **Haiku for commits**: Commits are straightforward tasks that don't need Opus/Sonnet reasoning. Haiku is fast and cheap.\n\n2. **Model at step level, not prompt level**: Simpler than per-prompt. A step's model doesn't change during retries.\n\n3. **No frontend changes**: Model is backend orchestration detail. Could add to `recipe-step-started` message later if needed.\n\n4. **Beads task ID in commit**: The agent already ran `bd ready` in :implement step, so it knows the task ID from that context.\n\n5. **Commit and push**: The commit step includes pushing to complete the workflow end-to-end.\n\n6. **Commit failures use :other**: Git errors (conflicts, permissions) are rare edge cases. Agent should report via `:other` with description rather than adding dedicated outcomes.\n\n## Assumptions to Verify\n\n1. **Model switching with --resume**: Claude CLI should accept `--model haiku --resume \u003csession-id\u003e` to use a different model for the same session. Need to verify this works correctly.\n\n## Test Plan\n\n1. **Unit test**: Model resolution (step \u003e recipe \u003e nil)\n2. **Unit test**: Model validation rejects invalid values\n3. **Unit test**: Commit step outcomes parsing\n4. **Integration test**: Full recipe with commit step\n5. **Manual test**: Verify Haiku is used for commit step via Claude logs\n6. **Manual test**: Verify model switching works with --resume\n\n## Acceptance Criteria\n\n- [ ] Recipes can specify default model at recipe level\n- [ ] Steps can override model at step level  \n- [ ] Invalid model values are rejected by validation\n- [ ] Model is passed through to Claude CLI\n- [ ] Implement-and-review recipe includes commit step after successful review\n- [ ] Commit step uses Haiku model\n- [ ] Model is logged when executing steps\n- [ ] All existing tests pass\n- [ ] New tests cover model resolution, validation, and commit step","status":"open","priority":1,"issue_type":"feature","created_at":"2025-12-28T08:51:13.107831-06:00","updated_at":"2025-12-28T09:00:46.514612-06:00","source_repo":"."}
