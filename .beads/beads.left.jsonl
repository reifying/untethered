{"id":"voice-code-message-too-long-hfn","content_hash":"8d917e4bff5fcc1959d302ec7ac539e1ee01e7496bcdda2aa9e10517a8fd4bbb","title":"Delta Sync Session History","description":"## Design Document\n@docs/design/delta-sync-session-history.md\n\n## Overview\nImplement delta sync for session history to eliminate redundant message transfer and improve truncation behavior. When iOS subscribes to a session, it sends the UUID of its newest cached message. The backend only sends messages newer than that ID, using smart per-message truncation (20KB max) instead of dividing budget equally among all messages.\n\n## Acceptance Criteria\n1. Subscribe with `last_message_id` returns only newer messages\n2. Subscribe without `last_message_id` returns recent messages (backward compatible)\n3. Messages under 20KB are never truncated\n4. Messages over 20KB are truncated with marker showing size\n5. Response never exceeds client's max message size setting\n6. Newest messages are prioritized when budget is exhausted\n7. `is_complete: false` indicates budget exhaustion\n8. iOS displays truncated content with appropriate indicator\n9. All existing tests continue to pass","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-31T17:07:49.744716-06:00","updated_at":"2025-12-31T17:45:32.350309-06:00","closed_at":"2025-12-31T17:45:32.350309-06:00","source_repo":"."}
{"id":"voice-code-message-too-long-hfn.2","content_hash":"a21eebf96f8de0c796c2a21375dd30ba7d66a43bbe708d88c759dc984c6277a6","title":"Implement build-session-history-response function","description":"## Design Reference\n@docs/design/delta-sync-session-history.md#backend-new-truncation-algorithm\n\n## Context\nThis is the core algorithm for delta sync. It replaces the current equal-budget truncation with smart per-message truncation that prioritizes recent messages and preserves small messages intact.\n\n## Requirements\n- [ ] Create `per-message-max-bytes` constant (20KB)\n- [ ] Implement `build-session-history-response` function with delta sync logic\n- [ ] Find messages newer than `last-message-id` (or all if not provided)\n- [ ] Work backwards from newest message, adding until budget exhausted\n- [ ] Truncate only messages exceeding per-message-max (20KB)\n- [ ] Return `is-complete`, `oldest-message-id`, `newest-message-id`\n\n## Technical Approach\n- File to modify: `backend/src/voice_code/server.clj`\n- Algorithm:\n  1. Find index of last-message-id in message list\n  2. Get messages newer than that index (or all if not found)\n  3. Reverse to process newest first\n  4. Loop: truncate large messages, add to result until budget exhausted\n  5. Reverse back to chronological order\n  6. Return with metadata fields\n\n## Verification\n- [ ] Unit test: Empty message list returns empty result with nil IDs\n- [ ] Unit test: All messages fit in budget → is-complete true\n- [ ] Unit test: Budget exhausted mid-way → is-complete false, newest prioritized\n- [ ] Unit test: last-message-id found → only newer messages returned\n- [ ] Unit test: last-message-id not found → all recent messages returned\n- [ ] Unit test: Large messages (\u003e20KB) truncated with marker\n- [ ] Unit test: Small messages (\u003c20KB) preserved intact\n\n## Acceptance Criteria\n- Messages under 20KB are never truncated\n- Messages over 20KB are truncated with marker showing size\n- Newest messages are prioritized when budget is exhausted","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T17:08:42.505319-06:00","updated_at":"2025-12-31T20:09:36.291425-06:00","closed_at":"2025-12-31T20:09:36.291425-06:00","source_repo":"."}
{"id":"voice-code-message-too-long-hfn.3","content_hash":"db62b66a87f3f69e8bcdc609e2ddc0765366977d4e8f55730480b02c1c082b2c","title":"Update subscribe handler to use delta sync algorithm","description":"## Design Reference\n@docs/design/delta-sync-session-history.md#backend-updated-subscribe-handler\n\n## Context\nThe subscribe handler must be updated to parse the new `last_message_id` field, call the new `build-session-history-response` function, and return the new response fields.\n\n## Requirements\n- [ ] Parse optional `last-message-id` from subscribe message\n- [ ] Pass `last-message-id` to `build-session-history-response`\n- [ ] Include `oldest-message-id`, `newest-message-id`, `is-complete` in response\n- [ ] Log delta sync usage for debugging\n- [ ] Handle backward compatibility (missing `last-message-id` = full history)\n\n## Technical Approach\n- File to modify: `backend/src/voice_code/server.clj`\n- In the \"subscribe\" case of message handler:\n  1. Extract `last-message-id` from data map\n  2. Call `build-session-history-response` with filtered messages, last-message-id, and max-bytes\n  3. Destructure result to get messages, is-complete, oldest-message-id, newest-message-id\n  4. Include all fields in `session-history` response\n\n## Dependencies\n- Requires: \"Implement build-session-history-response function\"\n\n## Verification\n- [ ] Integration test: Subscribe without last_message_id returns recent messages\n- [ ] Integration test: Subscribe with valid last_message_id returns only newer\n- [ ] Integration test: Subscribe with stale/unknown last_message_id returns recent messages\n- [ ] Integration test: Response includes is_complete, oldest_message_id, newest_message_id\n- [ ] All existing subscribe tests continue to pass\n\n## Acceptance Criteria\n- Subscribe with `last_message_id` returns only newer messages\n- Subscribe without `last_message_id` returns recent messages (backward compatible)\n- All existing tests continue to pass","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T17:09:05.07216-06:00","updated_at":"2025-12-31T23:07:34.648982-06:00","closed_at":"2025-12-31T23:07:34.648982-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-message-too-long-hfn.3","depends_on_id":"voice-code-message-too-long-hfn.2","type":"blocks","created_at":"2025-12-31T17:09:10.946434-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-message-too-long-hfn.4","content_hash":"a922c37a930becb406a929802d1d8abe3947ef8c1028be51a4db0407396d52bd","title":"Implement iOS getNewestCachedMessageId function","description":"## Design Reference\n@docs/design/delta-sync-session-history.md#ios-updated-subscribe-call\n\n## Context\niOS needs a function to query CoreData for the newest message UUID for a given session. This UUID will be sent to the backend as `last_message_id` to enable delta sync.\n\n## Requirements\n- [ ] Create `getNewestCachedMessageId(sessionId:)` function in VoiceCodeClient\n- [ ] Query CDMessage sorted by timestamp descending, limit 1\n- [ ] Return the message's UUID as lowercase string (per STANDARDS.md)\n- [ ] Return nil on error or if no messages exist\n- [ ] Log errors for debugging\n\n## Technical Approach\n- File to modify: `ios/VoiceCode/Managers/VoiceCodeClient.swift`\n- Implementation:\n  1. Parse sessionId string to UUID\n  2. Create NSFetchRequest for CDMessage\n  3. Set predicate: sessionId == uuid\n  4. Set sort: timestamp descending\n  5. Set fetchLimit: 1\n  6. Execute fetch on PersistenceController.shared.container.viewContext\n  7. Return first result's id.uuidString.lowercased()\n\n## Parallelization\nCan be worked alongside: \"Update subscribe handler to use delta sync algorithm\"\n\n## Verification\n- [ ] Manual test: Function returns correct UUID for session with messages\n- [ ] Manual test: Function returns nil for session with no messages\n- [ ] Manual test: Function returns nil for invalid session ID\n- [ ] Verify UUID is lowercase\n\n## Acceptance Criteria\n- iOS can retrieve the newest cached message ID for any session","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T17:09:31.941192-06:00","updated_at":"2025-12-31T23:36:49.264849-06:00","closed_at":"2025-12-31T23:36:49.264849-06:00","source_repo":"."}
{"id":"voice-code-message-too-long-hfn.5","content_hash":"95bb7f5d225b3673b0459c7d5d3c0d11c230c351598bfcd8c97d989c51bda62a","title":"Update iOS subscribe to send last_message_id","description":"## Design Reference\n@docs/design/delta-sync-session-history.md#ios-updated-subscribe-call\n\n## Context\nThe iOS subscribe call must be updated to include `last_message_id` when subscribing to a session. This enables delta sync, reducing redundant data transfer.\n\n## Requirements\n- [ ] Update `subscribe(sessionId:)` to call `getNewestCachedMessageId`\n- [ ] Include `last_message_id` in subscribe message if available\n- [ ] Log whether delta sync is being used\n- [ ] Maintain backward compatibility (message still valid without last_message_id)\n\n## Technical Approach\n- File to modify: `ios/VoiceCode/Managers/VoiceCodeClient.swift`\n- In `subscribe(sessionId:)`:\n  1. Call getNewestCachedMessageId(sessionId:)\n  2. Build message dictionary with type and session_id\n  3. If lastMessageId exists, add \"last_message_id\" key\n  4. Log delta sync status\n  5. Send message\n\n## Dependencies\n- Requires: \"Implement iOS getNewestCachedMessageId function\"\n- Requires: \"Update subscribe handler to use delta sync algorithm\" (backend must accept the field)\n\n## Verification\n- [ ] Manual test: Subscribe message includes last_message_id when messages exist\n- [ ] Manual test: Subscribe message omits last_message_id when no cached messages\n- [ ] Console logs show delta sync status\n- [ ] Backend receives and logs last_message_id\n\n## Acceptance Criteria\n- Subscribe with `last_message_id` returns only newer messages\n- Subscribe without `last_message_id` returns recent messages (backward compatible)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T17:09:46.221114-06:00","updated_at":"2026-01-01T09:40:00.041412-06:00","closed_at":"2026-01-01T09:40:00.041412-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-message-too-long-hfn.5","depends_on_id":"voice-code-message-too-long-hfn.4","type":"blocks","created_at":"2025-12-31T17:09:52.114723-06:00","created_by":"travisbrown"},{"issue_id":"voice-code-message-too-long-hfn.5","depends_on_id":"voice-code-message-too-long-hfn.3","type":"blocks","created_at":"2025-12-31T17:09:52.521672-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-message-too-long-hfn.6","content_hash":"bc93a21520062d8a41f47b1a7133da007a6df6521b0b1c33c7bbf7457445ec6a","title":"Handle is_complete response in iOS session history","description":"## Design Reference\n@docs/design/delta-sync-session-history.md#ios-handle-incomplete-response\n\n## Context\niOS needs to handle the new `is_complete` field in session_history responses. When false, it indicates the budget was exhausted before all messages could be sent, meaning there's a gap in history.\n\n## Requirements\n- [ ] Parse `is_complete` field from session_history response\n- [ ] Parse `oldest_message_id` and `newest_message_id` fields\n- [ ] Log warning when is_complete is false\n- [ ] Optionally display indicator to user when history is incomplete\n\n## Technical Approach\n- File to modify: `ios/VoiceCode/Managers/VoiceCodeClient.swift`\n- In session_history case handler:\n  1. Extract is_complete boolean (default true for backward compatibility)\n  2. Extract oldest_message_id and newest_message_id strings\n  3. Log if is_complete is false\n  4. Consider: notify delegate or post notification for UI indicator\n\n## Parallelization\nCan be worked alongside: \"Update iOS subscribe to send last_message_id\"\n\n## Dependencies\n- Requires: \"Update subscribe handler to use delta sync algorithm\" (backend must send the fields)\n\n## Verification\n- [ ] Manual test: is_complete=true logged correctly\n- [ ] Manual test: is_complete=false triggers warning log\n- [ ] Manual test: Missing is_complete field defaults to true (backward compat)\n- [ ] Console shows oldest/newest message IDs\n\n## Acceptance Criteria\n- `is_complete: false` indicates budget exhaustion\n- iOS displays truncated content with appropriate indicator","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T17:10:14.827133-06:00","updated_at":"2026-01-01T10:18:52.105878-06:00","closed_at":"2026-01-01T10:18:52.105878-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-message-too-long-hfn.6","depends_on_id":"voice-code-message-too-long-hfn.3","type":"blocks","created_at":"2025-12-31T17:10:19.9067-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-message-too-long-hfn.7","content_hash":"a391dc5590611dd33e7bbd39768dc8619ef70871a56186f6d6a0fef0a9100f34","title":"Update STANDARDS.md with delta sync protocol","description":"## Design Reference\n@docs/design/delta-sync-session-history.md#required-documentation-updates\n\n## Context\nSTANDARDS.md documents the WebSocket protocol. It must be updated to reflect the new delta sync fields and behavior.\n\n## Requirements\n- [ ] Document `last_message_id` optional field in Subscribe message\n- [ ] Document `oldest_message_id`, `newest_message_id`, `is_complete` in Session History response\n- [ ] Document delta sync behavior and algorithm summary\n- [ ] Document error cases (stale last_message_id treated as not provided)\n\n## Technical Approach\n- File to modify: `STANDARDS.md`\n- Sections to update:\n  1. Subscribe Message section - add last_message_id field\n  2. Session History Response section - add new fields\n  3. Add new \"Delta Sync\" subsection explaining behavior\n\n## Dependencies\n- Should be done after: All implementation tasks (to document final behavior)\n\n## Verification\n- [ ] All new fields documented with correct types and descriptions\n- [ ] Examples show both with and without last_message_id\n- [ ] Error cases documented\n- [ ] Documentation matches implemented behavior\n\n## Acceptance Criteria\n- Protocol documentation accurately reflects implementation\n- New developers can understand delta sync from STANDARDS.md alone","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-31T17:10:38.95168-06:00","updated_at":"2025-12-31T17:10:38.95168-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-message-too-long-hfn.7","depends_on_id":"voice-code-message-too-long-hfn.5","type":"blocks","created_at":"2025-12-31T17:10:44.994082-06:00","created_by":"travisbrown"},{"issue_id":"voice-code-message-too-long-hfn.7","depends_on_id":"voice-code-message-too-long-hfn.6","type":"blocks","created_at":"2025-12-31T17:10:45.39163-06:00","created_by":"travisbrown"}]}
