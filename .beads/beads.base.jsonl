{"id":"voice-code-session-74t","content_hash":"7c10f3e1ef0a4424c54179def012609c049b5d82d085d9298d26eba516ef232c","title":"Workstream Abstraction","description":"## Design Document\n@docs/design/workstream-abstraction.md\n\n## Overview\nIntroduce a Workstream abstraction that decouples front-end session identity from Claude Code session identity. This enables context window clearing without creating new UI entries, simplifies queue management (queue manages workstreams, not Claude sessions), and hides Claude sessions as an implementation detail.\n\n## Acceptance Criteria\n1. User sees workstreams in session list, not Claude sessions\n2. Clearing context keeps user in same workstream\n3. Queue position preserved after clear\n4. Workstream name persists through clears\n5. Migration creates workstream wrappers for existing sessions\n6. Recipes can request fresh context without UI disruption\n7. Messages display from active Claude session only\n8. Backward compatibility: legacy session_id prompts still work","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-28T22:17:00.895383-06:00","updated_at":"2025-12-28T22:17:00.895383-06:00","source_repo":"."}
{"id":"voice-code-session-74t.1","content_hash":"b4ed90af59e28e1c3ec218748beeb48bd2bed7507b5ddf0729260a7be5d2f614","title":"Implement workstream state management module","description":"## Design Reference\n@docs/design/workstream-abstraction.md#backend-workstream-state-management\n\n## Context\nThe workstream abstraction requires a new Clojure namespace to manage workstream state. This is the foundation for all backend workstream functionality - message handlers and migration logic depend on this module.\n\n## Requirements\n- [ ] Create `voice-code.workstream` namespace\n- [ ] Implement `workstream-index` atom for in-memory state\n- [ ] Implement persistence to `~/.voice-code/workstreams.edn`\n- [ ] Implement CRUD operations: `create-workstream!`, `get-workstream`, `get-all-workstreams`, `update-workstream!`, `delete-workstream!`\n- [ ] Implement session linking: `link-claude-session!`, `unlink-claude-session!`\n- [ ] Implement `load-workstream-index!` for startup loading\n- [ ] Add `format-timestamp` utility function\n\n## Technical Approach\n- Files to create: `backend/src/voice_code/workstream.clj`\n- Data structure per workstream:\n  ```clojure\n  {:id \"uuid\"\n   :name \"string\"\n   :working-directory \"path\"\n   :active-claude-session-id \"uuid or nil\"\n   :queue-priority :normal\n   :priority-order 0.0\n   :created-at timestamp-ms\n   :last-modified timestamp-ms}\n  ```\n- Use `swap!` for atomic updates\n- Persist after every mutation\n\n## Verification\n- [ ] Unit tests for `create-workstream!` with default and custom names\n- [ ] Unit tests for `link-claude-session!` and `unlink-claude-session!`\n- [ ] Unit tests for `unlink-claude-session!` returning previous session ID\n- [ ] Unit tests for persistence (save/load round-trip)\n- [ ] Manual: Verify `~/.voice-code/workstreams.edn` is created and readable\n\n## Acceptance Criteria\n- Workstream state can be created, read, updated, deleted\n- Claude sessions can be linked/unlinked from workstreams\n- State persists across backend restarts\n\n## Parallelization\nCan be worked alongside: iOS CoreData schema task","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T22:17:53.125873-06:00","updated_at":"2025-12-28T22:32:36.532912-06:00","closed_at":"2025-12-28T22:32:36.532912-06:00","source_repo":"."}
{"id":"voice-code-session-74t.10","content_hash":"1aaddb74ce9fae028b077cbc31f407c195058ee0ea6ab9f6eb185c5553e77c34","title":"Write iOS unit tests for WorkstreamSyncManager","description":"## Design Reference\n@docs/design/workstream-abstraction.md#ios-tests\n\n## Context\niOS unit tests verify CoreData operations and sync manager behavior work correctly.\n\n## Requirements\n- [ ] Create `WorkstreamTests` test class\n- [ ] Test `createWorkstream` creates entity with correct fields\n- [ ] Test `createWorkstream` defaults `isCleared` to true\n- [ ] Test `handleWorkstreamList` creates new workstreams\n- [ ] Test `handleWorkstreamList` updates existing workstreams\n- [ ] Test `handleContextCleared` sets activeClaudeSessionId to nil\n- [ ] Test `handleContextCleared` resets messageCount to 0\n- [ ] Test `handleContextCleared` with nil previousSessionId\n- [ ] Test CDWorkstream computed properties (`hasActiveSession`, `isCleared`)\n\n## Technical Approach\n- Files to create: `ios/VoiceCodeTests/WorkstreamTests.swift`\n- Use `PersistenceController.preview` for in-memory testing\n- Async tests using `async/await`\n- Refetch from context after background operations\n\n## Verification\n- [ ] All tests pass in Xcode\n- [ ] Test coverage for sync manager methods\n- [ ] Edge cases covered\n\n## Acceptance Criteria\n- All unit tests pass\n- WorkstreamSyncManager methods tested\n- CoreData operations verified\n\n## Parallelization\nDependencies: CDWorkstream entity (task 2), WorkstreamSyncManager (task 4)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T22:21:21.094817-06:00","updated_at":"2025-12-29T12:59:32.830534-06:00","closed_at":"2025-12-29T12:59:32.830534-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-session-74t.10","depends_on_id":"voice-code-session-74t.2","type":"blocks","created_at":"2025-12-28T22:22:26.962307-06:00","created_by":"daemon"},{"issue_id":"voice-code-session-74t.10","depends_on_id":"voice-code-session-74t.4","type":"blocks","created_at":"2025-12-28T22:22:26.995498-06:00","created_by":"daemon"}]}
{"id":"voice-code-session-74t.11","content_hash":"3db5961014db40060d2b7043d728ec0f9fedd10224fda38d92a1604a3855291b","title":"Write integration tests for workstream lifecycle","description":"## Design Reference\n@docs/design/workstream-abstraction.md#integration-tests\n\n## Context\nIntegration tests verify end-to-end workstream functionality across backend and iOS, including the 4 test scenarios from the design document.\n\n## Requirements\n- [ ] Test 1: Full workstream lifecycle\n  - Create workstream → first prompt → clear context → second prompt\n  - Verify workstream ID constant, two distinct Claude sessions\n- [ ] Test 2: Migration of existing sessions\n  - Create legacy session, start backend, verify workstream created\n  - Send legacy resume_session_id prompt, verify workstream reused\n- [ ] Test 3: Recipe with fresh context\n  - Create workstream with active session\n  - Start recipe with :fresh-context step\n  - Verify context_cleared sent, new Claude session created\n- [ ] Test 4: Backward compatibility\n  - Send legacy new_session_id prompt, verify workstream auto-created\n  - Send legacy resume_session_id prompt, verify same workstream used\n  - Send workstream_id prompt to same workstream, verify interoperability\n\n## Technical Approach\n- Use WebSocket test client to send messages\n- Verify responses match expected structure\n- Check backend state after operations\n- May require test fixtures for legacy session setup\n\n## Verification\n- [ ] All 4 integration test scenarios pass\n- [ ] Tests can run in CI environment\n- [ ] Tests clean up after themselves\n\n## Acceptance Criteria\n- All acceptance criteria verified through integration tests:\n  1. User sees workstreams, not Claude sessions\n  2. Clearing context keeps user in same workstream\n  3. Queue position preserved after clear\n  4. Workstream name persists through clears\n  5. Migration creates workstream wrappers\n  6. Recipes can request fresh context\n  7. Messages display from active Claude session only\n  8. Backward compatibility works\n\n## Parallelization\nDependencies: All previous tasks (this is the final verification)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T22:21:46.05976-06:00","updated_at":"2025-12-29T16:55:02.373229-06:00","closed_at":"2025-12-29T16:55:02.373229-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-session-74t.11","depends_on_id":"voice-code-session-74t.9","type":"blocks","created_at":"2025-12-28T22:22:27.028178-06:00","created_by":"daemon"},{"issue_id":"voice-code-session-74t.11","depends_on_id":"voice-code-session-74t.10","type":"blocks","created_at":"2025-12-28T22:22:27.059316-06:00","created_by":"daemon"},{"issue_id":"voice-code-session-74t.11","depends_on_id":"voice-code-session-74t.8","type":"blocks","created_at":"2025-12-28T22:22:27.090875-06:00","created_by":"daemon"}]}
{"id":"voice-code-session-74t.12","content_hash":"9a5d959c304cb4477f1b228e188c7a81347505ccdfd4c6446171ada72a0b6041","title":"Workstream UI Implementation","description":"## Design Document\n@docs/design/workstream-abstraction.md\n\n## Overview\nImplement the iOS UI layer for the workstream abstraction. The backend and data layer work is complete (voice-code-session-74t tasks 1-11). This epic covers the remaining UI work to expose workstreams to users.\n\n## Context\nThe workstream backend is fully implemented with:\n- Backend workstream state management\n- WebSocket message handlers (create_workstream, clear_context, workstream_list, workstream_updated)\n- iOS CDWorkstream CoreData entity\n- iOS WorkstreamSyncManager\n- VoiceCodeClient workstream messaging support\n\n## Remaining Work\nThe UI layer needs to be updated to:\n1. Display workstreams in the session list instead of raw Claude sessions\n2. Send prompts using workstream_id instead of session_id\n3. Add a Clear Context action for users to clear conversation history\n\n## Acceptance Criteria\n1. Session list displays CDWorkstream entities instead of CDBackendSession\n2. Prompts are sent with workstream_id parameter\n3. Users can clear context via UI action (button/swipe)\n4. Cleared workstreams show appropriate empty state\n5. New session creation creates a workstream first","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-29T20:08:48.5222-06:00","updated_at":"2025-12-29T20:08:48.5222-06:00","source_repo":"."}
{"id":"voice-code-session-74t.12.2","content_hash":"85b854bb0be0313de7054e052d2a2649342e395a16c494c5baea26ff4d350846","title":"Update SessionsView to display workstreams","description":"## Design Reference\n@docs/design/workstream-abstraction.md#ios-cdworkstream-entity\n\n## Context\nThe session list currently displays CDBackendSession entities directly. To fulfill acceptance criteria #1 (\"User sees workstreams in session list, not Claude sessions\"), we need to update the view to fetch and display CDWorkstream entities instead.\n\n## Requirements\n- [ ] Replace CDBackendSession fetch request with CDWorkstream fetch request\n- [ ] Update SessionRow to display workstream properties (name, workingDirectory, messageCount, preview)\n- [ ] Show visual indicator for cleared workstreams (no active Claude session)\n- [ ] Maintain existing sorting by lastModified\n- [ ] Preserve swipe actions (delete, queue management)\n\n## Technical Approach\n- Files to modify:\n  - `ios/VoiceCode/Views/SessionsView.swift` - Main list view\n  - `ios/VoiceCode/Views/SessionRow.swift` (if exists) - Row component\n  - `ios/VoiceCode/Views/SessionsForDirectoryView.swift` - Directory-filtered view\n- Use `CDWorkstream.fetchAllWorkstreams()` and `CDWorkstream.fetchWorkstreams(workingDirectory:)`\n- Workstream with nil activeClaudeSessionId shows \"Ready to start\" or similar empty state\n\n## Verification\n- [ ] Unit test: SessionsView displays workstream name and directory\n- [ ] Unit test: Cleared workstream shows appropriate empty state\n- [ ] Manual: Launch app, verify session list shows workstream data\n- [ ] Manual: Verify sorting works correctly\n\n## Acceptance Criteria\n- Session list displays CDWorkstream entities instead of CDBackendSession\n- Cleared workstreams show appropriate empty state\n\n## Parallelization\nCan be worked alongside: None (foundation task)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T20:10:05.722256-06:00","updated_at":"2025-12-29T20:42:25.587272-06:00","closed_at":"2025-12-29T20:42:25.587272-06:00","source_repo":"."}
{"id":"voice-code-session-74t.12.3","content_hash":"6fb2732095aab542ca99229f1da25b892b10143218f22c9e3f37504f9330efb1","title":"Update ConversationView to use workstream_id for prompts","description":"## Design Reference\n@docs/design/workstream-abstraction.md#modified-message-prompt\n\n## Context\nConversationView currently sends prompts using new_session_id or resume_session_id. To fully adopt the workstream abstraction, prompts must be sent with workstream_id instead. The VoiceCodeClient already has a `sendPrompt(text:workstreamId:)` method implemented.\n\n## Requirements\n- [ ] ConversationView tracks current workstream (CDWorkstream) instead of session\n- [ ] Prompt sending uses workstream_id parameter\n- [ ] New conversation creates workstream first, then sends prompt\n- [ ] Session locking tracks workstream, not Claude session\n- [ ] Message display filters by activeClaudeSessionId from workstream\n\n## Technical Approach\n- Files to modify:\n  - `ios/VoiceCode/Views/ConversationView.swift` - Main conversation UI\n  - `ios/VoiceCode/Managers/VoiceCodeClient.swift` - Already has workstream methods\n- Replace `currentSession: CDBackendSession?` with `currentWorkstream: CDWorkstream?`\n- Call `voiceCodeClient.sendPrompt(text:workstreamId:workingDirectory:systemPrompt:)`\n- For new conversations: call `voiceCodeClient.createWorkstream()` first\n- Message fetch predicate: filter by workstream's activeClaudeSessionId\n\n## Verification\n- [ ] Unit test: Prompt sends with workstream_id in payload\n- [ ] Unit test: New conversation creates workstream before first prompt\n- [ ] Manual: Send prompt, verify backend receives workstream_id\n- [ ] Manual: Verify messages appear correctly after prompt\n\n## Acceptance Criteria\n- Prompts are sent with workstream_id parameter\n- New session creation creates a workstream first\n\n## Parallelization\nCan be worked alongside: Update SessionsView task (mostly independent)\n\n## Dependencies\nRequires: Update SessionsView task (for navigation to pass workstream)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T20:10:28.801018-06:00","updated_at":"2025-12-29T22:34:49.229348-06:00","closed_at":"2025-12-29T22:34:49.229348-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-session-74t.12.3","depends_on_id":"voice-code-session-74t.12.2","type":"blocks","created_at":"2025-12-29T20:11:23.791946-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-session-74t.12.4","content_hash":"aabbc4d6d718df75fd2595b23091dbff89e1cade1228d6c1f6d5529f39c0d99c","title":"Add Clear Context button to ConversationView","description":"## Design Reference\n@docs/design/workstream-abstraction.md#new-message-clear_context\n\n## Context\nUsers need a way to clear the conversation context (start fresh) without creating a new session. The backend clear_context handler and iOS WorkstreamSyncManager.handleContextCleared are already implemented. This task adds the UI affordance.\n\n## Requirements\n- [ ] Add Clear Context button/action to conversation view toolbar or menu\n- [ ] Button calls `voiceCodeClient.clearContext(workstreamId:)`\n- [ ] Show confirmation dialog before clearing (optional but recommended)\n- [ ] Handle context_cleared response: clear messages from view\n- [ ] Disable button when workstream has no active session (already cleared)\n- [ ] Show loading state while clear is in progress\n\n## Technical Approach\n- Files to modify:\n  - `ios/VoiceCode/Views/ConversationView.swift` - Add button to toolbar\n- UI placement options:\n  - Toolbar button with trash/clear icon\n  - Menu item in overflow menu\n  - Swipe action on conversation header\n- VoiceCodeClient already has `clearContext(workstreamId:)` method\n- WorkstreamSyncManager handles `context_cleared` and clears messages\n\n## Verification\n- [ ] Unit test: Clear button calls clearContext with correct workstreamId\n- [ ] Unit test: Button disabled when workstream.activeClaudeSessionId is nil\n- [ ] Manual: Tap clear, verify messages disappear\n- [ ] Manual: Send new prompt after clear, verify new session starts\n- [ ] Manual: Verify workstream name unchanged after clear\n\n## Acceptance Criteria\n- Users can clear context via UI action (button/swipe)\n- Cleared workstreams show appropriate empty state\n\n## Parallelization\nCan be worked alongside: None\n\n## Dependencies\nRequires: Update ConversationView task (needs workstream context)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T20:10:50.874229-06:00","updated_at":"2025-12-30T10:38:15.874469-06:00","closed_at":"2025-12-30T10:38:15.874469-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-session-74t.12.4","depends_on_id":"voice-code-session-74t.12.3","type":"blocks","created_at":"2025-12-29T20:11:29.812179-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-session-74t.12.5","content_hash":"bb36f938899b7e4ea73d2928a55d564e13446a1ed5bc5c3a57292393ad024fbe","title":"Write iOS UI tests for workstream display","description":"## Design Reference\n@docs/design/workstream-abstraction.md#ios-tests\n\n## Context\nThe UI changes for workstream display need test coverage. This task adds unit tests for the view layer changes to ensure workstreams are displayed correctly and user interactions work as expected.\n\n## Requirements\n- [ ] Test SessionsView displays workstream list correctly\n- [ ] Test cleared workstream shows empty state indicator\n- [ ] Test navigation from session list to conversation passes workstream\n- [ ] Test prompt sending includes workstream_id\n- [ ] Test clear context button behavior\n- [ ] Test new workstream creation flow\n\n## Technical Approach\n- Files to create/modify:\n  - `ios/VoiceCodeTests/WorkstreamDisplayTests.swift` - New test file\n- Test patterns:\n  - Use PersistenceController.preview for CoreData\n  - Create test workstreams with various states (active, cleared)\n  - Verify view state matches workstream data\n- Mock VoiceCodeClient for verifying message payloads\n\n## Verification\n- [ ] All new tests pass\n- [ ] Tests cover happy path and edge cases\n- [ ] Tests run in CI without flakiness\n\n## Acceptance Criteria\n- Test coverage for workstream UI components\n- Tests verify all UI acceptance criteria\n\n## Parallelization\nCan be worked alongside: All other tasks (tests can be written incrementally)\n\n## Dependencies\nShould be completed after: All other UI tasks (to test final implementation)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-29T20:11:08.431191-06:00","updated_at":"2025-12-29T20:11:08.431191-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-session-74t.12.5","depends_on_id":"voice-code-session-74t.12.4","type":"blocks","created_at":"2025-12-29T20:11:36.121938-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-session-74t.2","content_hash":"e82fa6b879cd2bf25f337032f3af20b3a956ae5936b34b0d10c89c1f1a4e081d","title":"Add CDWorkstream CoreData entity and schema","description":"## Design Reference\n@docs/design/workstream-abstraction.md#ios-cdworkstream-entity\n@docs/design/workstream-abstraction.md#ios-coredata-schema-changes\n\n## Context\niOS needs a new CoreData entity to represent workstreams. This is the iOS foundation - the sync manager and VoiceCodeClient updates depend on this entity existing.\n\n## Requirements\n- [ ] Create new CoreData model version (e.g., VoiceCode 3.xcdatamodel)\n- [ ] Add CDWorkstream entity with all attributes from design\n- [ ] Set up indexes for id (unique), workingDirectory, and queue queries\n- [ ] Create `CDWorkstream.swift` with entity class\n- [ ] Add computed properties: `hasActiveSession`, `isCleared`\n- [ ] Add fetch request helpers: `fetchAllWorkstreams`, `fetchWorkstreams(workingDirectory:)`, `fetchWorkstream(id:)`, `fetchQueuedWorkstreams`\n- [ ] Conform to `Identifiable` protocol\n- [ ] Ensure lightweight migration is enabled in PersistenceController\n\n## Technical Approach\n- Files to create: `ios/VoiceCode/Models/CDWorkstream.swift`\n- Files to modify: `VoiceCode.xcdatamodeld` (add new version)\n- Entity attributes:\n  | Attribute | Type | Optional |\n  |-----------|------|----------|\n  | id | UUID | No |\n  | name | String | No |\n  | workingDirectory | String | No |\n  | activeClaudeSessionId | UUID | Yes |\n  | queuePriority | String | No |\n  | priorityOrder | Double | No |\n  | createdAt | Date | No |\n  | lastModified | Date | No |\n  | messageCount | Integer 32 | No |\n  | preview | String | Yes |\n  | unreadCount | Integer 32 | No |\n  | isInPriorityQueue | Boolean | No |\n  | priorityQueuedAt | Date | Yes |\n\n## Verification\n- [ ] Schema compiles without errors\n- [ ] Lightweight migration succeeds from previous version\n- [ ] Fetch requests return expected results\n- [ ] Manual: Create workstream in simulator, verify persistence\n\n## Acceptance Criteria\n- CDWorkstream entity exists with all required attributes\n- Fetch requests work for common query patterns\n- Migration from previous schema version works\n\n## Parallelization\nCan be worked alongside: Backend workstream state management task","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T22:18:22.529683-06:00","updated_at":"2025-12-28T23:06:26.232598-06:00","closed_at":"2025-12-28T23:06:26.232598-06:00","source_repo":"."}
{"id":"voice-code-session-74t.3","content_hash":"6766f7cd6dedee476f405c6d6cee271ac26a61ea848a607cdce1220a3a0d24c7","title":"Implement workstream WebSocket message handlers","description":"## Design Reference\n@docs/design/workstream-abstraction.md#websocket-protocol-changes\n@docs/design/workstream-abstraction.md#backend-message-handler-integration\n\n## Context\nThe backend needs new message handlers for workstream operations. These handlers use the workstream state management module to process client requests.\n\n## Requirements\n- [ ] Implement `handle-create-workstream` - creates workstream, sends `workstream_created`\n- [ ] Implement `handle-clear-context` - unlinks Claude session, sends `context_cleared`\n- [ ] Add `format-timestamp` utility if not in workstream module\n- [ ] Register handlers in message dispatch (handle-message fn)\n- [ ] Send `workstream_list` after `connected` response\n- [ ] Send `workstream_updated` when workstream metadata changes\n\n## Technical Approach\n- Files to modify: `backend/src/voice_code/server.clj`\n- Requires: `voice-code.workstream` namespace (from task 1)\n- Message types to handle:\n  - `create_workstream` → `workstream_created`\n  - `clear_context` → `context_cleared`\n- Error handling:\n  - Missing workstream_id → error message\n  - Missing working_directory (create) → error message\n  - Workstream not found (clear) → error message\n- Dependencies: Workstream state management module\n\n## Verification\n- [ ] Unit test: `handle-create-workstream` creates workstream and sends confirmation\n- [ ] Unit test: `handle-clear-context` unlinks session and returns previous ID\n- [ ] Unit test: `handle-clear-context` on workstream with no session returns null\n- [ ] Unit test: Error cases return appropriate error messages\n- [ ] Manual: Send create_workstream via WebSocket, verify workstream_created response\n\n## Acceptance Criteria\n- create_workstream message creates workstream and confirms\n- clear_context message unlinks Claude session and confirms\n- Error messages returned for invalid requests\n- workstream_list sent on connection\n\n## Parallelization\nCan be worked alongside: iOS WorkstreamSyncManager task\nDependencies: Workstream state management module (task 1)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T22:18:59.838779-06:00","updated_at":"2025-12-29T11:05:57.033334-06:00","closed_at":"2025-12-29T11:05:57.033334-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-session-74t.3","depends_on_id":"voice-code-session-74t.1","type":"blocks","created_at":"2025-12-28T22:22:26.598679-06:00","created_by":"daemon"}]}
{"id":"voice-code-session-74t.4","content_hash":"e9c2d44aad3c37d9fe857d3b04e843eb460b8a75293ae7f3ab3f075812a70dc9","title":"Implement WorkstreamSyncManager for iOS","description":"## Design Reference\n@docs/design/workstream-abstraction.md#ios-workstreamsyncmanager\n\n## Context\niOS needs a sync manager to handle workstream-related WebSocket messages and update CoreData. This mirrors the pattern of SessionSyncManager but for workstreams.\n\n## Requirements\n- [ ] Create `WorkstreamSyncManager` class\n- [ ] Implement `handleWorkstreamList(_:)` - upserts workstreams from backend list\n- [ ] Implement `handleWorkstreamUpdated(_:)` - updates single workstream\n- [ ] Implement `handleContextCleared(workstreamId:previousClaudeSessionId:)` - clears active session, deletes messages\n- [ ] Implement `createWorkstream(workingDirectory:name:)` - local creation before backend sync\n- [ ] Add `Notification.Name.workstreamListDidUpdate` notification\n- [ ] Use background context for database operations\n- [ ] All handlers must be async\n\n## Technical Approach\n- Files to create: `ios/VoiceCode/Managers/WorkstreamSyncManager.swift`\n- Requires: CDWorkstream entity (from task 2)\n- Pattern: Use `persistenceController.performBackgroundTask` for thread safety\n- Message cleanup on clear: Use `NSBatchDeleteRequest` for efficiency\n- Upsert logic: Fetch by ID, update if exists, create if not\n\n## Verification\n- [ ] Unit test: `handleWorkstreamList` creates new workstreams\n- [ ] Unit test: `handleWorkstreamList` updates existing workstreams\n- [ ] Unit test: `handleContextCleared` sets activeClaudeSessionId to nil\n- [ ] Unit test: `handleContextCleared` deletes messages for previous session\n- [ ] Unit test: `handleContextCleared` with nil previousSessionId doesn't crash\n- [ ] Manual: Connect to backend, verify workstream_list populates CoreData\n\n## Acceptance Criteria\n- Workstream list syncs from backend to CoreData\n- Context cleared operation updates workstream and cleans up messages\n- Local workstream creation works for optimistic UI\n\n## Parallelization\nCan be worked alongside: Backend message handlers task\nDependencies: CDWorkstream entity (task 2)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T22:19:17.322988-06:00","updated_at":"2025-12-29T11:47:20.943577-06:00","closed_at":"2025-12-29T11:47:20.943577-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-session-74t.4","depends_on_id":"voice-code-session-74t.2","type":"blocks","created_at":"2025-12-28T22:22:26.637493-06:00","created_by":"daemon"}]}
{"id":"voice-code-session-74t.5","content_hash":"a21fdec63f1cb905fb2edf1f668b1a95aa51620a4e43dfe14459af259de38124","title":"Update prompt handler to use workstream abstraction","description":"## Design Reference\n@docs/design/workstream-abstraction.md#modified-message-prompt\n@docs/design/workstream-abstraction.md#backward-compatibility-legacy-sessionid-prompts\n\n## Context\nThe prompt handler needs to support workstream_id as the primary session identifier while maintaining backward compatibility with legacy session_id fields.\n\n## Requirements\n- [ ] Implement `handle-prompt-with-workstream` - new prompt flow using workstream_id\n- [ ] Implement `handle-prompt-legacy` - backward compatibility for new_session_id/resume_session_id\n- [ ] Implement `get-or-create-workstream-for-session!` - auto-create workstream wrapper for legacy sessions\n- [ ] Implement unified `handle-prompt` - routes to workstream or legacy handler\n- [ ] Generate new Claude session ID when workstream has no active session\n- [ ] Link newly created Claude session to workstream\n- [ ] Acquire session lock before Claude invocation\n- [ ] Send `workstream_updated` after successful prompt\n\n## Technical Approach\n- Files to modify: `backend/src/voice_code/server.clj`\n- Requires: `voice-code.workstream` namespace\n- Prompt flow with workstream_id:\n  1. Look up workstream\n  2. If active_claude_session_id exists → resume\n  3. If nil → generate new UUID, link to workstream, create new session\n- Legacy flow:\n  1. new_session_id → create workstream + link\n  2. resume_session_id → find/create workstream, then delegate\n- Session locking: Use existing `acquire-session-lock!` / `release-session-lock!`\n\n## Verification\n- [ ] Unit test: Prompt with workstream_id creates new Claude session when none linked\n- [ ] Unit test: Prompt with workstream_id resumes existing Claude session\n- [ ] Unit test: Prompt with legacy new_session_id auto-creates workstream\n- [ ] Unit test: Prompt with legacy resume_session_id finds existing workstream\n- [ ] Unit test: Session lock acquired before Claude invocation\n- [ ] Manual: Send prompt via WebSocket, verify Claude session linked to workstream\n\n## Acceptance Criteria\n- Prompts with workstream_id work correctly (new and resume)\n- Legacy session_id prompts continue to work\n- Claude sessions automatically linked to workstreams\n- Backward compatibility: legacy session_id prompts still work\n\n## Parallelization\nDependencies: Workstream state management module (task 1), Message handlers (task 3)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T22:19:44.607127-06:00","updated_at":"2025-12-29T13:19:56.455128-06:00","closed_at":"2025-12-29T13:19:56.455128-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-session-74t.5","depends_on_id":"voice-code-session-74t.1","type":"blocks","created_at":"2025-12-28T22:22:26.670461-06:00","created_by":"daemon"},{"issue_id":"voice-code-session-74t.5","depends_on_id":"voice-code-session-74t.3","type":"blocks","created_at":"2025-12-28T22:22:26.703788-06:00","created_by":"daemon"}]}
{"id":"voice-code-session-74t.6","content_hash":"a705577f5e54af4f99acec1b6ee63791b70804560e8dfcd853c9ff00c4a8e946","title":"Update VoiceCodeClient for workstream messaging","description":"## Design Reference\n@docs/design/workstream-abstraction.md#ios-voicecodeclient-updates\n\n## Context\nVoiceCodeClient needs to handle new workstream message types and provide methods for sending workstream-related requests.\n\n## Requirements\n- [ ] Add `workstreamSyncManager` property\n- [ ] Handle `workstream_list` message type\n- [ ] Handle `workstream_created` message type\n- [ ] Handle `workstream_updated` message type\n- [ ] Handle `context_cleared` message type\n- [ ] Implement `createWorkstream(id:name:workingDirectory:)` send method\n- [ ] Implement `clearContext(workstreamId:)` send method\n- [ ] Implement `sendPrompt(text:workstreamId:workingDirectory:systemPrompt:)` send method\n- [ ] Wrap async handler calls in Task blocks\n\n## Technical Approach\n- Files to modify: `ios/VoiceCode/Managers/VoiceCodeClient.swift`\n- Requires: WorkstreamSyncManager (from task 4)\n- Message handling in `handleMessage(_:)` switch statement\n- All UUID strings must use `.lowercased()` per STANDARDS.md\n- Async handlers wrapped in `Task { await ... }`\n\n## Verification\n- [ ] Unit test: `workstream_list` message triggers sync manager\n- [ ] Unit test: `context_cleared` message triggers sync manager with correct params\n- [ ] Unit test: `createWorkstream` sends correct JSON structure\n- [ ] Unit test: `clearContext` sends correct JSON structure\n- [ ] Unit test: `sendPrompt` with workstreamId sends correct JSON structure\n- [ ] Manual: Connect to backend, verify workstream_list handled correctly\n\n## Acceptance Criteria\n- All workstream message types handled\n- Send methods produce correct JSON with snake_case keys\n- UUIDs are lowercase in all messages\n\n## Parallelization\nDependencies: WorkstreamSyncManager (task 4)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T22:20:01.434809-06:00","updated_at":"2025-12-29T15:51:18.794921-06:00","closed_at":"2025-12-29T15:51:18.794921-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-session-74t.6","depends_on_id":"voice-code-session-74t.4","type":"blocks","created_at":"2025-12-28T22:22:26.735948-06:00","created_by":"daemon"}]}
{"id":"voice-code-session-74t.7","content_hash":"db8abf76885f26748cd4edab3888209e72993f665d0d8353769a6790fb24d36e","title":"Implement session-to-workstream migration","description":"## Design Reference\n@docs/design/workstream-abstraction.md#migration-strategy\n@docs/design/workstream-abstraction.md#backend-migration\n\n## Context\nExisting Claude sessions need to be wrapped in workstreams during migration. This runs on backend startup and creates workstream wrappers for orphaned sessions.\n\n## Requirements\n- [ ] Implement `migrate-sessions-to-workstreams!` function\n- [ ] Scan session-index for sessions without workstream-id\n- [ ] Create workstream wrapper for each orphaned session\n- [ ] Link Claude session to new workstream\n- [ ] Update session metadata with workstream-id reference\n- [ ] Save both indices after migration\n- [ ] Call migration on backend startup (after loading indices)\n- [ ] Log migration statistics\n\n## Technical Approach\n- Files to modify: `backend/src/voice_code/workstream.clj`, `backend/src/voice_code/server.clj`\n- Migration logic:\n  1. Get all sessions from session-index\n  2. Filter to those without :workstream-id\n  3. For each orphaned session:\n     - Generate new workstream UUID\n     - Create workstream with session's name/working-directory\n     - Set active-claude-session-id to session ID\n     - Update session metadata with workstream-id\n  4. Save both indices\n- Idempotent: Running multiple times creates no duplicates\n\n## Verification\n- [ ] Unit test: Migration creates workstream for orphaned session\n- [ ] Unit test: Migration preserves session name and working directory\n- [ ] Unit test: Migration links Claude session to workstream\n- [ ] Unit test: Running migration twice doesn't create duplicates\n- [ ] Manual: Start backend with existing sessions, verify workstreams created\n\n## Acceptance Criteria\n- Migration creates workstream wrappers for existing sessions\n- Existing sessions continue to work after migration\n- Migration is idempotent\n\n## Parallelization\nDependencies: Workstream state management module (task 1)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T22:20:27.753354-06:00","updated_at":"2025-12-29T16:01:14.720599-06:00","closed_at":"2025-12-29T16:01:14.720599-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-session-74t.7","depends_on_id":"voice-code-session-74t.1","type":"blocks","created_at":"2025-12-28T22:22:26.768026-06:00","created_by":"daemon"}]}
{"id":"voice-code-session-74t.8","content_hash":"a4837683bdc936b29ed0ea87905ff833fc891458700fd0187c51a3e36d78ffeb","title":"Integrate workstream abstraction with recipe system","description":"## Design Reference\n@docs/design/workstream-abstraction.md#recipe-integration\n@docs/design/workstream-abstraction.md#modified-message-startrecipe\n\n## Context\nRecipes need to use workstream_id instead of session_id, and recipes that require fresh context should be able to clear and continue on the same workstream.\n\n## Requirements\n- [ ] Update `start_recipe` handler to accept workstream_id\n- [ ] Implement `execute-recipe-step-with-fresh-context`\n- [ ] Support `:fresh-context true` flag on recipe steps\n- [ ] Clear context internally when recipe step requires it\n- [ ] Notify client of context_cleared when recipe clears\n- [ ] Continue recipe execution on new Claude session\n- [ ] Maintain workstream identity through recipe execution\n\n## Technical Approach\n- Files to modify: `backend/src/voice_code/server.clj` (or recipe-specific namespace)\n- Recipe step execution flow:\n  1. Check if step has :fresh-context true\n  2. If yes, call `unlink-claude-session!`\n  3. Send `context_cleared` to client\n  4. Execute step (will create new Claude session)\n- Workstream ID remains constant throughout recipe\n\n## Verification\n- [ ] Unit test: Recipe with fresh-context step clears and continues\n- [ ] Unit test: Workstream ID unchanged after fresh context\n- [ ] Unit test: New Claude session created for fresh context step\n- [ ] Integration test: Full recipe execution with fresh context step\n- [ ] Manual: Run recipe that clears context, verify workstream stays same\n\n## Acceptance Criteria\n- Recipes can request fresh context without UI disruption\n- start_recipe accepts workstream_id\n- Recipe execution maintains workstream identity\n\n## Parallelization\nDependencies: Workstream state management (task 1), Message handlers (task 3), Prompt handler (task 5)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T22:20:42.712592-06:00","updated_at":"2025-12-29T16:38:01.922473-06:00","closed_at":"2025-12-29T16:38:01.922473-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-session-74t.8","depends_on_id":"voice-code-session-74t.1","type":"blocks","created_at":"2025-12-28T22:22:26.8002-06:00","created_by":"daemon"},{"issue_id":"voice-code-session-74t.8","depends_on_id":"voice-code-session-74t.3","type":"blocks","created_at":"2025-12-28T22:22:26.832995-06:00","created_by":"daemon"},{"issue_id":"voice-code-session-74t.8","depends_on_id":"voice-code-session-74t.5","type":"blocks","created_at":"2025-12-28T22:22:26.865455-06:00","created_by":"daemon"}]}
{"id":"voice-code-session-74t.9","content_hash":"422175bc5944e7e62c7a221a4edb31648857e665af3a30b888da2ca170f64bb4","title":"Write backend unit tests for workstream module","description":"## Design Reference\n@docs/design/workstream-abstraction.md#backend-tests\n\n## Context\nComprehensive unit tests ensure the workstream state management and handlers work correctly before integration testing.\n\n## Requirements\n- [ ] Create `voice-code.workstream-test` namespace\n- [ ] Test `create-workstream!` with default and custom names\n- [ ] Test `link-claude-session!` links correctly\n- [ ] Test `unlink-claude-session!` returns previous ID and clears\n- [ ] Test `unlink-claude-session!` returns nil when no active session\n- [ ] Test `update-workstream!` updates fields and timestamp\n- [ ] Test persistence round-trip (save/load)\n- [ ] Test migration creates workstreams for orphaned sessions\n- [ ] Test migration is idempotent\n\n## Technical Approach\n- Files to create: `backend/test/voice_code/workstream_test.clj`\n- Use `clojure.test` framework\n- Reset `workstream-index` atom before each test\n- Use temp directory for persistence tests to avoid side effects\n\n## Verification\n- [ ] All tests pass: `clj -X:test`\n- [ ] Test coverage for all public functions\n- [ ] Edge cases covered (nil values, missing workstreams)\n\n## Acceptance Criteria\n- All unit tests pass\n- Core CRUD operations tested\n- Session linking/unlinking tested\n- Migration tested\n\n## Parallelization\nDependencies: Workstream state management (task 1), Migration (task 7)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T22:21:05.760796-06:00","updated_at":"2025-12-29T16:13:39.03422-06:00","closed_at":"2025-12-29T16:13:39.03422-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-session-74t.9","depends_on_id":"voice-code-session-74t.1","type":"blocks","created_at":"2025-12-28T22:22:26.897433-06:00","created_by":"daemon"},{"issue_id":"voice-code-session-74t.9","depends_on_id":"voice-code-session-74t.7","type":"blocks","created_at":"2025-12-28T22:22:26.929251-06:00","created_by":"daemon"}]}
