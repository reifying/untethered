{"id":"voice-code-recipe-session-1k8","content_hash":"223964894177680d9f254aa9719f75593c35b78e573aed4d88749e48b4fae3bf","title":"Recipe New Session Toggle","description":"## Design Document\n@docs/design/recipe-new-session-toggle.md\n\n## Overview\nAdd a toggle to RecipeMenuView that allows users to start recipes in a fresh session instead of the current session. When enabled, generates a new UUID and sends it to the backend, which creates the session automatically. User receives confirmation alert and can navigate to the new session from the Sessions list.\n\n## Acceptance Criteria\n1. Toggle labeled \"Start in new session\" appears in RecipeMenuView above the recipe list\n2. Toggle defaults to OFF (disabled) each time the sheet opens\n3. When toggle is ON and recipe selected:\n   - New lowercase UUID is generated\n   - `start_recipe` WebSocket message contains the new UUID as `session_id`\n   - Confirmation alert appears with title \"Recipe Started\"\n   - Alert message indicates recipe is in a new session\n   - User must tap OK to dismiss the sheet\n4. When toggle is OFF and recipe selected:\n   - Current session ID is used in `start_recipe` message\n   - Sheet dismisses automatically after `recipe_started` confirmation (existing behavior)\n5. New session appears in Sessions list within a few seconds via existing replication\n6. New session has the same working directory as the session where the recipe was initiated\n7. Toggle state does not persist between sheet presentations","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-31T23:36:05.820384-06:00","updated_at":"2026-01-01T10:21:25.511531-06:00","closed_at":"2026-01-01T10:21:25.511531-06:00","source_repo":"."}
{"id":"voice-code-recipe-session-1k8.2","content_hash":"8605747f7d331f9296aba86b6e4ea285cc65abf7997fb533754cc4e625215f2f","title":"Add state properties for new session toggle","description":"## Design Reference\n@docs/design/recipe-new-session-toggle.md#ios-state-changes\n\n## Context\nFirst step in implementing the recipe new session toggle. Adds the required @State properties to RecipeMenuView that will control the toggle behavior and confirmation alert visibility.\n\n## Requirements\n- [ ] Add `@State private var useNewSession = false` property\n- [ ] Add `@State private var showingNewSessionConfirmation = false` property\n- [ ] Properties must be placed with other @State declarations in the struct\n\n## Technical Approach\n- Files to modify: `ios/VoiceCode/Views/RecipeMenuView.swift`\n- New files to create: None\n- Dependencies: None (first task)\n\nAdd two new @State properties after the existing ones:\n```swift\n@State private var useNewSession = false  // Toggle state\n@State private var showingNewSessionConfirmation = false  // Alert state\n```\n\n## Verification\n- [ ] Build succeeds with new properties\n- [ ] No compiler warnings\n\n## Acceptance Criteria\n- Toggle defaults to OFF (disabled) each time the sheet opens (AC #2)\n- Toggle state does not persist between sheet presentations (AC #7)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T23:36:45.494632-06:00","updated_at":"2026-01-01T10:41:30.578292-06:00","closed_at":"2026-01-01T10:41:30.578292-06:00","source_repo":"."}
{"id":"voice-code-recipe-session-1k8.3","content_hash":"4fd231e97693fa8a3e7bcf2894adb563e7039536edf9ae51e6c59bdaeec34526","title":"Add toggle UI section to recipe list","description":"## Design Reference\n@docs/design/recipe-new-session-toggle.md#code-examples\n\n## Context\nAdds the visual toggle to RecipeMenuView that allows users to enable/disable the \"start in new session\" behavior. The toggle appears as a Section at the top of the recipe list.\n\n## Requirements\n- [ ] Add Section with Toggle at top of List\n- [ ] Toggle label: \"Start in new session\"\n- [ ] Section footer explains behavior: \"Creates a fresh session for this recipe instead of using the current session.\"\n- [ ] Wrap existing recipe ForEach in a Section titled \"Recipes\"\n\n## Technical Approach\n- Files to modify: `ios/VoiceCode/Views/RecipeMenuView.swift`\n- New files to create: None\n- Dependencies: Task \"Add state properties for new session toggle\"\n\nReplace the existing List content:\n```swift\nList {\n    // NEW: Toggle section at top\n    Section {\n        Toggle(\"Start in new session\", isOn: $useNewSession)\n    } footer: {\n        Text(\"Creates a fresh session for this recipe instead of using the current session.\")\n    }\n\n    // Existing recipe list wrapped in section\n    Section(\"Recipes\") {\n        ForEach(client.availableRecipes) { recipe in\n            // ... existing RecipeRowView code ...\n        }\n    }\n}\n```\n\n## Verification\n- [ ] Build succeeds\n- [ ] Toggle visible at top of recipe list when recipes are loaded\n- [ ] Toggle can be switched ON/OFF\n- [ ] Footer text displays correctly\n\n## Acceptance Criteria\n- Toggle labeled \"Start in new session\" appears in RecipeMenuView above the recipe list (AC #1)\n\n## Parallelization\nCan be worked alongside: None (depends on state properties task)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T23:36:58.374445-06:00","updated_at":"2026-01-01T10:41:30.993366-06:00","closed_at":"2026-01-01T10:41:30.993366-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-recipe-session-1k8.3","depends_on_id":"voice-code-recipe-session-1k8.2","type":"blocks","created_at":"2025-12-31T23:37:56.07474-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-recipe-session-1k8.4","content_hash":"73e17337f4f59c271b11fa23a40198a1dc48ff715daadee135c5ac59092d664b","title":"Modify selectRecipe to generate new session ID when toggle enabled","description":"## Design Reference\n@docs/design/recipe-new-session-toggle.md#code-examples\n\n## Context\nCore logic change that determines which session ID to use when starting a recipe. When the toggle is ON, generates a new lowercase UUID instead of using the current session ID.\n\n## Requirements\n- [ ] Check `useNewSession` state at start of `selectRecipe()`\n- [ ] If true, generate new UUID: `UUID().uuidString.lowercased()`\n- [ ] If false, use existing `sessionId` parameter\n- [ ] Log which session ID is being used\n- [ ] Capture `useNewSession` value before async operation for use in completion handler\n\n## Technical Approach\n- Files to modify: `ios/VoiceCode/Views/RecipeMenuView.swift`\n- New files to create: None\n- Dependencies: Task \"Add state properties for new session toggle\"\n\nModify the start of `selectRecipe()`:\n```swift\nprivate func selectRecipe(recipeId: String) {\n    // NEW: Determine which session ID to use\n    let targetSessionId: String\n    if useNewSession {\n        targetSessionId = UUID().uuidString.lowercased()\n        print(\"ðŸ“¤ [RecipeMenuView] Starting recipe in NEW session: \\(targetSessionId)\")\n    } else {\n        targetSessionId = sessionId\n    }\n    \n    // ... rest uses targetSessionId instead of sessionId ...\n    client.startRecipe(sessionId: targetSessionId, recipeId: recipeId, workingDirectory: workingDirectory)\n    \n    // Capture for use in closure\n    let shouldShowConfirmation = useNewSession\n    \n    // Update Combine subscription to use targetSessionId\n    client.$activeRecipes\n        .first { $0[targetSessionId] != nil }\n        // ...\n}\n```\n\n## Verification\n- [ ] Build succeeds\n- [ ] Console log shows \"NEW session\" message when toggle is ON\n- [ ] Console log shows existing session ID when toggle is OFF\n- [ ] WebSocket message contains correct session_id\n\n## Acceptance Criteria\n- When toggle is ON: New lowercase UUID is generated (AC #3a)\n- When toggle is ON: `start_recipe` WebSocket message contains the new UUID as `session_id` (AC #3b)\n- When toggle is OFF: Current session ID is used in `start_recipe` message (AC #4a)\n\n## Parallelization\nCan be worked alongside: \"Add toggle UI section to recipe list\" (both depend on state properties)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T23:37:15.244128-06:00","updated_at":"2026-01-01T10:41:31.404194-06:00","closed_at":"2026-01-01T10:41:31.404194-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-recipe-session-1k8.4","depends_on_id":"voice-code-recipe-session-1k8.2","type":"blocks","created_at":"2025-12-31T23:38:02.48261-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-recipe-session-1k8.5","content_hash":"7e67267b8a1c8a62451484ff75a4ebb51983548876bff9d38235a2f62bf0a7cc","title":"Add confirmation alert for new session recipe start","description":"## Design Reference\n@docs/design/recipe-new-session-toggle.md#code-examples\n\n## Context\nWhen a recipe starts in a new session, users need feedback since they won't automatically navigate to the new session. This task adds a confirmation alert that informs the user and provides clear next steps.\n\n## Requirements\n- [ ] Add `.alert()` modifier to NavigationView\n- [ ] Alert title: \"Recipe Started\"\n- [ ] Alert message: \"Recipe is running in a new session. Go to Sessions to view it.\"\n- [ ] Single \"OK\" button that dismisses both alert and sheet\n- [ ] Modify Combine completion handler to show alert when `shouldShowConfirmation` is true\n- [ ] Use binding wrapper pattern consistent with existing codebase\n\n## Technical Approach\n- Files to modify: `ios/VoiceCode/Views/RecipeMenuView.swift`\n- New files to create: None\n- Dependencies: \n  - Task \"Add state properties for new session toggle\"\n  - Task \"Modify selectRecipe to generate new session ID when toggle enabled\"\n\nAdd alert modifier after NavigationView:\n```swift\n.alert(\"Recipe Started\", isPresented: $showingNewSessionConfirmation) {\n    Button(\"OK\") {\n        dismiss()\n    }\n} message: {\n    Text(\"Recipe is running in a new session. Go to Sessions to view it.\")\n}\n```\n\nModify the Combine `receiveValue` handler:\n```swift\nreceiveValue: { [self] _ in\n    isLoadingBinding.wrappedValue = false\n    if shouldShowConfirmation {\n        self.showingNewSessionConfirmation = true\n    } else {\n        dismissAction()\n    }\n}\n```\n\n## Verification\n- [ ] Build succeeds\n- [ ] Alert appears when starting recipe with toggle ON\n- [ ] Alert does NOT appear when starting recipe with toggle OFF\n- [ ] Tapping OK dismisses alert and sheet\n- [ ] Sheet dismisses automatically when toggle is OFF (existing behavior preserved)\n\n## Acceptance Criteria\n- Confirmation alert appears with title \"Recipe Started\" (AC #3c)\n- Alert message indicates recipe is in a new session (AC #3d)\n- User must tap OK to dismiss the sheet (AC #3e)\n- When toggle is OFF: Sheet dismisses automatically after `recipe_started` confirmation (AC #4b)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-31T23:37:32.048126-06:00","updated_at":"2026-01-01T10:41:31.815977-06:00","closed_at":"2026-01-01T10:41:31.815977-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-recipe-session-1k8.5","depends_on_id":"voice-code-recipe-session-1k8.4","type":"blocks","created_at":"2025-12-31T23:38:02.889025-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-recipe-session-1k8.6","content_hash":"efe76ad18b6d2bc411fc5aa029dce3af6c13742039be0fa7a13407ce4061afd4","title":"Manual testing of recipe new session toggle","description":"## Design Reference\n@docs/design/recipe-new-session-toggle.md#integration-tests-manual-test-script\n\n## Context\nFinal verification step to ensure the feature works end-to-end. Executes the 4 manual test scenarios defined in the design document to validate all acceptance criteria.\n\n## Requirements\n- [ ] Execute Test 1: New Session Recipe Start\n- [ ] Execute Test 2: Existing Session Recipe Start (Toggle Off)\n- [ ] Execute Test 3: Working Directory Inheritance\n- [ ] Execute Test 4: Toggle State Reset\n\n## Technical Approach\n- Files to modify: None\n- New files to create: None\n- Dependencies: All previous implementation tasks\n\n### Prerequisites\n- iOS app connected to backend\n- At least one recipe available (e.g., \"implement-and-review\")\n- Existing session with a working directory set\n\n### Test 1: New Session Recipe Start\n1. Open an existing session in ConversationView\n2. Tap the recipe button in the toolbar\n3. Verify the \"Start in new session\" toggle appears at the top of the list\n4. Verify the toggle is OFF by default\n5. Enable the toggle (switch to ON)\n6. Select any recipe (e.g., \"Implement \u0026 Review\")\n7. Wait for recipe to start (loading indicator)\n8. Verify an alert appears with title \"Recipe Started\"\n9. Verify alert message says \"Recipe is running in a new session. Go to Sessions to view it.\"\n10. Tap \"OK\" to dismiss\n11. Navigate back to Sessions list\n12. Verify a new session appears with the same working directory\n13. Open the new session and verify the recipe is active (green recipe icon)\n\n### Test 2: Existing Session Recipe Start (Toggle Off)\n1. Open an existing session in ConversationView\n2. Tap the recipe button in the toolbar\n3. Verify the toggle is OFF (default state)\n4. Do NOT enable the toggle\n5. Select any recipe\n6. Verify the sheet dismisses automatically (no confirmation alert)\n7. Verify the recipe is running in the CURRENT session (not a new one)\n8. Verify no new session was created in Sessions list\n\n### Test 3: Working Directory Inheritance\n1. Create or open a session with working directory `/path/to/project`\n2. Start a recipe with \"Start in new session\" enabled\n3. After recipe starts, navigate to the new session\n4. Verify the new session's working directory is `/path/to/project` (same as parent)\n\n### Test 4: Toggle State Reset\n1. Open recipe menu, enable the toggle\n2. Cancel (dismiss without selecting)\n3. Re-open recipe menu\n4. Verify the toggle is OFF (state should not persist)\n\n## Verification\n- [ ] All 4 test scenarios pass\n- [ ] No regressions in existing recipe functionality\n\n## Acceptance Criteria\nValidates ALL acceptance criteria (AC #1-7)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-31T23:37:50.340819-06:00","updated_at":"2025-12-31T23:37:50.340819-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-recipe-session-1k8.6","depends_on_id":"voice-code-recipe-session-1k8.3","type":"blocks","created_at":"2025-12-31T23:38:03.296865-06:00","created_by":"travisbrown"},{"issue_id":"voice-code-recipe-session-1k8.6","depends_on_id":"voice-code-recipe-session-1k8.5","type":"blocks","created_at":"2025-12-31T23:38:03.707416-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-message-too-long-hfn","content_hash":"8d917e4bff5fcc1959d302ec7ac539e1ee01e7496bcdda2aa9e10517a8fd4bbb","title":"Delta Sync Session History","description":"## Design Document\n@docs/design/delta-sync-session-history.md\n\n## Overview\nImplement delta sync for session history to eliminate redundant message transfer and improve truncation behavior. When iOS subscribes to a session, it sends the UUID of its newest cached message. The backend only sends messages newer than that ID, using smart per-message truncation (20KB max) instead of dividing budget equally among all messages.\n\n## Acceptance Criteria\n1. Subscribe with `last_message_id` returns only newer messages\n2. Subscribe without `last_message_id` returns recent messages (backward compatible)\n3. Messages under 20KB are never truncated\n4. Messages over 20KB are truncated with marker showing size\n5. Response never exceeds client's max message size setting\n6. Newest messages are prioritized when budget is exhausted\n7. `is_complete: false` indicates budget exhaustion\n8. iOS displays truncated content with appropriate indicator\n9. All existing tests continue to pass","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-31T17:07:49.744716-06:00","updated_at":"2025-12-31T17:07:49.744716-06:00","source_repo":"."}
{"id":"voice-code-message-too-long-hfn.2","content_hash":"a21eebf96f8de0c796c2a21375dd30ba7d66a43bbe708d88c759dc984c6277a6","title":"Implement build-session-history-response function","description":"## Design Reference\n@docs/design/delta-sync-session-history.md#backend-new-truncation-algorithm\n\n## Context\nThis is the core algorithm for delta sync. It replaces the current equal-budget truncation with smart per-message truncation that prioritizes recent messages and preserves small messages intact.\n\n## Requirements\n- [ ] Create `per-message-max-bytes` constant (20KB)\n- [ ] Implement `build-session-history-response` function with delta sync logic\n- [ ] Find messages newer than `last-message-id` (or all if not provided)\n- [ ] Work backwards from newest message, adding until budget exhausted\n- [ ] Truncate only messages exceeding per-message-max (20KB)\n- [ ] Return `is-complete`, `oldest-message-id`, `newest-message-id`\n\n## Technical Approach\n- File to modify: `backend/src/voice_code/server.clj`\n- Algorithm:\n  1. Find index of last-message-id in message list\n  2. Get messages newer than that index (or all if not found)\n  3. Reverse to process newest first\n  4. Loop: truncate large messages, add to result until budget exhausted\n  5. Reverse back to chronological order\n  6. Return with metadata fields\n\n## Verification\n- [ ] Unit test: Empty message list returns empty result with nil IDs\n- [ ] Unit test: All messages fit in budget â†’ is-complete true\n- [ ] Unit test: Budget exhausted mid-way â†’ is-complete false, newest prioritized\n- [ ] Unit test: last-message-id found â†’ only newer messages returned\n- [ ] Unit test: last-message-id not found â†’ all recent messages returned\n- [ ] Unit test: Large messages (\u003e20KB) truncated with marker\n- [ ] Unit test: Small messages (\u003c20KB) preserved intact\n\n## Acceptance Criteria\n- Messages under 20KB are never truncated\n- Messages over 20KB are truncated with marker showing size\n- Newest messages are prioritized when budget is exhausted","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-31T17:08:42.505319-06:00","updated_at":"2025-12-31T17:08:42.505319-06:00","source_repo":"."}
{"id":"voice-code-message-too-long-hfn.3","content_hash":"db62b66a87f3f69e8bcdc609e2ddc0765366977d4e8f55730480b02c1c082b2c","title":"Update subscribe handler to use delta sync algorithm","description":"## Design Reference\n@docs/design/delta-sync-session-history.md#backend-updated-subscribe-handler\n\n## Context\nThe subscribe handler must be updated to parse the new `last_message_id` field, call the new `build-session-history-response` function, and return the new response fields.\n\n## Requirements\n- [ ] Parse optional `last-message-id` from subscribe message\n- [ ] Pass `last-message-id` to `build-session-history-response`\n- [ ] Include `oldest-message-id`, `newest-message-id`, `is-complete` in response\n- [ ] Log delta sync usage for debugging\n- [ ] Handle backward compatibility (missing `last-message-id` = full history)\n\n## Technical Approach\n- File to modify: `backend/src/voice_code/server.clj`\n- In the \"subscribe\" case of message handler:\n  1. Extract `last-message-id` from data map\n  2. Call `build-session-history-response` with filtered messages, last-message-id, and max-bytes\n  3. Destructure result to get messages, is-complete, oldest-message-id, newest-message-id\n  4. Include all fields in `session-history` response\n\n## Dependencies\n- Requires: \"Implement build-session-history-response function\"\n\n## Verification\n- [ ] Integration test: Subscribe without last_message_id returns recent messages\n- [ ] Integration test: Subscribe with valid last_message_id returns only newer\n- [ ] Integration test: Subscribe with stale/unknown last_message_id returns recent messages\n- [ ] Integration test: Response includes is_complete, oldest_message_id, newest_message_id\n- [ ] All existing subscribe tests continue to pass\n\n## Acceptance Criteria\n- Subscribe with `last_message_id` returns only newer messages\n- Subscribe without `last_message_id` returns recent messages (backward compatible)\n- All existing tests continue to pass","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-31T17:09:05.07216-06:00","updated_at":"2025-12-31T17:09:05.07216-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-message-too-long-hfn.3","depends_on_id":"voice-code-message-too-long-hfn.2","type":"blocks","created_at":"2025-12-31T17:09:10.946434-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-message-too-long-hfn.4","content_hash":"a922c37a930becb406a929802d1d8abe3947ef8c1028be51a4db0407396d52bd","title":"Implement iOS getNewestCachedMessageId function","description":"## Design Reference\n@docs/design/delta-sync-session-history.md#ios-updated-subscribe-call\n\n## Context\niOS needs a function to query CoreData for the newest message UUID for a given session. This UUID will be sent to the backend as `last_message_id` to enable delta sync.\n\n## Requirements\n- [ ] Create `getNewestCachedMessageId(sessionId:)` function in VoiceCodeClient\n- [ ] Query CDMessage sorted by timestamp descending, limit 1\n- [ ] Return the message's UUID as lowercase string (per STANDARDS.md)\n- [ ] Return nil on error or if no messages exist\n- [ ] Log errors for debugging\n\n## Technical Approach\n- File to modify: `ios/VoiceCode/Managers/VoiceCodeClient.swift`\n- Implementation:\n  1. Parse sessionId string to UUID\n  2. Create NSFetchRequest for CDMessage\n  3. Set predicate: sessionId == uuid\n  4. Set sort: timestamp descending\n  5. Set fetchLimit: 1\n  6. Execute fetch on PersistenceController.shared.container.viewContext\n  7. Return first result's id.uuidString.lowercased()\n\n## Parallelization\nCan be worked alongside: \"Update subscribe handler to use delta sync algorithm\"\n\n## Verification\n- [ ] Manual test: Function returns correct UUID for session with messages\n- [ ] Manual test: Function returns nil for session with no messages\n- [ ] Manual test: Function returns nil for invalid session ID\n- [ ] Verify UUID is lowercase\n\n## Acceptance Criteria\n- iOS can retrieve the newest cached message ID for any session","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-31T17:09:31.941192-06:00","updated_at":"2025-12-31T17:09:31.941192-06:00","source_repo":"."}
{"id":"voice-code-message-too-long-hfn.5","content_hash":"95bb7f5d225b3673b0459c7d5d3c0d11c230c351598bfcd8c97d989c51bda62a","title":"Update iOS subscribe to send last_message_id","description":"## Design Reference\n@docs/design/delta-sync-session-history.md#ios-updated-subscribe-call\n\n## Context\nThe iOS subscribe call must be updated to include `last_message_id` when subscribing to a session. This enables delta sync, reducing redundant data transfer.\n\n## Requirements\n- [ ] Update `subscribe(sessionId:)` to call `getNewestCachedMessageId`\n- [ ] Include `last_message_id` in subscribe message if available\n- [ ] Log whether delta sync is being used\n- [ ] Maintain backward compatibility (message still valid without last_message_id)\n\n## Technical Approach\n- File to modify: `ios/VoiceCode/Managers/VoiceCodeClient.swift`\n- In `subscribe(sessionId:)`:\n  1. Call getNewestCachedMessageId(sessionId:)\n  2. Build message dictionary with type and session_id\n  3. If lastMessageId exists, add \"last_message_id\" key\n  4. Log delta sync status\n  5. Send message\n\n## Dependencies\n- Requires: \"Implement iOS getNewestCachedMessageId function\"\n- Requires: \"Update subscribe handler to use delta sync algorithm\" (backend must accept the field)\n\n## Verification\n- [ ] Manual test: Subscribe message includes last_message_id when messages exist\n- [ ] Manual test: Subscribe message omits last_message_id when no cached messages\n- [ ] Console logs show delta sync status\n- [ ] Backend receives and logs last_message_id\n\n## Acceptance Criteria\n- Subscribe with `last_message_id` returns only newer messages\n- Subscribe without `last_message_id` returns recent messages (backward compatible)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-31T17:09:46.221114-06:00","updated_at":"2025-12-31T17:09:46.221114-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-message-too-long-hfn.5","depends_on_id":"voice-code-message-too-long-hfn.4","type":"blocks","created_at":"2025-12-31T17:09:52.114723-06:00","created_by":"travisbrown"},{"issue_id":"voice-code-message-too-long-hfn.5","depends_on_id":"voice-code-message-too-long-hfn.3","type":"blocks","created_at":"2025-12-31T17:09:52.521672-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-message-too-long-hfn.6","content_hash":"bc93a21520062d8a41f47b1a7133da007a6df6521b0b1c33c7bbf7457445ec6a","title":"Handle is_complete response in iOS session history","description":"## Design Reference\n@docs/design/delta-sync-session-history.md#ios-handle-incomplete-response\n\n## Context\niOS needs to handle the new `is_complete` field in session_history responses. When false, it indicates the budget was exhausted before all messages could be sent, meaning there's a gap in history.\n\n## Requirements\n- [ ] Parse `is_complete` field from session_history response\n- [ ] Parse `oldest_message_id` and `newest_message_id` fields\n- [ ] Log warning when is_complete is false\n- [ ] Optionally display indicator to user when history is incomplete\n\n## Technical Approach\n- File to modify: `ios/VoiceCode/Managers/VoiceCodeClient.swift`\n- In session_history case handler:\n  1. Extract is_complete boolean (default true for backward compatibility)\n  2. Extract oldest_message_id and newest_message_id strings\n  3. Log if is_complete is false\n  4. Consider: notify delegate or post notification for UI indicator\n\n## Parallelization\nCan be worked alongside: \"Update iOS subscribe to send last_message_id\"\n\n## Dependencies\n- Requires: \"Update subscribe handler to use delta sync algorithm\" (backend must send the fields)\n\n## Verification\n- [ ] Manual test: is_complete=true logged correctly\n- [ ] Manual test: is_complete=false triggers warning log\n- [ ] Manual test: Missing is_complete field defaults to true (backward compat)\n- [ ] Console shows oldest/newest message IDs\n\n## Acceptance Criteria\n- `is_complete: false` indicates budget exhaustion\n- iOS displays truncated content with appropriate indicator","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-31T17:10:14.827133-06:00","updated_at":"2025-12-31T17:10:14.827133-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-message-too-long-hfn.6","depends_on_id":"voice-code-message-too-long-hfn.3","type":"blocks","created_at":"2025-12-31T17:10:19.9067-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-message-too-long-hfn.7","content_hash":"a391dc5590611dd33e7bbd39768dc8619ef70871a56186f6d6a0fef0a9100f34","title":"Update STANDARDS.md with delta sync protocol","description":"## Design Reference\n@docs/design/delta-sync-session-history.md#required-documentation-updates\n\n## Context\nSTANDARDS.md documents the WebSocket protocol. It must be updated to reflect the new delta sync fields and behavior.\n\n## Requirements\n- [ ] Document `last_message_id` optional field in Subscribe message\n- [ ] Document `oldest_message_id`, `newest_message_id`, `is_complete` in Session History response\n- [ ] Document delta sync behavior and algorithm summary\n- [ ] Document error cases (stale last_message_id treated as not provided)\n\n## Technical Approach\n- File to modify: `STANDARDS.md`\n- Sections to update:\n  1. Subscribe Message section - add last_message_id field\n  2. Session History Response section - add new fields\n  3. Add new \"Delta Sync\" subsection explaining behavior\n\n## Dependencies\n- Should be done after: All implementation tasks (to document final behavior)\n\n## Verification\n- [ ] All new fields documented with correct types and descriptions\n- [ ] Examples show both with and without last_message_id\n- [ ] Error cases documented\n- [ ] Documentation matches implemented behavior\n\n## Acceptance Criteria\n- Protocol documentation accurately reflects implementation\n- New developers can understand delta sync from STANDARDS.md alone","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-31T17:10:38.95168-06:00","updated_at":"2025-12-31T17:10:38.95168-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-message-too-long-hfn.7","depends_on_id":"voice-code-message-too-long-hfn.5","type":"blocks","created_at":"2025-12-31T17:10:44.994082-06:00","created_by":"travisbrown"},{"issue_id":"voice-code-message-too-long-hfn.7","depends_on_id":"voice-code-message-too-long-hfn.6","type":"blocks","created_at":"2025-12-31T17:10:45.39163-06:00","created_by":"travisbrown"}]}
{"id":"voice-code-orchestration-4ba","content_hash":"9d054979a6474d8ae0681fb3b0eeb132c8e4ac39273acf16bdb2569d95bba9b0","title":"Add model support to recipes with commit step","description":"Add ability to specify model per recipe step. Add commit step after successful code review using Haiku model.","design":"# Design: Model Support for Recipes with Commit Step\n\n## Overview\n\nAdd the ability to specify a model per recipe step, enabling routine commits to use fast/cheap models (Haiku) while complex implementation steps use more capable models.\n\n## Changes Required\n\n### 1. Recipe Schema Changes (`recipes.clj`)\n\nAdd optional `:model` field at both recipe level (default) and step level (override):\n\n```clojure\n{:id :implement-and-review\n :model \"sonnet\"  ; default model for all steps (optional)\n :steps\n {:implement\n  {:prompt \"Run bd ready and implement the task.\"\n   :outcomes #{:complete :other}\n   :on-outcome {...}}\n  \n  :commit\n  {:prompt \"Commit the changes for this task.\"\n   :model \"haiku\"  ; fast/cheap model for straightforward commits\n   :outcomes #{:committed :nothing-to-commit :other}\n   :on-outcome {...}}}}\n```\n\nModel resolution order:\n1. Step-level `:model` (if present)\n2. Recipe-level `:model` (if present)  \n3. Claude CLI default (if neither specified)\n\nValid model values: `\"haiku\"`, `\"sonnet\"`, `\"opus\"` (matches Claude Code CLI)\n\n### 2. Updated Recipe Flow\n\nCurrent flow:\n```\n:implement -\u003e :code-review -\u003e (issues? :fix : exit)\n                   ^            |\n                   +------------+\n```\n\nNew flow with commit step:\n```\n:implement -\u003e :code-review -\u003e (issues? :fix : :commit) -\u003e exit\n                   ^            |\n                   +------------+\n```\n\n### 3. Complete Updated Recipe Definition\n\n```clojure\n(defn implement-and-review-recipe\n  []\n  {:id :implement-and-review\n   :label \"Implement \u0026 Review\"\n   :description \"Implement task, review code, fix issues, and commit\"\n   :initial-step :implement\n   :steps\n   {:implement\n    {:prompt \"Run bd ready and implement the task.\"\n     :outcomes #{:complete :other}\n     :on-outcome\n     {:complete {:next-step :code-review}\n      :other {:action :exit :reason \"user-provided-other\"}}}\n\n    :code-review\n    {:prompt \"Perform a code review on the task that you just completed.\"\n     :outcomes #{:no-issues :issues-found :other}\n     :on-outcome\n     {:no-issues {:next-step :commit}\n      :issues-found {:next-step :fix}\n      :other {:action :exit :reason \"user-provided-other\"}}}\n\n    :fix\n    {:prompt \"Address the issues found.\"\n     :outcomes #{:complete :other}\n     :on-outcome\n     {:complete {:next-step :code-review}\n      :other {:action :exit :reason \"user-provided-other\"}}}\n\n    :commit\n    {:prompt \"Commit and push the changes you made for this task. Use the beads task ID in the commit message.\"\n     :model \"haiku\"\n     :outcomes #{:committed :nothing-to-commit :other}\n     :on-outcome\n     {:committed {:action :exit :reason \"task-committed\"}\n      :nothing-to-commit {:action :exit :reason \"no-changes-to-commit\"}\n      :other {:action :exit :reason \"user-provided-other\"}}}}\n\n   :guardrails\n   {:max-step-visits 3\n    :max-total-steps 20\n    :exit-on-other true}})\n```\n\n### 4. Server Changes (`server.clj`)\n\nAdd helper function and update `execute-recipe-step`:\n\n```clojure\n(defn get-step-model \n  \"Get model for a step. Resolution: step :model \u003e recipe :model \u003e nil\"\n  [recipe step-name]\n  (or (get-in recipe [:steps step-name :model])\n      (:model recipe)))\n\n;; In execute-recipe-step, update invoke-claude-async call:\n(claude/invoke-claude-async\n step-prompt\n callback-fn\n :resume-session-id session-id\n :working-directory working-dir\n :model (get-step-model recipe current-step)  ; NEW\n :timeout-ms 86400000)\n```\n\n### 5. Validation Updates (`recipes.clj`)\n\nAdd model validation to `validate-recipe`:\n\n```clojure\n(def valid-models #{\"haiku\" \"sonnet\" \"opus\"})\n\n(defn validate-model [model context]\n  (when (and model (not (contains? valid-models model)))\n    {:error (str \"Invalid model '\" model \"' at \" context \". Valid: \" valid-models)}))\n\n;; In validate-recipe, add checks for:\n;; - Recipe-level :model (if present)\n;; - Per-step :model (if present)\n```\n\nUpdate specs:\n\n```clojure\n(s/def ::model #{\"haiku\" \"sonnet\" \"opus\"})\n\n(s/def ::step-def\n  (s/keys :req-un [::prompt ::outcomes ::on-outcome]\n          :opt-un [::model]))\n\n(s/def ::recipe\n  (s/keys :req-un [::id ::description ::initial-step ::steps]\n          :opt-un [::guardrails ::model]))\n```\n\n### 6. Logging Enhancement\n\nLog model being used for each step:\n\n```clojure\n(log/info \"Executing recipe step\"\n          {:session-id session-id\n           :recipe-id (:recipe-id orch-state)\n           :step current-step\n           :model (get-step-model recipe current-step)  ; NEW\n           :step-count (:step-count orch-state)})\n```\n\n## Files to Modify\n\n1. `backend/src/voice_code/recipes.clj`\n   - Add `valid-models` set\n   - Update `implement-and-review-recipe` with commit step\n   - Update `validate-recipe` to check model values\n   - Update specs for `::model`, `::step-def`, `::recipe`\n\n2. `backend/src/voice_code/server.clj`\n   - Add `get-step-model` helper function\n   - Update `execute-recipe-step` to pass `:model` to `invoke-claude-async`\n   - Update logging to include model\n\n3. `backend/test/voice_code/recipes_test.clj`\n   - Add tests for model validation\n   - Add tests for commit step\n\n4. `backend/test/voice_code/server_test.clj`\n   - Add tests for `get-step-model` resolution\n   - Add integration test for recipe with model switching\n\n## Design Decisions\n\n1. **Haiku for commits**: Commits are straightforward tasks that don't need Opus/Sonnet reasoning. Haiku is fast and cheap.\n\n2. **Model at step level, not prompt level**: Simpler than per-prompt. A step's model doesn't change during retries.\n\n3. **No frontend changes**: Model is backend orchestration detail. Could add to `recipe-step-started` message later if needed.\n\n4. **Beads task ID in commit**: The agent already ran `bd ready` in :implement step, so it knows the task ID from that context.\n\n5. **Commit and push**: The commit step includes pushing to complete the workflow end-to-end.\n\n6. **Commit failures use :other**: Git errors (conflicts, permissions) are rare edge cases. Agent should report via `:other` with description rather than adding dedicated outcomes.\n\n## Assumptions to Verify\n\n1. **Model switching with --resume**: Claude CLI should accept `--model haiku --resume \u003csession-id\u003e` to use a different model for the same session. Need to verify this works correctly.\n\n## Test Plan\n\n1. **Unit test**: Model resolution (step \u003e recipe \u003e nil)\n2. **Unit test**: Model validation rejects invalid values\n3. **Unit test**: Commit step outcomes parsing\n4. **Integration test**: Full recipe with commit step\n5. **Manual test**: Verify Haiku is used for commit step via Claude logs\n6. **Manual test**: Verify model switching works with --resume\n\n## Acceptance Criteria\n\n- [ ] Recipes can specify default model at recipe level\n- [ ] Steps can override model at step level  \n- [ ] Invalid model values are rejected by validation\n- [ ] Model is passed through to Claude CLI\n- [ ] Implement-and-review recipe includes commit step after successful review\n- [ ] Commit step uses Haiku model\n- [ ] Model is logged when executing steps\n- [ ] All existing tests pass\n- [ ] New tests cover model resolution, validation, and commit step","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-28T08:51:13.107831-06:00","updated_at":"2025-12-28T14:17:35.51032-06:00","closed_at":"2025-12-28T14:17:35.51032-06:00","source_repo":"."}
{"id":"voice-code-orchestration-5k8","content_hash":"291a9da11c4102ed7e28fe1b66b8b09ea4f23eb4c4bec8fde92d2a812d8a0a70","title":"Add no-tasks outcome to implement-and-review recipe","description":"## Design Document\n@docs/design/no-tasks-outcome.md\n\n## Overview\nAdd a `:no-tasks` outcome to the implement-and-review recipe's `:implement` step. This handles the scenario where `bd ready` returns no tasks to work on, providing an explicit exit path instead of forcing the agent to use the catch-all `:other` outcome.\n\n## Acceptance Criteria\n1. `:implement` step includes `:no-tasks` in its outcomes set\n2. Selecting `:no-tasks` exits recipe with reason `\"no-tasks-available\"`\n3. Exit reason is classified as `:completed` (not `:error` or `:guardrail`) - deferred to exit-reason-classification feature\n4. iOS receives `category: \"completed\"` in the exit message - deferred to exit-reason-classification feature\n5. Human-readable message clearly states no tasks were available - deferred to exit-reason-classification feature\n6. All existing tests continue to pass","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-28T13:57:08.359587-06:00","updated_at":"2025-12-28T14:32:17.288601-06:00","closed_at":"2025-12-28T14:32:17.288601-06:00","source_repo":"."}
{"id":"voice-code-orchestration-5k8.1","content_hash":"d91932c090063afef99f08b0eb8863a75eac2eaff0ce191c4fd1d76650f8973a","title":"Add :no-tasks outcome to implement step in recipe definition","description":"## Design Reference\n@docs/design/no-tasks-outcome.md#detailed-design\n\n## Context\nThe implement-and-review recipe's :implement step currently only has outcomes for when tasks exist (:complete, :blocked, :other). When bd ready returns no tasks, the agent has no appropriate outcome to select. This task adds the :no-tasks outcome with proper prompt guidance.\n\n## Requirements\n- [ ] Add :no-tasks to the :outcomes set in :implement step\n- [ ] Add :no-tasks transition to :on-outcome map with exit action and reason \"no-tasks-available\"\n- [ ] Add \"No Tasks Available\" guidance section to the :implement step prompt\n\n## Technical Approach\nModify the implement-and-review-recipe function to:\n1. Add :no-tasks to outcomes: #{:complete :no-tasks :blocked :other}\n2. Add transition: :no-tasks {:action :exit :reason \"no-tasks-available\"}\n3. Add prompt section explaining when to use :no-tasks outcome\n\n- Files to modify: backend/src/voice_code/recipes.clj\n- New files to create: none\n- Dependencies: none (this is the foundation task)\n\n## Verification\n- [ ] Recipe validation passes (validate-recipe returns nil)\n- [ ] determine-next-action returns {:action :exit :reason \"no-tasks-available\"} for :no-tasks\n- [ ] Manual verification: Read the updated recipe and confirm structure matches design\n\n## Acceptance Criteria\n1. :implement step includes :no-tasks in its outcomes set\n2. Selecting :no-tasks exits recipe with reason \"no-tasks-available\"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T13:57:39.563357-06:00","updated_at":"2025-12-28T14:26:11.573641-06:00","closed_at":"2025-12-28T14:26:11.573641-06:00","source_repo":"."}
{"id":"voice-code-orchestration-5k8.2","content_hash":"3b2a3c474d8c02399fb8b4bc6cb9f68f6e74ef412316a7715b82bb369bfd6a0b","title":"Add unit tests for :no-tasks outcome","description":"## Design Reference\n@docs/design/no-tasks-outcome.md#verification-strategy\n\n## Context\nAfter adding the :no-tasks outcome to the recipe, we need unit tests to verify the outcome is properly configured and produces the correct exit action. These tests ensure the recipe structure is correct and the orchestration logic handles the new outcome properly.\n\n## Requirements\n- [ ] Test that :no-tasks is in the :implement step's :outcomes set\n- [ ] Test that :on-outcome contains the correct :no-tasks transition\n- [ ] Test that determine-next-action returns correct exit action for :no-tasks\n- [ ] Test that recipe validation passes with new outcome\n\n## Technical Approach\nAdd tests to the existing recipes_test.clj file:\n1. implement-step-no-tasks-outcome-test: Verify outcome exists and transition is correct\n2. implement-step-no-tasks-transition-test: Verify determine-next-action behavior\n3. recipe-validates-with-no-tasks-outcome-test: Verify validation passes\n\n- Files to modify: backend/test/voice_code/recipes_test.clj\n- New files to create: none\n- Dependencies: Task 1 must complete first (recipe definition changes)\n\n## Verification\n- [ ] All new tests pass\n- [ ] All existing tests continue to pass\n- [ ] Run full test suite: clojure -M:test\n\n## Acceptance Criteria\n6. All existing tests continue to pass (plus new tests for :no-tasks)\n\n## Parallelization\nCannot be parallelized - depends on Task 1 completing first.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T13:57:59.524457-06:00","updated_at":"2025-12-28T14:32:17.287979-06:00","closed_at":"2025-12-28T14:32:17.287979-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-orchestration-5k8.2","depends_on_id":"voice-code-orchestration-5k8.1","type":"blocks","created_at":"2025-12-28T13:57:59.525102-06:00","created_by":"daemon"}]}
{"id":"voice-code-orchestration-6k7","content_hash":"75e59e47869ab9cdbe8f7eac4e63002129a330c51cce7de8c097daafbad2f2a3","title":"Modify execute-recipe-step for conditional session ID type","description":"## Design Reference\n@docs/design/recipe-new-session-support.md#backend-modified-execute-recipe-step\n\n## Context\nThe execute-recipe-step function currently always uses :resume-session-id when calling invoke-claude-async. It needs to be modified to use :new-session-id for the first step of new sessions and :resume-session-id for all subsequent steps.\n\n## Requirements\n- [ ] Read :session-created? from orchestration state\n- [ ] Use :new-session-id when session-created? is false\n- [ ] Use :resume-session-id when session-created? is true\n- [ ] Update state to :session-created? true after first successful Claude invocation\n- [ ] Add session-created? to logging context\n\n## Technical Approach\nModify the invoke-claude-async call in execute-recipe-step:\n```clojure\n(let [step-prompt (or prompt-override (get-next-step-prompt session-id orch-state recipe))\n      current-step (:current-step orch-state)\n      session-created? (:session-created? orch-state)]\n  ;; ...\n  (claude/invoke-claude-async\n   step-prompt\n   (fn [response]\n     (try\n       (if (:success response)\n         (let [response-text (:result response)\n               current-orch-state (get-session-recipe-state session-id)]\n           ;; Mark session as created after first successful invocation\n           (when (and current-orch-state (not session-created?))\n             (swap! session-orchestration-state\n                    update session-id\n                    assoc :session-created? true))\n           ;; ... rest of response handling\n           )\n         ;; ... error handling\n         ))\n     ;; ... exception handling\n     ))\n   ;; Conditionally pass new-session-id or resume-session-id\n   (if session-created? :resume-session-id :new-session-id) session-id\n   :working-directory working-dir\n   :model (get-step-model recipe current-step)\n   :timeout-ms 86400000))\n```\n\n- Files to modify: backend/src/voice_code/server.clj\n- New files to create: None\n- Dependencies: voice-code-orchestration-ltq (start-recipe-for-session provides :session-created? in state)\n\n## Verification\n- [ ] Unit test: uses :new-session-id when session-created? is false\n- [ ] Unit test: uses :resume-session-id when session-created? is true\n- [ ] Unit test: state transitions to :session-created? true after success\n- [ ] Integration test: full recipe flow with new session uses correct flags\n\n## Acceptance Criteria\nThis task directly addresses:\n- Criterion 1: Starting a recipe on a new session succeeds\n- Criterion 2: The first recipe step uses --session-id flag (not --resume)\n- Criterion 3: Subsequent recipe steps use --resume flag\n- Criterion 4: Existing sessions continue to work with --resume from the first step\n- Criterion 6: Recipe state includes :session-created? flag that transitions correctly","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T15:17:22.886309-06:00","updated_at":"2025-12-28T15:38:43.300607-06:00","closed_at":"2025-12-28T15:38:43.300607-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-orchestration-6k7","depends_on_id":"voice-code-orchestration-dgr","type":"parent-child","created_at":"2025-12-28T15:17:31.732251-06:00","created_by":"daemon"},{"issue_id":"voice-code-orchestration-6k7","depends_on_id":"voice-code-orchestration-ltq","type":"blocks","created_at":"2025-12-28T15:17:31.796264-06:00","created_by":"daemon"}]}
{"id":"voice-code-orchestration-aqn","content_hash":"0ac49be70d96f2513cf6c999b8a1c21b05af32a06e1c435ede2f5f879de207b6","title":"Add session-exists? helper function","description":"## Design Reference\n@docs/design/recipe-new-session-support.md#backend-session-creation-detection\n\n## Context\nThis is the foundation task for recipe new session support. The session-exists? helper function determines whether a Claude session file exists for a given session ID, which is used to decide whether to use --session-id (new) or --resume (existing) when invoking Claude CLI.\n\n## Requirements\n- [ ] Add session-exists? function to server.clj\n- [ ] Function should check if session metadata exists via repl/get-session-metadata\n- [ ] Return boolean: true if session exists, false otherwise\n\n## Technical Approach\nAdd helper function to server.clj:\n```clojure\n(defn session-exists?\n  \"Check if a Claude session file exists for the given session ID.\n   Returns true if session metadata exists (implying .jsonl file exists).\"\n  [session-id]\n  (some? (repl/get-session-metadata session-id)))\n```\n\n- Files to modify: backend/src/voice_code/server.clj\n- New files to create: None\n- Dependencies: None (this is a foundation task)\n\n## Verification\n- [ ] Unit test: returns false when get-session-metadata returns nil\n- [ ] Unit test: returns true when get-session-metadata returns data\n- [ ] REPL verification: test with known existing and non-existing session IDs\n\n## Acceptance Criteria\nThis task enables detection of new vs existing sessions, which is prerequisite for:\n- Criterion 2: First recipe step uses --session-id flag\n- Criterion 4: Existing sessions continue to work with --resume\n\n## Parallelization\nThis is a foundation task with no dependencies. Must complete before tasks 2, 3.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T15:15:35.499142-06:00","updated_at":"2025-12-28T15:23:18.629881-06:00","closed_at":"2025-12-28T15:23:18.629881-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-orchestration-aqn","depends_on_id":"voice-code-orchestration-dgr","type":"parent-child","created_at":"2025-12-28T15:15:46.927476-06:00","created_by":"daemon"}]}
{"id":"voice-code-orchestration-dgr","content_hash":"2b191d785b5dc12c9ce9fc2081d468f6b80c0cd11707784c6e0222b21f09baee","title":"Recipe new session support","description":"## Design Document\n@docs/design/recipe-new-session-support.md\n\n## Overview\nEnable recipes to start on brand new sessions that have never communicated with Claude. Currently recipes fail on new sessions because they unconditionally use :resume-session-id, which requires an existing session file.\n\nThe implementation adds session existence detection, conditional use of :new-session-id vs :resume-session-id, and proper state transitions after the first Claude invocation.\n\n## Acceptance Criteria\n1. Starting a recipe on a new session (no prior Claude interaction) succeeds\n2. The first recipe step uses --session-id flag (not --resume)\n3. Subsequent recipe steps use --resume flag\n4. Existing sessions continue to work with --resume from the first step\n5. Starting a recipe on a new session without working_directory returns a clear error message\n6. Recipe state includes :session-created? flag that transitions correctly\n7. Logging indicates whether session is new or existing","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-28T15:14:54.066093-06:00","updated_at":"2025-12-28T15:41:15.497118-06:00","closed_at":"2025-12-28T15:41:15.497118-06:00","source_repo":"."}
{"id":"voice-code-orchestration-ltq","content_hash":"56043d906c1d6b2037e866aa727ff43bbce7e0374883a0ab31e75c42f0cf9d85","title":"Modify start-recipe-for-session to accept is-new-session? parameter","description":"## Design Reference\n@docs/design/recipe-new-session-support.md#backend-modified-start-recipe-for-session\n\n## Context\nThe start-recipe-for-session function initializes orchestration state when a recipe starts. It needs to be modified to accept an is-new-session? parameter and set the :session-created? flag in the state accordingly.\n\n## Requirements\n- [ ] Add is-new-session? parameter to start-recipe-for-session function\n- [ ] Set :session-created? to (not is-new-session?) in the orchestration state\n- [ ] Update logging to include {:is-new-session is-new-session?} context\n\n## Technical Approach\nModify function signature and implementation:\n```clojure\n(defn start-recipe-for-session\n  \"Initialize orchestration state for a session.\n   is-new-session? indicates whether this is a brand new session with no Claude history.\"\n  [session-id recipe-id is-new-session?]\n  (if-let [state (orch/create-orchestration-state recipe-id)]\n    (let [state-with-session-flag (assoc state :session-created? (not is-new-session?))]\n      (swap! session-orchestration-state assoc session-id state-with-session-flag)\n      (orch/log-orchestration-event \"recipe-started\" session-id recipe-id\n                                     (:current-step state)\n                                     {:is-new-session is-new-session?})\n      state-with-session-flag)\n    ...))\n```\n\n- Files to modify: backend/src/voice_code/server.clj\n- New files to create: None\n- Dependencies: None (but task 3 depends on this)\n\n## Verification\n- [ ] Unit test: new session (is-new-session?=true) sets :session-created? to false\n- [ ] Unit test: existing session (is-new-session?=false) sets :session-created? to true\n- [ ] Verify logging includes is-new-session context\n\n## Acceptance Criteria\nThis task enables:\n- Criterion 6: Recipe state includes :session-created? flag that transitions correctly\n- Criterion 7: Logging indicates whether session is new or existing\n\n## Parallelization\nCan be worked alongside: Add session-exists? helper function (task 1)\nBoth are foundation tasks with no mutual dependencies.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T15:16:14.768887-06:00","updated_at":"2025-12-28T15:28:41.709771-06:00","closed_at":"2025-12-28T15:28:41.709771-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-orchestration-ltq","depends_on_id":"voice-code-orchestration-dgr","type":"parent-child","created_at":"2025-12-28T15:16:20.48089-06:00","created_by":"daemon"}]}
{"id":"voice-code-orchestration-yy9","content_hash":"fcf1bc3a2405e8f8a0ccadf97c17096ce31a716f0558f9f6e65e1b8cc7fe0067","title":"Update start_recipe handler with new session detection and validation","description":"## Design Reference\n@docs/design/recipe-new-session-support.md#backend-modified-start_recipe-handler\n\n## Context\nThe start_recipe WebSocket message handler needs to detect whether the session is new or existing, validate that working_directory is provided for new sessions, and pass the is-new-session? flag to start-recipe-for-session.\n\n## Requirements\n- [ ] Call session-exists? to detect new vs existing sessions\n- [ ] Add validation: working_directory required for new sessions\n- [ ] Return error with message \"working_directory required for new session\" if validation fails\n- [ ] Pass is-new-session? to start-recipe-for-session\n\n## Technical Approach\nUpdate the \"start_recipe\" case in handle-message:\n```clojure\n\"start_recipe\"\n(let [recipe-id (keyword (:recipe-id data))\n      session-id (:session-id data)\n      working-directory (:working-directory data)\n      is-new-session? (not (session-exists? session-id))]\n  (cond\n    (not session-id)\n    (send-to-client! channel\n                     {:type :error\n                      :message \"session_id required in start_recipe message\"})\n\n    (not recipe-id)\n    (send-to-client! channel\n                     {:type :error\n                      :message \"recipe_id required in start_recipe message\"})\n\n    ;; New validation: working_directory required for new sessions\n    (and is-new-session? (str/blank? working-directory))\n    (send-to-client! channel\n                     {:type :error\n                      :message \"working_directory required for new session\"\n                      :session-id session-id})\n\n    :else\n    (if-let [orch-state (start-recipe-for-session session-id recipe-id is-new-session?)]\n      ;; ... rest of handler\n      )))\n```\n\n- Files to modify: backend/src/voice_code/server.clj\n- New files to create: None\n- Dependencies: \n  - voice-code-orchestration-aqn (session-exists? helper)\n  - voice-code-orchestration-ltq (start-recipe-for-session modification)\n\n## Verification\n- [ ] Integration test: new session without working_directory returns error\n- [ ] Integration test: new session with working_directory succeeds\n- [ ] Integration test: existing session works without working_directory\n- [ ] Verify error message includes session_id\n\n## Acceptance Criteria\nThis task directly addresses:\n- Criterion 5: Starting a recipe on a new session without working_directory returns a clear error message","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T15:16:44.591747-06:00","updated_at":"2025-12-28T15:33:38.219342-06:00","closed_at":"2025-12-28T15:33:38.219342-06:00","source_repo":".","dependencies":[{"issue_id":"voice-code-orchestration-yy9","depends_on_id":"voice-code-orchestration-dgr","type":"parent-child","created_at":"2025-12-28T15:16:51.27575-06:00","created_by":"daemon"},{"issue_id":"voice-code-orchestration-yy9","depends_on_id":"voice-code-orchestration-aqn","type":"blocks","created_at":"2025-12-28T15:16:51.340106-06:00","created_by":"daemon"},{"issue_id":"voice-code-orchestration-yy9","depends_on_id":"voice-code-orchestration-ltq","type":"blocks","created_at":"2025-12-28T15:16:51.402046-06:00","created_by":"daemon"}]}
