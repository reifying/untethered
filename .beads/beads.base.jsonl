{"id":"voice-code-orchestration-aqn","title":"Add session-exists? helper function","description":"## Design Reference\n@docs/design/recipe-new-session-support.md#backend-session-creation-detection\n\n## Context\nThis is the foundation task for recipe new session support. The session-exists? helper function determines whether a Claude session file exists for a given session ID, which is used to decide whether to use --session-id (new) or --resume (existing) when invoking Claude CLI.\n\n## Requirements\n- [ ] Add session-exists? function to server.clj\n- [ ] Function should check if session metadata exists via repl/get-session-metadata\n- [ ] Return boolean: true if session exists, false otherwise\n\n## Technical Approach\nAdd helper function to server.clj:\n```clojure\n(defn session-exists?\n  \"Check if a Claude session file exists for the given session ID.\n   Returns true if session metadata exists (implying .jsonl file exists).\"\n  [session-id]\n  (some? (repl/get-session-metadata session-id)))\n```\n\n- Files to modify: backend/src/voice_code/server.clj\n- New files to create: None\n- Dependencies: None (this is a foundation task)\n\n## Verification\n- [ ] Unit test: returns false when get-session-metadata returns nil\n- [ ] Unit test: returns true when get-session-metadata returns data\n- [ ] REPL verification: test with known existing and non-existing session IDs\n\n## Acceptance Criteria\nThis task enables detection of new vs existing sessions, which is prerequisite for:\n- Criterion 2: First recipe step uses --session-id flag\n- Criterion 4: Existing sessions continue to work with --resume\n\n## Parallelization\nThis is a foundation task with no dependencies. Must complete before tasks 2, 3.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-28T15:15:35.499142-06:00","updated_at":"2025-12-28T15:15:35.499142-06:00","dependencies":[{"issue_id":"voice-code-orchestration-aqn","depends_on_id":"voice-code-orchestration-dgr","type":"parent-child","created_at":"2025-12-28T15:15:46.927476-06:00","created_by":"daemon"}]}
{"id":"voice-code-orchestration-dgr","title":"Recipe new session support","description":"## Design Document\n@docs/design/recipe-new-session-support.md\n\n## Overview\nEnable recipes to start on brand new sessions that have never communicated with Claude. Currently recipes fail on new sessions because they unconditionally use :resume-session-id, which requires an existing session file.\n\nThe implementation adds session existence detection, conditional use of :new-session-id vs :resume-session-id, and proper state transitions after the first Claude invocation.\n\n## Acceptance Criteria\n1. Starting a recipe on a new session (no prior Claude interaction) succeeds\n2. The first recipe step uses --session-id flag (not --resume)\n3. Subsequent recipe steps use --resume flag\n4. Existing sessions continue to work with --resume from the first step\n5. Starting a recipe on a new session without working_directory returns a clear error message\n6. Recipe state includes :session-created? flag that transitions correctly\n7. Logging indicates whether session is new or existing","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-28T15:14:54.066093-06:00","updated_at":"2025-12-28T15:14:54.066093-06:00"}
{"id":"voice-code-orchestration-4ba","title":"Add model support to recipes with commit step","description":"Add ability to specify model per recipe step. Add commit step after successful code review using Haiku model.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-28T08:51:13.107831-06:00","updated_at":"2025-12-28T14:17:35.51032-06:00","closed_at":"2025-12-28T14:17:35.51032-06:00"}
{"id":"voice-code-orchestration-ltq","title":"Modify start-recipe-for-session to accept is-new-session? parameter","description":"## Design Reference\n@docs/design/recipe-new-session-support.md#backend-modified-start-recipe-for-session\n\n## Context\nThe start-recipe-for-session function initializes orchestration state when a recipe starts. It needs to be modified to accept an is-new-session? parameter and set the :session-created? flag in the state accordingly.\n\n## Requirements\n- [ ] Add is-new-session? parameter to start-recipe-for-session function\n- [ ] Set :session-created? to (not is-new-session?) in the orchestration state\n- [ ] Update logging to include {:is-new-session is-new-session?} context\n\n## Technical Approach\nModify function signature and implementation:\n```clojure\n(defn start-recipe-for-session\n  \"Initialize orchestration state for a session.\n   is-new-session? indicates whether this is a brand new session with no Claude history.\"\n  [session-id recipe-id is-new-session?]\n  (if-let [state (orch/create-orchestration-state recipe-id)]\n    (let [state-with-session-flag (assoc state :session-created? (not is-new-session?))]\n      (swap! session-orchestration-state assoc session-id state-with-session-flag)\n      (orch/log-orchestration-event \"recipe-started\" session-id recipe-id\n                                     (:current-step state)\n                                     {:is-new-session is-new-session?})\n      state-with-session-flag)\n    ...))\n```\n\n- Files to modify: backend/src/voice_code/server.clj\n- New files to create: None\n- Dependencies: None (but task 3 depends on this)\n\n## Verification\n- [ ] Unit test: new session (is-new-session?=true) sets :session-created? to false\n- [ ] Unit test: existing session (is-new-session?=false) sets :session-created? to true\n- [ ] Verify logging includes is-new-session context\n\n## Acceptance Criteria\nThis task enables:\n- Criterion 6: Recipe state includes :session-created? flag that transitions correctly\n- Criterion 7: Logging indicates whether session is new or existing\n\n## Parallelization\nCan be worked alongside: Add session-exists? helper function (task 1)\nBoth are foundation tasks with no mutual dependencies.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-28T15:16:14.768887-06:00","updated_at":"2025-12-28T15:16:14.768887-06:00","dependencies":[{"issue_id":"voice-code-orchestration-ltq","depends_on_id":"voice-code-orchestration-dgr","type":"parent-child","created_at":"2025-12-28T15:16:20.48089-06:00","created_by":"daemon"}]}
{"id":"voice-code-orchestration-yy9","title":"Update start_recipe handler with new session detection and validation","description":"## Design Reference\n@docs/design/recipe-new-session-support.md#backend-modified-start_recipe-handler\n\n## Context\nThe start_recipe WebSocket message handler needs to detect whether the session is new or existing, validate that working_directory is provided for new sessions, and pass the is-new-session? flag to start-recipe-for-session.\n\n## Requirements\n- [ ] Call session-exists? to detect new vs existing sessions\n- [ ] Add validation: working_directory required for new sessions\n- [ ] Return error with message \"working_directory required for new session\" if validation fails\n- [ ] Pass is-new-session? to start-recipe-for-session\n\n## Technical Approach\nUpdate the \"start_recipe\" case in handle-message:\n```clojure\n\"start_recipe\"\n(let [recipe-id (keyword (:recipe-id data))\n      session-id (:session-id data)\n      working-directory (:working-directory data)\n      is-new-session? (not (session-exists? session-id))]\n  (cond\n    (not session-id)\n    (send-to-client! channel\n                     {:type :error\n                      :message \"session_id required in start_recipe message\"})\n\n    (not recipe-id)\n    (send-to-client! channel\n                     {:type :error\n                      :message \"recipe_id required in start_recipe message\"})\n\n    ;; New validation: working_directory required for new sessions\n    (and is-new-session? (str/blank? working-directory))\n    (send-to-client! channel\n                     {:type :error\n                      :message \"working_directory required for new session\"\n                      :session-id session-id})\n\n    :else\n    (if-let [orch-state (start-recipe-for-session session-id recipe-id is-new-session?)]\n      ;; ... rest of handler\n      )))\n```\n\n- Files to modify: backend/src/voice_code/server.clj\n- New files to create: None\n- Dependencies: \n  - voice-code-orchestration-aqn (session-exists? helper)\n  - voice-code-orchestration-ltq (start-recipe-for-session modification)\n\n## Verification\n- [ ] Integration test: new session without working_directory returns error\n- [ ] Integration test: new session with working_directory succeeds\n- [ ] Integration test: existing session works without working_directory\n- [ ] Verify error message includes session_id\n\n## Acceptance Criteria\nThis task directly addresses:\n- Criterion 5: Starting a recipe on a new session without working_directory returns a clear error message","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-28T15:16:44.591747-06:00","updated_at":"2025-12-28T15:16:44.591747-06:00","dependencies":[{"issue_id":"voice-code-orchestration-yy9","depends_on_id":"voice-code-orchestration-dgr","type":"parent-child","created_at":"2025-12-28T15:16:51.27575-06:00","created_by":"daemon"},{"issue_id":"voice-code-orchestration-yy9","depends_on_id":"voice-code-orchestration-aqn","type":"blocks","created_at":"2025-12-28T15:16:51.340106-06:00","created_by":"daemon"},{"issue_id":"voice-code-orchestration-yy9","depends_on_id":"voice-code-orchestration-ltq","type":"blocks","created_at":"2025-12-28T15:16:51.402046-06:00","created_by":"daemon"}]}
{"id":"voice-code-orchestration-5k8.1","title":"Add :no-tasks outcome to implement step in recipe definition","description":"## Design Reference\n@docs/design/no-tasks-outcome.md#detailed-design\n\n## Context\nThe implement-and-review recipe's :implement step currently only has outcomes for when tasks exist (:complete, :blocked, :other). When bd ready returns no tasks, the agent has no appropriate outcome to select. This task adds the :no-tasks outcome with proper prompt guidance.\n\n## Requirements\n- [ ] Add :no-tasks to the :outcomes set in :implement step\n- [ ] Add :no-tasks transition to :on-outcome map with exit action and reason \"no-tasks-available\"\n- [ ] Add \"No Tasks Available\" guidance section to the :implement step prompt\n\n## Technical Approach\nModify the implement-and-review-recipe function to:\n1. Add :no-tasks to outcomes: #{:complete :no-tasks :blocked :other}\n2. Add transition: :no-tasks {:action :exit :reason \"no-tasks-available\"}\n3. Add prompt section explaining when to use :no-tasks outcome\n\n- Files to modify: backend/src/voice_code/recipes.clj\n- New files to create: none\n- Dependencies: none (this is the foundation task)\n\n## Verification\n- [ ] Recipe validation passes (validate-recipe returns nil)\n- [ ] determine-next-action returns {:action :exit :reason \"no-tasks-available\"} for :no-tasks\n- [ ] Manual verification: Read the updated recipe and confirm structure matches design\n\n## Acceptance Criteria\n1. :implement step includes :no-tasks in its outcomes set\n2. Selecting :no-tasks exits recipe with reason \"no-tasks-available\"","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T13:57:39.563357-06:00","updated_at":"2025-12-28T14:26:11.573641-06:00","closed_at":"2025-12-28T14:26:11.573641-06:00"}
{"id":"voice-code-orchestration-6k7","title":"Modify execute-recipe-step for conditional session ID type","description":"## Design Reference\n@docs/design/recipe-new-session-support.md#backend-modified-execute-recipe-step\n\n## Context\nThe execute-recipe-step function currently always uses :resume-session-id when calling invoke-claude-async. It needs to be modified to use :new-session-id for the first step of new sessions and :resume-session-id for all subsequent steps.\n\n## Requirements\n- [ ] Read :session-created? from orchestration state\n- [ ] Use :new-session-id when session-created? is false\n- [ ] Use :resume-session-id when session-created? is true\n- [ ] Update state to :session-created? true after first successful Claude invocation\n- [ ] Add session-created? to logging context\n\n## Technical Approach\nModify the invoke-claude-async call in execute-recipe-step:\n```clojure\n(let [step-prompt (or prompt-override (get-next-step-prompt session-id orch-state recipe))\n      current-step (:current-step orch-state)\n      session-created? (:session-created? orch-state)]\n  ;; ...\n  (claude/invoke-claude-async\n   step-prompt\n   (fn [response]\n     (try\n       (if (:success response)\n         (let [response-text (:result response)\n               current-orch-state (get-session-recipe-state session-id)]\n           ;; Mark session as created after first successful invocation\n           (when (and current-orch-state (not session-created?))\n             (swap! session-orchestration-state\n                    update session-id\n                    assoc :session-created? true))\n           ;; ... rest of response handling\n           )\n         ;; ... error handling\n         ))\n     ;; ... exception handling\n     ))\n   ;; Conditionally pass new-session-id or resume-session-id\n   (if session-created? :resume-session-id :new-session-id) session-id\n   :working-directory working-dir\n   :model (get-step-model recipe current-step)\n   :timeout-ms 86400000))\n```\n\n- Files to modify: backend/src/voice_code/server.clj\n- New files to create: None\n- Dependencies: voice-code-orchestration-ltq (start-recipe-for-session provides :session-created? in state)\n\n## Verification\n- [ ] Unit test: uses :new-session-id when session-created? is false\n- [ ] Unit test: uses :resume-session-id when session-created? is true\n- [ ] Unit test: state transitions to :session-created? true after success\n- [ ] Integration test: full recipe flow with new session uses correct flags\n\n## Acceptance Criteria\nThis task directly addresses:\n- Criterion 1: Starting a recipe on a new session succeeds\n- Criterion 2: The first recipe step uses --session-id flag (not --resume)\n- Criterion 3: Subsequent recipe steps use --resume flag\n- Criterion 4: Existing sessions continue to work with --resume from the first step\n- Criterion 6: Recipe state includes :session-created? flag that transitions correctly","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-28T15:17:22.886309-06:00","updated_at":"2025-12-28T15:17:22.886309-06:00","dependencies":[{"issue_id":"voice-code-orchestration-6k7","depends_on_id":"voice-code-orchestration-dgr","type":"parent-child","created_at":"2025-12-28T15:17:31.732251-06:00","created_by":"daemon"},{"issue_id":"voice-code-orchestration-6k7","depends_on_id":"voice-code-orchestration-ltq","type":"blocks","created_at":"2025-12-28T15:17:31.796264-06:00","created_by":"daemon"}]}
{"id":"voice-code-orchestration-5k8","title":"Add no-tasks outcome to implement-and-review recipe","description":"## Design Document\n@docs/design/no-tasks-outcome.md\n\n## Overview\nAdd a `:no-tasks` outcome to the implement-and-review recipe's `:implement` step. This handles the scenario where `bd ready` returns no tasks to work on, providing an explicit exit path instead of forcing the agent to use the catch-all `:other` outcome.\n\n## Acceptance Criteria\n1. `:implement` step includes `:no-tasks` in its outcomes set\n2. Selecting `:no-tasks` exits recipe with reason `\"no-tasks-available\"`\n3. Exit reason is classified as `:completed` (not `:error` or `:guardrail`) - deferred to exit-reason-classification feature\n4. iOS receives `category: \"completed\"` in the exit message - deferred to exit-reason-classification feature\n5. Human-readable message clearly states no tasks were available - deferred to exit-reason-classification feature\n6. All existing tests continue to pass","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-28T13:57:08.359587-06:00","updated_at":"2025-12-28T14:32:17.288601-06:00","closed_at":"2025-12-28T14:32:17.288601-06:00"}
{"id":"voice-code-orchestration-5k8.2","title":"Add unit tests for :no-tasks outcome","description":"## Design Reference\n@docs/design/no-tasks-outcome.md#verification-strategy\n\n## Context\nAfter adding the :no-tasks outcome to the recipe, we need unit tests to verify the outcome is properly configured and produces the correct exit action. These tests ensure the recipe structure is correct and the orchestration logic handles the new outcome properly.\n\n## Requirements\n- [ ] Test that :no-tasks is in the :implement step's :outcomes set\n- [ ] Test that :on-outcome contains the correct :no-tasks transition\n- [ ] Test that determine-next-action returns correct exit action for :no-tasks\n- [ ] Test that recipe validation passes with new outcome\n\n## Technical Approach\nAdd tests to the existing recipes_test.clj file:\n1. implement-step-no-tasks-outcome-test: Verify outcome exists and transition is correct\n2. implement-step-no-tasks-transition-test: Verify determine-next-action behavior\n3. recipe-validates-with-no-tasks-outcome-test: Verify validation passes\n\n- Files to modify: backend/test/voice_code/recipes_test.clj\n- New files to create: none\n- Dependencies: Task 1 must complete first (recipe definition changes)\n\n## Verification\n- [ ] All new tests pass\n- [ ] All existing tests continue to pass\n- [ ] Run full test suite: clojure -M:test\n\n## Acceptance Criteria\n6. All existing tests continue to pass (plus new tests for :no-tasks)\n\n## Parallelization\nCannot be parallelized - depends on Task 1 completing first.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T13:57:59.524457-06:00","updated_at":"2025-12-28T14:32:17.287979-06:00","closed_at":"2025-12-28T14:32:17.287979-06:00","dependencies":[{"issue_id":"voice-code-orchestration-5k8.2","depends_on_id":"voice-code-orchestration-5k8.1","type":"blocks","created_at":"2025-12-28T13:57:59.525102-06:00","created_by":"daemon"}]}
