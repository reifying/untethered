{"version":3,"sources":["voice_code/websocket.cljs"],"mappings":"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","names":["voice-code.websocket/ping-interval-ms","voice-code.websocket/max-reconnect-attempts","voice-code.websocket/max-reconnect-delay-ms","js/voice-code","js/voice-code.websocket","js/voice-code.websocket.ws-atom","voice-code.websocket/ws-atom","cljs.core.atom","js/voice-code.websocket.ping-timer","voice-code.websocket/ping-timer","js/voice-code.websocket.reconnect-timer","voice-code.websocket/reconnect-timer","voice-code.websocket/calculate-reconnect-delay","attempt","base-delay","cljs.core.min","Math/pow","jitter-range","jitter","cljs.core.rand","cljs.core.max","voice-code.websocket/start-ping-timer!","cljs.core/deref","js/clearInterval","cljs.core/reset!","js/setInterval","temp__5823__auto__","ws","cljs.core._EQ_","voice-code.json/clj->json","voice-code.websocket/stop-ping-timer!","voice-code.websocket/send-message!","msg","voice-code.websocket/disconnect!","js/clearTimeout","p__12057","map__12060","cljs.core/--destructure-map","cljs.core.get","voice-code.websocket/connect!","server-url","server-port","url","js/WebSocket","_","re-frame.core/dispatch","event","voice-code.json/parse-json-safe","error","re-frame.core/reg-fx","config","p__12093","map__12094","delay-ms","js/setTimeout"],"sourcesContent":["(ns voice-code.websocket\n  \"WebSocket client for voice-code backend communication.\n   Implements the full protocol from STANDARDS.md.\"\n  (:require [re-frame.core :as rf]\n            [voice-code.json :as json]))\n\n(def ^:private ping-interval-ms 30000)\n(def ^:private max-reconnect-attempts 20)\n(def ^:private max-reconnect-delay-ms 30000)\n\n(defonce ^:private ws-atom (atom nil))\n(defonce ^:private ping-timer (atom nil))\n(defonce ^:private reconnect-timer (atom nil))\n\n;; ============================================================================\n;; Reconnection Logic\n;; ============================================================================\n\n(defn- calculate-reconnect-delay\n  \"Calculate reconnection delay with exponential backoff and jitter.\"\n  [attempt]\n  (let [base-delay (min (Math/pow 2 attempt) (/ max-reconnect-delay-ms 1000))\n        jitter-range (* base-delay 0.25)\n        jitter (- (* (rand) jitter-range 2) jitter-range)]\n    (max 1000 (* 1000 (+ base-delay jitter)))))\n\n;; ============================================================================\n;; Ping/Pong Keepalive\n;; ============================================================================\n\n(defn- start-ping-timer!\n  \"Start sending periodic ping messages.\"\n  []\n  (when @ping-timer\n    (js/clearInterval @ping-timer))\n  (reset! ping-timer\n          (js/setInterval\n           #(when-let [ws @ws-atom]\n              (when (= (.-readyState ws) 1)\n                (.send ws (json/clj->json {:type \"ping\"}))))\n           ping-interval-ms)))\n\n(defn- stop-ping-timer!\n  \"Stop sending ping messages.\"\n  []\n  (when @ping-timer\n    (js/clearInterval @ping-timer)\n    (reset! ping-timer nil)))\n\n;; ============================================================================\n;; Message Sending\n;; ============================================================================\n\n(defn send-message!\n  \"Send a message over the WebSocket connection.\"\n  [msg]\n  (when-let [ws @ws-atom]\n    (when (= (.-readyState ws) 1) ; OPEN\n      (.send ws (json/clj->json msg)))))\n\n;; ============================================================================\n;; Connection\n;; ============================================================================\n\n(defn disconnect!\n  \"Close the WebSocket connection.\"\n  []\n  (stop-ping-timer!)\n  (when @reconnect-timer\n    (js/clearTimeout @reconnect-timer)\n    (reset! reconnect-timer nil))\n  (when-let [ws @ws-atom]\n    (.close ws)\n    (reset! ws-atom nil)))\n\n(defn connect!\n  \"Establish a WebSocket connection to the backend.\"\n  [{:keys [server-url server-port]}]\n  (disconnect!)\n  (let [url (str \"ws://\" server-url \":\" server-port \"/ws\")\n        ws (js/WebSocket. url)]\n\n    (set! (.-onopen ws)\n          (fn [_]\n            (rf/dispatch [:ws/connected])))\n\n    (set! (.-onmessage ws)\n          (fn [event]\n            (when-let [msg (json/parse-json-safe (.-data event))]\n              (rf/dispatch [:ws/message-received msg]))))\n\n    (set! (.-onclose ws)\n          (fn [event]\n            (rf/dispatch [:ws/disconnected {:code (.-code event)\n                                            :reason (.-reason event)}])))\n\n    (set! (.-onerror ws)\n          (fn [error]\n            (rf/dispatch [:ws/error error])))\n\n    (reset! ws-atom ws)))\n\n;; ============================================================================\n;; Effect Handlers\n;; ============================================================================\n\n(rf/reg-fx\n :ws/connect\n (fn [config]\n   (connect! config)))\n\n(rf/reg-fx\n :ws/disconnect\n (fn [_]\n   (disconnect!)))\n\n(rf/reg-fx\n :ws/send\n (fn [msg]\n   (send-message! msg)))\n\n(rf/reg-fx\n :ws/start-ping-timer\n (fn [_]\n   (start-ping-timer!)))\n\n(rf/reg-fx\n :ws/stop-ping-timer\n (fn [_]\n   (stop-ping-timer!)))\n\n(rf/reg-fx\n :ws/schedule-reconnect\n (fn [{:keys [delay-ms config]}]\n   (when @reconnect-timer\n     (js/clearTimeout @reconnect-timer))\n   (reset! reconnect-timer\n           (js/setTimeout\n            #(connect! config)\n            delay-ms))))\n"]}